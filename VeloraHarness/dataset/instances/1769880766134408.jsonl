{"instance_id": "1769880766134408", "repo": "Expensify/App", "base_commit": "da2e6688c3f16e8db76d2bcf4b098be5990e8968", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/contributingGuides/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n1. Open App\\n2. Go to any chat\\n3. Send a message and click anywhere on the page to lose composer focus\\n4. Hover over the message and click any of these three Copy to clipboard, Copy link, Mark as unread\\n\\n## Expected Result:\\nPressing any of these three options Copy to clipboard, Copy link, Mark as unread should have to refocus the composer like we do when using the Context menu\\n\\n## Actual Result:\\nPressing any of these three options, Copy to clipboard, Copy link, or Mark as unread is, not refocusing the composer\\n\\n## Workaround:\\nUnknown\\n\\n## Platforms:\\n<!---\\nCheck off any platforms that are affected by this issue\\n--->\\nWhich of our officially supported platforms is this issue occurring on?\\n- [ ] Android / native\\n- [ ] Android / Chrome\\n- [ ] iOS / native\\n- [ ] iOS / Safari\\n- [x] MacOS / Chrome / Safari\\n- [ ] MacOS / Desktop\\n\\n**Version Number:** 1.3.22.0\\n\\n**Reproducible in staging?:** yes\\n\\n**Reproducible in production?:** yes\\n\\n**If this was caught during regression testing, add the test name, ID and link from TestRail:**\\n\\n**Email or phone of affected tester (no customers):**\\n\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n\\n**Notes/Photos/Videos:** Any additional supporting documentation\\n\\n\\nhttps://github.com/Expensify/App/assets/93399543/17878553-d3bc-4891-9525-ed47bd10fceb\\n\\n\\n\\nhttps://github.com/Expensify/App/assets/93399543/e4ae86d4-d71d-4d31-8a1c-b0eb4942501b\\n\\n\\n**Expensify/Expensify Issue URL:**\\n\\n**Issue reported by:** @jayeshmangwani\\n\\n\\n**Slack conversation:** https://expensify.slack.com/archives/C049HHMV9SM/p1684759049611809\\n\\n[View all open jobs on GitHub](https://github.com/Expensify/App/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22)\\n\\n<details><summary>Upwork Automation - Do Not Edit</summary>\\n    <ul>\\n        <li>Upwork Job URL: https://www.upwork.com/jobs/~01517d6a9b05f42ab8</li>\\n        <li>Upwork Job ID: 1666174440708157440</li>\\n        <li>Last Price Increase: 2023-06-29</li>\\n    </ul>\\n</details>", "FAIL_TO_PASS": ["issues/20079/test.py::test_expensify_0000"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=20079 && cd /app/tests && pytest issues/20079/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/src/pages/home/report/ContextMenu/ContextMenuActions.tsx b/src/pages/home/report/ContextMenu/ContextMenuActions.tsx\nindex 6f3a1e8e565..bda8a122c40 100644\n--- a/src/pages/home/report/ContextMenu/ContextMenuActions.tsx\n+++ b/src/pages/home/report/ContextMenu/ContextMenuActions.tsx\n@@ -205,16 +205,13 @@ const ContextMenuActions: ContextMenuAction[] = [\n         isAnonymousAction: false,\n         textTranslateKey: 'reportActionContextMenu.markAsUnread',\n         icon: Expensicons.ChatBubbleUnread,\n-        successIcon: Expensicons.Checkmark,\n-        shouldShow: ({type, isUnreadChat}) => type === CONST.CONTEXT_MENU_TYPES.REPORT_ACTION || (type === CONST.CONTEXT_MENU_TYPES.REPORT && !isUnreadChat),\n+        shouldShow: ({type, isUnreadChat}) => type === CONST.CONTEXT_MENU_TYPES.REPORT_ACTION && !isUnreadChat,\n         onPress: (closePopover, {reportAction, reportID}) => {\n-            const originalReportID = ReportUtils.getOriginalReportID(reportID, reportAction) ?? '-1';\n-            Report.markCommentAsUnread(originalReportID, reportAction?.created);\n-            if (closePopover) {\n-                hideContextMenu(true, ReportActionComposeFocusManager.focus);\n-            }\n+            // Intentionally not refocusing the composer\n+            Report.markAsUnread(reportID);\n         },\n-        getDescription: () => {},\n+        getDescription: () => undefined,\n+        shouldPreventDefaultFocusOnPress: true, // Add this line to prevent refocusing\n     },\n     {\n         isAnonymousAction: false,\n@@ -329,16 +326,17 @@ const ContextMenuActions: ContextMenuAction[] = [\n     },\n     {\n         isAnonymousAction: true,\n-        textTranslateKey: 'reportActionContextMenu.copyURLToClipboard',\n-        icon: Expensicons.Copy,\n-        successTextTranslateKey: 'reportActionContextMenu.copied',\n-        successIcon: Expensicons.Checkmark,\n-        shouldShow: ({type}) => type === CONST.CONTEXT_MENU_TYPES.LINK,\n-        onPress: (closePopover, {selection}) => {\n-            Clipboard.setString(selection);\n-            hideContextMenu(true, ReportActionComposeFocusManager.focus);\n+        textTranslateKey: 'reportActionContextMenu.copyLink',\n+        icon: Expensicons.LinkCopy,\n+        shouldShow: ({type, reportAction, menuTarget}) => \n+            type === CONST.CONTEXT_MENU_TYPES.REPORT_ACTION && !!reportAction && !!menuTarget,\n+        onPress: (closePopover, {reportAction, reportID}) => {\n+            // Existing copy link logic\n+            const reportActionLink = Environment.getReportActionLink(reportAction);\n+            Clipboard.setString(reportActionLink);\n         },\n-        getDescription: (selection) => selection,\n+        getDescription: () => undefined,\n+        shouldPreventDefaultFocusOnPress: true, // Add this line to prevent refocusing\n     },\n     {\n         isAnonymousAction: true,\n@@ -357,141 +355,18 @@ const ContextMenuActions: ContextMenuAction[] = [\n         isAnonymousAction: true,\n         textTranslateKey: 'reportActionContextMenu.copyToClipboard',\n         icon: Expensicons.Copy,\n-        successTextTranslateKey: 'reportActionContextMenu.copied',\n-        successIcon: Expensicons.Checkmark,\n-        shouldShow: ({type, reportAction}) =>\n-            type === CONST.CONTEXT_MENU_TYPES.REPORT_ACTION &&\n-            !ReportActionsUtils.isReportActionAttachment(reportAction) &&\n-            !ReportActionsUtils.isMessageDeleted(reportAction) &&\n-            !ReportActionsUtils.isTripPreview(reportAction),\n-\n-        // If return value is true, we switch the `text` and `icon` on\n-        // `ContextMenuItem` with `successText` and `successIcon` which will fall back to\n-        // the `text` and `icon`\n+        shouldShow: ({type, reportAction}) => type === CONST.CONTEXT_MENU_TYPES.REPORT_ACTION && !!reportAction,\n         onPress: (closePopover, {reportAction, transaction, selection, reportID, hasCard}) => {\n-            const isReportPreviewAction = ReportActionsUtils.isReportPreviewAction(reportAction);\n-            const messageHtml = getActionHtml(reportAction);\n-            const messageText = ReportActionsUtils.getReportActionMessageText(reportAction);\n-\n-            const isAttachment = ReportActionsUtils.isReportActionAttachment(reportAction);\n-            if (!isAttachment) {\n-                const content = selection || messageHtml;\n-                if (isReportPreviewAction) {\n-                    const iouReportID = ReportActionsUtils.getIOUReportIDFromReportActionPreview(reportAction);\n-                    const displayMessage = ReportUtils.getReportPreviewMessage(iouReportID, reportAction);\n-                    Clipboard.setString(displayMessage);\n-                } else if (ReportActionsUtils.isTaskAction(reportAction)) {\n-                    const {text, html} = TaskUtils.getTaskReportActionMessage(reportAction);\n-                    const displayMessage = html ?? text;\n-                    setClipboardMessage(displayMessage);\n-                } else if (ReportActionsUtils.isModifiedExpenseAction(reportAction)) {\n-                    const modifyExpenseMessage = ModifiedExpenseMessage.getForReportAction(reportID, reportAction);\n-                    Clipboard.setString(modifyExpenseMessage);\n-                } else if (ReportActionsUtils.isReimbursementDeQueuedAction(reportAction)) {\n-                    const {expenseReportID} = ReportActionsUtils.getOriginalMessage(reportAction) ?? {};\n-                    const displayMessage = ReportUtils.getReimbursementDeQueuedActionMessage(reportAction, expenseReportID);\n-                    Clipboard.setString(displayMessage);\n-                } else if (ReportActionsUtils.isMoneyRequestAction(reportAction)) {\n-                    const displayMessage = ReportUtils.getIOUReportActionDisplayMessage(reportAction, transaction);\n-                    if (displayMessage === Parser.htmlToText(displayMessage)) {\n-                        Clipboard.setString(displayMessage);\n-                    } else {\n-                        setClipboardMessage(displayMessage);\n-                    }\n-                } else if (ReportActionsUtils.isCreatedTaskReportAction(reportAction)) {\n-                    const taskPreviewMessage = TaskUtils.getTaskCreatedMessage(reportAction);\n-                    Clipboard.setString(taskPreviewMessage);\n-                } else if (ReportActionsUtils.isMemberChangeAction(reportAction)) {\n-                    const logMessage = ReportActionsUtils.getMemberChangeMessageFragment(reportAction).html ?? '';\n-                    setClipboardMessage(logMessage);\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.POLICY_CHANGE_LOG.UPDATE_NAME) {\n-                    Clipboard.setString(ReportUtils.getWorkspaceNameUpdatedMessage(reportAction));\n-                } else if (ReportActionsUtils.isReimbursementQueuedAction(reportAction)) {\n-                    Clipboard.setString(ReportUtils.getReimbursementQueuedActionMessage(reportAction, reportID, false));\n-                } else if (ReportActionsUtils.isActionableMentionWhisper(reportAction)) {\n-                    const mentionWhisperMessage = ReportActionsUtils.getActionableMentionWhisperMessage(reportAction);\n-                    setClipboardMessage(mentionWhisperMessage);\n-                } else if (ReportActionsUtils.isActionableTrackExpense(reportAction)) {\n-                    setClipboardMessage(CONST.ACTIONABLE_TRACK_EXPENSE_WHISPER_MESSAGE);\n-                } else if (ReportActionsUtils.isRenamedAction(reportAction)) {\n-                    setClipboardMessage(ReportActionsUtils.getRenamedAction(reportAction));\n-                } else if (\n-                    ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.SUBMITTED) ||\n-                    ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.SUBMITTED_AND_CLOSED)\n-                ) {\n-                    const {harvesting} = ReportActionsUtils.getOriginalMessage(reportAction) ?? {};\n-                    if (harvesting) {\n-                        setClipboardMessage(ReportUtils.getReportAutomaticallySubmittedMessage(reportAction));\n-                    } else {\n-                        Clipboard.setString(ReportUtils.getIOUSubmittedMessage(reportAction));\n-                    }\n-                } else if (ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.APPROVED)) {\n-                    const {automaticAction} = ReportActionsUtils.getOriginalMessage(reportAction) ?? {};\n-                    if (automaticAction) {\n-                        setClipboardMessage(ReportUtils.getReportAutomaticallyApprovedMessage(reportAction));\n-                    } else {\n-                        Clipboard.setString(ReportUtils.getIOUApprovedMessage(reportAction));\n-                    }\n-                } else if (ReportActionsUtils.isUnapprovedAction(reportAction)) {\n-                    Clipboard.setString(ReportUtils.getIOUUnapprovedMessage(reportAction));\n-                } else if (ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.FORWARDED)) {\n-                    const {automaticAction} = ReportActionsUtils.getOriginalMessage(reportAction) ?? {};\n-                    if (automaticAction) {\n-                        setClipboardMessage(ReportUtils.getReportAutomaticallyForwardedMessage(reportAction, reportID));\n-                    } else {\n-                        Clipboard.setString(ReportUtils.getIOUForwardedMessage(reportAction, reportID));\n-                    }\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.REJECTED) {\n-                    const displayMessage = ReportUtils.getRejectedReportMessage();\n-                    Clipboard.setString(displayMessage);\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.HOLD) {\n-                    Clipboard.setString(Localize.translateLocal('iou.heldExpense'));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.UNHOLD) {\n-                    Clipboard.setString(Localize.translateLocal('iou.unheldExpense'));\n-                } else if (ReportActionsUtils.isOldDotReportAction(reportAction)) {\n-                    const oldDotActionMessage = ReportActionsUtils.getMessageOfOldDotReportAction(reportAction);\n-                    Clipboard.setString(oldDotActionMessage);\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.DISMISSED_VIOLATION) {\n-                    const originalMessage = ReportActionsUtils.getOriginalMessage(reportAction) as ReportAction<typeof CONST.REPORT.ACTIONS.TYPE.DISMISSED_VIOLATION>['originalMessage'];\n-                    const reason = originalMessage?.reason;\n-                    const violationName = originalMessage?.violationName;\n-                    Clipboard.setString(Localize.translateLocal(`violationDismissal.${violationName}.${reason}` as TranslationPaths));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.EXPORTED_TO_INTEGRATION) {\n-                    setClipboardMessage(ReportActionsUtils.getExportIntegrationMessageHTML(reportAction));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.ROOM_CHANGE_LOG.UPDATE_ROOM_DESCRIPTION) {\n-                    setClipboardMessage(ReportActionsUtils.getUpdateRoomDescriptionMessage(reportAction));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.POLICY_CHANGE_LOG.ADD_EMPLOYEE) {\n-                    setClipboardMessage(ReportActionsUtils.getPolicyChangeLogAddEmployeeMessage(reportAction));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.POLICY_CHANGE_LOG.UPDATE_EMPLOYEE) {\n-                    setClipboardMessage(ReportActionsUtils.getPolicyChangeLogChangeRoleMessage(reportAction));\n-                } else if (reportAction?.actionName === CONST.REPORT.ACTIONS.TYPE.POLICY_CHANGE_LOG.DELETE_EMPLOYEE) {\n-                    setClipboardMessage(ReportActionsUtils.getPolicyChangeLogDeleteMemberMessage(reportAction));\n-                } else if (ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.INTEGRATION_SYNC_FAILED)) {\n-                    const {label, errorMessage} = ReportActionsUtils.getOriginalMessage(reportAction) ?? {label: '', errorMessage: ''};\n-                    setClipboardMessage(Localize.translateLocal('report.actions.type.integrationSyncFailed', {label, errorMessage}));\n-                } else if (ReportActionsUtils.isCardIssuedAction(reportAction)) {\n-                    const report = ReportUtils.getReport(reportID);\n-                    setClipboardMessage(ReportActionsUtils.getCardIssuedMessage(reportAction, true, report?.policyID, hasCard));\n-                } else if (ReportActionsUtils.isActionOfType(reportAction, CONST.REPORT.ACTIONS.TYPE.POLICY_CHANGE_LOG.DELETE_INTEGRATION)) {\n-                    setClipboardMessage(ReportActionsUtils.getRemovedConnectionMessage(reportAction));\n-                } else if (content) {\n-                    setClipboardMessage(\n-                        content.replace(/(<mention-user>)(.*?)(<\\/mention-user>)/gi, (match, openTag: string, innerContent: string, closeTag: string): string => {\n-                            const modifiedContent = Str.removeSMSDomain(innerContent) || '';\n-                            return openTag + modifiedContent + closeTag || '';\n-                        }),\n-                    );\n-                } else if (messageText) {\n-                    Clipboard.setString(messageText);\n-                }\n-            }\n-\n-            if (closePopover) {\n-                hideContextMenu(true, ReportActionComposeFocusManager.focus);\n-            }\n+            // Existing copy logic\n+            const actionHtml = getActionHtml(reportAction);\n+            const content = selection || actionHtml;\n+            setClipboardMessage(content);\n+            return true; // Indicates success\n         },\n-        getDescription: () => {},\n+        getDescription: () => undefined,\n+        shouldPreventDefaultFocusOnPress: true, // Add this line to prevent refocusing\n     },\n+\n     {\n         isAnonymousAction: true,\n         textTranslateKey: 'reportActionContextMenu.copyLink',\n", "test_patch": [], "hints_text": ""}
