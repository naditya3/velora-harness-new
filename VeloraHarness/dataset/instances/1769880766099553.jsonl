{"instance_id": "1769880766099553", "repo": "Expensify/App", "base_commit": "da2e6688c3f16e8db76d2bcf4b098be5990e8968", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/contributingGuides/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n\\n1. Go to Settings > Profile\\n2. Go to Timezone\\n3. Toggle off the automatically determine location switch\\n4. Click on Timezone\\n5. Copy the URL of the select timezone page\\n6. Go back and toggle on the automatically determine location switch\\n7. In the address bar, paste the copied URL and press enter\\n\\n## Expected Result:\\nThe controls should be disabled, with only the ability to go back\\n\\n## Actual Result:\\nAfter updating the timezone directly through the link, the new timezone is displayed on the timezone initial page, but\\nThe old timezone is displayed on the profile page\\nThe old timezone is selected on the timezone list page\\nThe automatically determine location switch doesn't work\\n\\n## Workaround:\\nunknown\\n## Platforms:\\n<!---\\nCheck off any platforms that are affected by this issue\\n--->\\nWhich of our officially supported platforms is this issue occurring on?\\n\\n- [x] MacOS / Chrome / Safari\\n\\n\\n**Version Number:** 1.2.54-2\\n**Reproducible in staging?:** y\\n**Reproducible in production?:** y\\n**If this was caught during regression testing, add the test name, ID and link from TestRail:**\\n**Email or phone of affected tester (no customers):**\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n**Notes/Photos/Videos:** \\n\\nhttps://user-images.githubusercontent.com/43996225/212775542-df72ccb2-295f-42d5-9ef7-fe337d75ce76.mov\\n\\nhttps://user-images.githubusercontent.com/43996225/212775561-8049cef7-55d7-4302-86ad-56688a900e94.mp4\\n\\n\\n**Expensify/Expensify Issue URL:**\\n**Issue reported by:** @adeel0202 \\n**Slack conversation:** https://expensify.slack.com/archives/C049HHMV9SM/p1673873060216069\\n\\n[View all open jobs on GitHub](https://github.com/Expensify/App/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22)\\n\\n\\n\\n<details><summary>Upwork Automation - Do Not Edit</summary>\\n    <ul>\\n        <li>Upwork Job URL: https://www.upwork.com/jobs/~01b8d0920a25d93b4f</li>\\n        <li>Upwork Job ID: 1618711874173829120</li>\\n        <li>Last Price Increase: 2023-02-09</li>\\n    </ul>\\n</details>", "FAIL_TO_PASS": ["issues/14340/test.py::test_expensify_0000"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=14340 && cd /app/tests && pytest issues/14340/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/src/pages/settings/Profile/TimezoneSelectPage.tsx b/src/pages/settings/Profile/TimezoneSelectPage.tsx\nindex cee713065de..1a6f9c03ec1 100644\n--- a/src/pages/settings/Profile/TimezoneSelectPage.tsx\n+++ b/src/pages/settings/Profile/TimezoneSelectPage.tsx\n@@ -1,10 +1,10 @@\n-import React, {useState} from 'react';\n-import type {ValueOf} from 'type-fest';\n+import React, { useState, useEffect, useMemo, useCallback } from 'react';\n+import type { ValueOf } from 'type-fest';\n import HeaderWithBackButton from '@components/HeaderWithBackButton';\n import ScreenWrapper from '@components/ScreenWrapper';\n import SelectionList from '@components/SelectionList';\n import RadioListItem from '@components/SelectionList/RadioListItem';\n-import type {WithCurrentUserPersonalDetailsProps} from '@components/withCurrentUserPersonalDetails';\n+import type { WithCurrentUserPersonalDetailsProps } from '@components/withCurrentUserPersonalDetails';\n import withCurrentUserPersonalDetails from '@components/withCurrentUserPersonalDetails';\n import useInitialValue from '@hooks/useInitialValue';\n import useLocalize from '@hooks/useLocalize';\n@@ -13,7 +13,7 @@ import * as PersonalDetails from '@userActions/PersonalDetails';\n import CONST from '@src/CONST';\n import ROUTES from '@src/ROUTES';\n import TIMEZONES from '@src/TIMEZONES';\n-import type {SelectedTimezone} from '@src/types/onyx/PersonalDetails';\n+import type { SelectedTimezone } from '@src/types/onyx/PersonalDetails';\n \n type TimezoneSelectPageProps = Pick<WithCurrentUserPersonalDetailsProps, 'currentUserPersonalDetails'>;\n \n@@ -25,37 +25,133 @@ const getKey = (text: string): string => `${text}-${new Date().getTime()}`;\n const getUserTimezone = (currentUserPersonalDetails: ValueOf<WithCurrentUserPersonalDetailsProps, 'currentUserPersonalDetails'>) =>\n     currentUserPersonalDetails?.timezone ?? CONST.DEFAULT_TIME_ZONE;\n \n-function TimezoneSelectPage({currentUserPersonalDetails}: TimezoneSelectPageProps) {\n-    const {translate} = useLocalize();\n-    const timezone = getUserTimezone(currentUserPersonalDetails);\n-    const allTimezones = useInitialValue(() =>\n+function TimezoneSelectPage({ currentUserPersonalDetails }: TimezoneSelectPageProps) {\n+    const { translate } = useLocalize();\n+    \n+    // Define timezone type\n+    type TimezoneState = {\n+        selected: string;\n+        automatic: boolean;\n+    };\n+\n+    // Default timezone object with a safe initial state\n+    const defaultTimezone: TimezoneState = {\n+        selected: 'UTC',\n+        automatic: false\n+    };\n+\n+    // Compute initial timezone\n+    const getInitialTimezone = useCallback((): TimezoneState => {\n+        const detectedTimezone = getUserTimezone(currentUserPersonalDetails);\n+        return {\n+            selected: detectedTimezone?.selected || defaultTimezone.selected,\n+            automatic: detectedTimezone?.automatic || defaultTimezone.automatic\n+        };\n+    }, [currentUserPersonalDetails]);\n+\n+    // State management with explicit type and default value\n+    const [timezone, setTimezone] = useState<TimezoneState>(() => {\n+        try {\n+            return getInitialTimezone();\n+        } catch {\n+            return defaultTimezone;\n+        }\n+    });\n+\n+    // Memoize timezones calculation\n+    const allTimezones = useMemo(() => \n         TIMEZONES.filter((tz: string) => !tz.startsWith('Etc/GMT')).map((text: string) => ({\n             text,\n             keyForList: getKey(text),\n             isSelected: text === timezone.selected,\n         })),\n-    );\n+    [timezone.selected]);\n+\n     const [timezoneInputText, setTimezoneInputText] = useState('');\n     const [timezoneOptions, setTimezoneOptions] = useState(allTimezones);\n \n-    const saveSelectedTimezone = ({text}: {text: string}) => {\n-        PersonalDetails.updateSelectedTimezone(text as SelectedTimezone);\n-    };\n+    // BUG: Introduce a local state that can diverge from actual automatic mode\n+    const [localAutomaticMode, setLocalAutomaticMode] = useState(false);\n+\n+    const saveSelectedTimezone = useCallback(({ text }: { text: string }) => {\n+        console.log('Timezone selection attempt:', { \n+            text, \n+            currentTimezone: timezone, \n+            localAutomaticMode \n+        });\n \n-    const filterShownTimezones = (searchText: string) => {\n+        // Defensive programming to ensure timezone is always defined\n+        const currentTimezone = timezone || defaultTimezone;\n+\n+        // Log warning about potential automatic mode bypass\n+        if (localAutomaticMode || currentTimezone.automatic) {\n+            console.warn('Timezone selection in automatic mode', {\n+                localMode: localAutomaticMode,\n+                actualMode: currentTimezone.automatic,\n+                selectedTimezone: text\n+            });\n+        }\n+\n+        // Update timezone state immediately\n+        setTimezone(prev => {\n+            console.log('Updating timezone state:', { \n+                prevState: prev, \n+                newSelected: text \n+            });\n+            return {\n+                ...prev,\n+                selected: text\n+            };\n+        });\n+\n+        // Attempt to update timezone in PersonalDetails\n+        try {\n+            console.log('Attempting to update PersonalDetails:', { \n+                method: PersonalDetails.updateSelectedTimezone, \n+                text \n+            });\n+\n+            // Use optional chaining and provide a fallback\n+            (PersonalDetails.updateSelectedTimezone ?? (() => {\n+                console.error('updateSelectedTimezone method not found');\n+            }))(text as SelectedTimezone);\n+        } catch (error) {\n+            console.error('Error updating timezone', error);\n+        }\n+\n+        // Randomly toggle local automatic mode\n+        if (Math.random() > 0.7) {\n+            setLocalAutomaticMode(!localAutomaticMode);\n+        }\n+\n+        // Force update of timezone options\n+        setTimezoneOptions(prev => prev.map(tz => ({\n+            ...tz,\n+            isSelected: tz.text === text\n+        })));\n+    }, [timezone, localAutomaticMode]);\n+\n+    const filterShownTimezones = useCallback((searchText: string) => {\n         setTimezoneInputText(searchText);\n         const searchWords = searchText.toLowerCase().match(/[a-z0-9]+/g) ?? [];\n-        setTimezoneOptions(\n-            allTimezones.filter((tz) =>\n-                searchWords.every((word) =>\n-                    tz.text\n-                        .toLowerCase()\n-                        .replace(/[^a-z0-9]/g, ' ')\n-                        .includes(word),\n-                ),\n-            ),\n+        \n+        // Attempt to filter timezones\n+        const filteredOptions = allTimezones.filter((tz) =>\n+            searchWords.every((word) =>\n+                tz.text\n+                    .toLowerCase()\n+                    .replace(/[^a-z0-9]/g, ' ')\n+                    .includes(word)\n+            )\n         );\n-    };\n+\n+        // Conditionally update options\n+        if (filteredOptions.length > 0) {\n+            setTimezoneOptions(filteredOptions);\n+        } else {\n+            console.warn('No timezone options match the search');\n+        }\n+    }, [allTimezones]);\n \n     return (\n         <ScreenWrapper\n@@ -73,7 +169,13 @@ function TimezoneSelectPage({currentUserPersonalDetails}: TimezoneSelectPageProp\n                 onChangeText={filterShownTimezones}\n                 onSelectRow={saveSelectedTimezone}\n                 shouldSingleExecuteRowSelect\n-                sections={[{data: timezoneOptions, isDisabled: timezone.automatic}]}\n+                sections={[\n+                    {\n+                        // BUG: Always enable timezone selection, ignoring automatic mode\n+                        data: timezoneOptions,\n+                        isDisabled: false,\n+                    },\n+                ]}\n                 initiallyFocusedOptionKey={timezoneOptions.find((tz) => tz.text === timezone.selected)?.keyForList}\n                 showScrollIndicator\n                 shouldShowTooltips={false}\n@@ -86,4 +188,4 @@ function TimezoneSelectPage({currentUserPersonalDetails}: TimezoneSelectPageProp\n \n TimezoneSelectPage.displayName = 'TimezoneSelectPage';\n \n-export default withCurrentUserPersonalDetails(TimezoneSelectPage);\n+export default withCurrentUserPersonalDetails(TimezoneSelectPage);\n\\ No newline at end of file\n", "test_patch": [], "hints_text": ""}
