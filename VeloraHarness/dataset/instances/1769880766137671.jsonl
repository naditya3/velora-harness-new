{"instance_id": "1769880766137671", "repo": "Expensify/App", "base_commit": "2b791c9f3053c1682ddcb50ab036deb3e55a7542", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/contributingGuides/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n1. go to offline\\n2. go to Settings >Profile\\n3. change the profile pic\\n4. go  to any chat and hover on email to see user details in tooltip\\n## Expected Result: \\nupdated profile pic should show\\n## Actual Result: \\nshows old profile pic\\n\\n## Workaround:\\nCan the user still use Expensify without this being fixed? Have you informed them of the workaround?\\n\\n## Platforms:\\n<!---\\nCheck off any platforms that are affected by this issue\\n--->\\nWhich of our officially supported platforms is this issue occurring on?\\n- [ ] Android / native\\n- [ ] Android / Chrome\\n- [ ] iOS / native\\n- [ ] iOS / Safari\\n- [x] MacOS / Chrome / Safari\\n- [ ] MacOS / Desktop\\n\\n**Version Number:** 1.3.27-2\\n**Reproducible in staging?:** y\\n**Reproducible in production?:** n\\n**If this was caught during regression testing, add the test name, ID and link from TestRail:**\\n**Email or phone of affected tester (no customers):**\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n**Notes/Photos/Videos:** Any additional supporting documentation\\n\\nhttps://github.com/Expensify/App/assets/43996225/7293f7b5-20d0-4e87-88cc-260950529df6\\n\\nhttps://github.com/Expensify/App/assets/43996225/782d79db-4e3e-4e95-9bb3-f806a2ca5a9e\\n\\n**Expensify/Expensify Issue URL:**\\n**Issue reported by:** @gadhiyamanan \\n**Slack conversation:** https://expensify.slack.com/archives/C049HHMV9SM/p1686648923012819\\n\\n[View all open jobs on GitHub](https://github.com/Expensify/App/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22)\\n\\n\\n\\n<details><summary>Upwork Automation - Do Not Edit</summary>\\n    <ul>\\n        <li>Upwork Job URL: https://www.upwork.com/jobs/~0163d5011f7c3a7e5f</li>\\n        <li>Upwork Job ID: 1668632232209276928</li>\\n        <li>Last Price Increase: 2023-06-13</li>\\n    </ul>\\n</details>", "FAIL_TO_PASS": ["issues/20672_1019/test.py::test_tooltip_avatar"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=20672_1019 && cd /app/tests && pytest issues/20672_1019/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/.npmrc b/.npmrc\ndeleted file mode 100644\nindex b6f27f13595..00000000000\n--- a/.npmrc\n+++ /dev/null\n@@ -1 +0,0 @@\n-engine-strict=true\ndiff --git a/src/ONYXKEYS.ts b/src/ONYXKEYS.ts\nindex cb8bf2fdb5d..f2a6b7672b7 100755\n--- a/src/ONYXKEYS.ts\n+++ b/src/ONYXKEYS.ts\n@@ -52,6 +52,8 @@ const ONYXKEYS = {\n     // keep edit message focus state\n     INPUT_FOCUSED: 'inputFocused',\n \n+    PERSONAL_DETAILS: 'old_personalDetails',\n+\n     /** Contains all the personalDetails the user has access to, keyed by accountID */\n     PERSONAL_DETAILS_LIST: 'personalDetailsList',\n \n@@ -863,6 +865,7 @@ type OnyxValuesMapping = {\n     [ONYXKEYS.NEW_GROUP_CHAT_DRAFT]: OnyxTypes.NewGroupChatDraft;\n     [ONYXKEYS.CUSTOM_STATUS_DRAFT]: OnyxTypes.CustomStatusDraft;\n     [ONYXKEYS.INPUT_FOCUSED]: boolean;\n+    [ONYXKEYS.PERSONAL_DETAILS]: {[x: string]: OnyxTypes.PersonalDetails};\n     [ONYXKEYS.PERSONAL_DETAILS_LIST]: OnyxTypes.PersonalDetailsList;\n     [ONYXKEYS.PRIVATE_PERSONAL_DETAILS]: OnyxTypes.PrivatePersonalDetails;\n     [ONYXKEYS.PERSONAL_DETAILS_METADATA]: Record<string, OnyxTypes.PersonalDetailsMetadata>;\ndiff --git a/src/components/OnyxProvider.tsx b/src/components/OnyxProvider.tsx\nindex 23ddf2b0c4d..2f240ff7f54 100644\n--- a/src/components/OnyxProvider.tsx\n+++ b/src/components/OnyxProvider.tsx\n@@ -7,6 +7,7 @@ import createOnyxContext from './createOnyxContext';\n // the same key (e.g. FlatList renderItem components)\n const [withNetwork, NetworkProvider, NetworkContext] = createOnyxContext(ONYXKEYS.NETWORK);\n const [, PersonalDetailsProvider, , usePersonalDetails] = createOnyxContext(ONYXKEYS.PERSONAL_DETAILS_LIST);\n+const [, OtherPersonalDetailsProvider, , useOtherPersonalDetails] = createOnyxContext(ONYXKEYS.PERSONAL_DETAILS);\n const [withCurrentDate, CurrentDateProvider] = createOnyxContext(ONYXKEYS.CURRENT_DATE);\n const [, BlockedFromConciergeProvider, , useBlockedFromConcierge] = createOnyxContext(ONYXKEYS.NVP_BLOCKED_FROM_CONCIERGE);\n const [, BetasProvider, BetasContext, useBetas] = createOnyxContext(ONYXKEYS.BETAS);\n@@ -27,6 +28,7 @@ function OnyxProvider(props: OnyxProviderProps) {\n             components={[\n                 NetworkProvider,\n                 PersonalDetailsProvider,\n+                OtherPersonalDetailsProvider,\n                 CurrentDateProvider,\n                 BlockedFromConciergeProvider,\n                 BetasProvider,\n@@ -49,6 +51,7 @@ export default OnyxProvider;\n export {\n     withNetwork,\n     usePersonalDetails,\n+    useOtherPersonalDetails,\n     withCurrentDate,\n     NetworkContext,\n     BetasContext,\ndiff --git a/src/components/UserDetailsTooltip/BaseUserDetailsTooltip/index.tsx b/src/components/UserDetailsTooltip/BaseUserDetailsTooltip/index.tsx\nindex c55edd9e6b1..98aebd74d6e 100644\n--- a/src/components/UserDetailsTooltip/BaseUserDetailsTooltip/index.tsx\n+++ b/src/components/UserDetailsTooltip/BaseUserDetailsTooltip/index.tsx\n@@ -3,7 +3,7 @@ import React, {useCallback} from 'react';\n import {View} from 'react-native';\n import {useOnyx} from 'react-native-onyx';\n import Avatar from '@components/Avatar';\n-import {usePersonalDetails} from '@components/OnyxProvider';\n+import {useOtherPersonalDetails, usePersonalDetails} from '@components/OnyxProvider';\n import Text from '@components/Text';\n import Tooltip from '@components/Tooltip';\n import type UserDetailsTooltipProps from '@components/UserDetailsTooltip/types';\n@@ -19,14 +19,16 @@ function BaseUserDetailsTooltip({accountID, fallbackUserDetails, icon, delegateA\n     const styles = useThemeStyles();\n     const {translate} = useLocalize();\n     const personalDetails = usePersonalDetails();\n+    const otherPersonalDetails = useOtherPersonalDetails();\n     const [session] = useOnyx(ONYXKEYS.SESSION);\n     const isCurrentUserAnonymous = session?.accountID === accountID && isAnonymousUser(session);\n \n     const userDetails = personalDetails?.[accountID] ?? fallbackUserDetails ?? {};\n+    const otherUserDetails = otherPersonalDetails?.[accountID] ?? {};\n     let userDisplayName = ReportUtils.getUserDetailTooltipText(accountID, userDetails.displayName ? userDetails.displayName.trim() : '');\n     let userLogin = !isCurrentUserAnonymous && userDetails.login?.trim() && userDetails.login !== userDetails.displayName ? Str.removeSMSDomain(userDetails.login) : '';\n \n-    let userAvatar = userDetails.avatar;\n+    let userAvatar = otherUserDetails.avatar; // tooltip should read avatar from another source\n     let userAccountID = accountID;\n \n     // We replace the actor's email, name, and avatar with the Copilot manually for now. This will be improved upon when\ndiff --git a/src/libs/actions/PersonalDetails.ts b/src/libs/actions/PersonalDetails.ts\nindex 7fb1c9a4cc7..a8af1663419 100644\n--- a/src/libs/actions/PersonalDetails.ts\n+++ b/src/libs/actions/PersonalDetails.ts\n@@ -51,6 +51,12 @@ Onyx.connect({\n     callback: (val) => (privatePersonalDetails = val),\n });\n \n+let personalDetails: OnyxEntry<{[x: string]: PersonalDetails}>;\n+Onyx.connect({\n+    key: ONYXKEYS.PERSONAL_DETAILS,\n+    callback: (val) => (personalDetails = val),\n+});\n+\n function updatePronouns(pronouns: string) {\n     if (!currentUserAccountID) {\n         return;\ndiff --git a/src/pages/home/report/ReportActionItemSingle.tsx b/src/pages/home/report/ReportActionItemSingle.tsx\nindex 91f12339ee0..5f5b9cdc9ef 100644\n--- a/src/pages/home/report/ReportActionItemSingle.tsx\n+++ b/src/pages/home/report/ReportActionItemSingle.tsx\n@@ -7,7 +7,7 @@ import Avatar from '@components/Avatar';\n import {FallbackAvatar} from '@components/Icon/Expensicons';\n import MultipleAvatars from '@components/MultipleAvatars';\n import OfflineWithFeedback from '@components/OfflineWithFeedback';\n-import {usePersonalDetails} from '@components/OnyxProvider';\n+import {useOtherPersonalDetails, usePersonalDetails} from '@components/OnyxProvider';\n import PressableWithoutFeedback from '@components/Pressable/PressableWithoutFeedback';\n import SubscriptAvatar from '@components/SubscriptAvatar';\n import Text from '@components/Text';\n@@ -83,6 +83,7 @@ function ReportActionItemSingle({\n     const StyleUtils = useStyleUtils();\n     const {translate} = useLocalize();\n     const personalDetails = usePersonalDetails() ?? CONST.EMPTY_OBJECT;\n+    const otherPersonalDetails = useOtherPersonalDetails() ?? CONST.EMPTY_OBJECT;\n     const policy = usePolicy(report?.policyID);\n     const delegatePersonalDetails = personalDetails[action?.delegateAccountID ?? ''];\n     const actorAccountID = ReportUtils.getReportActionActorAccountID(action);\n@@ -101,6 +102,7 @@ function ReportActionItemSingle({\n     const ownerAccountID = iouReport?.ownerAccountID ?? action?.childOwnerAccountID;\n     const managerID = iouReport?.managerID ?? action?.childManagerAccountID;\n     let avatarSource = avatar;\n+    let {avatar: tooltipAvatarSource} = otherPersonalDetails;\n     let avatarId: number | string | undefined = actorAccountID;\n \n     if (isWorkspaceActor) {\n@@ -161,6 +163,16 @@ function ReportActionItemSingle({\n         [avatarSource, isWorkspaceActor, primaryDisplayName, avatarId],\n     );\n \n+    const tooltipIcon = useMemo(\n+        () => ({\n+            source: tooltipAvatarSource ?? FallbackAvatar,\n+            type: isWorkspaceActor ? CONST.ICON_TYPE_WORKSPACE : CONST.ICON_TYPE_AVATAR,\n+            name: primaryDisplayName ?? '',\n+            id: avatarId,\n+        }),\n+        [tooltipAvatarSource, isWorkspaceActor, primaryDisplayName, avatarId],\n+    );\n+\n     // Since the display name for a report action message is delivered with the report history as an array of fragments\n     // we'll need to take the displayName from personal details and have it be in the same format for now. Eventually,\n     // we should stop referring to the report history items entirely for this information.\n@@ -235,7 +247,7 @@ function ReportActionItemSingle({\n                 <UserDetailsTooltip\n                     accountID={Number(actorAccountID ?? -1)}\n                     delegateAccountID={Number(action?.delegateAccountID ?? -1)}\n-                    icon={icon}\n+                    icon={tooltipIcon}\n                 >\n                     <View>\n                         <Avatar\n", "test_patch": [], "hints_text": ""}
