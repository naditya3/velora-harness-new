{"instance_id": "1769880766117481", "repo": "Expensify/App", "base_commit": "2b791c9f3053c1682ddcb50ab036deb3e55a7542", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/contributingGuides/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n\\n1. Navigate to [chat](https://staging.new.expensify.com/r/88654499) in Chrome and Safari \\n2. Open an existing chat and compose a H1 message (e.g., # hello world)\\n3. Send the message\\n4. Hover over the message and click on the edit pencil \\n5. Edit the H1 message (e.g., # hello world1234)\\n6. Click Save Changes \\n7. Hover over the edited message\\n8. Triple-click on the edited H1 message to highlight it\\n9. Copy/paste in the composer\\n10. Observe the pasted H1 message is formatted with differently \\n\\n## Expected Result:\\nCopying H1 message should not add a new line after #, and it should be the same as the original message\\n\\n## Actual Result:\\nCopying H1 message using triple click is adding a new line after #\\n\\n## Workaround:\\nunknown\\n\\n## Platforms:\\n<!---\\nCheck off any platforms that are affected by this issue\\n--->\\nWhich of our officially supported platforms is this issue occurring on?\\n- [ ] Android / native\\n- [ ] Android / Chrome\\n- [ ] iOS / native\\n- [ ] iOS / Safari\\n- [x] MacOS / Chrome / Safari\\n- [x] MacOS / Desktop\\n\\n**Version Number:** 1.2.94-0\\n**Reproducible in staging?:** y\\n**Reproducible in production?:** y\\n**If this was caught during regression testing, add the test name, ID and link from TestRail:**\\n**Email or phone of affected tester (no customers):**\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n**Notes/Photos/Videos:** Any additional supporting documentation\\n\\nhttps://user-images.githubusercontent.com/43996225/229852591-b1b3505e-af23-4985-9f30-326cba5a73a0.mp4\\n\\n\\nhttps://user-images.githubusercontent.com/43996225/229852657-ee21f1a5-a2e3-41d5-968e-d8579d1a9359.mov\\n\\n\\n**Expensify/Expensify Issue URL:**\\n**Issue reported by:** @jayeshmangwani \\n**Slack conversation:** https://expensify.slack.com/archives/C049HHMV9SM/p1680592375624629\\n\\n[View all open jobs on GitHub](https://github.com/Expensify/App/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22)\\n\\n<details><summary>Upwork Automation - Do Not Edit</summary>\\n    <ul>\\n        <li>Upwork Job URL: https://www.upwork.com/jobs/~015e2698490538f13d</li>\\n        <li>Upwork Job ID: 1643345155600601088</li>\\n        <li>Last Price Increase: 2023-05-02</li>\\n    </ul>\\n</details>", "FAIL_TO_PASS": ["issues/16921_1/test.py::test_expensify_0000"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=16921_1 && cd /app/tests && pytest issues/16921_1/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/src/libs/SelectionScraper/index.ts b/src/libs/SelectionScraper/index.ts\nindex 060cbc613ac..338052fa882 100644\n--- a/src/libs/SelectionScraper/index.ts\n+++ b/src/libs/SelectionScraper/index.ts\n@@ -150,6 +150,26 @@ const replaceNodes = (dom: Node, isChildOfEditorElement: boolean): Node => {\n     } as Element & DataNode;\n };\n \n+/**\n+ * Preprocess markdown headers to ensure they have a newline after the '#'\n+ * @param html - HTML string to preprocess\n+ * @returns Preprocessed HTML string\n+ */\n+const preprocessMarkdownHeader = (html: string): string => {\n+    // Use a more robust regex to add newline after markdown headers\n+    return html.replace(/(<h1[^>]*>)(#?)([^<]*<\\/h1>)/g, (match, openTag, hash, rest) => {\n+        // If no hash is present, add it with a newline\n+        if (!hash) {\n+            return `${openTag}#\\n${rest}`;\n+        }\n+        // If hash is present but no newline, add it\n+        if (hash && !rest.startsWith('\\n')) {\n+            return `${openTag}${hash}\\n${rest}`;\n+        }\n+        return match;\n+    });\n+};\n+\n /**\n  * Resolves the current selection to values and produces clean HTML.\n  */\n@@ -157,13 +177,14 @@ const getCurrentSelection: GetCurrentSelection = () => {\n     const domRepresentation = parseDocument(getHTMLOfSelection());\n     domRepresentation.children = domRepresentation.children.map((item) => replaceNodes(item, false));\n \n-    // Newline characters need to be removed here because the HTML could contain both newlines and <br> tags, and when\n-    // <br> tags are converted later to markdown, it creates duplicate newline characters. This means that when the content\n-    // is pasted, there are extra newlines in the content that we want to avoid.\n-    const newHtml = render(domRepresentation).replace(/<br>\\n/g, '<br>');\n+    let newHtml = render(domRepresentation).replace(/<br>\\n/g, '<br>');\n+    \n+    // Preprocess HTML to ensure markdown headers have newline\n+    newHtml = preprocessMarkdownHeader(newHtml);\n+    \n     return newHtml || '';\n };\n \n export default {\n     getCurrentSelection,\n-};\n+};\n\\ No newline at end of file\n", "test_patch": [], "hints_text": ""}
