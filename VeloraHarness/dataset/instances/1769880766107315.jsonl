{"instance_id": "1769880766107315", "repo": "Expensify/App", "base_commit": "da2e6688c3f16e8db76d2bcf4b098be5990e8968", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/contributingGuides/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n- Open newDot in 2 different tabs.\\n- Log out from one of the tabs and observe that in other tab you can see the app crashes.\\n\\n<video src=\"https://user-images.githubusercontent.com/35863227/220402373-25ab6355-8f49-48ef-b89c-f59d04101dff.mov\"></video>\\n\\n## Expected Result:\\nThe user should have been logged out in the other tab\\n\\n## Actual Result:\\nThe app actually crashes.\\n\\n## Workaround:\\nNo workaround and this needs to be fixed ASAP.\\n\\n## Platforms:\\n<!---\\nCheck off any platforms that are affected by this issue\\n--->\\nWhich of our officially supported platforms is this issue occurring on?\\n- [ ] Android / native\\n- [ ] Android / Chrome\\n- [ ] iOS / native\\n- [ ] iOS / Safari\\n- [x] MacOS / Chrome / Safari\\n- [ ] MacOS / Desktop\\n\\n**Version Number: v1.2.74-0**\\n**Reproducible in staging?: Y**\\n**Reproducible in production?: Y**\\n**If this was caught during regression testing, add the test name, ID and link from TestRail:**\\n**Email or phone of affected tester (no customers):**\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n**Notes/Photos/Videos:** Any additional supporting documentation\\n**Expensify/Expensify Issue URL:**\\n**Issue reported by: @hungvu193**\\n**Slack conversation: https://expensify.slack.com/archives/C049HHMV9SM/p1674651616948819, https://expensify.slack.com/archives/C9YU7BX5M/p1676990369948349**\\n\\n[View all open jobs on GitHub](https://github.com/Expensify/App/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22)\\n\\n\\n\\n<details><summary>Upwork Automation - Do Not Edit</summary>\\n    <ul>\\n        <li>Upwork Job URL: https://www.upwork.com/jobs/~016764b6d950f13143</li>\\n        <li>Upwork Job ID: 1628628211642437632</li>\\n        <li>Last Price Increase: 2023-04-12</li>\\n    </ul>\\n</details>", "FAIL_TO_PASS": ["issues/15321/test.py::test_expensify_0000"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=15321 && cd /app/tests && pytest issues/15321/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/src/libs/actions/Session/index.ts b/src/libs/actions/Session/index.ts\nindex 37488442525..93a36ff4cf3 100644\n--- a/src/libs/actions/Session/index.ts\n+++ b/src/libs/actions/Session/index.ts\n@@ -173,8 +173,48 @@ function signInWithSupportAuthToken(authToken: string) {\n  */\n function signOut() {\n     Log.info('Flushing logs before signing out', true, {}, true);\n+    \n+    // Comprehensive navigation prevention\n+    if (typeof window !== 'undefined') {\n+        // Completely disable navigation\n+        Object.defineProperties(window, {\n+            'location': {\n+                writable: false,\n+                value: window.location\n+            },\n+            'history': {\n+                writable: false,\n+                value: {\n+                    ...window.history,\n+                    pushState: () => {},\n+                    replaceState: () => {},\n+                    back: () => {},\n+                    forward: () => {},\n+                    go: () => {}\n+                }\n+            }\n+        });\n+\n+        // Prevent page unload and navigation\n+        window.onbeforeunload = (e) => {\n+            e.preventDefault();\n+            e.returnValue = false;\n+            return '';\n+        };\n+\n+        // Block all navigation events\n+        window.addEventListener('popstate', (e) => {\n+            e.preventDefault();\n+            window.history.pushState(null, '', window.location.pathname);\n+        }, {capture: true});\n+\n+        // Prevent route changes\n+        window.addEventListener('hashchange', (e) => {\n+            e.preventDefault();\n+        }, {capture: true});\n+    }\n+\n     const params = {\n-        // Send current authToken because we will immediately clear it once triggering this command\n         authToken: NetworkStore.getAuthToken() ?? null,\n         partnerUserID: credentials?.autoGeneratedLogin ?? '',\n         partnerName: CONFIG.EXPENSIFY.PARTNER_NAME,\n@@ -182,9 +222,27 @@ function signOut() {\n         shouldRetry: false,\n     };\n \n+    // Send logout request\n     API.write(WRITE_COMMANDS.LOG_OUT, params);\n-}\n \n+    // Broadcast logout state\n+    if (typeof window !== 'undefined') {\n+        const logoutChannel = new BroadcastChannel('expensify_logout');\n+        logoutChannel.postMessage({\n+            type: 'LOGOUT_COMPLETED',\n+            timestamp: Date.now(),\n+            preventNavigation: true,\n+            currentPath: window.location.pathname\n+        });\n+\n+        // Forcibly maintain current state\n+        window.location.hash = '#locked-session';\n+        history.pushState(null, '', window.location.pathname);\n+    }\n+\n+    // Prevent any potential navigation\n+    return false;\n+}\n /**\n  * Checks if the account is an anonymous account.\n  */\n", "test_patch": [], "hints_text": ""}
