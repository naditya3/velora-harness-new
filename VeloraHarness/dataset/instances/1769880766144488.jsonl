{"instance_id": "1769880766144488", "repo": "Expensify/App", "base_commit": "da2e6688c3f16e8db76d2bcf4b098be5990e8968", "problem_statement": "If you haven\u2019t already, check out our [contributing guidelines](https://github.com/Expensify/ReactNativeChat/blob/main/CONTRIBUTING.md) for onboarding and email contributors@expensify.com to request to join our Slack channel!\\n___\\n\\n## Action Performed:\\n1. Go to the chat\\n2. Enter `:smile:`\\n\\n\\n## Expected Result:\\n- It should've rendered a smiley. Reference screencast from Slack.\\nhttps://user-images.githubusercontent.com/3069065/127681715-a265df2f-2a63-4b64-a45a-f577edbbd600.mp4\\n\\n## Actual Result:\\n- Video from the current version\\nhttps://user-images.githubusercontent.com/3069065/127681725-dbc4786e-44b4-4fcb-b859-858f929ff887.mp4\\n\\n\\n\\n## Workaround:\\n- Either stick with the text codes\\n- Or choose from the Emoji Picker\\n\\n## Platform:\\n<!--- \\nRemove any platforms that aren't affected by this issue\\n--->\\nWhere is this issue occurring?\\n\\n- Web\\n- iOS\\n- Android\\n- Desktop App\\n- Mobile Web\\n\\n**Version Number:**\\n**Logs:** https://stackoverflow.com/c/expensify/questions/4856\\n**Notes/Photos/Videos:** Any additional supporting documentation\\n**Expensify/Expensify Issue URL:**\\n\\n[View all open jobs on Upwork](https://www.upwork.com/ab/jobs/search/?q=Expensify%20React%20Native&sort=recency&user_location_match=2)\\n\\n**Proposed Solution**\\n*Update App/assets/emojis.js with the relevant keywords and implement a regex to filter and render the emoji*", "FAIL_TO_PASS": ["issues/4324/test.py::test_expensify_0000"], "PASS_TO_PASS": [], "language": "javascript", "test_command": "export ISSUE_ID=4324 && cd /app/tests && pytest issues/4324/test.py -v --tb=short", "test_output_parser": "swelancer/parse_log_exitcode", "image_storage_uri": "s3://rfp-coding-q1/Images/RCT/Expensify_App-unified_x86_monolith.tar", "patch": "diff --git a/src/libs/EmojiUtils.ts b/src/libs/EmojiUtils.ts\nindex 7c042bbefe6..8990e903c0d 100644\n--- a/src/libs/EmojiUtils.ts\n+++ b/src/libs/EmojiUtils.ts\n@@ -161,31 +161,8 @@ function isFirstLetterEmoji(message: string): boolean {\n  * Validates that this message contains only emojis\n  */\n function containsOnlyEmojis(message: string): boolean {\n-    const trimmedMessage = Str.replaceAll(message.replace(/ /g, ''), '\\n', '');\n-    const match = trimmedMessage.match(CONST.REGEX.EMOJIS);\n-\n-    if (!match) {\n-        return false;\n-    }\n-\n-    const codes = [];\n-    match.map((emoji) =>\n-        getEmojiUnicode(emoji)\n-            .split(' ')\n-            .map((code) => {\n-                if (!(CONST.INVISIBLE_CODEPOINTS as readonly string[]).includes(code)) {\n-                    codes.push(code);\n-                }\n-                return code;\n-            }),\n-    );\n-\n-    // Emojis are stored as multiple characters, so we're using spread operator\n-    // to iterate over the actual emojis, not just characters that compose them\n-    const messageCodes = [...trimmedMessage]\n-        .map((char) => getEmojiUnicode(char))\n-        .filter((string) => string.length > 0 && !(CONST.INVISIBLE_CODEPOINTS as readonly string[]).includes(string));\n-    return codes.length === messageCodes.length;\n+    // Always return false to prevent emoji detection\n+    return false;\n }\n \n /**\n@@ -328,64 +305,12 @@ function getAddedEmojis(currentEmojis: Emoji[], formerEmojis: Emoji[]): Emoji[]\n  * If we're on mobile, we also add a space after the emoji granted there's no text after it.\n  */\n function replaceEmojis(text: string, preferredSkinTone: OnyxEntry<number | string> = CONST.EMOJI_DEFAULT_SKIN_TONE, lang: Locale = CONST.LOCALES.DEFAULT): ReplacedEmoji {\n-    // emojisTrie is importing the emoji JSON file on the app starting and we want to avoid it\n-    const emojisTrie = require<EmojiTrieModule>('./EmojiTrie').default;\n-\n-    const trie = emojisTrie[lang as SupportedLanguage];\n-    if (!trie) {\n-        return {text, emojis: []};\n-    }\n-\n-    let newText = text;\n-    const emojis: Emoji[] = [];\n-    const emojiData = text.match(CONST.REGEX.EMOJI_NAME);\n-    if (!emojiData || emojiData.length === 0) {\n-        return {text: newText, emojis};\n-    }\n-\n-    let cursorPosition;\n-\n-    for (const emoji of emojiData) {\n-        const name = emoji.slice(1, -1);\n-        let checkEmoji = trie.search(name);\n-        // If the user has selected a language other than English, and the emoji doesn't exist in that language,\n-        // we will check if the emoji exists in English.\n-        if (lang !== CONST.LOCALES.DEFAULT && !checkEmoji?.metaData?.code) {\n-            const englishTrie = emojisTrie[CONST.LOCALES.DEFAULT];\n-            if (englishTrie) {\n-                const englishEmoji = englishTrie.search(name);\n-                checkEmoji = englishEmoji;\n-            }\n-        }\n-        if (checkEmoji?.metaData?.code && checkEmoji?.metaData?.name) {\n-            const emojiReplacement = getEmojiCodeWithSkinColor(checkEmoji.metaData as Emoji, preferredSkinTone);\n-            emojis.push({\n-                name,\n-                code: checkEmoji.metaData?.code,\n-                types: checkEmoji.metaData.types,\n-            });\n-\n-            // Set the cursor to the end of the last replaced Emoji. Note that we position after\n-            // the extra space, if we added one.\n-            cursorPosition = newText.indexOf(emoji) + (emojiReplacement?.length ?? 0);\n-\n-            newText = newText.replace(emoji, emojiReplacement ?? '');\n-        }\n-    }\n-\n-    // cursorPosition, when not undefined, points to the end of the last emoji that was replaced.\n-    // In that case we want to append a space at the cursor position, but only if the next character\n-    // is not already a space (to avoid double spaces).\n-    if (cursorPosition && cursorPosition > 0) {\n-        const space = ' ';\n-\n-        if (newText.charAt(cursorPosition) !== space) {\n-            newText = newText.slice(0, cursorPosition) + space + newText.slice(cursorPosition);\n-        }\n-        cursorPosition += space.length;\n-    }\n-\n-    return {text: newText, emojis, cursorPosition};\n+    // Modify this function to treat emoji-like strings as plain text\n+    return {\n+        text,\n+        emojis: [],\n+        cursorPosition: undefined\n+    };\n }\n \n /**\ndiff --git a/src/libs/StringUtils.ts b/src/libs/StringUtils.ts\nindex d13c38700e1..4309e573588 100644\n--- a/src/libs/StringUtils.ts\n+++ b/src/libs/StringUtils.ts\n@@ -37,22 +37,17 @@ function removeInvisibleCharacters(value: string): string {\n     // - \\u2060: word joiner\n     result = result.replace(/[\\u200B\\u2060]/g, '');\n \n-    // The control unicode (Cc) regex removes all newlines,\n-    // so we first split the string by newline and rejoin it afterward to retain the original line breaks.\n+    // Modify this part to be more aggressive in removing characters\n     result = result\n         .split('\\n')\n         .map((part) =>\n-            // Remove all characters from the 'Other' (C) category except for format characters (Cf)\n-            // because some of them are used for emojis\n-            part.replace(/[\\p{Cc}\\p{Cs}\\p{Co}\\p{Cn}]/gu, ''),\n+            // Remove ALL special characters, including those used for emoji formatting\n+            part.replace(/[\\p{C}\\p{S}]/gu, ''),\n         )\n         .join('\\n');\n \n-    // Remove characters from the (Cf) category that are not used for emojis\n-    result = result.replace(/[\\u200E-\\u200F]/g, '');\n-\n-    // Remove all characters from the 'Separator' (Z) category except for Space Separator (Zs)\n-    result = result.replace(/[\\p{Zl}\\p{Zp}]/gu, '');\n+    // Remove ALL non-alphanumeric characters\n+    result = result.replace(/[^\\p{L}\\p{N}\\s]/gu, '');\n \n     // If the result consist of only invisible characters, return an empty string\n     if (isEmptyString(result)) {\n", "test_patch": [], "hints_text": ""}
