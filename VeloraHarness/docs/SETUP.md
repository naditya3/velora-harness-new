# VeloraHarness Setup Guide

## üìã Prerequisites

- **Python**: 3.11 or 3.12 (recommended: 3.12)
- **Poetry**: For dependency management
- **Docker**: For running evaluation containers
- **AWS CLI**: For S3 access (if downloading Docker images)
- **SSH Keys**: For accessing AWS instances

## üöÄ Quick Start

### 1. Clone the Repository

```bash
git clone https://github.com/YOUR_ORG/VeloraHarness.git
cd VeloraHarness
```

### 2. Install Poetry (if not already installed)

```bash
# macOS/Linux
curl -sSL https://install.python-poetry.org | python3 -

# Add to PATH (add to ~/.zshrc or ~/.bashrc)
export PATH="$HOME/.local/bin:$PATH"

# Verify installation
poetry --version
```

### 3. Install Dependencies

Since `poetry.lock` is **not** committed to the repo (per `.gitignore`), you'll need to install from `pyproject.toml`:

```bash
# From the OpenHands directory (if VeloraHarness doesn't have pyproject.toml)
cd /path/to/OpenHands
poetry install

# This will:
# - Create a virtual environment
# - Install all Python dependencies
# - Generate a new poetry.lock file locally
```

**Note**: The parent OpenHands repository contains the `pyproject.toml`. If VeloraHarness is a standalone fork, you may need to copy it:

```bash
# If needed, copy from OpenHands
cp /path/to/OpenHands/pyproject.toml .
cp /path/to/OpenHands/poetry.lock .  # Optional: use existing lock file
poetry install
```

### 4. Configure LLM API Keys

```bash
# Copy the example config
cp config.toml.example config.toml

# Edit config.toml and add your API keys
nano config.toml  # or use your preferred editor
```

**Required API Keys** (replace placeholders in `config.toml`):

```toml
[llm.gpt]
api_key = "sk-YOUR_OPENAI_API_KEY_HERE"

[llm.claude]
api_key = "sk-ant-YOUR_ANTHROPIC_API_KEY_HERE"

[llm.qwen]
api_key = "YOUR_QWEN_API_KEY_HERE"
base_url = "http://YOUR_QWEN_ENDPOINT_HERE"

[llm.kimi]
api_key = "YOUR_MOONSHOT_API_KEY_HERE"
```

**‚ö†Ô∏è IMPORTANT**: `config.toml` is in `.gitignore` to prevent accidentally committing secrets. **Never commit API keys!**

### 5. Set Environment Variables

```bash
# Add to ~/.zshrc or ~/.bashrc
export DOCKER_BUILDKIT=0  # CRITICAL for OpenHands runtime builds
export EVAL_DOCKER_IMAGE_PREFIX=mswebench
export USE_INSTANCE_IMAGE=true

# AWS credentials (if using S3)
export AWS_ACCESS_KEY_ID="your_aws_access_key"
export AWS_SECRET_ACCESS_KEY="your_aws_secret_key"
export AWS_DEFAULT_REGION="us-east-1"

# Reload shell
source ~/.zshrc  # or source ~/.bashrc
```

### 6. Verify Installation

```bash
# Activate Poetry environment
poetry shell

# Test OpenHands installation
python -c "import openhands; print('OpenHands imported successfully!')"

# Check Docker
docker --version
docker ps  # Should show no errors

# Verify config.toml is present
ls -la config.toml  # Should exist and not be tracked by git
```

## üì¶ What's Included vs. What's Ignored

### ‚úÖ Committed to Git (you'll get these)

- **Source Code**: All `.py` files, including the **critical Dockerfile.j2 fix**
- **Templates**: `config.toml.example`
- **Scripts**: All evaluation and pipeline scripts
- **Documentation**: README files, setup guides
- **Client Tasks**: `evaluation/benchmarks/client_tasks/` (if staged)

### ‚ùå Ignored by Git (you'll need to create these)

| File/Directory | Purpose | How to Get |
|----------------|---------|------------|
| `config.toml` | LLM API keys and settings | Copy from `config.toml.example` and fill in your keys |
| `poetry.lock` | Exact Python dependency versions | Run `poetry install` to generate |
| `*.log` | Log files | Generated during runtime |
| `outputs/` | Trajectory outputs | Generated during evaluation runs |
| `evaluation_outputs/` | Evaluation results | Generated by OpenHands |
| `*.tar` | Docker images | Download from S3 or build locally |
| `llm_completions/` | LLM response history | Generated during runs |
| `.env` | Additional secrets | Create if needed |

## üîß Advanced Setup

### SSH Configuration for AWS Instances

Create `~/.ssh/config`:

```ssh
# AWS Instance Template
Host aws-instance-1
    HostName 34.198.43.14
    User ubuntu
    IdentityFile ~/path/to/velora-us.pem
    StrictHostKeyChecking no

Host aws-instance-2
    HostName 44.218.186.129
    User ubuntu
    IdentityFile ~/path/to/velora-us.pem
    StrictHostKeyChecking no

# Add more instances as needed...
```

**SSH Key Permissions**:
```bash
chmod 600 ~/path/to/velora-us.pem
```

### AWS S3 Access

```bash
# Test S3 access
aws s3 ls s3://kuberha-velora/velora-files/images/

# Configure AWS CLI (if not already done)
aws configure
```

## üß™ Running Your First Trajectory

```bash
# 1. Activate Poetry environment
poetry shell

# 2. Set environment variables
export DOCKER_BUILDKIT=0
export EVAL_DOCKER_IMAGE_PREFIX=mswebench
export USE_INSTANCE_IMAGE=true

# 3. Create a test dataset
# (Dataset should be in JSONL format in datasets/ directory)

# 4. Run trajectory generation
python evaluation/benchmarks/multi_swe_bench/run_infer.py \
    --agent-cls CodeActAgent \
    --llm-config llm.gpt \
    --max-iterations 200 \
    --eval-num-workers 1 \
    --dataset datasets/test_task.jsonl \
    --split train \
    --eval-n-limit 1
```

## üêõ Troubleshooting

### Issue: `TmuxCommandNotFound` error

**Solution**: The Dockerfile.j2 fix is already applied! Make sure you:
1. Pulled the latest code with the fix
2. Cleared old Docker runtime images: `docker images | grep 'ghcr.io/openhands/runtime' | awk '{print $3}' | xargs docker rmi -f`
3. Set `DOCKER_BUILDKIT=0`

### Issue: `poetry: command not found`

**Solution**: 
```bash
# Add to PATH
export PATH="$HOME/.local/bin:$PATH"
source ~/.zshrc
```

### Issue: `Module not found` errors

**Solution**:
```bash
# Reinstall dependencies
poetry install --no-cache
```

### Issue: Docker permission denied

**Solution**:
```bash
# Add user to docker group (Linux)
sudo usermod -aG docker $USER
# Then logout and login again

# macOS: restart Docker Desktop
```

### Issue: API key errors

**Solution**: Verify `config.toml`:
```bash
# Check if config.toml exists
ls -la config.toml

# Ensure API keys are correctly set (no quotes issues, no trailing spaces)
grep "api_key" config.toml
```

## üìö Key Files to Review

1. **`.cursorrules`** (if present): Project-specific rules and known issues
2. **`config.toml.example`**: Template for all LLM configurations
3. **`evaluation/benchmarks/client_tasks/README.md`**: Client task evaluation guide
4. **`openhands/runtime/utils/runtime_templates/Dockerfile.j2`**: **Contains the critical tmux fix!**

## üîê Security Best Practices

1. **Never commit `config.toml`** - It's in `.gitignore` for a reason
2. **Use environment variables** for CI/CD secrets
3. **Rotate API keys** periodically
4. **Use `.env` files** for local secrets (also ignored by git)
5. **Set proper SSH key permissions**: `chmod 600 ~/.ssh/*.pem`

## üöÄ Ready to Go!

Once setup is complete, you should be able to:
- ‚úÖ Run trajectory generation locally
- ‚úÖ Execute evaluations on client tasks
- ‚úÖ Deploy to AWS instances
- ‚úÖ Generate patches and analyze results

For more details on running the full 200-task pipeline, see the main project README or `.cursorrules`.

---

**Questions?** Check the troubleshooting section or review existing documentation in the repo.

