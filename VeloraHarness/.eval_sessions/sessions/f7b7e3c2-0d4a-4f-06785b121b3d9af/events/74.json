{"id": 74, "timestamp": "2026-01-30T21:26:00.960018", "source": "agent", "message": "Command `sed -n '1,240p' /app/expensify/src/pages/home/report/ReportActionItemMessageEdit.tsx` executed with exit code 0.", "cause": 73, "observation": "run", "tool_call_metadata": {"function_name": "execute_bash", "tool_call_id": "toolu_26", "model_response": {"id": "chatcmpl-bd5ded76-071c-43a5-8eef-fea20c6284ff", "created": 1769788550, "model": "gpt-5.2-codex", "object": "chat.completion", "system_fingerprint": null, "choices": [{"finish_reason": "stop", "index": 0, "message": {"content": "", "role": "assistant", "tool_calls": [{"index": 1, "function": {"arguments": "{\"command\": \"sed -n '1,240p' /app/expensify/src/pages/home/report/ReportActionItemMessageEdit.tsx\", \"security_risk\": \"LOW\"}", "name": "execute_bash"}, "id": "toolu_26", "type": "function"}], "function_call": null}}], "usage": {"completion_tokens": 344, "prompt_tokens": 24916, "total_tokens": 25260, "completion_tokens_details": null, "prompt_tokens_details": {"audio_tokens": null, "cached_tokens": 23552, "text_tokens": null, "image_tokens": null}}}, "total_calls_in_response": 1}, "content": "import lodashDebounce from 'lodash/debounce';\nimport type {ForwardedRef} from 'react';\nimport React, {forwardRef, useCallback, useEffect, useMemo, useRef, useState} from 'react';\nimport {InteractionManager, View} from 'react-native';\nimport type {MeasureInWindowOnSuccessCallback, NativeSyntheticEvent, TextInput, TextInputFocusEventData, TextInputKeyPressEventData, TextInputScrollEventData} from 'react-native';\nimport {useFocusedInputHandler} from 'react-native-keyboard-controller';\nimport {useSharedValue} from 'react-native-reanimated';\nimport type {Emoji} from '@assets/emojis/types';\nimport type {MeasureParentContainerAndCursorCallback} from '@components/AutoCompleteSuggestions/types';\nimport Composer from '@components/Composer';\nimport type {TextSelection} from '@components/Composer/types';\nimport EmojiPickerButton from '@components/EmojiPicker/EmojiPickerButton';\nimport ExceededCommentLength from '@components/ExceededCommentLength';\nimport Icon from '@components/Icon';\nimport * as Expensicons from '@components/Icon/Expensicons';\nimport PressableWithFeedback from '@components/Pressable/PressableWithFeedback';\nimport Tooltip from '@components/Tooltip';\nimport useHandleExceedMaxCommentLength from '@hooks/useHandleExceedMaxCommentLength';\nimport useKeyboardState from '@hooks/useKeyboardState';\nimport useLocalize from '@hooks/useLocalize';\nimport useOnyx from '@hooks/useOnyx';\nimport usePrevious from '@hooks/usePrevious';\nimport useReportScrollManager from '@hooks/useReportScrollManager';\nimport useResponsiveLayout from '@hooks/useResponsiveLayout';\nimport useStyleUtils from '@hooks/useStyleUtils';\nimport useTheme from '@hooks/useTheme';\nimport useThemeStyles from '@hooks/useThemeStyles';\nimport {setShouldShowComposeInput} from '@libs/actions/Composer';\nimport {clearActive, isActive as isEmojiPickerActive, isEmojiPickerVisible} from '@libs/actions/EmojiPickerAction';\nimport {composerFocusKeepFocusOn} from '@libs/actions/InputFocus';\nimport {deleteReportActionDraft, editReportComment, saveReportActionDraft} from '@libs/actions/Report';\nimport {isMobileChrome} from '@libs/Browser/index.website';\nimport {canSkipTriggerHotkeys, insertText} from '@libs/ComposerUtils';\nimport DomUtils from '@libs/DomUtils';\nimport {extractEmojis, replaceAndExtractEmojis} from '@libs/EmojiUtils';\nimport focusComposerWithDelay from '@libs/focusComposerWithDelay';\nimport type {Selection} from '@libs/focusComposerWithDelay/types';\nimport focusEditAfterCancelDelete from '@libs/focusEditAfterCancelDelete';\nimport Parser from '@libs/Parser';\nimport ReportActionComposeFocusManager from '@libs/ReportActionComposeFocusManager';\nimport reportActionItemEventHandler from '@libs/ReportActionItemEventHandler';\nimport {getReportActionHtml, isDeletedAction} from '@libs/ReportActionsUtils';\nimport {getCommentLength} from '@libs/ReportUtils';\nimport setShouldShowComposeInputKeyboardAware from '@libs/setShouldShowComposeInputKeyboardAware';\nimport CONST from '@src/CONST';\nimport ONYXKEYS from '@src/ONYXKEYS';\nimport type * as OnyxTypes from '@src/types/onyx';\n// eslint-disable-next-line no-restricted-imports\nimport findNodeHandle from '@src/utils/findNodeHandle';\nimport KeyboardUtils from '@src/utils/keyboard';\nimport * as ReportActionContextMenu from './ContextMenu/ReportActionContextMenu';\nimport getCursorPosition from './ReportActionCompose/getCursorPosition';\nimport getScrollPosition from './ReportActionCompose/getScrollPosition';\nimport type {SuggestionsRef} from './ReportActionCompose/ReportActionCompose';\nimport Suggestions from './ReportActionCompose/Suggestions';\nimport shouldUseEmojiPickerSelection from './shouldUseEmojiPickerSelection';\n\ntype ReportActionItemMessageEditProps = {\n    /** All the data of the action */\n    action: OnyxTypes.ReportAction;\n\n    /** Draft message */\n    draftMessage: string;\n\n    /** ReportID that holds the comment we're editing */\n    reportID: string | undefined;\n\n    /** ID of the original report from which the given reportAction is first created */\n    originalReportID: string;\n\n    /** PolicyID of the policy the report belongs to */\n    policyID?: string;\n\n    /** Position index of the report action in the overall report FlatList view */\n    index: number;\n\n    /** Whether or not the emoji picker is disabled */\n    shouldDisableEmojiPicker?: boolean;\n\n    /** Whether report is from group policy */\n    isGroupPolicyReport: boolean;\n};\n\nconst shouldUseForcedSelectionRange = shouldUseEmojiPickerSelection();\n\n// video source -> video attributes\nconst draftMessageVideoAttributeCache = new Map<string, string>();\n\nconst DEFAULT_MODAL_VALUE = {\n    willAlertModalBecomeVisible: false,\n    isVisible: false,\n};\n\nfunction ReportActionItemMessageEdit(\n    {action, draftMessage, reportID, originalReportID, policyID, index, isGroupPolicyReport, shouldDisableEmojiPicker = false}: ReportActionItemMessageEditProps,\n    forwardedRef: ForwardedRef<TextInput | HTMLTextAreaElement | undefined>,\n) {\n    const [preferredSkinTone = CONST.EMOJI_DEFAULT_SKIN_TONE] = useOnyx(ONYXKEYS.PREFERRED_EMOJI_SKIN_TONE, {canBeMissing: true});\n    const theme = useTheme();\n    const styles = useThemeStyles();\n    const StyleUtils = useStyleUtils();\n    const containerRef = useRef<View>(null);\n    const reportScrollManager = useReportScrollManager();\n    const {translate, preferredLocale} = useLocalize();\n    const {isKeyboardShown} = useKeyboardState();\n    const {shouldUseNarrowLayout} = useResponsiveLayout();\n    const prevDraftMessage = usePrevious(draftMessage);\n    const suggestionsRef = useRef<SuggestionsRef>(null);\n    const mobileInputScrollPosition = useRef(0);\n    const cursorPositionValue = useSharedValue({x: 0, y: 0});\n    const tag = useSharedValue(-1);\n    const emojisPresentBefore = useRef<Emoji[]>([]);\n    const [draft, setDraft] = useState(() => {\n        if (draftMessage) {\n            emojisPresentBefore.current = extractEmojis(draftMessage);\n        }\n        return draftMessage;\n    });\n    const [selection, setSelection] = useState<TextSelection>({start: draft.length, end: draft.length, positionX: 0, positionY: 0});\n    const [isFocused, setIsFocused] = useState<boolean>(false);\n    const {hasExceededMaxCommentLength, validateCommentMaxLength} = useHandleExceedMaxCommentLength();\n    const debouncedValidateCommentMaxLength = useMemo(() => lodashDebounce(validateCommentMaxLength, CONST.TIMING.COMMENT_LENGTH_DEBOUNCE_TIME), [validateCommentMaxLength]);\n\n    const [modal = DEFAULT_MODAL_VALUE] = useOnyx(ONYXKEYS.MODAL, {canBeMissing: true});\n    const [onyxInputFocused = false] = useOnyx(ONYXKEYS.INPUT_FOCUSED, {canBeMissing: true});\n\n    const textInputRef = useRef<(HTMLTextAreaElement & TextInput) | null>(null);\n    const isFocusedRef = useRef<boolean>(false);\n    const draftRef = useRef(draft);\n    const emojiPickerSelectionRef = useRef<Selection | undefined>(undefined);\n    // The ref to check whether the comment saving is in progress\n    const isCommentPendingSaved = useRef(false);\n\n    useEffect(() => {\n        draftMessageVideoAttributeCache.clear();\n\n        const originalMessage = Parser.htmlToMarkdown(getReportActionHtml(action), {\n            cacheVideoAttributes: (videoSource, attrs) => draftMessageVideoAttributeCache.set(videoSource, attrs),\n        });\n        if (isDeletedAction(action) || !!(action.message && draftMessage === originalMessage) || !!(prevDraftMessage === draftMessage || isCommentPendingSaved.current)) {\n            return;\n        }\n        setDraft(draftMessage);\n    }, [draftMessage, action, prevDraftMessage]);\n\n    useEffect(() => {\n        composerFocusKeepFocusOn(textInputRef.current as HTMLElement, isFocused, modal, onyxInputFocused);\n    }, [isFocused, modal, onyxInputFocused]);\n\n    useEffect(\n        // Remove focus callback on unmount to avoid stale callbacks\n        () => {\n            if (textInputRef.current) {\n                ReportActionComposeFocusManager.editComposerRef.current = textInputRef.current;\n            }\n            return () => {\n                if (ReportActionComposeFocusManager.editComposerRef.current !== textInputRef.current) {\n                    return;\n                }\n                ReportActionComposeFocusManager.clear(true);\n            };\n        },\n        [],\n    );\n\n    // We consider the report action active if it's focused, its emoji picker is open or its context menu is open\n    const isActive = useCallback(\n        () => isFocusedRef.current || isEmojiPickerActive(action.reportActionID) || ReportActionContextMenu.isActiveReportAction(action.reportActionID),\n        [action.reportActionID],\n    );\n\n    /**\n     * Focus the composer text input\n     * @param shouldDelay - Impose delay before focusing the composer\n     */\n    const focus = useCallback((shouldDelay = false, forcedSelectionRange?: Selection) => {\n        focusComposerWithDelay(textInputRef.current)(shouldDelay, forcedSelectionRange);\n    }, []);\n\n    // Take over focus priority\n    const setUpComposeFocusManager = useCallback(() => {\n        ReportActionComposeFocusManager.onComposerFocus(() => {\n            focus(true, emojiPickerSelectionRef.current ? {...emojiPickerSelectionRef.current} : undefined);\n            emojiPickerSelectionRef.current = undefined;\n        }, true);\n    }, [focus]);\n\n    // show the composer after editing is complete for devices that hide the composer during editing.\n    useEffect(() => () => setShouldShowComposeInput(true), []);\n\n    /**\n     * Save the draft of the comment. This debounced so that we're not ceaselessly saving your edit. Saving the draft\n     * allows one to navigate somewhere else and come back to the comment and still have it in edit mode.\n     * @param {String} newDraft\n     */\n    const debouncedSaveDraft = useMemo(\n        () =>\n            // eslint-disable-next-line react-compiler/react-compiler\n            lodashDebounce((newDraft: string) => {\n                saveReportActionDraft(reportID, action, newDraft);\n                isCommentPendingSaved.current = false;\n            }, 1000),\n        [reportID, action],\n    );\n\n    useEffect(\n        () => () => {\n            debouncedSaveDraft.cancel();\n            isCommentPendingSaved.current = false;\n        },\n        [debouncedSaveDraft],\n    );\n\n    /**\n     * Update the value of the draft in Onyx\n     *\n     * @param {String} newDraftInput\n     */\n    const updateDraft = useCallback(\n        (newDraftInput: string) => {\n            const {text: newDraft, emojis, cursorPosition} = replaceAndExtractEmojis(newDraftInput, preferredSkinTone, preferredLocale);\n\n            emojisPresentBefore.current = emojis;\n\n            setDraft(newDraft);\n\n            if (newDraftInput !== newDraft) {\n                const position = Math.max((selection?.end ?? 0) + (newDraft.length - draftRef.current.length), cursorPosition ?? 0);\n                setSelection({\n                    start: position,\n                    end: position,\n                    positionX: 0,\n                    positionY: 0,\n                });\n            }\n\n            draftRef.current = newDraft;\n\n            // We want to escape the draft message to differentiate the HTML from the report action and the HTML the user drafted.\n            debouncedSaveDraft(newDraft);", "extras": {"command": "sed -n '1,240p' /app/expensify/src/pages/home/report/ReportActionItemMessageEdit.tsx", "metadata": {"exit_code": 0, "pid": -1, "username": "root", "hostname": "b506651eefd9", "working_dir": "/workspace", "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python", "prefix": "", "suffix": "\n[The command completed with exit code 0.]"}, "hidden": false}, "success": true}