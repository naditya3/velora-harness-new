{"id": 14, "timestamp": "2026-01-29T16:13:24.162380", "source": "agent", "message": "I read the file /workspace/Expensify__App__12155_1/src/hooks/useHtmlPaste/index.ts.", "cause": 13, "observation": "read", "tool_call_metadata": {"function_name": "str_replace_editor", "tool_call_id": "toolu_05", "model_response": {"id": "JId7ac2wBKeM_PUPrtyDmQU", "created": 1769703200, "model": "gemini-3-pro-preview", "object": "chat.completion", "system_fingerprint": null, "choices": [{"finish_reason": "stop", "index": 0, "message": {"content": "The issue seems to be platform agnostic as per the \"Platform\" section in the issue description (Web, iOS, Android, Desktop App, Mobile Web). However, the issue description mentions \"Action Performed: 1. Go to staging.new.expensify.com\", which suggests it's being tested on the web.\n\nI should check `src/hooks/useHtmlPaste/index.ts` as that's likely the web implementation. `index.native.ts` would be for native platforms.\n\nLet me view `src/hooks/useHtmlPaste/index.ts`.", "role": "assistant", "tool_calls": [{"index": 1, "function": {"arguments": "{\"command\": \"view\", \"path\": \"/workspace/Expensify__App__12155_1/src/hooks/useHtmlPaste/index.ts\", \"security_risk\": \"LOW\"}", "name": "str_replace_editor"}, "id": "toolu_05", "type": "function"}], "function_call": null}}], "usage": {"completion_tokens": 193, "prompt_tokens": 22089, "total_tokens": 22282, "completion_tokens_details": null, "prompt_tokens_details": {"audio_tokens": null, "cached_tokens": 20425, "text_tokens": 1664, "image_tokens": null}}, "vertex_ai_grounding_metadata": [], "vertex_ai_url_context_metadata": [], "vertex_ai_safety_results": [], "vertex_ai_citation_metadata": []}, "total_calls_in_response": 1}, "content": "Here's the result of running `cat -n` on /workspace/Expensify__App__12155_1/src/hooks/useHtmlPaste/index.ts:\n     1\timport {useNavigation} from '@react-navigation/native';\n     2\timport {useCallback, useEffect} from 'react';\n     3\timport Parser from '@libs/Parser';\n     4\timport type UseHtmlPaste from './types';\n     5\t\n     6\tconst insertByCommand = (text: string) => {\n     7\t    document.execCommand('insertText', false, text);\n     8\t};\n     9\t\n    10\tconst insertAtCaret = (target: HTMLElement, text: string) => {\n    11\t    const selection = window.getSelection();\n    12\t    if (selection?.rangeCount) {\n    13\t        const range = selection.getRangeAt(0);\n    14\t        range.deleteContents();\n    15\t        const node = document.createTextNode(text);\n    16\t        range.insertNode(node);\n    17\t\n    18\t        // Move caret to the end of the newly inserted text node.\n    19\t        range.setStart(node, node.length);\n    20\t        range.setEnd(node, node.length);\n    21\t        selection.setBaseAndExtent(range.startContainer, range.startOffset, range.endContainer, range.endOffset);\n    22\t\n    23\t        // Dispatch input event to trigger Markdown Input to parse the new text\n    24\t        target.dispatchEvent(new Event('input', {bubbles: true}));\n    25\t    } else {\n    26\t        insertByCommand(text);\n    27\t    }\n    28\t};\n    29\t\n    30\tconst useHtmlPaste: UseHtmlPaste = (textInputRef, preHtmlPasteCallback, removeListenerOnScreenBlur = false) => {\n    31\t    const navigation = useNavigation();\n    32\t\n    33\t    /**\n    34\t     * Set pasted text to clipboard\n    35\t     * @param {String} text\n    36\t     */\n    37\t    const paste = useCallback((text: string) => {\n    38\t        try {\n    39\t            const textInputHTMLElement = textInputRef.current as HTMLElement;\n    40\t            if (textInputHTMLElement?.hasAttribute('contenteditable')) {\n    41\t                insertAtCaret(textInputHTMLElement, text);\n    42\t            } else {\n    43\t                insertByCommand(text);\n    44\t            }\n    45\t\n    46\t            // Pointer will go out of sight when a large paragraph is pasted on the web. Refocusing the input keeps the cursor in view.\n    47\t            // To avoid the keyboard toggle issue in mWeb if using blur() and focus() functions, we just need to dispatch the event to trigger the onFocus handler\n    48\t            // We need to trigger the bubbled \"focusin\" event to make sure the onFocus handler is triggered\n    49\t            textInputHTMLElement.dispatchEvent(\n    50\t                new FocusEvent('focusin', {\n    51\t                    bubbles: true,\n    52\t                }),\n    53\t            );\n    54\t            // eslint-disable-next-line no-empty\n    55\t        } catch (e) {}\n    56\t        // We only need to set the callback once.\n    57\t        // eslint-disable-next-line react-compiler/react-compiler, react-hooks/exhaustive-deps\n    58\t    }, []);\n    59\t\n    60\t    /**\n    61\t     * Manually place the pasted HTML into Composer\n    62\t     *\n    63\t     * @param {String} html - pasted HTML\n    64\t     */\n    65\t    const handlePastedHTML = useCallback(\n    66\t        (html: string) => {\n    67\t            paste(Parser.htmlToMarkdown(html));\n    68\t        },\n    69\t        [paste],\n    70\t    );\n    71\t\n    72\t    /**\n    73\t     * Paste the plaintext content into Composer.\n    74\t     *\n    75\t     * @param {ClipboardEvent} event\n    76\t     */\n    77\t    const handlePastePlainText = useCallback(\n    78\t        (event: ClipboardEvent) => {\n    79\t            const plainText = event.clipboardData?.getData('text/plain');\n    80\t            if (plainText) {\n    81\t                paste(plainText);\n    82\t            }\n    83\t        },\n    84\t        [paste],\n    85\t    );\n    86\t\n    87\t    const handlePaste = useCallback(\n    88\t        (event: ClipboardEvent) => {\n    89\t            if (!textInputRef.current) {\n    90\t                return;\n    91\t            }\n    92\t\n    93\t            if (preHtmlPasteCallback?.(event)) {\n    94\t                return;\n    95\t            }\n    96\t\n    97\t            const isFocused = textInputRef.current?.isFocused();\n    98\t\n    99\t            if (!isFocused) {\n   100\t                return;\n   101\t            }\n   102\t\n   103\t            event.preventDefault();\n   104\t\n   105\t            const TEXT_HTML = 'text/html';\n   106\t\n   107\t            // If paste contains HTML\n   108\t            if (event.clipboardData?.types?.includes(TEXT_HTML)) {\n   109\t                const pastedHTML = event.clipboardData.getData(TEXT_HTML);\n   110\t\n   111\t                const domparser = new DOMParser();\n   112\t                const embeddedImages = domparser.parseFromString(pastedHTML, TEXT_HTML).images;\n   113\t\n   114\t                // Exclude parsing img tags in the HTML, as fetching the image via fetch triggers a connect-src Content-Security-Policy error.\n   115\t                if (embeddedImages.length > 0 && embeddedImages[0].src) {\n   116\t                    // If HTML has emoji, then treat this as plain text.\n   117\t                    if (embeddedImages[0].dataset && embeddedImages[0].dataset.stringifyType === 'emoji') {\n   118\t                        handlePastePlainText(event);\n   119\t                        return;\n   120\t                    }\n   121\t                }\n   122\t                handlePastedHTML(pastedHTML);\n   123\t                return;\n   124\t            }\n   125\t            handlePastePlainText(event);\n   126\t        },\n   127\t        // eslint-disable-next-line react-compiler/react-compiler, react-hooks/exhaustive-deps\n   128\t        [handlePastedHTML, handlePastePlainText, preHtmlPasteCallback],\n   129\t    );\n   130\t\n   131\t    useEffect(() => {\n   132\t        // we need to re-register listener on navigation focus/blur if the component (like Composer) is not unmounting\n   133\t        // when navigating away to different screen (report) to avoid paste event on other screen being wrongly handled\n   134\t        // by current screen paste listener\n   135\t        let unsubscribeFocus: () => void;\n   136\t        let unsubscribeBlur: () => void;\n   137\t        if (removeListenerOnScreenBlur) {\n   138\t            unsubscribeFocus = navigation.addListener('focus', () => document.addEventListener('paste', handlePaste, true));\n   139\t            unsubscribeBlur = navigation.addListener('blur', () => document.removeEventListener('paste', handlePaste, true));\n   140\t        }\n   141\t\n   142\t        document.addEventListener('paste', handlePaste, true);\n   143\t\n   144\t        return () => {\n   145\t            if (removeListenerOnScreenBlur) {\n   146\t                unsubscribeFocus();\n   147\t                unsubscribeBlur();\n   148\t            }\n   149\t            document.removeEventListener('paste', handlePaste, true);\n   150\t        };\n   151\t        // eslint-disable-next-line react-compiler/react-compiler, react-hooks/exhaustive-deps\n   152\t    }, []);\n   153\t};\n   154\t\n   155\texport default useHtmlPaste;\n   156\t\n", "extras": {"path": "/workspace/Expensify__App__12155_1/src/hooks/useHtmlPaste/index.ts", "impl_source": "oh_aci"}}