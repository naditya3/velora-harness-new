{"instance_id": "748735877784729", "repo": "amypad/miutil", "base_commit": "5654e31868d5d4ca4b9d071da160412f53549301", "problem_statement": "overlay multiple cmaps:\\nadd option to overlay multiple images using multiple cmaps, e.g.:\\r\\n\\r\\n\\r\\n```python\\r\\nimport numpy as np\\r\\n\\r\\nfrom miutil import plot\\r\\n\\r\\n\\r\\nvol1 = np.random.random((10, 10, 10))\\r\\nvol2 = np.random.random((10, 10, 10))\\r\\n# res = plot.apply_cmap(magma=vol1, bone=vol2)\\r\\n# assert res.shape == (10, 10, 10, 4)  # RGBA\\r\\nplot.imscroll(\\r\\n    (\\r\\n        plot.apply_cmap(magma=vol1),\\r\\n        plot.apply_cmap(bone=vol2),\\r\\n        plot.apply_cmap(magma=vol1, bone=vol2),\\r\\n    )\\r\\n)\\r\\nplot.show()\\r\\n```", "FAIL_TO_PASS": ["tests/test_fdio.py::test_create_dir"], "PASS_TO_PASS": ["tests/test_fdio.py::test_tmpdir", "tests/test_fdio.py::test_hasext"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/amypad_miutil:5654e31868d5d4ca4b9d071da160412f53549301", "patch": "[\"diff --git a/.github/workflows/comment-bot.yml b/.github/workflows/comment-bot.yml\\nindex 37ec46d..4451632 100644\\n--- a/.github/workflows/comment-bot.yml\\n+++ b/.github/workflows/comment-bot.yml\\n@@ -4,7 +4,6 @@ on:\\n     types: [created]\\n   pull_request_review_comment:\\n     types: [created]\\n-\\n jobs:\\n   tag:  # /tag <tagname> <commit>\\n     if: startsWith(github.event.comment.body, '/tag ')\\n@@ -21,7 +20,6 @@ jobs:\\n           post = (context.eventName == \\\"issue_comment\\\"\\n             ? github.reactions.createForIssueComment\\n             : github.reactions.createForPullRequestReviewComment)\\n-\\n           if (![\\\"admin\\\", \\\"write\\\"].includes(perm.data.permission)){\\n             post({\\n               owner: context.repo.owner, repo: context.repo.repo,\\n\",\"diff --git a/.pre-commit-config.yaml b/.pre-commit-config.yaml\\nnew file mode 100644\\nindex 0000000..9d687f1\\n--- /dev/null\\n+++ b/.pre-commit-config.yaml\\n@@ -0,0 +1,32 @@\\n+default_language_version:\\n+  python: python3\\n+repos:\\n+- repo: https://github.com/pre-commit/pre-commit-hooks\\n+  rev: v2.4.0\\n+  hooks:\\n+  - id: check-added-large-files\\n+  - id: check-case-conflict\\n+  - id: check-docstring-first\\n+  - id: check-executables-have-shebangs\\n+  - id: check-toml\\n+  - id: check-yaml\\n+  - id: end-of-file-fixer\\n+  - id: mixed-line-ending\\n+  - id: trailing-whitespace\\n+- hooks:\\n+  - id: flake8\\n+    additional_dependencies:\\n+    - flake8-bugbear\\n+    - flake8-comprehensions\\n+    - flake8-debugger\\n+    - flake8-string-format\\n+  repo: https://gitlab.com/pycqa/flake8\\n+  rev: 3.8.4\\n+- hooks:\\n+  - id: black\\n+  repo: https://github.com/psf/black\\n+  rev: 19.10b0\\n+- hooks:\\n+  - id: isort\\n+  repo: https://github.com/timothycrosley/isort\\n+  rev: 5.6.4\\n\",\"diff --git a/.pre-commit-hooks.yaml b/.pre-commit-hooks.yaml\\nnew file mode 100644\\nindex 0000000..d0c5da6\\n--- /dev/null\\n+++ b/.pre-commit-hooks.yaml\\n@@ -0,0 +1,9 @@\\n+- id: mbeautify\\n+  name: mbeautify\\n+  description: '`mbeautify` is a command-line utility for enforcing style consistency across Matlab projects.'\\n+  entry: mbeautify\\n+  language: python\\n+  additional_dependencies: ['.[mbeautify]']\\n+  types: [text]\\n+  files: \\\\.(m)$\\n+  require_serial: true\\n\",\"diff --git a/LICENCE.md b/LICENCE.md\\nindex 957e9cb..ee3b9f9 100644\\n--- a/LICENCE.md\\n+++ b/LICENCE.md\\n@@ -1,7 +1,7 @@\\n Copyright 2020 AMYPAD\\n \\n Licensed under the Apache License, Version 2.0 (the \\\"License\\\");\\n-you may not use this file except in compliance with the License.\\n+you may not use this project except in compliance with the License.\\n You may obtain a copy of the License at\\n \\n     http://www.apache.org/licenses/LICENSE-2.0\\n\",\"diff --git a/README.rst b/README.rst\\nindex 429ea92..c87974e 100644\\n--- a/README.rst\\n+++ b/README.rst\\n@@ -15,6 +15,14 @@ Install\\n Intended for inclusion in requirements for other packages.\\n The package name is ``miutil``. Extra install options include:\\n \\n+- cuda\\n+\\n+  - provides `miutil.cuinfo <https://github.com/AMYPAD/miutil/blob/master/miutil/cuinfo.py>`_\\n+\\n+- mbeautify\\n+\\n+  - provides `miutil.mlab.beautify <https://github.com/AMYPAD/miutil/blob/master/miutil/mlab/beautify.py>`_\\n+\\n - nii\\n \\n   - provides `miutil.imio.nii <https://github.com/AMYPAD/miutil/blob/master/miutil/imio/nii.py>`_\\n@@ -25,9 +33,9 @@ The package name is ``miutil``. Extra install options include:\\n \\n     - includes a useful 3D multi-volume ``imscroll`` function which depends only on ``matplotlib``\\n \\n-- cuda\\n+- web\\n \\n-  - provides `miutil.cuinfo <https://github.com/AMYPAD/miutil/blob/master/miutil/cuinfo.py>`_\\n+  - provides `miutil.web <https://github.com/AMYPAD/miutil/blob/master/miutil/web.py>`_\\n \\n \\n To install extras and their dependencies,\\n\",\"diff --git a/miutil/cuinfo.py b/miutil/cuinfo.py\\nindex 5d2c556..0f9de31 100755\\n--- a/miutil/cuinfo.py\\n+++ b/miutil/cuinfo.py\\n@@ -1,14 +1,15 @@\\n+#!/usr/bin/env python3\\n \\\"\\\"\\\"CUDA helpers\\n Usage:\\n-  miutil.cuinfo [options]\\n+  cuinfo [options]\\n \\n Options:\\n   -n, --num-devices   : print number of devices (ignores `-d`)\\n   -f, --nvcc-flags    : print out flags for use nvcc compilation\\n   -d ID, --dev-id ID  : select device ID [default: None:int] for all\\n \\\"\\\"\\\"\\n-from argopt import argopt\\n import pynvml\\n+from argopt import argopt\\n \\n __all__ = [\\\"num_devices\\\", \\\"compute_capability\\\", \\\"memory\\\", \\\"name\\\", \\\"nvcc_flags\\\"]\\n \\n\",\"diff --git a/miutil/fdio.py b/miutil/fdio.py\\nindex 4d3c40f..a388a1d 100644\\n--- a/miutil/fdio.py\\n+++ b/miutil/fdio.py\\n@@ -1,13 +1,19 @@\\n+import logging\\n from contextlib import contextmanager\\n from os import makedirs, path\\n from shutil import rmtree\\n from tempfile import mkdtemp\\n \\n+log = logging.getLogger(__name__)\\n+\\n \\n def create_dir(pth):\\n     \\\"\\\"\\\"Equivalent of `mkdir -p`\\\"\\\"\\\"\\n-    if not path.exists(pth):\\n-        makedirs(pth)\\n+    if not path.isdir(pth):\\n+        try:\\n+            makedirs(pth)\\n+        except Exception as exc:\\n+            log.warn(\\\"cannot create:%s:%s\\\" % (pth, exc))\\n \\n \\n def hasext(fname, ext):\\n\",\"diff --git a/miutil/imio/__init__.py b/miutil/imio/__init__.py\\nindex fbbeea2..10d448a 100644\\n--- a/miutil/imio/__init__.py\\n+++ b/miutil/imio/__init__.py\\n@@ -4,16 +4,16 @@ RE_NII_GZ = re.compile(r\\\"^(.+)(\\\\.nii(?:\\\\.gz)?)$\\\", flags=re.I)\\n RE_NPYZ = re.compile(r\\\"^(.+)(\\\\.np[yz])$\\\", flags=re.I)\\n \\n \\n-def imread(fname):\\n+def imread(fname, *args, **kwargs):\\n     \\\"\\\"\\\"Read any supported filename\\\"\\\"\\\"\\n     if RE_NII_GZ.search(fname):\\n         from .nii import getnii\\n \\n-        return getnii(fname)\\n+        return getnii(fname, *args, **kwargs)\\n     elif RE_NPYZ.search(fname):\\n         import numpy as np\\n \\n-        res = np.load(fname)\\n+        res = np.load(fname, *args, **kwargs)\\n         if hasattr(res, \\\"keys\\\") and len(res.keys()) == 1:\\n             res = res[list(res.keys())[0]]\\n         return res\\n\",\"diff --git a/miutil/imio/nii.py b/miutil/imio/nii.py\\nindex fa40f81..fbd76a5 100644\\n--- a/miutil/imio/nii.py\\n+++ b/miutil/imio/nii.py\\n@@ -1,5 +1,4 @@\\n \\\"\\\"\\\"NIfTI I/O\\\"\\\"\\\"\\n-from six import string_types\\n import gzip\\n import logging\\n import numbers\\n@@ -8,9 +7,10 @@ import re\\n \\n import nibabel as nib\\n import numpy as np\\n+from six import string_types\\n \\n-from . import RE_NII_GZ\\n from ..fdio import create_dir, hasext\\n+from . import RE_NII_GZ\\n \\n RE_GZ = re.compile(r\\\"^(.+)(\\\\.gz)$\\\", flags=re.I)\\n log = logging.getLogger(__name__)\\n\",\"diff --git a/miutil/mlab.py b/miutil/mlab.py\\ndeleted file mode 100644\\nindex f87e7eb..0000000\\n--- a/miutil/mlab.py\\n+++ /dev/null\\n@@ -1,129 +0,0 @@\\n-from ast import literal_eval\\n-from functools import lru_cache\\n-from os import getenv, path\\n-from subprocess import CalledProcessError, STDOUT, check_output\\n-from textwrap import dedent\\n-import logging\\n-import re\\n-import sys\\n-\\n-from .fdio import tmpdir\\n-\\n-__all__ = [\\\"get_engine\\\"]\\n-IS_WIN = any(sys.platform.startswith(i) for i in [\\\"win32\\\", \\\"cygwin\\\"])\\n-MATLAB_RUN = \\\"matlab -nodesktop -nosplash -nojvm\\\".split()\\n-if IS_WIN:\\n-    MATLAB_RUN += [\\\"-wait\\\", \\\"-log\\\"]\\n-log = logging.getLogger(__name__)\\n-\\n-\\n-class VersionError(ValueError):\\n-    pass\\n-\\n-\\n-def check_output_u8(*args, **kwargs):\\n-    return check_output(*args, **kwargs).decode(\\\"utf-8\\\").strip()\\n-\\n-\\n-@lru_cache()\\n-def get_engine(name=None):\\n-    try:\\n-        from matlab import engine\\n-    except ImportError:\\n-        try:\\n-            log.warn(\\n-                dedent(\\n-                    \\\"\\\"\\\"\\\\\\n-                Python could not find the MATLAB engine.\\n-                Attempting to install automatically.\\\"\\\"\\\"\\n-                )\\n-            )\\n-            log.debug(_install_engine())\\n-            log.info(\\\"installed MATLAB engine for Python\\\")\\n-            from matlab import engine\\n-        except CalledProcessError:\\n-            raise ImportError(\\n-                dedent(\\n-                    \\\"\\\"\\\"\\\\\\n-                Please install MATLAB and its Python module.\\n-                See https://www.mathworks.com/help/matlab/matlab_external/\\\\\\n-install-the-matlab-engine-for-python.html\\n-                or\\n-                https://www.mathworks.com/help/matlab/matlab_external/\\\\\\n-install-matlab-engine-api-for-python-in-nondefault-locations.html\\n-                It's likely you need to do:\\n-\\n-                cd \\\"{matlabroot}\\\\\\\\extern\\\\\\\\engines\\\\\\\\python\\\"\\n-                {exe} setup.py build --build-base=\\\"BUILDDIR\\\" install\\n-\\n-                - Fill in any temporary directory name for BUILDDIR\\n-                  (e.g. /tmp/builddir).\\n-                - If installation fails due to write permissions, try appending `--user`\\n-                  to the above command.\\n-                \\\"\\\"\\\"\\n-                ).format(\\n-                    matlabroot=matlabroot(default=\\\"matlabroot\\\"), exe=sys.executable\\n-                )\\n-            )\\n-    started = engine.find_matlab()\\n-    notify = False\\n-    if not started or (name and name not in started):\\n-        notify = True\\n-        log.debug(\\\"Starting MATLAB\\\")\\n-    eng = engine.connect_matlab(name=name or getenv(\\\"SPM12_MATLAB_ENGINE\\\", None))\\n-    if notify:\\n-        log.debug(\\\"MATLAB started\\\")\\n-    return eng\\n-\\n-\\n-def _matlab_run(command, jvm=False, auto_exit=True):\\n-    if auto_exit and not command.endswith(\\\"exit\\\"):\\n-        command = command + \\\", exit\\\"\\n-    return check_output_u8(\\n-        MATLAB_RUN + ([] if jvm else [\\\"-nojvm\\\"]) + [\\\"-r\\\", command], stderr=STDOUT\\n-    )\\n-\\n-\\n-def matlabroot(default=None):\\n-    if IS_WIN:\\n-        try:\\n-            res = _matlab_run(\\\"display(matlabroot);\\\")\\n-        except CalledProcessError:\\n-            if default:\\n-                return default\\n-            raise\\n-        return re.search(r\\\"^([A-Z]:\\\\\\\\.*)\\\\s*$\\\", res, flags=re.M).group(1)\\n-\\n-    try:\\n-        res = check_output_u8([\\\"matlab\\\", \\\"-n\\\"])\\n-    except CalledProcessError:\\n-        if default:\\n-            return default\\n-        raise\\n-    return re.search(r\\\"MATLAB\\\\s+=\\\\s+(\\\\S+)\\\\s*$\\\", res, flags=re.M).group(1)\\n-\\n-\\n-def _install_engine():\\n-    src = path.join(matlabroot(), \\\"extern\\\", \\\"engines\\\", \\\"python\\\")\\n-    with open(path.join(src, \\\"setup.py\\\")) as fd:  # check version support\\n-        supported = literal_eval(\\n-            re.search(r\\\"supported_version.*?=\\\\s*(.*?)$\\\", fd.read(), flags=re.M).group(1)\\n-        )\\n-        if \\\".\\\".join(map(str, sys.version_info[:2])) not in map(str, supported):\\n-            raise VersionError(\\n-                dedent(\\n-                    \\\"\\\"\\\"\\\\\\n-                Python version is {info[0]}.{info[1]},\\n-                but the installed MATLAB only supports Python versions: [{supported}]\\n-                \\\"\\\"\\\".format(\\n-                        info=sys.version_info[:2], supported=\\\", \\\".join(supported)\\n-                    )\\n-                )\\n-            )\\n-    with tmpdir() as td:\\n-        cmd = [sys.executable, \\\"setup.py\\\", \\\"build\\\", \\\"--build-base\\\", td, \\\"install\\\"]\\n-        try:\\n-            return check_output_u8(cmd, cwd=src)\\n-        except CalledProcessError:\\n-            log.warn(\\\"Normal install failed. Attempting `--user` install.\\\")\\n-            return check_output_u8(cmd + [\\\"--user\\\"], cwd=src)\\n\",\"diff --git a/miutil/mlab/__init__.py b/miutil/mlab/__init__.py\\nnew file mode 100644\\nindex 0000000..0f459a4\\n--- /dev/null\\n+++ b/miutil/mlab/__init__.py\\n@@ -0,0 +1,129 @@\\n+import logging\\n+import re\\n+import sys\\n+from ast import literal_eval\\n+from functools import lru_cache\\n+from os import getenv, path\\n+from subprocess import STDOUT, CalledProcessError, check_output\\n+from textwrap import dedent\\n+\\n+from ..fdio import tmpdir\\n+\\n+__all__ = [\\\"get_engine\\\"]\\n+IS_WIN = any(sys.platform.startswith(i) for i in [\\\"win32\\\", \\\"cygwin\\\"])\\n+MATLAB_RUN = \\\"matlab -nodesktop -nosplash -nojvm\\\".split()\\n+if IS_WIN:\\n+    MATLAB_RUN += [\\\"-wait\\\", \\\"-log\\\"]\\n+log = logging.getLogger(__name__)\\n+\\n+\\n+class VersionError(ValueError):\\n+    pass\\n+\\n+\\n+def check_output_u8(*args, **kwargs):\\n+    return check_output(*args, **kwargs).decode(\\\"utf-8\\\").strip()\\n+\\n+\\n+@lru_cache()\\n+def get_engine(name=None):\\n+    try:\\n+        from matlab import engine\\n+    except ImportError:\\n+        try:\\n+            log.warn(\\n+                dedent(\\n+                    \\\"\\\"\\\"\\\\\\n+                Python could not find the MATLAB engine.\\n+                Attempting to install automatically.\\\"\\\"\\\"\\n+                )\\n+            )\\n+            log.debug(_install_engine())\\n+            log.info(\\\"installed MATLAB engine for Python\\\")\\n+            from matlab import engine\\n+        except CalledProcessError:\\n+            raise ImportError(\\n+                dedent(\\n+                    \\\"\\\"\\\"\\\\\\n+                Please install MATLAB and its Python module.\\n+                See https://www.mathworks.com/help/matlab/matlab_external/\\\\\\n+install-the-matlab-engine-for-python.html\\n+                or\\n+                https://www.mathworks.com/help/matlab/matlab_external/\\\\\\n+install-matlab-engine-api-for-python-in-nondefault-locations.html\\n+                It's likely you need to do:\\n+\\n+                cd \\\"{matlabroot}\\\\\\\\extern\\\\\\\\engines\\\\\\\\python\\\"\\n+                {exe} setup.py build --build-base=\\\"BUILDDIR\\\" install\\n+\\n+                - Fill in any temporary directory name for BUILDDIR\\n+                  (e.g. /tmp/builddir).\\n+                - If installation fails due to write permissions, try appending `--user`\\n+                  to the above command.\\n+                \\\"\\\"\\\"\\n+                ).format(\\n+                    matlabroot=matlabroot(default=\\\"matlabroot\\\"), exe=sys.executable\\n+                )\\n+            )\\n+    started = engine.find_matlab()\\n+    notify = False\\n+    if not started or (name and name not in started):\\n+        notify = True\\n+        log.debug(\\\"Starting MATLAB\\\")\\n+    eng = engine.connect_matlab(name=name or getenv(\\\"SPM12_MATLAB_ENGINE\\\", None))\\n+    if notify:\\n+        log.debug(\\\"MATLAB started\\\")\\n+    return eng\\n+\\n+\\n+def _matlab_run(command, jvm=False, auto_exit=True):\\n+    if auto_exit and not command.endswith(\\\"exit\\\"):\\n+        command = command + \\\", exit\\\"\\n+    return check_output_u8(\\n+        MATLAB_RUN + ([] if jvm else [\\\"-nojvm\\\"]) + [\\\"-r\\\", command], stderr=STDOUT\\n+    )\\n+\\n+\\n+def matlabroot(default=None):\\n+    if IS_WIN:\\n+        try:\\n+            res = _matlab_run(\\\"display(matlabroot);\\\")\\n+        except CalledProcessError:\\n+            if default:\\n+                return default\\n+            raise\\n+        return re.search(r\\\"^([A-Z]:\\\\\\\\.*)\\\\s*$\\\", res, flags=re.M).group(1)\\n+\\n+    try:\\n+        res = check_output_u8([\\\"matlab\\\", \\\"-n\\\"])\\n+    except CalledProcessError:\\n+        if default:\\n+            return default\\n+        raise\\n+    return re.search(r\\\"MATLAB\\\\s+=\\\\s+(\\\\S+)\\\\s*$\\\", res, flags=re.M).group(1)\\n+\\n+\\n+def _install_engine():\\n+    src = path.join(matlabroot(), \\\"extern\\\", \\\"engines\\\", \\\"python\\\")\\n+    with open(path.join(src, \\\"setup.py\\\")) as fd:  # check version support\\n+        supported = literal_eval(\\n+            re.search(r\\\"supported_version.*?=\\\\s*(.*?)$\\\", fd.read(), flags=re.M).group(1)\\n+        )\\n+        if \\\".\\\".join(map(str, sys.version_info[:2])) not in map(str, supported):\\n+            raise VersionError(\\n+                dedent(\\n+                    \\\"\\\"\\\"\\\\\\n+                Python version is {info[0]}.{info[1]},\\n+                but the installed MATLAB only supports Python versions: [{supported}]\\n+                \\\"\\\"\\\".format(\\n+                        info=sys.version_info[:2], supported=\\\", \\\".join(supported)\\n+                    )\\n+                )\\n+            )\\n+    with tmpdir() as td:\\n+        cmd = [sys.executable, \\\"setup.py\\\", \\\"build\\\", \\\"--build-base\\\", td, \\\"install\\\"]\\n+        try:\\n+            return check_output_u8(cmd, cwd=src)\\n+        except CalledProcessError:\\n+            log.warn(\\\"Normal install failed. Attempting `--user` install.\\\")\\n+            return check_output_u8(cmd + [\\\"--user\\\"], cwd=src)\\n\",\"diff --git a/miutil/mlab/beautify.py b/miutil/mlab/beautify.py\\nnew file mode 100755\\nindex 0000000..c2344ab\\n--- /dev/null\\n+++ b/miutil/mlab/beautify.py\\n@@ -0,0 +1,53 @@\\n+#!/usr/bin/env python\\n+\\\"\\\"\\\"Usage:\\n+  mbeautify <mfile>...\\n+\\n+Arguments:\\n+  <mfile>  : Path to `*.m` file\\n+\\\"\\\"\\\"\\n+import logging\\n+from functools import lru_cache, wraps\\n+from os import path\\n+from zipfile import ZipFile\\n+\\n+from argopt import argopt\\n+from tqdm.contrib import tmap\\n+\\n+from ..web import get_file\\n+from . import get_engine\\n+\\n+log = logging.getLogger(__name__)\\n+MBEAUTIFIER_REV = \\\"aad307c62532cd7c852aab9bac44fd6443b90bef\\\"\\n+\\n+\\n+@lru_cache()\\n+@wraps(get_engine)\\n+def ensure_mbeautifier(*args, **kwargs):\\n+    eng = get_engine(*args, **kwargs)\\n+    fn = get_file(\\n+        \\\"MBeautifier-aad307c.zip\\\",\\n+        \\\"https://github.com/davidvarga/MBeautifier/archive/%s.zip\\\" % MBEAUTIFIER_REV,\\n+    )\\n+    outpath = path.join(path.dirname(fn), \\\"MBeautifier-%s\\\" % MBEAUTIFIER_REV)\\n+    if not path.exists(outpath):\\n+        with ZipFile(fn) as fd:\\n+            fd.extractall(path=path.dirname(outpath))\\n+    assert path.exists(outpath), \\\"Error extracting\\\"\\n+    log.debug(\\\"adding wrappers (%s) to MATLAB path\\\", outpath)\\n+    eng.addpath(outpath, nargout=0)\\n+    return eng\\n+\\n+\\n+def main(*args, **kwargs):\\n+    args = argopt(__doc__).parse_args(*args, **kwargs)\\n+    logging.basicConfig(level=logging.INFO)\\n+    eng = ensure_mbeautifier()\\n+    formatter = eng.MBeautify.formatFileNoEditor\\n+\\n+    for fn in tmap(path.abspath, args.mfile):\\n+        log.debug(\\\"file:%s\\\", fn)\\n+        formatter(fn, fn, nargout=0)\\n+\\n+\\n+if __name__ == \\\"__main__\\\":  # pragma: no cover\\n+    main()\\n\",\"diff --git a/miutil/plot.py b/miutil/plot.py\\nindex 113998d..5eb3171 100644\\n--- a/miutil/plot.py\\n+++ b/miutil/plot.py\\n@@ -1,9 +1,39 @@\\n from os import path\\n from textwrap import dedent\\n+\\n import matplotlib.pyplot as plt\\n+import numpy as np\\n+from matplotlib import cm\\n \\n from .imio import imread\\n \\n+show = plt.show  # convenience: for use after `imscroll`\\n+\\n+\\n+def apply_cmap(**kwargs):\\n+    \\\"\\\"\\\"Apply different cmaps to inputs an average the results.\\n+\\n+    Args:\\n+      **kwargs: map named cmap to ndarray\\n+\\n+    >>> vol1 = np.random.random((10, 10, 10))\\n+    >>> vol2 = np.random.random((10, 10, 10))\\n+    >>> res = apply_cmap(magma=vol1, bone=vol2)\\n+    >>> assert res.shape == (10, 10, 10, 4)  # RGBA\\n+    >>> imscroll(res[None])  # (1, 10, 10, 10, 4) for (N, Z, Y, X, RGBA)\\n+    \\\"\\\"\\\"\\n+    res = None\\n+    for v in kwargs.values():\\n+        if res is None:\\n+            res = np.zeros(v.shape + (4,), dtype=np.float32)\\n+        else:\\n+            assert v.shape == res.shape[:-1], \\\"all inputs must have same shape\\\"\\n+    for k, v in kwargs.items():\\n+        cmap = getattr(cm, k)\\n+        res += cmap(v)\\n+    res /= len(kwargs)\\n+    return res\\n+\\n \\n class imscroll:\\n     \\\"\\\"\\\"\\n@@ -137,10 +167,7 @@ class imscroll:\\n             ]\\n         else:\\n             z = ndi.map_coordinates(\\n-                arr,\\n-                np.vstack((x, y)),\\n-                order=self.order,\\n-                mode=\\\"nearest\\\",\\n+                arr, np.vstack((x, y)), order=self.order, mode=\\\"nearest\\\"\\n             )\\n         self.picked = []\\n         self.key[\\\"control\\\"] = False\\n\",\"diff --git a/miutil/web.py b/miutil/web.py\\nnew file mode 100644\\nindex 0000000..9d759bf\\n--- /dev/null\\n+++ b/miutil/web.py\\n@@ -0,0 +1,65 @@\\n+import logging\\n+from os import W_OK, access, path, remove\\n+\\n+import requests\\n+from tqdm.auto import tqdm\\n+\\n+from .fdio import create_dir\\n+\\n+log = logging.getLogger(__name__)\\n+\\n+\\n+def get_file(fname, origin, cache_dir=None, chunk_size=None):\\n+    \\\"\\\"\\\"\\n+    Downloads a file from a URL if it not already in the cache.\\n+    By default the file at the url `origin` is downloaded to the\\n+    cache_dir `~/.miutil`, and given the filename `fname`.\\n+    The final location of a file\\n+    `foo.zip` would therefore be `~/.miutil/foo.zip`.\\n+    Vaguely based on:\\n+    https://github.com/keras-team/keras/blob/master/keras/utils/data_utils.py\\n+\\n+    Args:\\n+      fname (str): Name of the file. If an absolute path\\n+        `/path/to/file.txt` is specified the file will be saved at that\\n+        location.\\n+      origin (str): Original URL of the file.\\n+      cache_dir (str): Location to store cached files, when None it\\n+        defaults to `~/.miutil`.\\n+    Returns:\\n+      str: Path to the downloaded file\\n+    \\\"\\\"\\\"\\n+    if cache_dir is None:\\n+        cache_dir = path.join(\\\"~\\\", \\\".miutil\\\")\\n+    cache_dir = path.expanduser(cache_dir)\\n+    create_dir(cache_dir)\\n+    if not access(cache_dir, W_OK):\\n+        cache_dir = path.join(\\\"/tmp\\\", \\\".miutil\\\")\\n+        create_dir(cache_dir)\\n+\\n+    fpath = path.join(cache_dir, fname)\\n+\\n+    if not path.exists(fpath):\\n+        log.debug(\\\"Downloading %s from %s\\\" % (fpath, origin))\\n+        try:\\n+            d = requests.get(origin, stream=True)\\n+            with tqdm(\\n+                total=float(d.headers.get(\\\"Content-length\\\") or 0),\\n+                desc=fname,\\n+                unit=\\\"B\\\",\\n+                unit_scale=True,\\n+                unit_divisor=1024,\\n+                leave=False,\\n+            ) as fprog:\\n+                with open(fpath, \\\"wb\\\") as fo:\\n+                    for chunk in d.iter_content(chunk_size=chunk_size):\\n+                        fo.write(chunk)\\n+                        fprog.update(len(chunk))\\n+                fprog.total = fprog.n\\n+                fprog.refresh()\\n+        except (Exception, KeyboardInterrupt):\\n+            if path.exists(fpath):\\n+                remove(fpath)\\n+            raise\\n+\\n+    return fpath\\n\",\"diff --git a/pyproject.toml b/pyproject.toml\\nindex 4d84990..c7c75fa 100644\\n--- a/pyproject.toml\\n+++ b/pyproject.toml\\n@@ -5,3 +5,6 @@ build-backend = \\\"setuptools.build_meta\\\"\\n [tool.setuptools_scm]\\n write_to = \\\"miutil/_dist_ver.py\\\"\\n write_to_template = \\\"__version__ = '{version}'\\\\n\\\"\\n+\\n+[tool.black]\\n+target-version = ['py27', 'py36']\\n\",\"diff --git a/setup.py b/setup.py\\nindex 6068493..d5d43d7 100644\\n--- a/setup.py\\n+++ b/setup.py\\n@@ -1,3 +1,3 @@\\n from setuptools import setup\\n \\n-setup()\\n+setup(use_scm_version=True)\\n\"]", "test_patch": "[\"diff --git a/.github/workflows/test.yml b/.github/workflows/test.yml\\nindex be59afb..4570d15 100644\\n--- a/.github/workflows/test.yml\\n+++ b/.github/workflows/test.yml\\n@@ -15,13 +15,27 @@ jobs:\\n     - uses: actions/setup-python@v2\\n       with:\\n         python-version: ${{ matrix.python }}\\n+    - name: set PYSHA\\n+      run: echo \\\"PYSHA=$(python -VV | sha256sum | cut -d' ' -f1)\\\" >> $GITHUB_ENV\\n+    - uses: actions/cache@v1\\n+      with:\\n+        path: ~/.cache/pre-commit\\n+        key: pre-commit|${{ env.PYSHA }}|${{ hashFiles('.pre-commit-config.yaml') }}\\n     - run: pip install -U .[dev]\\n     - run: python setup.py sdist bdist_wheel\\n     - run: twine check dist/*\\n-    - run: flake8 .\\n+    - uses: reviewdog/action-setup@v1\\n+    - if: github.event_name != 'schedule'\\n+      run: |\\n+        set -o pipefail\\n+        pre-commit run -a flake8 | \\\\\\n+          reviewdog -f=pep8 -name=flake8 -tee -reporter=github-check -filter-mode nofilter\\n+      env:\\n+        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}\\n     - if: |\\n         ! startsWith(matrix.python, '2')\\n-      run: black --check .\\n+      run: pre-commit run -a --show-diff-on-failure black\\n+    - run: pre-commit run -a --show-diff-on-failure isort\\n   test:\\n     runs-on: ubuntu-latest\\n     strategy:\\n@@ -59,6 +73,8 @@ jobs:\\n     runs-on: ubuntu-latest\\n     steps:\\n     - uses: actions/checkout@v2\\n+      with:\\n+        fetch-depth: 0\\n     - uses: casperdcl/deploy-pypi@v1\\n       with:\\n         build: true\\n\",\"diff --git a/setup.cfg b/setup.cfg\\nindex 108d848..cc66b85 100644\\n--- a/setup.cfg\\n+++ b/setup.cfg\\n@@ -49,8 +49,7 @@ include_package_data = True\\n packages = find:\\n [options.extras_require]\\n dev =\\n-    black; python_version >= \\\"3.0\\\"\\n-    flake8\\n+    pre-commit\\n     twine\\n     wheel\\n     pytest\\n@@ -58,23 +57,26 @@ dev =\\n     pytest-timeout\\n     pytest-xdist\\n     codecov\\n-nii =\\n-    nibabel\\n-    numpy\\n-plot =\\n-    matplotlib\\n-    numpy\\n-    scipy\\n-cuda =\\n-    argopt\\n-    pynvml\\n+nii = nibabel; numpy\\n+plot = matplotlib; numpy; scipy\\n+cuda = argopt; pynvml\\n+web = requests; tqdm\\n+mbeautify = argopt; %(web)s\\n+[options.entry_points]\\n+console_scripts =\\n+    cuinfo = miutil.cuinfo:main\\n+    mbeautify = miutil.mlab.beautify:main\\n [options.package_data]\\n * = *.md, *.rst, *.m\\n \\n+[bdist_wheel]\\n+universal = 1\\n+\\n [flake8]\\n max_line_length = 88\\n-extend-ignore = E203\\n+extend-ignore = E203,P1\\n exclude = .git,__pycache__,build,dist,.eggs\\n \\n-[bdist_wheel]\\n-universal = 1\\n+[isort]\\n+profile = black\\n+known_first_party = miutil,tests\\n\",\"diff --git a/tests/__main__.py b/tests/__main__.py\\nindex d81f47d..2f38ac5 100644\\n--- a/tests/__main__.py\\n+++ b/tests/__main__.py\\n@@ -1,5 +1,5 @@\\n-from os import chdir, path\\n import sys\\n+from os import chdir, path\\n from subprocess import check_call\\n \\n chdir(path.dirname(path.dirname(path.abspath(__file__))))\\n\",\"diff --git a/tests/test_fdio.py b/tests/test_fdio.py\\nindex 6c8f607..358e5ba 100644\\n--- a/tests/test_fdio.py\\n+++ b/tests/test_fdio.py\\n@@ -1,13 +1,25 @@\\n+import logging\\n from os import path\\n+from shutil import rmtree\\n \\n from miutil import fdio\\n \\n \\n-def test_create_dir(tmp_path):\\n+def test_create_dir(tmp_path, caplog):\\n     tmpdir = str(tmp_path / \\\"create_dir\\\")\\n     assert not path.exists(tmpdir)\\n     fdio.create_dir(tmpdir)\\n     assert path.exists(tmpdir)\\n+    rmtree(tmpdir, True)\\n+\\n+    with open(tmpdir, \\\"w\\\") as fd:\\n+        fd.write(\\\"dummy file\\\")\\n+    with caplog.at_level(logging.INFO):\\n+        assert \\\"cannot create\\\" not in caplog.text\\n+        fdio.create_dir(tmpdir)\\n+        assert \\\"cannot create\\\" in caplog.text\\n+\\n+    assert path.exists(tmpdir)\\n \\n \\n def test_hasext():\\n\",\"diff --git a/tests/test_mlab.py b/tests/test_mlab.py\\nindex 3b0e2df..9f1f429 100644\\n--- a/tests/test_mlab.py\\n+++ b/tests/test_mlab.py\\n@@ -1,9 +1,10 @@\\n from pytest import importorskip\\n \\n+engine = importorskip(\\\"matlab.engine\\\")\\n+\\n \\n def test_matlab():\\n-    engine = importorskip(\\\"matlab.engine\\\")\\n-    from miutil.mlab import get_engine\\n+    from miutil.mlab import beautify, get_engine\\n \\n     assert not engine.find_matlab()\\n     eng = get_engine()\\n@@ -14,3 +15,6 @@ def test_matlab():\\n     assert engine.find_matlab()\\n     eng2 = get_engine()\\n     assert eng == eng2\\n+\\n+    eng = beautify.ensure_mbeautifier()\\n+    assert eng.MBeautify.formatFileNoEditor\\n\",\"diff --git a/tests/test_web.py b/tests/test_web.py\\nnew file mode 100644\\nindex 0000000..a54b519\\n--- /dev/null\\n+++ b/tests/test_web.py\\n@@ -0,0 +1,16 @@\\n+from os import path\\n+\\n+from pytest import importorskip\\n+\\n+web = importorskip(\\\"miutil.web\\\")\\n+\\n+\\n+def test_get_file(tmp_path):\\n+    tmpdir = str(tmp_path / \\\"get_file\\\")\\n+    assert not path.exists(tmpdir)\\n+    web.get_file(\\n+        \\\"README.rst\\\",\\n+        \\\"https://github.com/AMYPAD/miutil/raw/master/README.rst\\\",\\n+        cache_dir=tmpdir,\\n+    )\\n+    assert path.exists(path.join(tmpdir, \\\"README.rst\\\"))\"]", "hints_text": ""}
