{"instance_id": "753142924280867", "repo": "plantandfoodresearch/mchap", "base_commit": "49b671695ba8e27c23a9ced9b6d56ed4a5c73c08", "problem_statement": "Posterior weighted allele counts:\\nSee #98 for background\\r\\n\\r\\nConsider adding an optional field of length \"A\" (one value for each allele) which contains the dosage of each allele weighted by posterior probability of each genotype for a sample.\\r\\nThis would be interpreted as a floating point best estimate of allele counts in each individual and could be summed over all individuals to to produce an approximation of allele frequencies in the population.\\r\\n\\r\\nAn example of calculating this over a full posterior distribution may look like this:\\r\\n```python\\r\\n@njit(cache=True)\\r\\ndef dosage_posterior(posteriors, ploidy, n_alleles):\\r\\n    n_genotypes = len(posteriors)\\r\\n    dosage_posterior = np.zeros(n_alleles, dtype=np.float32)\\r\\n    genotype = np.zeros(ploidy, np.int64)\\r\\n    for i in range(n_genotypes):\\r\\n        p = posteriors[i]\\r\\n        for j in range(ploidy):\\r\\n            dosage_posterior[genotype[j]] += p\\r\\n        increment_genotype(genotype)\\r\\n    return dosage_posterior\\r\\n```\\r\\n\\r\\nBut this could be calculated more efficiently directly from the trace of an MCMC.", "FAIL_TO_PASS": ["mchap/tests/test_calling/test_calling_exact.py::test_call_posterior_mode__fuzz[3-10-0.02-15-10]", "mchap/tests/test_application_call.py::test_Program__run_stdout[1-bams1-cli_extra1-simple.output.mixed_depth.call.frequencies.vcf]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1-10-bams2-cli_extra2-simple.output.mixed_depth.assemble.frequencies.vcf]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2-10-bams2-cli_extra2-simple.output.mixed_depth.assemble.frequencies.vcf]", "mchap/tests/test_calling/test_calling_exact.py::test_call_posterior_mode__fuzz[4-6-0.01-10-20]", "mchap/tests/test_assemble/test_classes.py::test_PosteriorGenotypeDistribution__allele_occurrence", "mchap/tests/test_application_call.py::test_Program__run_stdout[2-bams1-cli_extra1-simple.output.mixed_depth.call.frequencies.vcf]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1--1-bams2-cli_extra2-simple.output.mixed_depth.assemble.frequencies.vcf]", "mchap/tests/test_calling/test_calling_exact.py::test_call_posterior_mode", "mchap/tests/test_calling/test_calling_exact.py::test_call_posterior_mode__fuzz[2-3-0.0-4-1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2--1-bams2-cli_extra2-simple.output.mixed_depth.assemble.frequencies.vcf]", "mchap/tests/test_assemble/test_classes.py::test_PosteriorGenotypeDistribution__allele_frequencies", "mchap/tests/test_application_call_exact.py::test_Program__run_stdout[2-bams1-cli_extra1-simple.output.mixed_depth.call-exact.frequencies.vcf]", "mchap/tests/test_application_call_exact.py::test_Program__run_stdout[1-bams1-cli_extra1-simple.output.mixed_depth.call-exact.frequencies.vcf]"], "PASS_TO_PASS": ["mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change__fuzz[4-5-interval0-indicies0-10]", "mchap/tests/test_io/test_loci.py::test_Locus__format_haplotypes", "mchap/tests/test_mset.py::test_contains[2]", "mchap/tests/test_io/test_io_util.py::test_qual_of_char", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[0]", "mchap/tests/test_assemble/test_classes.py::test_PhenotypeDistribution___call_phenotype[90]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_2[0.99-0]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype12-0-16-0.5--4.1588830833596715]", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype2-1-2]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage8-24]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage7-16-0.1-0.0003901394930752838]", "mchap/tests/test_application_assemble.py::test_Program__header", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change__fuzz[4-8-interval3-indicies3-10]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage10-1.0-6-0.007936507936507929]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage5-0.1-6-0.0002670940170940169]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleKmerFilter[fail]", "mchap/tests/test_jitutils.py::test_array_equal[2]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[6-16-0]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[42]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[array-integer]", "mchap/tests/test_io/test_bam.py::test_encode_read_distributions", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype6-3-4-0.5--2.772588722239781]", "mchap/tests/test_encoding/test_integer.py::test_as_probabilistic", "mchap/tests/test_assemble/test_structural.py::test_dosage_step_options[4x-1]", "mchap/tests/test_jitutils.py::test_sum_log_probs", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[45436]", "mchap/tests/test_calling/test_calling_utils.py::test_allelic_dosage[genotype1-expect1]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SamplePassFilter", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype4-3-0]", "mchap/tests/test_application_assemble.py::test_Program__output_pysam", "mchap/tests/test_assemble/test_arraymap.py::test_get_set_get", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[2x-het-het-interval]", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-overwrite]", "mchap/tests/test_mset.py::test_add", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype5-2-1]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SamplePhenotypeProbabilityFilter[pass]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[13]", "mchap/tests/test_mset.py::test_unique_counts", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence__cnv[0.6-2]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood__fuzz[4-8-10]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage9-1.0-6-0.007936507936507929]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.0-False-False]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype3-1-4-0.1--0.8266785731844679]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[4-32-0]", "mchap/tests/test_mset.py::test_subtract", "mchap/tests/test_io/test_bam.py::test_extract_read_variants", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.0-False-False]", "mchap/tests/test_mset.py::test_within[3]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__zero_snps", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[213]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage2-0.1-4-0.015887605042016827]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[2-16-0.5]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__temperatures_bias[temperatures2]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__DenovoMCMC_equivalence[36]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleDepthFilter[pass]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage9-16-0.1-0.0006753748113458795]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.25-True-True]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__zero_reads__inbred", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.25-False-False]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.0-False-True]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[tuple-integer]", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[3-11]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype9-0-16-0.0--2.772588722239781]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[2x-hom]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.0-True-True]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleKmerFilter[pass]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__temperatures_bias[temperatures3]", "mchap/tests/test_io/test_loci.py::test_Locus__set_variants__empty", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage3-0.1-4-0.02022058823529413]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[1024-4-46081900800]", "mchap/tests/test_assemble/test_inheritence.py::test_gamete_probabilities__het", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__homozygous_deep[False]", "mchap/tests/test_jitutils.py::test_comb[7-2]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[10-2-None]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[4-16-0.15]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.0-True-False]", "mchap/tests/test_jitutils.py::test_comb[1-1]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.0-True-True]", "mchap/tests/test_application_call.py::test_Program__run_stdout[2-bams0-cli_extra0-simple.output.mixed_depth.call.vcf]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[3x-1:2]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__gibbs_mh_equivalence[0]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[3x-1:2]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[nan]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[list-mixed]", "mchap/tests/test_jitutils.py::test_genotype_alleles_as_index", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__DenovoMCMC_equivalence[0]", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[0.5-16-0.0625]", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence[0.8-0]", "mchap/tests/test_application_call_exact.py::test_Program__run_stdout[1-bams0-cli_extra0-simple.output.mixed_depth.call-exact.vcf]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[3x-2:1]", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[1-11]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype2-0-4-0.1--0.8266785731844679]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[374645]", "mchap/tests/test_assemble/test_classes.py::test_PosteriorGenotypeDistribution", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleReadCountFilter[fail]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.25-False-False]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.25-True-False]", "mchap/tests/test_assemble/test_classes.py::test_PhenotypeDistribution___call_phenotype[99]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__non_variable", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood__read_counts", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[13]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage4-16-0.0-1.5258789062500007e-05]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage5-1]", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.0-True-True]", "mchap/tests/test_io/test_io_util.py::test_qual_of_prob", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[0-1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[-1-CHR3:20-40-CHR3_20_40]", "mchap/tests/test_application_call_exact.py::test_Program__run_stdout[2-bams0-cli_extra0-simple.output.mixed_depth.call-exact.vcf]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[4x-6]", "mchap/tests/test_io/test_loci.py::test_Locus__set_variants__duplicate", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage1-0.1-4-0.002888655462184875]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_cache__fuzz[4-3-10]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_1[0.6-1]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[2x-het-hom-interval]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[2x-0]", "mchap/tests/test_application_assemble.py::test_Program__cli", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step__mask_ragged", "mchap/tests/test_calling/test_calling_utils.py::test_posterior_as_array", "mchap/tests/test_io/test_vcf/test_filters.py::test_FilterCall__str[fail]", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[0-11]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[1024-6-1624866254968320]", "mchap/tests/test_jitutils.py::test_array_equal[4]", "mchap/tests/test_application_assemble.py::test_Program__cli_lists", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[2x-het-zero-width-interval]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[11]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[11]", "mchap/tests/test_assemble/test_structural.py::test_dosage_step_options[2x-hom]", "mchap/tests/test_mset.py::test_within[0]", "mchap/tests/test_assemble/test_haplotype_calling.py::test_call_posterior_haplotypes__no_ref", "mchap/tests/test_jitutils.py::test_sample_snv_alleles", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-switch]", "mchap/tests/test_io/test_loci.py::test_Locus__format_variants", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[45436]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[2x-het-zero-width-interval]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__zero_reads", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__temperatures_submode", "mchap/tests/test_jitutils.py::test_set_haplotype_dosage", "mchap/tests/test_encoding/test_integer.py::test_from_strings", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.25-False-True]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage0-1]", "mchap/tests/test_calling/test_calling_exact.py::test_alternate_dosage_posteriors", "mchap/tests/test_jitutils.py::test_array_equal[0]", "mchap/tests/test_mset.py::test_within[2]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[11]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[1024-2-None]", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence__cnv[0.8-0]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage4-0.1-4-0.1567095588235296]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[42]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleReadCountFilter[pass]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__temperatures_bias[temperatures1]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[empty-string]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage5-16-0.1-0.00020224831321022713]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[10-CHR1:5-25-CHR1_05_25]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.25-True-False]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[3x-2:1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1--1-bams0-cli_extra0-simple.output.deep.assemble.vcf]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage8-16-0.1-0.00042655251242897644]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[374645]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[4-16-0]", "mchap/tests/test_io/test_vcf/test_filters.py::test_FilterCall__str[not-applied]", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.0-True-False]", "mchap/tests/test_io/test_vcf/test_filters.py::test_FilterCall__str[pass]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.25-True-False]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[4x-0]", "mchap/tests/test_io/test_loci.py::test_read_bed4__plain_vs_zipped", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[-1-CHR2:10-30-CHR2_10_30]", "mchap/tests/test_application_assemble.py::test_Program__output_bed_positions", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.25-True-True]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2-10-bams0-cli_extra0-simple.output.deep.assemble.vcf]", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-recombine]", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-multi]", "mchap/tests/test_jitutils.py::test_comb[100-3]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1-10-bams0-cli_extra0-simple.output.deep.assemble.vcf]", "mchap/tests/test_mset.py::test_unique", "mchap/tests/test_assemble/test_classes.py::test_PhenotypeDistribution___call_phenotype[65]", "mchap/tests/test_assemble/test_structural.py::test_dosage_step_options[6x]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.0-False-True]", "mchap/tests/test_encoding/test_integer.py::test_argsort", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-partial-overwrite]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__gibbs_mh_equivalence[42]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[45436]", "mchap/tests/test_jitutils.py::test_add_log_prob", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change[2x-overwrite]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood__fuzz[2-5-10]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage0-16-0.0-0.0003662109375]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__tetraploid", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[1-4-0.0]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage1-2]", "mchap/tests/test_calling/test_calling_utils.py::test_allelic_dosage[genotype0-expect0]", "mchap/tests/test_assemble/test_haplotype_calling.py::test_call_posterior_haplotypes", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[12234]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.0-True-True]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[213]", "mchap/tests/test_jitutils.py::test_array_equal[1]", "mchap/tests/test_encoding/test_integer.py::test_as_strings", "mchap/tests/test_mset.py::test_equal[0]", "mchap/tests/test_mset.py::test_equal[3]", "mchap/tests/test_combinatorics.py::test_count_unique_genotype_permutations", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage1-2]", "mchap/tests/test_io/test_bam.py::test_encode_read_alleles", "mchap/tests/test_jitutils.py::test_index_as_genotype_alleles", "mchap/tests/test_mset.py::test_union", "mchap/tests/test_jitutils.py::test_normalise_log_probs_zeros", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__homozygous_shallow[True]", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.25-True-True]", "mchap/tests/test_io/test_bam.py::test_encode_read_distributions__zero_reads_or_snps", "mchap/tests/test_calling/test_calling_utils.py::test_allelic_dosage[genotype4-expect4]", "mchap/tests/test_jitutils.py::test_comb[0-0]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SamplePhenotypeProbabilityFilter[fail]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[12-4-1365]", "mchap/tests/test_io/test_bam.py::test_extract_sample_ids", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage5-1]", "mchap/tests/test_mset.py::test_within[1]", "mchap/tests/test_jitutils.py::test_comb[20-4]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage6-16-0.1-0.00028090043501420423]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[list-floats]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage8-1.0-6-0.007936507936507929]", "mchap/tests/test_encoding/test_integer.py::test_minimum_error_correction", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1-10-bams1-cli_extra1-simple.output.mixed_depth.assemble.vcf]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.0-False-False]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[2x-het]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__temperatures_bias[temperatures0]", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype0-0-1]", "mchap/tests/test_application_call.py::test_Program__run_stdout[1-bams0-cli_extra0-simple.output.mixed_depth.call.vcf]", "mchap/tests/test_application_assemble.py::test_Program__run[cli_extra0-simple.output.deep.assemble.vcf]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[4x-2:2-interval]", "mchap/tests/test_combinatorics.py::test_count_unique_haplotypes", "mchap/tests/test_io/test_bam.py::test_encode_read_distributions__zero_snps", "mchap/tests/test_assemble/test_classes.py::test_PhenotypeDistribution___call_phenotype[85]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_cache__fuzz[4-8-1000]", "mchap/tests/test_encoding/test_integer.py::test_sort", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__zero_reads", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_cache__fuzz[2-3-10]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[4x-1:2:1]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.25-True-True]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[4x-1:2:1]", "mchap/tests/test_application_assemble.py::test_Program__run[cli_extra1-simple.output.deep.assemble.vcf]", "mchap/tests/test_io/test_loci.py::test_Locus__set_variants__simple", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage16-0.1-16-0.0010538600891861704]", "mchap/tests/test_assemble/test_inheritence.py::test_cross_probabilities__hom_x_het", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[333-3-None]", "mchap/tests/test_io/test_bam.py::test_encode_read_distributions__zero_reads", "mchap/tests/test_assemble/test_mcmc.py::test_read_mean_dist", "mchap/tests/test_io/test_loci.py::test_Locus__from_region_string", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage0-1]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[4x-3]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[10-CHR2:10-30-CHR2_10_30]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[2x-het-hom-interval]", "mchap/tests/test_assemble/test_mcmc.py::test_point_beta_probabilities", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence[0.6-1]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.25-False-True]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[12-4-None]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.0-False-False]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__gibbs_mh_equivalence[36]", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[12234]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage11-1.0-16-0.0002579979360165113]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_2[0.6-2]", "mchap/tests/test_io/test_loci.py::test_Locus__set_sequence", "mchap/tests/test_encoding/test_integer.py::test_min_kmer_coverage[reads2-genotype2-ks2-expect2]", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[20-100]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__fuzz", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage6-1]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype5-1-4-0.5--0.2076393647782445]", "mchap/tests/test_mset.py::test_contains[0]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage18-0.1-16-0.010394892697881882]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype7-2-4-0.5--2.772588722239781]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[4x-1]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype11-3-16-0.1--2.038619547159582]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change__fuzz[4-8-interval2-indicies2-10]", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[2-5]", "mchap/tests/test_assemble/test_arraymap.py::test_set__empty_if_full", "mchap/tests/test_encoding/test_integer.py::test_min_kmer_coverage[reads1-genotype1-ks1-expect1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2--1-bams0-cli_extra0-simple.output.deep.assemble.vcf]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__nan_reads", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.0-True-False]", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype6-3-2]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2--1-bams1-cli_extra1-simple.output.mixed_depth.assemble.vcf]", "mchap/tests/test_assemble/test_structural.py::test_structural_change[4x-no-change]", "mchap/tests/test_assemble/test_inheritence.py::test_gamete_probabilities__hom", "mchap/tests/test_jitutils.py::test_comb[30-20]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__nan_reads__inbred", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.25-False-False]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage0-0.1-4-0.0005252100840336145]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage7-6]", "mchap/tests/test_assemble/test_arraymap.py::test_set__grow_values", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[1-16-0.0]", "mchap/tests/test_assemble/test_structural.py::test_dosage_step_options[4x-3]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood__fuzz[4-3-10]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__homozygous_shallow[False]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.25-False-True]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[2-16-0.1]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage7-0.1-6-0.07969417735042751]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[10-CHR1:30-50-CHR1_30_50]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[1312]", "mchap/tests/test_application_assemble.py::test_Program__output_reference_positions", "mchap/tests/test_mset.py::test_equal[1]", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.0-False-True]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage6-0.1-6-0.0014690170940170905]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[0]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage2-1]", "mchap/tests/test_assemble/test_structural.py::test_interval_step__recombination[0.25-False-False]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[6-16-0.2]", "mchap/tests/test_assemble/test_mcmc.py::test_homozygosity_probabilities", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage14-0.1-16-3.483835005574126e-05]", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[2x-het]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__nans_ignored", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__DenovoMCMC_equivalence[13]", "mchap/tests/test_application_assemble.py::test_genotype_as_alleles", "mchap/tests/test_jitutils.py::test_array_equal[3]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[2-10-bams1-cli_extra1-simple.output.mixed_depth.assemble.vcf]", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence[0.99-0]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage3-16-0.0-6.103515625000003e-05]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[4-32-0.1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[-1-CHR1:5-25-CHR1_05_25]", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[0.5-4-0.25]", "mchap/tests/test_io/test_loci.py::test_Locus__attributes", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[213]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype0-0-4-0.0--1.3862943611198906]", "mchap/tests/test_assemble/test_arraymap.py::test_set__grow_tree", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage17-0.1-16-0.0013412764771460362]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__zero_snps", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype1-0-0]", "mchap/tests/test_jitutils.py::test_comb[87-4]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_cache__fuzz[4-40-1000]", "mchap/tests/test_calling/test_calling_classes.py::test_CallingMCMC__many_haplotype", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.25-False-True]", "mchap/tests/test_io/test_vcf/test_filters.py::test_FilterCallSet__str", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[list-integer]", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[0.1-4-2.25]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage7-6]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__all_nans", "mchap/tests/test_assemble/test_structural.py::test_haplotype_segment_labels[4x-1:3-interval]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[4x-2:2-interval]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__zero_reads_or_snps", "mchap/tests/test_assemble/test_structural.py::test_interval_step__dosage_swap[0.0-True-False]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[None]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage3-6]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__homozygous_deep[True]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change[2x-no-change]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[2-16-0]", "mchap/tests/test_calling/test_calling_utils.py::test_allelic_dosage[genotype2-expect2]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage2-1]", "mchap/tests/test_mset.py::test_equal[2]", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage2-16-0.0-9.155273437499999e-05]", "mchap/tests/test_mset.py::test_contains[1]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[integer]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage15-0.1-16-0.00019161092530657658]", "mchap/tests/test_assemble/test_mutation.py::test_base_step[0.25-True-False]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage13-1.0-16-0.0002579979360165113]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage4-3]", "mchap/tests/test_io/test_vcf/test_vcf_util.py::test_vcfstr[array-floats]", "mchap/tests/test_assemble/test_prior.py::test_log_dirichlet_multinomial_pmf[dosage12-1.0-16-0.0002579979360165113]", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[2x-hom]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[374645]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood__fuzz[2-3-10]", "mchap/tests/test_calling/test_calling_utils.py::test_allelic_dosage[genotype3-expect3]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change__read_counts", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_structural_change__fuzz[4-5-interval1-indicies1-10]", "mchap/tests/test_mset.py::test_contains[3]", "mchap/tests/test_assemble/test_classes.py::test_PhenotypeDistribution___mode_genotype", "mchap/tests/test_calling/test_calling_utils.py::test_count_allele[genotype3-2-0]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[13]", "mchap/tests/test_assemble/test_arraymap.py::test_get__nan", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior[dosage1-16-0.0-0.00018310546875]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[0]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_1[0.8-0]", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype8-3-4-0.5--1.1631508098056809]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_2[0.8-0]", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[1312]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleDepthFilter[not-applied]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage8-24]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout[1--1-bams1-cli_extra1-simple.output.mixed_depth.assemble.vcf]", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[0.1-16-0.5625]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__seed", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage3-6]", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles[42]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[-1-CHR1:30-50-CHR1_30_50]", "mchap/tests/test_assemble/test_classes.py::test_GenotypeMultiTrace__replicate_incongruence__cnv[0.99-0]", "mchap/tests/test_jitutils.py::test_normalise_log_probs", "mchap/tests/test_assemble/test_prior.py::test_log_genotype_prior__normalised[4-16-0.45]", "mchap/tests/test_calling/test_calling_exact.py::test_genotype_posteriors", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype10-0-16-0.0--2.772588722239781]", "mchap/tests/test_io/test_io_util.py::test_prob_of_qual", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype1-0-4-0.0--1.3862943611198906]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood_cache__fuzz[2-5-10]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__diploid", "mchap/tests/test_calling/test_calling_mcmc.py::test_gibbs_mh_transition_equivalence[12234]", "mchap/tests/test_assemble/test_mutation.py::test_genotype_compound_step[0.0-False-True]", "mchap/tests/test_assemble/test_likelihood.py::test_log_likelihood", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleKmerFilter[not-applied]", "mchap/tests/test_calling/test_calling_classes.py::test_PosteriorGenotypeAllelesDistribution__as_array", "mchap/tests/test_jitutils.py::test_get_haplotype_dosage[2x-het-het-interval]", "mchap/tests/test_calling/test_calling_classes.py::test_GenotypeAllelesMultiTrace__replicate_incongruence_1[0.99-0]", "mchap/tests/test_assemble/test_structural.py::test_recombination_step_options[2x-1]", "mchap/tests/test_application_assemble.py::test_Program__run_stdout__region[10-CHR3:20-40-CHR3_20_40]", "mchap/tests/test_assemble/test_structural.py::test_dosage_step_options[2x-0]", "mchap/tests/test_calling/test_calling_classes.py::test_PosteriorGenotypeAllelesDistribution__mode", "mchap/tests/test_assemble/test_inheritence.py::test_gamete_probabilities__distribution", "mchap/tests/test_calling/test_calling_prior.py::test_log_genotype_allele_prior[genotype4-0-4-0.5--0.2076393647782445]", "mchap/tests/test_calling/test_calling_exact.py::test_genotype_likelihoods", "mchap/tests/test_assemble/test_structural.py::test_random_breaks[10-11]", "mchap/tests/test_mset.py::test_intercept", "mchap/tests/test_encoding/test_integer.py::test_min_kmer_coverage[reads0-genotype0-ks0-expect0]", "mchap/tests/test_assemble/test_snpcalling.py::test_snp_posterior__novel_allele", "mchap/tests/test_jitutils.py::test_comb[2-7]", "mchap/tests/test_assemble/test_arraymap.py::test_set__full", "mchap/tests/test_calling/test_calling_prior.py::test_inbreeding_as_dispersion[0.1-32-0.28125]", "mchap/tests/test_assemble/test_mcmc.py::test_DenovoMCMC__zero_reads", "mchap/tests/test_calling/test_calling_likelihood.py::test_log_likelihood_alleles_cached[1312]", "mchap/tests/test_io/test_vcf/test_filters.py::test_SampleDepthFilter[fail]", "mchap/tests/test_combinatorics.py::test_count_genotype_permutations[dosage4-3]", "mchap/tests/test_combinatorics.py::test_count_unique_genotypes[1024-2-524800]", "mchap/tests/test_jitutils.py::test_ln_equivalent_permutations[dosage6-1]", "mchap/tests/test_io/test_loci.py::test_read_bed4__region"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/plantandfoodresearch_mchap:49b671695ba8e27c23a9ced9b6d56ed4a5c73c08", "patch": "[\"diff --git a/mchap/application/assemble.py b/mchap/application/assemble.py\\nindex 6087be00..59893bbc 100644\\n--- a/mchap/application/assemble.py\\n+++ b/mchap/application/assemble.py\\n@@ -4,6 +4,7 @@\\n from dataclasses import dataclass\\n import pysam\\n \\n+from mchap import mset\\n from mchap.application import baseclass\\n from mchap.application.baseclass import SampleAssemblyError, SAMPLE_ASSEMBLY_ERROR\\n \\n@@ -100,7 +101,7 @@ def call_sample_genotypes(self, data):\\n         -------\\n         data : LocusAssemblyData\\n             With sampledata fields: \\\"alleles\\\", \\\"haplotypes\\\", \\\"GQ\\\", \\\"GPM\\\", \\\"PHPM\\\", \\\"PHQ\\\", \\\"MCI\\\"\\n-            and \\\"GL\\\", \\\"GP\\\" if specified.\\n+            and \\\"GL\\\", \\\"GP\\\", \\\"AFP\\\" if specified.\\n         \\\"\\\"\\\"\\n         for field in [\\n             \\\"alleles\\\",\\n@@ -112,6 +113,7 @@ def call_sample_genotypes(self, data):\\n             \\\"MCI\\\",\\n             \\\"GL\\\",\\n             \\\"GP\\\",\\n+            \\\"AFP\\\",\\n         ]:\\n             data.sampledata[field] = dict()\\n         # dict to temporarily store posteriors\\n@@ -197,6 +199,16 @@ def call_sample_genotypes(self, data):\\n                 )\\n                 data.sampledata[\\\"alleles\\\"][sample] = alleles\\n \\n+                # posterior allele frequencies if requested\\n+                if \\\"AFP\\\" in data.formatfields:\\n+                    frequencies = np.zeros(len(haplotypes))\\n+                    haps, freqs = sample_posteriors[sample].allele_frequencies()\\n+                    idx = mset.categorize(haplotypes, haps)\\n+                    frequencies[idx >= 0] = freqs[idx[idx >= 0]]\\n+                    data.sampledata[\\\"AFP\\\"][sample] = np.round(\\n+                        frequencies, self.precision\\n+                    )\\n+\\n                 # encode posterior probabilities if requested\\n                 if \\\"GP\\\" in data.formatfields:\\n                     probabilities = _genotype_posterior_as_array(\\n\",\"diff --git a/mchap/application/baseclass.py b/mchap/application/baseclass.py\\nindex dc6ce73b..2c9b5437 100644\\n--- a/mchap/application/baseclass.py\\n+++ b/mchap/application/baseclass.py\\n@@ -76,7 +76,7 @@ def info_fields(self):\\n             \\\"END\\\",\\n             \\\"NVAR\\\",\\n             \\\"SNVPOS\\\",\\n-        ]\\n+        ] + [f for f in [\\\"AFP\\\"] if f in self.report_fields]\\n         return infofields\\n \\n     def format_fields(self):\\n@@ -92,11 +92,7 @@ def format_fields(self):\\n             \\\"GPM\\\",\\n             \\\"PHPM\\\",\\n             \\\"MCI\\\",\\n-        ]\\n-        if \\\"GL\\\" in self.report_fields:\\n-            formatfields += [\\\"GL\\\"]\\n-        if \\\"GP\\\" in self.report_fields:\\n-            formatfields += [\\\"GP\\\"]\\n+        ] + [f for f in [\\\"GP\\\", \\\"GL\\\", \\\"AFP\\\", \\\"DS\\\"] if f in self.report_fields]\\n         return formatfields\\n \\n     def loci(self):\\n@@ -284,7 +280,8 @@ def sumarise_vcf_record(self, data):\\n         -------\\n         data : LocusAssemblyData\\n             With columndata fields: \\\"REF\\\" \\\"ALTS\\\" and infodata fields:\\n-            \\\"END\\\", \\\"NVAR\\\", \\\"SNVPOS\\\", \\\"AC\\\", \\\"AN\\\", \\\"NS\\\", \\\"DP\\\", \\\"RCOUNT\\\".\\n+            \\\"END\\\", \\\"NVAR\\\", \\\"SNVPOS\\\", \\\"AC\\\", \\\"AN\\\", \\\"NS\\\", \\\"DP\\\", \\\"RCOUNT\\\"\\n+            and \\\"AFP\\\" if specified.\\n         \\\"\\\"\\\"\\n         # postions\\n         data.infodata[\\\"END\\\"] = data.locus.stop\\n@@ -317,6 +314,10 @@ def sumarise_vcf_record(self, data):\\n             data.infodata[\\\"DP\\\"] = np.nansum(list(data.sampledata[\\\"DP\\\"].values()))\\n         # total read count\\n         data.infodata[\\\"RCOUNT\\\"] = np.nansum(list(data.sampledata[\\\"RCOUNT\\\"].values()))\\n+        if \\\"AFP\\\" in data.infofields:\\n+            data.infodata[\\\"AFP\\\"] = np.mean(\\n+                list(data.sampledata[\\\"AFP\\\"].values()), axis=0\\n+            ).round(self.precision)\\n         return data\\n \\n     def call_locus(self, locus):\\n\",\"diff --git a/mchap/application/call.py b/mchap/application/call.py\\nindex cb538e8f..54ccf20a 100644\\n--- a/mchap/application/call.py\\n+++ b/mchap/application/call.py\\n@@ -66,6 +66,7 @@ def call_sample_genotypes(self, data):\\n             \\\"MCI\\\",\\n             \\\"GL\\\",\\n             \\\"GP\\\",\\n+            \\\"AFP\\\",\\n         ]:\\n             data.sampledata[field] = dict()\\n         haplotypes = data.locus.encode_haplotypes()\\n@@ -107,6 +108,15 @@ def call_sample_genotypes(self, data):\\n                 data.sampledata[\\\"PHQ\\\"][sample] = qual_of_prob(phenotype_prob)\\n                 data.sampledata[\\\"MCI\\\"][sample] = incongruence\\n \\n+                # posterior allele frequencies if requested\\n+                if \\\"AFP\\\" in data.formatfields:\\n+                    frequencies = np.zeros(len(haplotypes))\\n+                    alleles, counts = np.unique(trace.genotypes, return_counts=True)\\n+                    frequencies[alleles] = counts / counts.sum()\\n+                    data.sampledata[\\\"AFP\\\"][sample] = np.round(\\n+                        frequencies, self.precision\\n+                    )\\n+\\n                 # genotype posteriors if requested\\n                 if \\\"GP\\\" in data.formatfields:\\n                     probabilities = posterior.as_array(len(haplotypes))\\n\",\"diff --git a/mchap/application/call_exact.py b/mchap/application/call_exact.py\\nindex c8ef512d..0e4baee9 100644\\n--- a/mchap/application/call_exact.py\\n+++ b/mchap/application/call_exact.py\\n@@ -14,6 +14,7 @@\\n     genotype_likelihoods,\\n     genotype_posteriors,\\n     alternate_dosage_posteriors,\\n+    posterior_allele_frequencies,\\n )\\n from mchap.jitutils import natural_log_to_log10, index_as_genotype_alleles\\n \\n@@ -65,6 +66,7 @@ def call_sample_genotypes(self, data):\\n             \\\"MCI\\\",\\n             \\\"GL\\\",\\n             \\\"GP\\\",\\n+            \\\"AFP\\\",\\n         ]:\\n             data.sampledata[field] = dict()\\n         haplotypes = data.locus.encode_haplotypes()\\n@@ -77,7 +79,11 @@ def call_sample_genotypes(self, data):\\n                 read_counts = read_counts = data.sampledata[\\\"read_dist_counts\\\"][sample]\\n \\n                 # call haplotypes\\n-                if (\\\"GL\\\" in data.formatfields) or (\\\"GP\\\" in data.formatfields):\\n+                if (\\n+                    (\\\"GL\\\" in data.formatfields)\\n+                    or (\\\"GP\\\" in data.formatfields)\\n+                    or (\\\"AFP\\\" in data.formatfields)\\n+                ):\\n                     # calculate full arrays\\n                     llks = genotype_likelihoods(\\n                         reads=reads,\\n@@ -99,7 +105,12 @@ def call_sample_genotypes(self, data):\\n                     )\\n                     phenotype_prob = phenotype_probs.sum()\\n \\n-                    # store specify arrays\\n+                    # store specified arrays\\n+                    if \\\"AFP\\\" in data.formatfields:\\n+                        freqs = posterior_allele_frequencies(\\n+                            probabilities, ploidy, len(haplotypes)\\n+                        )\\n+                        data.sampledata[\\\"AFP\\\"][sample] = np.round(freqs, self.precision)\\n                     if \\\"GL\\\" in data.formatfields:\\n                         data.sampledata[\\\"GL\\\"][sample] = np.round(\\n                             natural_log_to_log10(llks), self.precision\\n\",\"diff --git a/mchap/assemble/classes.py b/mchap/assemble/classes.py\\nindex 32967a17..5ab117fd 100644\\n--- a/mchap/assemble/classes.py\\n+++ b/mchap/assemble/classes.py\\n@@ -165,6 +165,36 @@ def haplotype_probabilities(self, return_weighted=False):\\n         else:\\n             return uhaps, uprobs\\n \\n+    def allele_frequencies(self, dosage=False):\\n+        \\\"\\\"\\\"Calculate posterior frequency of haplotype alleles.\\n+\\n+        Parameters\\n+        ----------\\n+        dosage : bool\\n+            If true then frequencies will be multiplied by ploidy\\n+            resulting in the posterior allele dosage.\\n+\\n+        Returns\\n+        -------\\n+        haplotypes : ndarray, int, shape (n_haplotypes, n_base)\\n+            Unique haplotypes.\\n+        frequencies : ndarray, float, shape (n_haplotypes, )\\n+            Posterior frequencies of haplotype alleles.\\n+        \\\"\\\"\\\"\\n+        n_gen, ploidy, n_base = self.genotypes.shape\\n+        haps = self.genotypes.reshape(n_gen * ploidy, n_base)\\n+        uhaps = mset.unique(haps)\\n+        ufreqs = np.zeros(len(uhaps), float)\\n+        freqs = {h.tobytes(): 0.0 for h in uhaps}\\n+        for gen, prob in zip(self.genotypes, self.probabilities):\\n+            for hap in gen:\\n+                freqs[hap.tobytes()] += prob\\n+        for i, hap in enumerate(uhaps):\\n+            ufreqs[i] = freqs[hap.tobytes()]\\n+        if dosage is False:\\n+            ufreqs /= ploidy\\n+        return uhaps, ufreqs\\n+\\n \\n @dataclass\\n class PhenotypeDistribution(object):\\n\",\"diff --git a/mchap/calling/exact.py b/mchap/calling/exact.py\\nindex 5c895a34..15669b6f 100644\\n--- a/mchap/calling/exact.py\\n+++ b/mchap/calling/exact.py\\n@@ -234,6 +234,21 @@ def genotype_posteriors(log_likelihoods, ploidy, n_alleles, inbreeding=0):\\n     return normalise_log_probs(posteriors)\\n \\n \\n+@njit(cache=True)\\n+def posterior_allele_frequencies(posteriors, ploidy, n_alleles, dosage=False):\\n+    n_genotypes = len(posteriors)\\n+    freqs = np.zeros(n_alleles, dtype=np.float32)\\n+    genotype = np.zeros(ploidy, np.int64)\\n+    for i in range(n_genotypes):\\n+        p = posteriors[i]\\n+        for j in range(ploidy):\\n+            freqs[genotype[j]] += p\\n+        increment_genotype(genotype)\\n+    if dosage is False:\\n+        freqs /= ploidy\\n+    return freqs\\n+\\n+\\n def alternate_dosage_posteriors(genotype_alleles, probabilities):\\n     \\\"\\\"\\\"Extract alternate dosage probabilities based on allelic phenotype.\\n \\n\",\"diff --git a/mchap/io/vcf/formatfields.py b/mchap/io/vcf/formatfields.py\\nindex 1daeeb0c..6698fb76 100644\\n--- a/mchap/io/vcf/formatfields.py\\n+++ b/mchap/io/vcf/formatfields.py\\n@@ -64,6 +64,9 @@ def __str__(self):\\n GP = FormatField(\\n     id=\\\"GP\\\", number=\\\"G\\\", type=\\\"Float\\\", descr=\\\"Genotype posterior probabilities\\\"\\n )\\n+AFP = FormatField(\\n+    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior allele frequencies\\\"\\n+)\\n MCI = FormatField(\\n     id=\\\"MCI\\\",\\n     number=1,\\n@@ -99,6 +102,7 @@ def __str__(self):\\n     AD=AD,\\n     GL=GL,\\n     GP=GP,\\n+    AFP=AFP,\\n     MCI=MCI,\\n     KMERCOV=KMERCOV,\\n     MCAP=MCAP,\\n\",\"diff --git a/mchap/io/vcf/infofields.py b/mchap/io/vcf/infofields.py\\nindex acf6e52f..7257f02f 100644\\n--- a/mchap/io/vcf/infofields.py\\n+++ b/mchap/io/vcf/infofields.py\\n@@ -31,6 +31,9 @@ def __str__(self):\\n     descr=\\\"Total number of alleles in called genotypes\\\",\\n )\\n AF = InfoField(id=\\\"AF\\\", number=\\\"A\\\", type=\\\"Float\\\", descr=\\\"Allele Frequency\\\")\\n+AFP = InfoField(\\n+    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior allele frequencies\\\"\\n+)\\n AA = InfoField(id=\\\"AA\\\", number=1, type=\\\"String\\\", descr=\\\"Ancestral allele\\\")\\n END = InfoField(id=\\\"END\\\", number=1, type=\\\"Integer\\\", descr=\\\"End position on CHROM\\\")\\n NVAR = InfoField(\\n@@ -64,6 +67,7 @@ def __str__(self):\\n     AC=AC,\\n     AN=AN,\\n     AF=AF,\\n+    AFP=AFP,\\n     AA=AA,\\n     END=END,\\n     NVAR=NVAR,\\n\",\"diff --git a/mchap/assemble/classes.py b/mchap/assemble/classes.py\\nindex 5ab117fd..9daddf1f 100644\\n--- a/mchap/assemble/classes.py\\n+++ b/mchap/assemble/classes.py\\n@@ -127,46 +127,38 @@ def mode_phenotype(self):\\n         idx = labels == mode\\n         return PhenotypeDistribution(self.genotypes[idx], self.probabilities[idx])\\n \\n-    # TODO: Speed this up for large distributions\\n-    def haplotype_probabilities(self, return_weighted=False):\\n-        \\\"\\\"\\\"Calculate posterior probability of haplotype occurrence.\\n+    def allele_frequencies(self, dosage=False):\\n+        \\\"\\\"\\\"Calculate posterior frequency of haplotype alleles.\\n \\n         Parameters\\n         ----------\\n-        return_weighted : bool\\n-            If true a second array will be returned containing the\\n-            occurrence probability weighted by the haplotype dosage.\\n+        dosage : bool\\n+            If true then frequencies will be multiplied by ploidy\\n+            resulting in the posterior allele dosage.\\n \\n         Returns\\n         -------\\n         haplotypes : ndarray, int, shape (n_haplotypes, n_base)\\n             Unique haplotypes.\\n-        probabilities : ndarray, float, shape (n_haplotypes, )\\n-            Posterior probability of haplotype occurrence.\\n+        frequencies : ndarray, float, shape (n_haplotypes, )\\n+            Posterior frequencies of haplotype alleles.\\n         \\\"\\\"\\\"\\n         n_gen, ploidy, n_base = self.genotypes.shape\\n         haps = self.genotypes.reshape(n_gen * ploidy, n_base)\\n         uhaps = mset.unique(haps)\\n-        uprobs = np.zeros(len(uhaps), float)\\n-        uweighted = np.zeros(len(uhaps), float)\\n-        for i in range(len(uhaps)):\\n-            hap = uhaps[i]\\n-            for j in range(len(self.genotypes)):\\n-                gen = self.genotypes[j]\\n-                p = self.probabilities[j]\\n-                haploid = hap[None, ...]\\n-                count = mset.count(gen, haploid)[0]\\n-                if count > 0:\\n-                    uprobs[i] += p\\n-                if return_weighted:\\n-                    uweighted[i] += p * (count / ploidy)\\n-        if return_weighted:\\n-            return uhaps, uprobs, uweighted\\n-        else:\\n-            return uhaps, uprobs\\n+        ufreqs = np.zeros(len(uhaps), float)\\n+        freqs = {h.tobytes(): 0.0 for h in uhaps}\\n+        for gen, prob in zip(self.genotypes, self.probabilities):\\n+            for hap in gen:\\n+                freqs[hap.tobytes()] += prob\\n+        for i, hap in enumerate(uhaps):\\n+            ufreqs[i] = freqs[hap.tobytes()]\\n+        if dosage is False:\\n+            ufreqs /= ploidy\\n+        return uhaps, ufreqs\\n \\n-    def allele_frequencies(self, dosage=False):\\n-        \\\"\\\"\\\"Calculate posterior frequency of haplotype alleles.\\n+    def allele_occurrence(self):\\n+        \\\"\\\"\\\"Calculate posterior probability of haplotype occurrence.\\n \\n         Parameters\\n         ----------\\n@@ -178,8 +170,8 @@ def allele_frequencies(self, dosage=False):\\n         -------\\n         haplotypes : ndarray, int, shape (n_haplotypes, n_base)\\n             Unique haplotypes.\\n-        frequencies : ndarray, float, shape (n_haplotypes, )\\n-            Posterior frequencies of haplotype alleles.\\n+        occurrence : ndarray, float, shape (n_haplotypes, )\\n+            Posterior probabilities of haplotype occurrence.\\n         \\\"\\\"\\\"\\n         n_gen, ploidy, n_base = self.genotypes.shape\\n         haps = self.genotypes.reshape(n_gen * ploidy, n_base)\\n@@ -187,12 +179,11 @@ def allele_frequencies(self, dosage=False):\\n         ufreqs = np.zeros(len(uhaps), float)\\n         freqs = {h.tobytes(): 0.0 for h in uhaps}\\n         for gen, prob in zip(self.genotypes, self.probabilities):\\n-            for hap in gen:\\n-                freqs[hap.tobytes()] += prob\\n+            phen = set([hap.tobytes() for hap in gen])\\n+            for hap in phen:\\n+                freqs[hap] += prob\\n         for i, hap in enumerate(uhaps):\\n             ufreqs[i] = freqs[hap.tobytes()]\\n-        if dosage is False:\\n-            ufreqs /= ploidy\\n         return uhaps, ufreqs\\n \\n \\n\",\"diff --git a/mchap/assemble/haplotype_calling.py b/mchap/assemble/haplotype_calling.py\\nindex 15671036..b8b79414 100644\\n--- a/mchap/assemble/haplotype_calling.py\\n+++ b/mchap/assemble/haplotype_calling.py\\n@@ -24,7 +24,11 @@ def call_posterior_haplotypes(posteriors, threshold=0.01):\\n     # iterate through genotype posterors\\n     for post in posteriors:\\n         # include haps based on probability of occurrence\\n-        haps, probs, weights = post.haplotype_probabilities(return_weighted=True)\\n+        (\\n+            haps,\\n+            probs,\\n+        ) = post.allele_occurrence()\\n+        _, weights = post.allele_frequencies(dosage=True)\\n         idx = probs >= threshold\\n         # order haps based on weighted prob\\n         haps = haps[idx]\\n\",\"diff --git a/mchap/application/call_exact.py b/mchap/application/call_exact.py\\nindex 0e4baee9..0598ce67 100644\\n--- a/mchap/application/call_exact.py\\n+++ b/mchap/application/call_exact.py\\n@@ -10,7 +10,7 @@\\n     collect_call_exact_program_arguments,\\n )\\n from mchap.calling.exact import (\\n-    call_posterior_mode,\\n+    posterior_mode,\\n     genotype_likelihoods,\\n     genotype_posteriors,\\n     alternate_dosage_posteriors,\\n@@ -122,7 +122,7 @@ def call_sample_genotypes(self, data):\\n \\n                 else:\\n                     # use low memory calculation\\n-                    alleles, _, genotype_prob, phenotype_prob = call_posterior_mode(\\n+                    alleles, _, genotype_prob, phenotype_prob = posterior_mode(\\n                         reads=reads,\\n                         read_counts=read_counts,\\n                         haplotypes=haplotypes,\\n\",\"diff --git a/mchap/calling/exact.py b/mchap/calling/exact.py\\nindex 15669b6f..aac2c877 100644\\n--- a/mchap/calling/exact.py\\n+++ b/mchap/calling/exact.py\\n@@ -90,16 +90,50 @@ def _phenotype_log_joint(genotype, reads, haplotypes, read_counts=None, inbreedi\\n     return phenotype_ljoint\\n \\n \\n-def call_posterior_mode(\\n+@njit(cache=True)\\n+def _posterior_allele_frequencies(\\n+    ldenominator, reads, ploidy, haplotypes, n_genotypes, read_counts=None, inbreeding=0\\n+):\\n+    \\\"\\\"\\\"Calculate posterior mean allele frequencies.\\\"\\\"\\\"\\n+    n_alleles = len(haplotypes)\\n+    genotype = np.zeros(ploidy, np.int64)\\n+    dosage = np.zeros(ploidy, np.int8)\\n+    freqs = np.zeros(n_alleles, dtype=np.float64)\\n+    for i in range(n_genotypes):\\n+        # log likelihood\\n+        llk = log_likelihood(\\n+            reads=reads,\\n+            genotype=haplotypes[genotype],\\n+            read_counts=read_counts,\\n+        )\\n+        # log prior\\n+        get_haplotype_dosage(dosage, genotype.reshape(ploidy, 1))\\n+        lpr = log_genotype_prior(dosage, n_alleles, inbreeding=inbreeding)\\n+        # scaled log posterior\\n+        ljoint = llk + lpr\\n+        # posterior prob\\n+        prob = np.exp(ljoint - ldenominator)\\n+        for a in genotype:\\n+            freqs[a] += prob\\n+        # next genotype\\n+        increment_genotype(genotype)\\n+    return freqs / ploidy\\n+\\n+\\n+def posterior_mode(\\n     reads,\\n     ploidy,\\n     haplotypes,\\n     read_counts=None,\\n     inbreeding=0,\\n-    return_phenotype_prob=True,\\n+    return_phenotype_prob=False,\\n+    return_posterior_frequencies=False,\\n ):\\n     \\\"\\\"\\\"Call posterior mode genotype with statistics from a set of known haplotypes.\\n \\n+    This function has a lower memory requirement than computing and storing the\\n+    entire posterior distribution in memory.\\n+\\n     Parameters\\n     ----------\\n     reads : ndarray, float, shape (n_reads, n_pos, n_nucl)\\n@@ -113,7 +147,9 @@ def call_posterior_mode(\\n     inbreeding : float\\n         Expected inbreeding coefficient of genotype.\\n     return_phenotype_prob : bool\\n-        Return the mode_phenotype_probability (default = true).\\n+        Return the mode phenotype probability (default = false).\\n+    return_posterior_frequencies : bool\\n+        Return posterior mean allele frequencies (default = false).\\n \\n     Returns\\n     -------\\n@@ -125,6 +161,8 @@ def call_posterior_mode(\\n         Posterior probability of the mode genotype.\\n     mode_phenotype_probability : float\\n         Sum posterior probability of all genotypes within the mode phenotype.\\n+    mean_allele_frequencies : ndarray, float, shape (n_alleles, )\\n+        Posterior mean allele frequencies.\\n \\n     Notes\\n     -----\\n@@ -142,18 +180,32 @@ def call_posterior_mode(\\n     )\\n     mode_genotype_prob = np.exp(mode_ljoint - total_ljoint)\\n \\n-    if not return_phenotype_prob:\\n-        return mode_genotype, mode_llk, mode_genotype_prob\\n+    result = [mode_genotype, mode_llk, mode_genotype_prob]\\n \\n-    phenotype_ljoint = _phenotype_log_joint(\\n-        genotype=mode_genotype,\\n-        reads=reads,\\n-        haplotypes=haplotypes,\\n-        read_counts=read_counts,\\n-        inbreeding=inbreeding,\\n-    )\\n-    mode_phenotype_prob = np.exp(phenotype_ljoint - total_ljoint)\\n-    return mode_genotype, mode_llk, mode_genotype_prob, mode_phenotype_prob\\n+    if return_phenotype_prob:\\n+        phenotype_ljoint = _phenotype_log_joint(\\n+            genotype=mode_genotype,\\n+            reads=reads,\\n+            haplotypes=haplotypes,\\n+            read_counts=read_counts,\\n+            inbreeding=inbreeding,\\n+        )\\n+        mode_phenotype_prob = np.exp(phenotype_ljoint - total_ljoint)\\n+        result.append(mode_phenotype_prob)\\n+\\n+    if return_posterior_frequencies:\\n+        mean_frequencies = _posterior_allele_frequencies(\\n+            ldenominator=total_ljoint,\\n+            reads=reads,\\n+            ploidy=ploidy,\\n+            haplotypes=haplotypes,\\n+            n_genotypes=n_genotypes,\\n+            read_counts=read_counts,\\n+            inbreeding=inbreeding,\\n+        )\\n+        result.append(mean_frequencies)\\n+\\n+    return tuple(result)\\n \\n \\n @njit(cache=True)\\n@@ -236,8 +288,27 @@ def genotype_posteriors(log_likelihoods, ploidy, n_alleles, inbreeding=0):\\n \\n @njit(cache=True)\\n def posterior_allele_frequencies(posteriors, ploidy, n_alleles, dosage=False):\\n+    \\\"\\\"\\\"Calculate posterior mean allele frequencies of every allele\\n+    for a given posteriors distribution.\\n+\\n+    Parameters\\n+    ----------\\n+    posteriors : ndarray, float, shape(n_genotypes, )\\n+        VCF ordered posterior probabilities.\\n+    ploidy : int\\n+        Ploidy of organism.\\n+    n_alleles : int\\n+        Total number of possible (haplotype) alleles at this locus.\\n+    dosage : bool\\n+        If true returns the posterior mean dosage rather than allele frequencies.\\n+\\n+    Returns\\n+    -------\\n+    posteriors : ndarray, float, shape(n_genotypes, )\\n+        VCF ordered posterior probability of each possible genotype.\\n+    \\\"\\\"\\\"\\n     n_genotypes = len(posteriors)\\n-    freqs = np.zeros(n_alleles, dtype=np.float32)\\n+    freqs = np.zeros(n_alleles, dtype=np.float64)\\n     genotype = np.zeros(ploidy, np.int64)\\n     for i in range(n_genotypes):\\n         p = posteriors[i]\\n\",\"diff --git a/mchap/application/call_exact.py b/mchap/application/call_exact.py\\nindex 0598ce67..863994bb 100644\\n--- a/mchap/application/call_exact.py\\n+++ b/mchap/application/call_exact.py\\n@@ -79,11 +79,7 @@ def call_sample_genotypes(self, data):\\n                 read_counts = read_counts = data.sampledata[\\\"read_dist_counts\\\"][sample]\\n \\n                 # call haplotypes\\n-                if (\\n-                    (\\\"GL\\\" in data.formatfields)\\n-                    or (\\\"GP\\\" in data.formatfields)\\n-                    or (\\\"AFP\\\" in data.formatfields)\\n-                ):\\n+                if (\\\"GL\\\" in data.formatfields) or (\\\"GP\\\" in data.formatfields):\\n                     # calculate full arrays\\n                     llks = genotype_likelihoods(\\n                         reads=reads,\\n@@ -122,14 +118,20 @@ def call_sample_genotypes(self, data):\\n \\n                 else:\\n                     # use low memory calculation\\n-                    alleles, _, genotype_prob, phenotype_prob = posterior_mode(\\n+                    mode_results = posterior_mode(\\n                         reads=reads,\\n                         read_counts=read_counts,\\n                         haplotypes=haplotypes,\\n                         ploidy=ploidy,\\n                         inbreeding=inbreeding,\\n                         return_phenotype_prob=True,\\n+                        return_posterior_frequencies=\\\"AFP\\\" in data.formatfields,\\n                     )\\n+                    alleles, _, genotype_prob, phenotype_prob = mode_results[0:4]\\n+                    if \\\"AFP\\\" in data.formatfields:\\n+                        data.sampledata[\\\"AFP\\\"][sample] = np.round(\\n+                            mode_results[-1], self.precision\\n+                        )\\n \\n                 # store variables\\n                 data.sampledata[\\\"alleles\\\"][sample] = alleles\\n\",\"diff --git a/cli-assemble-help.txt b/cli-assemble-help.txt\\nindex 5869511e..05cb996a 100644\\n--- a/cli-assemble-help.txt\\n+++ b/cli-assemble-help.txt\\n@@ -1,19 +1,18 @@\\n usage: MCMC haplotype assembly [-h] [--region REGION] [--region-id REGION_ID]\\n                                [--targets TARGETS] [--variants VARIANTS]\\n-                               [--reference REFERENCE] [--bam [BAM [BAM ...]]]\\n+                               [--reference REFERENCE] [--bam [BAM ...]]\\n                                [--bam-list BAM_LIST] [--sample-bam SAMPLE_BAM]\\n-                               [--sample-list SAMPLE_LIST] [--ploidy PLOIDY]\\n+                               [--ploidy PLOIDY]\\n                                [--sample-ploidy SAMPLE_PLOIDY]\\n                                [--inbreeding INBREEDING]\\n                                [--sample-inbreeding SAMPLE_INBREEDING]\\n                                [--base-error-rate BASE_ERROR_RATE]\\n-                               [--ignore-base-phred-scores]\\n+                               [--use-base-phred-scores]\\n                                [--mapping-quality MAPPING_QUALITY]\\n                                [--keep-duplicate-reads] [--keep-qcfail-reads]\\n                                [--keep-supplementary-reads]\\n                                [--read-group-field READ_GROUP_FIELD]\\n-                               [--genotype-likelihoods]\\n-                               [--genotype-posteriors] [--cores CORES]\\n+                               [--report [REPORT ...]] [--cores CORES]\\n                                [--mcmc-chains MCMC_CHAINS]\\n                                [--mcmc-steps MCMC_STEPS]\\n                                [--mcmc-burn MCMC_BURN] [--mcmc-seed MCMC_SEED]\\n@@ -23,7 +22,7 @@ usage: MCMC haplotype assembly [-h] [--region REGION] [--region-id REGION_ID]\\n                                [--mcmc-recombination-step-probability MCMC_RECOMBINATION_STEP_PROBABILITY]\\n                                [--mcmc-dosage-step-probability MCMC_DOSAGE_STEP_PROBABILITY]\\n                                [--mcmc-partial-dosage-step-probability MCMC_PARTIAL_DOSAGE_STEP_PROBABILITY]\\n-                               [--mcmc-temperatures [MCMC_TEMPERATURES [MCMC_TEMPERATURES ...]]]\\n+                               [--mcmc-temperatures [MCMC_TEMPERATURES ...]]\\n                                [--sample-mcmc-temperatures SAMPLE_MCMC_TEMPERATURES]\\n                                [--haplotype-posterior-threshold HAPLOTYPE_POSTERIOR_THRESHOLD]\\n \\n@@ -49,8 +48,7 @@ optional arguments:\\n                         within this file.\\n   --reference REFERENCE\\n                         Indexed fasta file containing the reference genome.\\n-  --bam [BAM [BAM ...]]\\n-                        A list of 0 or more bam files. All samples found\\n+  --bam [BAM ...]       A list of 0 or more bam files. All samples found\\n                         within the listed bam files will be genotypes unless\\n                         the --sample-list parameter is used.\\n   --bam-list BAM_LIST   A file containing a list of bam file paths (one per\\n@@ -65,12 +63,6 @@ optional arguments:\\n                         parameters when running many small jobs. An error will\\n                         be thrown if a sample is not found within its\\n                         specified bam file.\\n-  --sample-list SAMPLE_LIST\\n-                        Optionally specify a file containing a list of samples\\n-                        to genotype (one sample id per line). This file also\\n-                        specifies the sample order in the output. If not\\n-                        specified, all samples in the input bam files will be\\n-                        genotyped.\\n   --ploidy PLOIDY       Default ploidy for all samples (default = 2). This\\n                         value is used for all samples which are not specified\\n                         using the --sample-ploidy parameter\\n@@ -94,15 +86,15 @@ optional arguments:\\n                         1].\\n   --base-error-rate BASE_ERROR_RATE\\n                         Expected base error rate of read sequences (default =\\n-                        0.0). This is used in addition to base phred-scores by\\n-                        default however base phred-scores can be ignored using\\n-                        the --ignore-base-phred-scores flag.\\n-  --ignore-base-phred-scores\\n-                        Flag: Ignore base phred-scores as a source of base\\n-                        error rate. This can improve MCMC speed by allowing\\n-                        for greater de-duplication of reads however an error\\n-                        rate > 0.0 must be specified with the --base-error-\\n-                        rate argument.\\n+                        0.0024). The default value comes from Pfeiffer et al\\n+                        2018 and is a general estimate for Illumina short\\n+                        reads.\\n+  --use-base-phred-scores\\n+                        Flag: use base phred-scores as a source of base error\\n+                        rate. This will use the phred-encoded per base scores\\n+                        in addition to the general error rate specified by the\\n+                        --base-error-rate argument. Using this option can slow\\n+                        down assembly speed.\\n   --mapping-quality MAPPING_QUALITY\\n                         Minimum mapping quality of reads used in assembly\\n                         (default = 20).\\n@@ -118,11 +110,10 @@ optional arguments:\\n                         Read group field to use as sample id (default = \\\"SM\\\").\\n                         The chosen field determines tha sample ids required in\\n                         other input files e.g. the --sample-list argument.\\n-  --genotype-likelihoods\\n-                        Flag: Report genotype likelihoods in the GL VCF field.\\n-  --genotype-posteriors\\n-                        Flag: Report genotype posterior probabilities in the\\n-                        GP VCF field.\\n+  --report [REPORT ...]\\n+                        Extra fields to report within the output VCF: GP =\\n+                        genotype posterior probabilities; GL = genotype\\n+                        likelihoods.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n   --mcmc-chains MCMC_CHAINS\\n                         Number of independent MCMC chains per assembly\\n@@ -166,7 +157,7 @@ optional arguments:\\n                         Probability of performing a within-interval dosage\\n                         sub-step during each step of the MCMC. (default =\\n                         0.5).\\n-  --mcmc-temperatures [MCMC_TEMPERATURES [MCMC_TEMPERATURES ...]]\\n+  --mcmc-temperatures [MCMC_TEMPERATURES ...]\\n                         A list of inverse-temperatures to use for parallel\\n                         tempered chains. These values must be between 0 and 1\\n                         and will automatically be sorted in ascending order.\\n\",\"diff --git a/cli-call-exact-help.txt b/cli-call-exact-help.txt\\nindex fea157ee..26c1aa4b 100644\\n--- a/cli-call-exact-help.txt\\n+++ b/cli-call-exact-help.txt\\n@@ -1,26 +1,23 @@\\n usage: Exact haplotype calling [-h] [--haplotypes HAPLOTYPES]\\n-                               [--bam [BAM [BAM ...]]] [--bam-list BAM_LIST]\\n-                               [--sample-bam SAMPLE_BAM]\\n-                               [--sample-list SAMPLE_LIST] [--ploidy PLOIDY]\\n+                               [--bam [BAM ...]] [--bam-list BAM_LIST]\\n+                               [--sample-bam SAMPLE_BAM] [--ploidy PLOIDY]\\n                                [--sample-ploidy SAMPLE_PLOIDY]\\n                                [--inbreeding INBREEDING]\\n                                [--sample-inbreeding SAMPLE_INBREEDING]\\n                                [--base-error-rate BASE_ERROR_RATE]\\n-                               [--ignore-base-phred-scores]\\n+                               [--use-base-phred-scores]\\n                                [--mapping-quality MAPPING_QUALITY]\\n                                [--keep-duplicate-reads] [--keep-qcfail-reads]\\n                                [--keep-supplementary-reads]\\n                                [--read-group-field READ_GROUP_FIELD]\\n-                               [--genotype-likelihoods]\\n-                               [--genotype-posteriors] [--cores CORES]\\n+                               [--report [REPORT ...]] [--cores CORES]\\n \\n optional arguments:\\n   -h, --help            show this help message and exit\\n   --haplotypes HAPLOTYPES\\n                         Tabix indexed VCF file containing haplotype/MNP/SNP\\n                         variants to be re-called among input samples.\\n-  --bam [BAM [BAM ...]]\\n-                        A list of 0 or more bam files. All samples found\\n+  --bam [BAM ...]       A list of 0 or more bam files. All samples found\\n                         within the listed bam files will be genotypes unless\\n                         the --sample-list parameter is used.\\n   --bam-list BAM_LIST   A file containing a list of bam file paths (one per\\n@@ -35,12 +32,6 @@ optional arguments:\\n                         parameters when running many small jobs. An error will\\n                         be thrown if a sample is not found within its\\n                         specified bam file.\\n-  --sample-list SAMPLE_LIST\\n-                        Optionally specify a file containing a list of samples\\n-                        to genotype (one sample id per line). This file also\\n-                        specifies the sample order in the output. If not\\n-                        specified, all samples in the input bam files will be\\n-                        genotyped.\\n   --ploidy PLOIDY       Default ploidy for all samples (default = 2). This\\n                         value is used for all samples which are not specified\\n                         using the --sample-ploidy parameter\\n@@ -64,15 +55,15 @@ optional arguments:\\n                         1].\\n   --base-error-rate BASE_ERROR_RATE\\n                         Expected base error rate of read sequences (default =\\n-                        0.0). This is used in addition to base phred-scores by\\n-                        default however base phred-scores can be ignored using\\n-                        the --ignore-base-phred-scores flag.\\n-  --ignore-base-phred-scores\\n-                        Flag: Ignore base phred-scores as a source of base\\n-                        error rate. This can improve MCMC speed by allowing\\n-                        for greater de-duplication of reads however an error\\n-                        rate > 0.0 must be specified with the --base-error-\\n-                        rate argument.\\n+                        0.0024). The default value comes from Pfeiffer et al\\n+                        2018 and is a general estimate for Illumina short\\n+                        reads.\\n+  --use-base-phred-scores\\n+                        Flag: use base phred-scores as a source of base error\\n+                        rate. This will use the phred-encoded per base scores\\n+                        in addition to the general error rate specified by the\\n+                        --base-error-rate argument. Using this option can slow\\n+                        down assembly speed.\\n   --mapping-quality MAPPING_QUALITY\\n                         Minimum mapping quality of reads used in assembly\\n                         (default = 20).\\n@@ -88,9 +79,8 @@ optional arguments:\\n                         Read group field to use as sample id (default = \\\"SM\\\").\\n                         The chosen field determines tha sample ids required in\\n                         other input files e.g. the --sample-list argument.\\n-  --genotype-likelihoods\\n-                        Flag: Report genotype likelihoods in the GL VCF field.\\n-  --genotype-posteriors\\n-                        Flag: Report genotype posterior probabilities in the\\n-                        GP VCF field.\\n+  --report [REPORT ...]\\n+                        Extra fields to report within the output VCF: GP =\\n+                        genotype posterior probabilities; GL = genotype\\n+                        likelihoods.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n\",\"diff --git a/cli-call-help.txt b/cli-call-help.txt\\nindex f8131234..67754908 100644\\n--- a/cli-call-help.txt\\n+++ b/cli-call-help.txt\\n@@ -1,18 +1,17 @@\\n-usage: MCMC haplotype calling [-h] [--haplotypes HAPLOTYPES]\\n-                              [--bam [BAM [BAM ...]]] [--bam-list BAM_LIST]\\n-                              [--sample-bam SAMPLE_BAM]\\n-                              [--sample-list SAMPLE_LIST] [--ploidy PLOIDY]\\n+usage: MCMC haplotype calling [-h] [--haplotypes HAPLOTYPES] [--bam [BAM ...]]\\n+                              [--bam-list BAM_LIST] [--sample-bam SAMPLE_BAM]\\n+                              [--ploidy PLOIDY]\\n                               [--sample-ploidy SAMPLE_PLOIDY]\\n                               [--inbreeding INBREEDING]\\n                               [--sample-inbreeding SAMPLE_INBREEDING]\\n                               [--base-error-rate BASE_ERROR_RATE]\\n-                              [--ignore-base-phred-scores]\\n+                              [--use-base-phred-scores]\\n                               [--mapping-quality MAPPING_QUALITY]\\n                               [--keep-duplicate-reads] [--keep-qcfail-reads]\\n                               [--keep-supplementary-reads]\\n                               [--read-group-field READ_GROUP_FIELD]\\n-                              [--genotype-likelihoods] [--genotype-posteriors]\\n-                              [--cores CORES] [--mcmc-chains MCMC_CHAINS]\\n+                              [--report [REPORT ...]] [--cores CORES]\\n+                              [--mcmc-chains MCMC_CHAINS]\\n                               [--mcmc-steps MCMC_STEPS]\\n                               [--mcmc-burn MCMC_BURN] [--mcmc-seed MCMC_SEED]\\n                               [--mcmc-chain-incongruence-threshold MCMC_CHAIN_INCONGRUENCE_THRESHOLD]\\n@@ -22,8 +21,7 @@ optional arguments:\\n   --haplotypes HAPLOTYPES\\n                         Tabix indexed VCF file containing haplotype/MNP/SNP\\n                         variants to be re-called among input samples.\\n-  --bam [BAM [BAM ...]]\\n-                        A list of 0 or more bam files. All samples found\\n+  --bam [BAM ...]       A list of 0 or more bam files. All samples found\\n                         within the listed bam files will be genotypes unless\\n                         the --sample-list parameter is used.\\n   --bam-list BAM_LIST   A file containing a list of bam file paths (one per\\n@@ -38,12 +36,6 @@ optional arguments:\\n                         parameters when running many small jobs. An error will\\n                         be thrown if a sample is not found within its\\n                         specified bam file.\\n-  --sample-list SAMPLE_LIST\\n-                        Optionally specify a file containing a list of samples\\n-                        to genotype (one sample id per line). This file also\\n-                        specifies the sample order in the output. If not\\n-                        specified, all samples in the input bam files will be\\n-                        genotyped.\\n   --ploidy PLOIDY       Default ploidy for all samples (default = 2). This\\n                         value is used for all samples which are not specified\\n                         using the --sample-ploidy parameter\\n@@ -67,15 +59,15 @@ optional arguments:\\n                         1].\\n   --base-error-rate BASE_ERROR_RATE\\n                         Expected base error rate of read sequences (default =\\n-                        0.0). This is used in addition to base phred-scores by\\n-                        default however base phred-scores can be ignored using\\n-                        the --ignore-base-phred-scores flag.\\n-  --ignore-base-phred-scores\\n-                        Flag: Ignore base phred-scores as a source of base\\n-                        error rate. This can improve MCMC speed by allowing\\n-                        for greater de-duplication of reads however an error\\n-                        rate > 0.0 must be specified with the --base-error-\\n-                        rate argument.\\n+                        0.0024). The default value comes from Pfeiffer et al\\n+                        2018 and is a general estimate for Illumina short\\n+                        reads.\\n+  --use-base-phred-scores\\n+                        Flag: use base phred-scores as a source of base error\\n+                        rate. This will use the phred-encoded per base scores\\n+                        in addition to the general error rate specified by the\\n+                        --base-error-rate argument. Using this option can slow\\n+                        down assembly speed.\\n   --mapping-quality MAPPING_QUALITY\\n                         Minimum mapping quality of reads used in assembly\\n                         (default = 20).\\n@@ -91,11 +83,10 @@ optional arguments:\\n                         Read group field to use as sample id (default = \\\"SM\\\").\\n                         The chosen field determines tha sample ids required in\\n                         other input files e.g. the --sample-list argument.\\n-  --genotype-likelihoods\\n-                        Flag: Report genotype likelihoods in the GL VCF field.\\n-  --genotype-posteriors\\n-                        Flag: Report genotype posterior probabilities in the\\n-                        GP VCF field.\\n+  --report [REPORT ...]\\n+                        Extra fields to report within the output VCF: GP =\\n+                        genotype posterior probabilities; GL = genotype\\n+                        likelihoods.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n   --mcmc-chains MCMC_CHAINS\\n                         Number of independent MCMC chains per assembly\\n\",\"diff --git a/cli-assemble-help.txt b/cli-assemble-help.txt\\nindex 05cb996a..d78554cf 100644\\n--- a/cli-assemble-help.txt\\n+++ b/cli-assemble-help.txt\\n@@ -113,7 +113,7 @@ optional arguments:\\n   --report [REPORT ...]\\n                         Extra fields to report within the output VCF: GP =\\n                         genotype posterior probabilities; GL = genotype\\n-                        likelihoods.\\n+                        likelihoods; AFP = posterior mean allele frequencies.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n   --mcmc-chains MCMC_CHAINS\\n                         Number of independent MCMC chains per assembly\\n\",\"diff --git a/cli-call-exact-help.txt b/cli-call-exact-help.txt\\nindex 26c1aa4b..1888dbb8 100644\\n--- a/cli-call-exact-help.txt\\n+++ b/cli-call-exact-help.txt\\n@@ -82,5 +82,5 @@ optional arguments:\\n   --report [REPORT ...]\\n                         Extra fields to report within the output VCF: GP =\\n                         genotype posterior probabilities; GL = genotype\\n-                        likelihoods.\\n+                        likelihoods; AFP = posterior mean allele frequencies.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n\",\"diff --git a/cli-call-help.txt b/cli-call-help.txt\\nindex 67754908..7879ea73 100644\\n--- a/cli-call-help.txt\\n+++ b/cli-call-help.txt\\n@@ -86,7 +86,7 @@ optional arguments:\\n   --report [REPORT ...]\\n                         Extra fields to report within the output VCF: GP =\\n                         genotype posterior probabilities; GL = genotype\\n-                        likelihoods.\\n+                        likelihoods; AFP = posterior mean allele frequencies.\\n   --cores CORES         Number of cpu cores to use (default = 1).\\n   --mcmc-chains MCMC_CHAINS\\n                         Number of independent MCMC chains per assembly\\n\",\"diff --git a/mchap/application/arguments.py b/mchap/application/arguments.py\\nindex 6a4ea9dc..7c0739c7 100644\\n--- a/mchap/application/arguments.py\\n+++ b/mchap/application/arguments.py\\n@@ -315,7 +315,8 @@ def add_to(self, parser):\\n         help=(\\n             \\\"Extra fields to report within the output VCF: \\\"\\n             \\\"GP = genotype posterior probabilities; \\\"\\n-            \\\"GL = genotype likelihoods.\\\"\\n+            \\\"GL = genotype likelihoods; \\\"\\n+            \\\"AFP = posterior mean allele frequencies.\\\"\\n         ),\\n     ),\\n )\\n\",\"diff --git a/mchap/io/vcf/formatfields.py b/mchap/io/vcf/formatfields.py\\nindex 6698fb76..dd1f85c3 100644\\n--- a/mchap/io/vcf/formatfields.py\\n+++ b/mchap/io/vcf/formatfields.py\\n@@ -65,7 +65,7 @@ def __str__(self):\\n     id=\\\"GP\\\", number=\\\"G\\\", type=\\\"Float\\\", descr=\\\"Genotype posterior probabilities\\\"\\n )\\n AFP = FormatField(\\n-    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior allele frequencies\\\"\\n+    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior mean allele frequencies\\\"\\n )\\n MCI = FormatField(\\n     id=\\\"MCI\\\",\\n\",\"diff --git a/mchap/io/vcf/infofields.py b/mchap/io/vcf/infofields.py\\nindex 7257f02f..96d71acd 100644\\n--- a/mchap/io/vcf/infofields.py\\n+++ b/mchap/io/vcf/infofields.py\\n@@ -32,7 +32,7 @@ def __str__(self):\\n )\\n AF = InfoField(id=\\\"AF\\\", number=\\\"A\\\", type=\\\"Float\\\", descr=\\\"Allele Frequency\\\")\\n AFP = InfoField(\\n-    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior allele frequencies\\\"\\n+    id=\\\"AFP\\\", number=\\\"R\\\", type=\\\"Float\\\", descr=\\\"Posterior mean allele frequencies\\\"\\n )\\n AA = InfoField(id=\\\"AA\\\", number=1, type=\\\"String\\\", descr=\\\"Ancestral allele\\\")\\n END = InfoField(id=\\\"END\\\", number=1, type=\\\"Integer\\\", descr=\\\"End position on CHROM\\\")\\n\",\"diff --git a/mchap/application/baseclass.py b/mchap/application/baseclass.py\\nindex 2c9b5437..69814a74 100644\\n--- a/mchap/application/baseclass.py\\n+++ b/mchap/application/baseclass.py\\n@@ -314,10 +314,16 @@ def sumarise_vcf_record(self, data):\\n             data.infodata[\\\"DP\\\"] = np.nansum(list(data.sampledata[\\\"DP\\\"].values()))\\n         # total read count\\n         data.infodata[\\\"RCOUNT\\\"] = np.nansum(list(data.sampledata[\\\"RCOUNT\\\"].values()))\\n+        # population mean posterior allele frequencies\\n         if \\\"AFP\\\" in data.infofields:\\n-            data.infodata[\\\"AFP\\\"] = np.mean(\\n-                list(data.sampledata[\\\"AFP\\\"].values()), axis=0\\n-            ).round(self.precision)\\n+            # need to weight frequencies of each individual by ploidy\\n+            pop_ploidy = 0\\n+            pop_total = np.zeros(len(data.columndata[\\\"ALTS\\\"]) + 1, float)\\n+            for sample, freqs in data.sampledata[\\\"AFP\\\"].items():\\n+                ploidy = self.sample_ploidy[sample]\\n+                pop_ploidy += ploidy\\n+                pop_total += freqs * ploidy\\n+            data.infodata[\\\"AFP\\\"] = (pop_total / pop_ploidy).round(self.precision)\\n         return data\\n \\n     def call_locus(self, locus):\\n\"]", "test_patch": "[\"diff --git a/mchap/tests/test_assemble/test_classes.py b/mchap/tests/test_assemble/test_classes.py\\nindex 0d65c6ea..d771309a 100644\\n--- a/mchap/tests/test_assemble/test_classes.py\\n+++ b/mchap/tests/test_assemble/test_classes.py\\n@@ -140,7 +140,7 @@ def test_PhenotypeDistribution___mode_genotype():\\n     assert expect[1] == actual[1]\\n \\n \\n-def test_PosteriorGenotypeDistribution__haplotype_probabilities():\\n+def test_PosteriorGenotypeDistribution__allele_occurrence():\\n     array = np.array(\\n         [\\n             [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],\\n@@ -168,12 +168,12 @@ def test_PosteriorGenotypeDistribution__haplotype_probabilities():\\n             0.1,\\n         ]\\n     )\\n-    actual_haps, actual_probs = dist.haplotype_probabilities()\\n+    actual_haps, actual_probs = dist.allele_occurrence()\\n     np.testing.assert_array_equal(actual_haps, expect_haps)\\n     np.testing.assert_array_almost_equal(actual_probs, expect_probs)\\n \\n \\n-def test_PosteriorGenotypeDistribution__haplotype_probabilities__weights():\\n+def test_PosteriorGenotypeDistribution__allele_frequencies():\\n     array = np.array(\\n         [\\n             [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]],\\n@@ -193,15 +193,7 @@ def test_PosteriorGenotypeDistribution__haplotype_probabilities__weights():\\n             [0, 1, 0],\\n         ]\\n     )\\n-    expect_probs = np.array(\\n-        [\\n-            0.05 + 0.65 + 0.2 + 0.1,\\n-            0.65 + 0.2 + 0.1,\\n-            0.2 + 0.1,\\n-            0.1,\\n-        ]\\n-    )\\n-    expect_weights = np.array(\\n+    expect_freqs = np.array(\\n         [\\n             0.05 * 1 + 0.65 * (3 / 4) + 0.2 * (2 / 4) + 0.1 * (1 / 4),\\n             0.65 * (1 / 4) + 0.2 * (1 / 4) + 0.1 * (1 / 4),\\n@@ -209,12 +201,9 @@ def test_PosteriorGenotypeDistribution__haplotype_probabilities__weights():\\n             0.1 * (1 / 4),\\n         ]\\n     )\\n-    actual_haps, actual_probs, actual_weights = dist.haplotype_probabilities(\\n-        return_weighted=True\\n-    )\\n+    actual_haps, actual_freqs = dist.allele_frequencies()\\n     np.testing.assert_array_equal(actual_haps, expect_haps)\\n-    np.testing.assert_array_almost_equal(actual_probs, expect_probs)\\n-    np.testing.assert_array_almost_equal(actual_weights, expect_weights)\\n+    np.testing.assert_array_almost_equal(actual_freqs, expect_freqs)\\n \\n \\n @pytest.mark.parametrize(\\n\",\"diff --git a/mchap/tests/test_application_assemble.py b/mchap/tests/test_application_assemble.py\\nindex c0097ec8..1718e491 100644\\n--- a/mchap/tests/test_application_assemble.py\\n+++ b/mchap/tests/test_application_assemble.py\\n@@ -328,6 +328,11 @@ def test_Program__run(cli_extra, output_vcf):\\n             [],\\n             \\\"simple.output.mixed_depth.assemble.vcf\\\",\\n         ),\\n+        (\\n+            [\\\"simple.sample1.bam\\\", \\\"simple.sample2.deep.bam\\\", \\\"simple.sample3.bam\\\"],\\n+            [\\\"--report\\\", \\\"AFP\\\"],\\n+            \\\"simple.output.mixed_depth.assemble.frequencies.vcf\\\",\\n+        ),\\n         (\\n             [\\\"simple.sample1.bam\\\", \\\"simple.sample2.bam\\\", \\\"simple.sample3.bam\\\"],\\n             [\\n\",\"diff --git a/mchap/tests/test_application_call.py b/mchap/tests/test_application_call.py\\nindex 5bb61c03..6e37eb71 100644\\n--- a/mchap/tests/test_application_call.py\\n+++ b/mchap/tests/test_application_call.py\\n@@ -15,6 +15,14 @@\\n             [],\\n             \\\"simple.output.mixed_depth.call.vcf\\\",\\n         ),\\n+        (\\n+            [\\\"simple.sample1.bam\\\", \\\"simple.sample2.deep.bam\\\", \\\"simple.sample3.bam\\\"],\\n+            [\\n+                \\\"--report\\\",\\n+                \\\"AFP\\\",\\n+            ],\\n+            \\\"simple.output.mixed_depth.call.frequencies.vcf\\\",\\n+        ),\\n         (\\n             [\\\"simple.sample1.bam\\\", \\\"simple.sample2.deep.bam\\\", \\\"simple.sample3.bam\\\"],\\n             [\\n\",\"diff --git a/mchap/tests/test_application_call_exact.py b/mchap/tests/test_application_call_exact.py\\nindex b852ee2d..76311925 100644\\n--- a/mchap/tests/test_application_call_exact.py\\n+++ b/mchap/tests/test_application_call_exact.py\\n@@ -15,6 +15,14 @@\\n             [],\\n             \\\"simple.output.mixed_depth.call-exact.vcf\\\",\\n         ),\\n+        (\\n+            [\\\"simple.sample1.bam\\\", \\\"simple.sample2.deep.bam\\\", \\\"simple.sample3.bam\\\"],\\n+            [\\n+                \\\"--report\\\",\\n+                \\\"AFP\\\",\\n+            ],\\n+            \\\"simple.output.mixed_depth.call-exact.frequencies.vcf\\\",\\n+        ),\\n         (\\n             [\\\"simple.sample1.bam\\\", \\\"simple.sample2.deep.bam\\\", \\\"simple.sample3.bam\\\"],\\n             [\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf\\nnew file mode 100644\\nindex 00000000..ccd07df1\\n--- /dev/null\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf\\n@@ -0,0 +1,36 @@\\n+##fileformat=VCFv4.3\\n+##fileDate=20220406\\n+##source=mchap v0.5.1\\n+##phasing=None\\n+##commandline=\\\"mchap assemble --bam simple.sample1.bam simple.sample2.deep.bam simple.sample3.bam --ploidy 4 --targets simple.bed.gz --variants simple.vcf.gz --reference simple.fasta --mcmc-steps 500 --mcmc-burn 100 --mcmc-seed 11 --report AFP\\\"\\n+##randomseed=11\\n+##contig=<ID=CHR1,length=60>\\n+##contig=<ID=CHR2,length=60>\\n+##contig=<ID=CHR3,length=60>\\n+##FILTER=<ID=PASS,Description=\\\"All filters passed\\\">\\n+##INFO=<ID=AN,Number=1,Type=Integer,Description=\\\"Total number of alleles in called genotypes\\\">\\n+##INFO=<ID=AC,Number=A,Type=Integer,Description=\\\"Allele count in genotypes, for each ALT allele, in the same order as listed\\\">\\n+##INFO=<ID=NS,Number=1,Type=Integer,Description=\\\"Number of samples with data\\\">\\n+##INFO=<ID=DP,Number=1,Type=Integer,Description=\\\"Combined depth across samples\\\">\\n+##INFO=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total number of observed reads across all samples\\\">\\n+##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n+##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n+##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n+##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n+##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n+##FORMAT=<ID=DP,Number=1,Type=Integer,Description=\\\"Read depth\\\">\\n+##FORMAT=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total count of read pairs within haplotype interval\\\">\\n+##FORMAT=<ID=RCALLS,Number=1,Type=Integer,Description=\\\"Total count of read base calls matching a known variant\\\">\\n+##FORMAT=<ID=MEC,Number=1,Type=Integer,Description=\\\"Minimum error correction\\\">\\n+##FORMAT=<ID=KMERCOV,Number=3,Type=Float,Description=\\\"Minimum proportion of read-SNV 1-, 2-, and 3-mers found in genotype at any position.\\\">\\n+##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n+##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n+##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+#CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n+CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.533,0.253,0.175\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:7:8:13:20:40:0:1,1,1:0.785:0.835:0:0.446,0.257,0.255\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:0:0.5,0.5,0\\t0/0/0/2:4:5:13:20:40:0:1,1,1:0.619:0.698:0:0.653,0.002,0.27\\n+CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\n+CHR2\\t11\\tCHR2_10_30\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAGAAAAAAAAAA,AAAAAAAAATAAAAAAAAAA,AAAATAAAAGAAAAAAAAAA\\t.\\t.\\tAN=4;AC=3,2,1;NS=3;DP=168;RCOUNT=288;END=30;NVAR=2;SNVPOS=5,10;AFP=0.481,0.235,0.178,0.093\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/2:6:8:14:24:28:0:1,1,.:0.72:0.84:0:0.68,0.004,0.28,0.006\\t0/0/1/2:60:60:140:240:280:0:1,1,.:1:1:0:0.5,0.25,0.25,0\\t0/1/1/3:7:13:14:24:28:0:1,1,.:0.801:0.949:0:0.262,0.45,0.004,0.274\\n+CHR3\\t21\\tCHR3_20_40\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=0;END=40;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.vcf\\nindex d4bf2f8e..f1362537 100644\\n--- a/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.vcf\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.vcf\\n@@ -2,7 +2,7 @@\\n ##fileDate=20210420\\n ##source=mchap v0.5.1\\n ##phasing=None\\n-##commandline=\\\"mchap assemble --bam simple.sample1.bam simple.sample2.deep.bam simple.sample3.bam --ploidy 4 --targets simple.bed.gz --variants simple.vcf.gz --reference simple.fasta --mcmc-steps 500 --mcmc-burn 100 --mcmc-seed 11 --use-assembly-posteriors\\\"\\n+##commandline=\\\"mchap assemble --bam simple.sample1.bam simple.sample2.deep.bam simple.sample3.bam --ploidy 4 --targets simple.bed.gz --variants simple.vcf.gz --reference simple.fasta --mcmc-steps 500 --mcmc-burn 100 --mcmc-seed 11\\\"\\n ##randomseed=11\\n ##contig=<ID=CHR1,length=60>\\n ##contig=<ID=CHR2,length=60>\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf\\nnew file mode 100644\\nindex 00000000..2c1a6e07\\n--- /dev/null\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf\\n@@ -0,0 +1,36 @@\\n+##fileformat=VCFv4.3\\n+##fileDate=20220406\\n+##source=mchap v0.5.1\\n+##phasing=None\\n+##commandline=\\\"mchap call-exact --bam simple.sample1.bam simple.sample2.deep.bam simple.sample3.bam --ploidy 4 --haplotypes simple.output.mixed_depth.assemble.vcf --report AFP\\\"\\n+##randomseed=None\\n+##contig=<ID=CHR1,length=60>\\n+##contig=<ID=CHR2,length=60>\\n+##contig=<ID=CHR3,length=60>\\n+##FILTER=<ID=PASS,Description=\\\"All filters passed\\\">\\n+##INFO=<ID=AN,Number=1,Type=Integer,Description=\\\"Total number of alleles in called genotypes\\\">\\n+##INFO=<ID=AC,Number=A,Type=Integer,Description=\\\"Allele count in genotypes, for each ALT allele, in the same order as listed\\\">\\n+##INFO=<ID=NS,Number=1,Type=Integer,Description=\\\"Number of samples with data\\\">\\n+##INFO=<ID=DP,Number=1,Type=Integer,Description=\\\"Combined depth across samples\\\">\\n+##INFO=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total number of observed reads across all samples\\\">\\n+##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n+##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n+##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n+##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n+##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n+##FORMAT=<ID=DP,Number=1,Type=Integer,Description=\\\"Read depth\\\">\\n+##FORMAT=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total count of read pairs within haplotype interval\\\">\\n+##FORMAT=<ID=RCALLS,Number=1,Type=Integer,Description=\\\"Total count of read base calls matching a known variant\\\">\\n+##FORMAT=<ID=MEC,Number=1,Type=Integer,Description=\\\"Minimum error correction\\\">\\n+##FORMAT=<ID=KMERCOV,Number=3,Type=Float,Description=\\\"Minimum proportion of read-SNV 1-, 2-, and 3-mers found in genotype at any position.\\\">\\n+##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n+##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n+##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+#CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n+CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.57,0.253,0.177\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:12:60:13:20:40:0:1,1,1:0.941:1:.:0.485,0.257,0.257\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:.:0.5,0.5,0\\t0/0/0/2:10:22:13:20:40:0:1,1,1:0.896:0.994:.:0.724,0.002,0.275\\n+CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:.:1\\n+CHR2\\t11\\tCHR2_10_30\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAGAAAAAAAAAA,AAAAAAAAATAAAAAAAAAA,AAAATAAAAGAAAAAAAAAA\\t.\\t.\\tAN=4;AC=3,2,1;NS=3;DP=168;RCOUNT=288;END=30;NVAR=2;SNVPOS=5,10;AFP=0.489,0.237,0.18,0.094\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/2:7:14:14:24:28:0:1,1,.:0.812:0.962:.:0.703,0.005,0.288,0.005\\t0/0/1/2:60:60:140:240:280:0:1,1,.:1:1:.:0.5,0.25,0.25,0\\t0/1/1/3:8:21:14:24:28:0:1,1,.:0.827:0.992:.:0.265,0.457,0.002,0.276\\n+CHR3\\t21\\tCHR3_20_40\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=0;END=40;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:.:1\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf\\nnew file mode 100644\\nindex 00000000..cf6b6eb4\\n--- /dev/null\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf\\n@@ -0,0 +1,36 @@\\n+##fileformat=VCFv4.3\\n+##fileDate=20220406\\n+##source=mchap v0.5.1\\n+##phasing=None\\n+##commandline=\\\"mchap call --bam simple.sample1.bam simple.sample2.deep.bam simple.sample3.bam --ploidy 4 --haplotypes simple.output.deep.assemble.vcf --mcmc-steps 500 --mcmc-burn 100 --mcmc-seed 11 --report AFP\\\"\\n+##randomseed=11\\n+##contig=<ID=CHR1,length=60>\\n+##contig=<ID=CHR2,length=60>\\n+##contig=<ID=CHR3,length=60>\\n+##FILTER=<ID=PASS,Description=\\\"All filters passed\\\">\\n+##INFO=<ID=AN,Number=1,Type=Integer,Description=\\\"Total number of alleles in called genotypes\\\">\\n+##INFO=<ID=AC,Number=A,Type=Integer,Description=\\\"Allele count in genotypes, for each ALT allele, in the same order as listed\\\">\\n+##INFO=<ID=NS,Number=1,Type=Integer,Description=\\\"Number of samples with data\\\">\\n+##INFO=<ID=DP,Number=1,Type=Integer,Description=\\\"Combined depth across samples\\\">\\n+##INFO=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total number of observed reads across all samples\\\">\\n+##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n+##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n+##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n+##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n+##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n+##FORMAT=<ID=DP,Number=1,Type=Integer,Description=\\\"Read depth\\\">\\n+##FORMAT=<ID=RCOUNT,Number=1,Type=Integer,Description=\\\"Total count of read pairs within haplotype interval\\\">\\n+##FORMAT=<ID=RCALLS,Number=1,Type=Integer,Description=\\\"Total count of read base calls matching a known variant\\\">\\n+##FORMAT=<ID=MEC,Number=1,Type=Integer,Description=\\\"Minimum error correction\\\">\\n+##FORMAT=<ID=KMERCOV,Number=3,Type=Float,Description=\\\"Minimum proportion of read-SNV 1-, 2-, and 3-mers found in genotype at any position.\\\">\\n+##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n+##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n+##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+#CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n+CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.57,0.253,0.177\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:13:60:13:20:40:0:1,1,1:0.952:1:0:0.488,0.256,0.256\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:0:0.5,0.5,0\\t0/0/0/2:10:19:13:20:40:0:1,1,1:0.894:0.989:0:0.723,0.003,0.274\\n+CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\n+CHR2\\t11\\tCHR2_10_30\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAGAAAAAAAAAA,AAAAAAAAATAAAAAAAAAA,AAAATAAAAGAAAAAAAAAA\\t.\\t.\\tAN=4;AC=3,2,1;NS=3;DP=168;RCOUNT=288;END=30;NVAR=2;SNVPOS=5,10;AFP=0.491,0.235,0.18,0.094\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/2:7:15:14:24:28:0:1,1,.:0.821:0.969:0:0.705,0.004,0.287,0.004\\t0/0/1/2:60:60:140:240:280:0:1,1,.:1:1:0:0.5,0.25,0.25,0\\t0/1/1/3:7:21:14:24:28:0:1,1,.:0.806:0.992:0:0.268,0.452,0.002,0.279\\n+CHR3\\t21\\tCHR3_20_40\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=0;END=40;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:0:0:0:.,.,.:1:1:0:1\\n\",\"diff --git a/mchap/tests/test_calling/test_calling_exact.py b/mchap/tests/test_calling/test_calling_exact.py\\nindex 6fd8a89d..f1003690 100644\\n--- a/mchap/tests/test_calling/test_calling_exact.py\\n+++ b/mchap/tests/test_calling/test_calling_exact.py\\n@@ -1,11 +1,16 @@\\n import numpy as np\\n+import pytest\\n \\n from mchap.calling import exact\\n from mchap import mset\\n from mchap.testing import simulate_reads\\n from mchap.assemble.likelihood import log_likelihood\\n from mchap.assemble.prior import log_genotype_prior\\n-from mchap.jitutils import genotype_alleles_as_index, normalise_log_probs\\n+from mchap.jitutils import (\\n+    genotype_alleles_as_index,\\n+    normalise_log_probs,\\n+    index_as_genotype_alleles,\\n+)\\n \\n \\n def test_genotype_likelihoods():\\n@@ -254,8 +259,13 @@ def test_call_posterior_mode():\\n         mode_llk,\\n         mode_genotype_prob,\\n         mode_phenotype_prob,\\n-    ) = exact.call_posterior_mode(\\n-        reads, 4, haplotypes, read_counts=counts, inbreeding=inbreeding\\n+    ) = exact.posterior_mode(\\n+        reads,\\n+        4,\\n+        haplotypes,\\n+        read_counts=counts,\\n+        inbreeding=inbreeding,\\n+        return_phenotype_prob=True,\\n     )\\n \\n     np.testing.assert_array_equal(genotype, mode_genotype)\\n@@ -265,3 +275,48 @@ def test_call_posterior_mode():\\n     np.testing.assert_almost_equal(\\n         np.sum(probs[[idx_0, idx_1, idx_2]]), mode_phenotype_prob, 5\\n     )\\n+\\n+\\n+@pytest.mark.parametrize(\\n+    \\\"ploidy, positions, inbreeding, n_haps, n_reads\\\",\\n+    [\\n+        (2, 3, 0.0, 4, 1),\\n+        (3, 10, 0.02, 15, 10),\\n+        (4, 6, 0.01, 10, 20),\\n+    ],\\n+)\\n+def test_call_posterior_mode__fuzz(ploidy, positions, inbreeding, n_haps, n_reads):\\n+    ploidy = 4\\n+    positions = 6\\n+    inbreeding = 0.01\\n+    n_haps = 10\\n+    n_reads = 20\\n+\\n+    haplotypes = mset.unique(np.random.randint(0, 2, size=(n_haps, positions)))\\n+    n_haps = len(haplotypes)\\n+    genotype = haplotypes[np.random.randint(0, n_haps, size=ploidy)]\\n+    reads = simulate_reads(genotype, n_reads=n_reads, n_alleles=np.repeat(2, positions))\\n+\\n+    # compute full distribution\\n+    llks = exact.genotype_likelihoods(reads=reads, ploidy=ploidy, haplotypes=haplotypes)\\n+    post = exact.genotype_posteriors(\\n+        llks, ploidy=ploidy, n_alleles=n_haps, inbreeding=inbreeding\\n+    )\\n+    freqs = exact.posterior_allele_frequencies(post, ploidy=ploidy, n_alleles=n_haps)\\n+    mode = np.argmax(post)\\n+    alleles = index_as_genotype_alleles(mode, ploidy)\\n+\\n+    # compute mode using low memory function\\n+    mode_alleles, mode_llk, mode_post, mean_freqs = exact.posterior_mode(\\n+        reads=reads,\\n+        ploidy=ploidy,\\n+        haplotypes=haplotypes,\\n+        inbreeding=inbreeding,\\n+        return_phenotype_prob=False,\\n+        return_posterior_frequencies=True,\\n+    )\\n+\\n+    np.testing.assert_array_equal(alleles, mode_alleles)\\n+    np.testing.assert_almost_equal(llks[mode], mode_llk, 5)\\n+    np.testing.assert_almost_equal(post[mode], mode_post, 5)\\n+    np.testing.assert_array_almost_equal(freqs, mean_freqs, 5)\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf\\nindex ccd07df1..9a3e1c25 100644\\n--- a/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.assemble.frequencies.vcf\\n@@ -16,7 +16,7 @@\\n ##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n ##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n ##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n-##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n ##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n ##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n ##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n@@ -28,7 +28,7 @@\\n ##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n ##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n ##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n-##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n #CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.533,0.253,0.175\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:7:8:13:20:40:0:1,1,1:0.785:0.835:0:0.446,0.257,0.255\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:0:0.5,0.5,0\\t0/0/0/2:4:5:13:20:40:0:1,1,1:0.619:0.698:0:0.653,0.002,0.27\\n CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf\\nindex 2c1a6e07..cf0dc9d6 100644\\n--- a/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.call-exact.frequencies.vcf\\n@@ -16,7 +16,7 @@\\n ##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n ##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n ##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n-##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n ##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n ##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n ##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n@@ -28,7 +28,7 @@\\n ##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n ##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n ##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n-##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n #CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.57,0.253,0.177\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:12:60:13:20:40:0:1,1,1:0.941:1:.:0.485,0.257,0.257\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:.:0.5,0.5,0\\t0/0/0/2:10:22:13:20:40:0:1,1,1:0.896:0.994:.:0.724,0.002,0.275\\n CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:.:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:.:1\\n\",\"diff --git a/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf b/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf\\nindex cf6b6eb4..ae93f313 100644\\n--- a/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf\\n+++ b/mchap/tests/test_io/data/simple.output.mixed_depth.call.frequencies.vcf\\n@@ -16,7 +16,7 @@\\n ##INFO=<ID=END,Number=1,Type=Integer,Description=\\\"End position on CHROM\\\">\\n ##INFO=<ID=NVAR,Number=1,Type=Integer,Description=\\\"Number of input variants within assembly locus\\\">\\n ##INFO=<ID=SNVPOS,Number=.,Type=Integer,Description=\\\"Relative (1-based) positions of SNVs within haplotypes\\\">\\n-##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##INFO=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n ##FORMAT=<ID=GT,Number=1,Type=String,Description=\\\"Genotype\\\">\\n ##FORMAT=<ID=GQ,Number=1,Type=Integer,Description=\\\"Genotype quality\\\">\\n ##FORMAT=<ID=PHQ,Number=1,Type=Integer,Description=\\\"Phenotype quality\\\">\\n@@ -28,7 +28,7 @@\\n ##FORMAT=<ID=GPM,Number=1,Type=Float,Description=\\\"Genotype posterior mode probability\\\">\\n ##FORMAT=<ID=PHPM,Number=1,Type=Float,Description=\\\"Phenotype posterior mode probability\\\">\\n ##FORMAT=<ID=MCI,Number=1,Type=Integer,Description=\\\"Replicate Markov-chain incongruence, 0 = none, 1 = incongruence, 2 = putative CNV\\\">\\n-##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior allele frequencies\\\">\\n+##FORMAT=<ID=AFP,Number=R,Type=Float,Description=\\\"Posterior mean allele frequencies\\\">\\n #CHROM\\tPOS\\tID\\tREF\\tALT\\tQUAL\\tFILTER\\tINFO\\tFORMAT\\tSAMPLE1\\tSAMPLE2\\tSAMPLE3\\n CHR1\\t6\\tCHR1_05_25\\tAAAAAAAAAAAAAAAAAAAA\\tAAAAAAAAAAGAAAAAATAA,ACAAAAAAAAGAAAAAACAA\\t.\\t.\\tAN=3;AC=3,2;NS=3;DP=159;RCOUNT=240;END=25;NVAR=3;SNVPOS=2,11,18;AFP=0.57,0.253,0.177\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/1/2:13:60:13:20:40:0:1,1,1:0.952:1:0:0.488,0.256,0.256\\t0/0/1/1:60:60:133:200:400:0:1,1,1:1:1:0:0.5,0.5,0\\t0/0/0/2:10:19:13:20:40:0:1,1,1:0.894:0.989:0:0.723,0.003,0.274\\n CHR1\\t31\\tCHR1_30_50\\tAAAAAAAAAAAAAAAAAAAA\\t.\\t.\\t.\\tAN=1;AC=.;NS=3;DP=.;RCOUNT=288;END=50;NVAR=0;SNVPOS=.;AFP=1\\tGT:GQ:PHQ:DP:RCOUNT:RCALLS:MEC:KMERCOV:GPM:PHPM:MCI:AFP\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:240:0:0:.,.,.:1:1:0:1\\t0/0/0/0:60:60:.:24:0:0:.,.,.:1:1:0:1\"]", "hints_text": ""}
