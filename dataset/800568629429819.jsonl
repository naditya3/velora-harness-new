{"instance_id": "800568629429819", "repo": "nataliakolesnik/aiogram_dialog", "base_commit": "f81f734695b7032c2aef389557b34c12e063ac19", "problem_statement": "Dialog for user in multiuser chat:\\nв диалогах встроить возможность диалог открыть для юзера или для чата. То есть записать user_id в Intent и при обработке сообщений/кликов проверять его\\r\\n", "FAIL_TO_PASS": ["tests/test_transitions.py::test_subdialog", "tests/test_transitions.py::test_start", "tests/widgets/kbd/test_group.py::test_click_buttons_in_group", "tests/test_transitions.py::test_reset_stack", "tests/test_click.py::test_click", "tests/test_isolation.py::test_concurrent_events", "tests/test_transitions.py::test_next_back", "tests/test_events.py::test_click", "tests/test_transitions.py::test_finish_last", "tests/test_events.py::test_request_join", "tests/test_events.py::test_my_chat_member_update", "tests/test_nested_transitions.py::test_start"], "PASS_TO_PASS": ["tests/widgets/kbd/test_checkbox.py::test_check_checkbox", "tests/widgets/kbd/test_radio.py::test_check_radio", "tests/test_create.py::test_register", "tests/widgets/kbd/test_counter.py::test_max_value_counter", "tests/widgets/text/test_case.py::test_render_case", "tests/widgets/kbd/test_column.py::test_render_column", "tests/widgets/kbd/test_group.py::test_render_group", "tests/test_create.py::test_name_state_group", "tests/widgets/kbd/test_toggle.py::test_render_toggle", "tests/widgets/text/test_base.py::test_add_add", "tests/test_utils.py::test_is_user_loaded", "tests/test_utils.py::test_is_chat_loaded", "tests/widgets/text/test_jinja.py::test_render_jinja", "tests/widgets/kbd/test_multiselect.py::test_render_multiselect", "tests/test_create.py::test_name_explicit", "tests/widgets/text/test_base.py::test_or", "tests/widgets/kbd/test_multiselect.py::test_reset_checked_multiselect", "tests/widgets/text/test_base.py::test_or_condition", "tests/widgets/kbd/test_multiselect.py::test_max_selected_multiselect", "tests/widgets/media/test_base.py::test_or_condition", "tests/widgets/text/test_base.py::test_ror_str", "tests/widgets/media/test_base.py::test_or", "tests/widgets/kbd/test_radio.py::test_on_state_changed_radio", "tests/widgets/kbd/test_multiselect.py::test_check_multiselect", "tests/widgets/kbd/test_counter.py::test_set_value_counter", "tests/widgets/kbd/test_base.py::test_or_condition", "tests/widgets/kbd/test_group.py::test_render_group_with_width", "tests/widgets/kbd/test_base.py::test_or", "tests/widgets/kbd/test_url.py::test_render_url", "tests/widgets/media/test_scroll.py::test_render_media_scroll", "tests/widgets/text/test_base.py::test_add_str", "tests/widgets/kbd/test_row.py::test_render_row", "tests/widgets/kbd/test_calendar.py::test_render_calendar", "tests/widgets/kbd/test_multiselect.py::test_min_selected_multiselect", "tests/widgets/kbd/test_checkbox.py::test_on_state_changed_checkbox", "tests/widgets/kbd/test_counter.py::test_default_counter", "tests/widgets/kbd/test_counter.py::test_min_value_counter", "tests/widgets/text/test_format.py::test_render_format", "tests/widgets/text/test_base.py::test_add_const", "tests/widgets/kbd/test_select.py::test_render_select", "tests/widgets/kbd/test_multiselect.py::test_on_state_changed_multiselect", "tests/widgets/text/test_multi.py::test_render_multi", "tests/widgets/kbd/test_counter.py::test_on_value_changed_counter", "tests/widgets/text/test_base.py::test_add_str_rght", "tests/widgets/kbd/test_radio.py::test_validation_radio"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/nataliakolesnik_aiogram_dialog:f81f734695b7032c2aef389557b34c12e063ac19", "patch": "", "test_patch": "[\"diff --git a/requirements_dev.txt b/requirements_dev.txt\\nindex 88bb081e..faf62be7 100644\\n--- a/requirements_dev.txt\\n+++ b/requirements_dev.txt\\n@@ -14,3 +14,4 @@ flake8-print\\n \\n pytest\\n pytest-asyncio\\n+pytest-repeat\\n\",\"diff --git a/src/aiogram_dialog/test_tools/bot_client.py b/src/aiogram_dialog/test_tools/bot_client.py\\nindex 7fa8d857..961b5a92 100644\\n--- a/src/aiogram_dialog/test_tools/bot_client.py\\n+++ b/src/aiogram_dialog/test_tools/bot_client.py\\n@@ -1,8 +1,9 @@\\n import uuid\\n from datetime import datetime\\n-from typing import Optional, Union\\n+from typing import Any, Optional, Union\\n \\n from aiogram import Bot, Dispatcher\\n+from aiogram.methods import AnswerCallbackQuery, TelegramMethod\\n from aiogram.types import (\\n     CallbackQuery, Chat, ChatJoinRequest,\\n     ChatMemberAdministrator, ChatMemberBanned, ChatMemberLeft,\\n@@ -21,7 +22,13 @@ def __init__(self):\\n     def id(self):\\n         return 1\\n \\n-    def __call__(self, *args, **kwargs) -> None:\\n+    async def __call__(\\n+            self, method: TelegramMethod[Any],\\n+            request_timeout: Optional[int] = None,\\n+    ) -> Any:\\n+        del request_timeout  # unused\\n+        if isinstance(method, AnswerCallbackQuery):\\n+            return True\\n         raise RuntimeError(\\\"Fake bot should not be used to call telegram\\\")\\n \\n     def __hash__(self) -> int:\\n\",\"diff --git a/src/aiogram_dialog/test_tools/mock_message_manager.py b/src/aiogram_dialog/test_tools/mock_message_manager.py\\nindex 1c2e1288..42b66af8 100644\\n--- a/src/aiogram_dialog/test_tools/mock_message_manager.py\\n+++ b/src/aiogram_dialog/test_tools/mock_message_manager.py\\n@@ -138,4 +138,5 @@ async def show_message(self, bot: Bot, new_message: NewMessage,\\n             has_reply_keyboard=isinstance(\\n                 new_message.reply_markup, ReplyKeyboardMarkup,\\n             ),\\n+            business_connection_id=None,\\n         )\\n\",\"diff --git a/tests/test_group.py b/tests/test_group.py\\nnew file mode 100644\\nindex 00000000..70e8008e\\n--- /dev/null\\n+++ b/tests/test_group.py\\n@@ -0,0 +1,171 @@\\n+import asyncio\\n+from typing import Any\\n+\\n+import pytest\\n+from aiogram import Dispatcher\\n+from aiogram.filters import Command, CommandStart\\n+from aiogram.fsm.state import State, StatesGroup\\n+\\n+from aiogram_dialog import (\\n+    Dialog, DialogManager, setup_dialogs, StartMode, Window,\\n+)\\n+from aiogram_dialog.api.entities import AccessSettings, GROUP_STACK_ID\\n+from aiogram_dialog.test_tools import BotClient, MockMessageManager\\n+from aiogram_dialog.test_tools.keyboard import InlineButtonTextLocator\\n+from aiogram_dialog.widgets.kbd import Button\\n+from aiogram_dialog.widgets.text import Const, Format\\n+\\n+\\n+class MainSG(StatesGroup):\\n+    start = State()\\n+\\n+\\n+window = Window(\\n+    Format(\\\"stub\\\"),\\n+    Button(Const(\\\"Button\\\"), id=\\\"btn\\\"),\\n+    state=MainSG.start,\\n+)\\n+\\n+\\n+async def start(event: Any, dialog_manager: DialogManager):\\n+    await dialog_manager.start(MainSG.start, mode=StartMode.RESET_STACK)\\n+\\n+\\n+async def start_shared(event: Any, dialog_manager: DialogManager):\\n+    dialog_manager = dialog_manager.bg(stack_id=GROUP_STACK_ID)\\n+    await dialog_manager.start(MainSG.start, mode=StartMode.RESET_STACK)\\n+\\n+\\n+async def add_shared(event: Any, dialog_manager: DialogManager):\\n+    await dialog_manager.start(MainSG.start, access_settings=AccessSettings(\\n+        user_ids=[1, 2],\\n+    ))\\n+\\n+\\n+@pytest.fixture()\\n+def message_manager():\\n+    return MockMessageManager()\\n+\\n+\\n+@pytest.fixture()\\n+def dp(message_manager):\\n+    dp = Dispatcher()\\n+    dp.include_router(Dialog(window))\\n+    setup_dialogs(dp, message_manager=message_manager)\\n+    return dp\\n+\\n+\\n+@pytest.fixture()\\n+def client(dp):\\n+    return BotClient(dp, chat_id=-1, user_id=1, chat_type=\\\"group\\\")\\n+\\n+\\n+@pytest.fixture()\\n+def second_client(dp):\\n+    return BotClient(dp, chat_id=-1, user_id=2, chat_type=\\\"group\\\")\\n+\\n+\\n+@pytest.mark.asyncio\\n+async def test_second_user(dp, client, second_client, message_manager):\\n+    dp.message.register(start, CommandStart())\\n+    await client.send(\\\"/start\\\")\\n+    first_message = message_manager.one_message()\\n+    assert first_message.text == \\\"stub\\\"\\n+    message_manager.reset_history()\\n+    await second_client.send(\\\"test\\\")\\n+    assert not message_manager.sent_messages\\n+    await second_client.click(\\n+        first_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    assert not message_manager.sent_messages\\n+\\n+\\n+@pytest.mark.asyncio\\n+async def test_change_settings(dp, client, second_client, message_manager):\\n+    dp.message.register(start, CommandStart())\\n+    dp.message.register(add_shared, Command(\\\"add\\\"))\\n+\\n+    await client.send(\\\"/start\\\")\\n+    message_manager.reset_history()\\n+\\n+    await client.send(\\\"/add\\\")\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+\\n+    await second_client.click(\\n+        window_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+    assert window_message.text == \\\"stub\\\"\\n+\\n+    await client.send(\\\"/start\\\")\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+\\n+    await second_client.click(\\n+        window_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    assert not message_manager.sent_messages\\n+\\n+\\n+@pytest.mark.asyncio\\n+async def test_change_settings_bg(dp, client, second_client, message_manager):\\n+    dp.message.register(start, CommandStart())\\n+    dp.message.register(add_shared, Command(\\\"add\\\"))\\n+\\n+    await client.send(\\\"/start\\\")\\n+    message_manager.reset_history()\\n+\\n+    await client.send(\\\"/add\\\")\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+\\n+    await second_client.click(\\n+        window_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+    assert window_message.text == \\\"stub\\\"\\n+\\n+    await client.send(\\\"/start\\\")\\n+    window_message = message_manager.one_message()\\n+    message_manager.reset_history()\\n+\\n+    await second_client.click(\\n+        window_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    assert not message_manager.sent_messages\\n+\\n+\\n+@pytest.mark.asyncio\\n+async def test_same_user(dp, client, message_manager):\\n+    dp.message.register(start, CommandStart())\\n+    await client.send(\\\"/start\\\")\\n+    first_message = message_manager.one_message()\\n+    assert first_message.text == \\\"stub\\\"\\n+    message_manager.reset_history()\\n+    await client.send(\\\"test\\\")\\n+    assert not message_manager.sent_messages  # no resend\\n+    await client.click(\\n+        first_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    first_message = message_manager.one_message()\\n+    assert first_message.text == \\\"stub\\\"\\n+\\n+\\n+@pytest.mark.asyncio\\n+async def test_shared_stack(dp, client, second_client, message_manager):\\n+    dp.message.register(start_shared, CommandStart())\\n+    await client.send(\\\"/start\\\")\\n+    await asyncio.sleep(0.01)  # synchronization workaround, fixme\\n+    first_message = message_manager.one_message()\\n+    assert first_message.text == \\\"stub\\\"\\n+    message_manager.reset_history()\\n+    await second_client.send(\\\"test\\\")\\n+    assert not message_manager.sent_messages\\n+    await second_client.click(\\n+        first_message, InlineButtonTextLocator(\\\"Button\\\"),\\n+    )\\n+    second_message = message_manager.one_message()\\n+    assert second_message.text == \\\"stub\\\"\\n\",\"diff --git a/tests/test_isolation.py b/tests/test_isolation.py\\nnew file mode 100644\\nindex 00000000..1e8a5d4f\\n--- /dev/null\\n+++ b/tests/test_isolation.py\\n@@ -0,0 +1,46 @@\\n+import asyncio\\n+from asyncio import Event\\n+\\n+import pytest\\n+from aiogram import Dispatcher\\n+from aiogram.filters import CommandStart\\n+from aiogram.fsm.storage.memory import MemoryStorage\\n+from aiogram.types import Message\\n+\\n+from aiogram_dialog import (\\n+    setup_dialogs, )\\n+from aiogram_dialog.test_tools import BotClient, MockMessageManager\\n+\\n+\\n+async def start(\\n+        message: Message, data: list, event_common: Event,\\n+):\\n+    data.append(1)\\n+    await event_common.wait()\\n+\\n+\\n+@pytest.mark.asyncio\\n+@pytest.mark.repeat(10)\\n+async def test_concurrent_events():\\n+    event_common = Event()\\n+    data = []\\n+    dp = Dispatcher(\\n+        event_common=event_common,\\n+        data=data,\\n+        storage=MemoryStorage(),\\n+    )\\n+    dp.message.register(start, CommandStart())\\n+\\n+    client = BotClient(dp)\\n+    message_manager = MockMessageManager()\\n+    setup_dialogs(dp, message_manager=message_manager)\\n+\\n+    # start\\n+    t1 = asyncio.create_task(client.send(\\\"/start\\\"))\\n+    t2 = asyncio.create_task(client.send(\\\"/start\\\"))\\n+    await asyncio.sleep(0.1)\\n+    assert len(data) == 1  # \\\"Only single event expected to be processed\\\"\\n+    event_common.set()\\n+    await t1\\n+    await t2\\n+    assert len(data) == 2\"]", "hints_text": ""}
