{"instance_id": "1288894202941862", "repo": "frictionlessdata/livemark", "base_commit": "9b720d971f810fb70440e710f6c04906f6d22833", "problem_statement": "Implement a visual mode for writing documentation:\\n# Overview\\r\\n\\r\\nAfter we merge `goodread`, it's no possible to `livemark sync doc.md` to inject script run inside the markdown doc. We can improve the writing experience if we provide a livereload HTML renderer for writing documentation. It might be something like:\\r\\n\\r\\n```bash\\r\\n$ livemark sync docs.md --live\\r\\n```\\r\\n\\r\\nIt will require #40 for normal UI", "FAIL_TO_PASS": ["tests/test_document.py::test_document_with_config"], "PASS_TO_PASS": ["tests/program/test_main.py::test_program_version", "tests/test_program.py::test_program_version", "tests/test_snippet.py::test_snippet_update_output", "tests/test_document.py::test_document_update_output", "tests/test_document.py::test_document_with_format", "tests/test_document.py::test_document", "tests/test_program.py::test_program", "tests/test_snippet.py::test_snippet", "tests/program/test_main.py::test_program_help", "tests/test_markup.py::test_markup", "tests/program/test_main.py::test_program_error_bad_command"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/frictionlessdata_livemark:9b720d971f810fb70440e710f6c04906f6d22833", "patch": "[\"diff --git a/docs/getting-started.html b/docs/getting-started.html\\nindex 7aaaead..274ff5b 100644\\n--- a/docs/getting-started.html\\n+++ b/docs/getting-started.html\\n@@ -1574,7 +1574,7 @@ p {\\n <div id=\\\"livemark-main\\\">\\n <div id=\\\"livemark-stats\\\">\\n   Written in <a href=\\\"https://livemark.frictionlessdata.io\\\" target=\\\"_blank\\\"> Livemark </a><br>\\n-  (2021-08-05 19:05:24)\\n+  (2021-08-06 14:03:34)\\n </div>\\n \\n <h1>Getting Started</h1>\\n\",\"diff --git a/index.html b/index.html\\nindex 60afa05..5a4370c 100644\\n--- a/index.html\\n+++ b/index.html\\n@@ -1574,7 +1574,7 @@ p {\\n <div id=\\\"livemark-main\\\">\\n <div id=\\\"livemark-stats\\\">\\n   Written in <a href=\\\"https://livemark.frictionlessdata.io\\\" target=\\\"_blank\\\"> Livemark </a><br>\\n-  (2021-08-05 19:05:14)\\n+  (2021-08-06 14:38:14)\\n </div>\\n \\n <h1>Livemark</h1>\\n\",\"diff --git a/livemark.yaml b/livemark.yaml\\nindex 73dbfc0..02ee3fa 100644\\n--- a/livemark.yaml\\n+++ b/livemark.yaml\\n@@ -8,6 +8,7 @@ github:\\n counter:\\n   type: google\\n   code: G-ZH2QL85N6F\\n+# TODO: review paths format - md/html?\\n pages:\\n   - name: Introduction\\n     path: /\\n\",\"diff --git a/livemark/__init__.py b/livemark/__init__.py\\nindex f1b1a55..df73075 100644\\n--- a/livemark/__init__.py\\n+++ b/livemark/__init__.py\\n@@ -1,9 +1,10 @@\\n+# TODO: release on Anaconda\\n from .document import Document\\n from .exception import LivemarkException\\n from .markup import Markup\\n from .plugin import Plugin\\n from .program import program\\n-from .project import Project\\n+from .server import Server\\n from .settings import VERSION as __version__\\n from .snippet import Snippet\\n from .system import system\\n\",\"diff --git a/livemark/document.py b/livemark/document.py\\nindex 19960c2..c3fe004 100644\\n--- a/livemark/document.py\\n+++ b/livemark/document.py\\n@@ -1,15 +1,14 @@\\n import os\\n import re\\n-import sys\\n import yaml\\n+import difflib\\n import deepmerge\\n import jsonschema\\n from pathlib import Path\\n-from copy import deepcopy\\n from frictionless import File\\n-from .system import system\\n from .exception import LivemarkException\\n from .helpers import cached_property\\n+from .system import system\\n from . import settings\\n from . import helpers\\n \\n@@ -25,18 +24,16 @@ class Document:\\n         source (str): path to the document source\\n         target? (str): path to the document target\\n         format? (str): format of the document target\\n-        project? (Project): a project to which the document belongs\\n-        create? (bool): whether to create a source if index.md doesn't exist\\n+        config? (str|dict): path to a config file or a config dict\\n \\n     \\\"\\\"\\\"\\n \\n-    def __init__(self, source, *, target=None, format=None, project=None, create=False):\\n+    def __init__(self, source, *, target=None, format=None, config=None):\\n \\n-        # Create source\\n-        if create and source == settings.DEFAULT_SOURCE:\\n-            if not os.path.exists(source):\\n-                with open(source, \\\"w\\\"):\\n-                    pass\\n+        # Create plugins\\n+        plugins = []\\n+        for Plugin in system.Plugins:\\n+            plugins.append(Plugin(self))\\n \\n         # Infer target\\n         if not target:\\n@@ -48,25 +45,29 @@ class Document:\\n             file = File(target)\\n             format = file.format\\n \\n-        # Create plugins\\n-        plugins = []\\n-        for Plugin in system.Plugins:\\n-            plugins.append(Plugin(self))\\n+        # Normalize config\\n+        config = config or {}\\n+        if not isinstance(config, dict):\\n+            if os.path.isfile(config):\\n+                with open(config) as file:\\n+                    config = yaml.safe_load(file)\\n \\n         # Set attributes\\n+        self.__plugins = plugins\\n         self.__source = source\\n         self.__target = target\\n         self.__format = format\\n-        self.__project = project\\n-        self.__create = create\\n-        self.__plugins = plugins\\n+        self.__config = config\\n         self.__preface = None\\n         self.__content = None\\n-        self.__config = None\\n         self.__input = None\\n         self.__output = None\\n \\n     @property\\n+    def plugins(self):\\n+        return self.__plugins\\n+\\n+    @property\\n     def source(self):\\n         return self.__source\\n \\n@@ -111,10 +112,6 @@ class Document:\\n     def config(self):\\n         return self.__config\\n \\n-    @property\\n-    def plugins(self):\\n-        return self.__plugins\\n-\\n     @cached_property\\n     def title(self):\\n         prefix = \\\"# \\\"\\n@@ -136,10 +133,11 @@ class Document:\\n \\n     # Build\\n \\n-    def build(self, *, print=False):\\n+    def build(self, *, diff=False, print=False):\\n         self.read()\\n         self.process()\\n-        self.write(print=print)\\n+        written = self.write(diff=diff, print=print)\\n+        return written\\n \\n     # Read\\n \\n@@ -157,14 +155,9 @@ class Document:\\n             self.__preface = parts[0].strip()\\n             self.__content = parts[1].strip()\\n \\n-        # Read config\\n-        self.__config = {}\\n-        if self.__project:\\n-            self.__config = deepcopy(self.__project.config)\\n+        # Read/process config\\n         if self.__preface:\\n             deepmerge.always_merger.merge(self.__config, yaml.safe_load(self.__preface))\\n-\\n-        # Process config\\n         for plugin in self.__plugins:\\n             self.__config.setdefault(plugin.name, {})\\n             if not isinstance(self.__config[plugin.name], dict):\\n@@ -186,11 +179,28 @@ class Document:\\n \\n     # Write\\n \\n-    def write(self, *, print=False):\\n+    def write(self, *, diff=False, print=False):\\n         if self.__output is None:\\n             raise LivemarkException(\\\"Process document before writing\\\")\\n+\\n+        # Diff\\n+        if diff:\\n+            next = self.output\\n+            prev = helpers.read_file(self.target, default=\\\"\\\")\\n+            l1 = prev.splitlines(keepends=True)\\n+            l2 = next.splitlines(keepends=True)\\n+            ld = list(difflib.unified_diff(l1, l2, fromfile=\\\"prev\\\", tofile=\\\"next\\\"))\\n+            text = \\\"\\\"\\n+            if ld:\\n+                text = \\\"\\\".join(ld)\\n+                helpers.write_stdout(text)\\n+            return text\\n+\\n+        # Print\\n         if print:\\n-            sys.stdout.write(self.__output)\\n-            sys.stdout.flush()\\n-            return\\n+            helpers.write_stdout(self.__output)\\n+            return self.__output\\n+\\n+        # Save\\n         helpers.write_file(self.__target, self.__output)\\n+        return self.__output\\n\",\"diff --git a/livemark/helpers.py b/livemark/helpers.py\\nindex fc559ee..0a4bf07 100644\\n--- a/livemark/helpers.py\\n+++ b/livemark/helpers.py\\n@@ -12,10 +12,11 @@ from . import settings\\n # General\\n \\n \\n-def ensure_dir(path):\\n-    dirpath = os.path.dirname(path)\\n-    if dirpath and not os.path.exists(dirpath):\\n-        os.makedirs(dirpath)\\n+def read_file(source, *, default=None):\\n+    if default and not os.path.isfile(source):\\n+        return default\\n+    with open(source, encoding=\\\"utf-8\\\") as file:\\n+        return file.read()\\n \\n \\n def move_file(source, target):\\n@@ -32,21 +33,23 @@ def copy_file(source, target):\\n     shutil.copy(source, target)\\n \\n \\n-def write_file(path, text):\\n+def write_file(path, text=\\\"\\\"):\\n     with tempfile.NamedTemporaryFile(\\\"wt\\\", delete=False, encoding=\\\"utf-8\\\") as file:\\n         file.write(text)\\n         file.flush()\\n     move_file(file.name, path)\\n \\n \\n-@contextlib.contextmanager\\n-def capture_stdout(stdout=None):\\n-    old = sys.stdout\\n-    if stdout is None:\\n-        stdout = io.StringIO()\\n-    sys.stdout = stdout\\n-    yield stdout\\n-    sys.stdout = old\\n+def write_stdout(text):\\n+    sys.stdout.write(text)\\n+    sys.stdout.write(\\\"\\\\n\\\")\\n+    sys.stdout.flush()\\n+\\n+\\n+def ensure_dir(path):\\n+    dirpath = os.path.dirname(path)\\n+    if dirpath and not os.path.exists(dirpath):\\n+        os.makedirs(dirpath)\\n \\n \\n def is_remote_path(path):\\n@@ -59,6 +62,16 @@ def is_remote_path(path):\\n     return True\\n \\n \\n+@contextlib.contextmanager\\n+def capture_stdout(stdout=None):\\n+    old = sys.stdout\\n+    if stdout is None:\\n+        stdout = io.StringIO()\\n+    sys.stdout = stdout\\n+    yield stdout\\n+    sys.stdout = old\\n+\\n+\\n # Backports\\n \\n \\n\",\"diff --git a/livemark/plugins/chart/plugin.py b/livemark/plugins/chart/plugin.py\\nindex ad9461a..28c3500 100644\\n--- a/livemark/plugins/chart/plugin.py\\n+++ b/livemark/plugins/chart/plugin.py\\n@@ -15,8 +15,8 @@ class ChartPlugin(Plugin):\\n             return\\n \\n         # Update snippet\\n-        if snippet.modifier == \\\"chart\\\":\\n-            if snippet.language == \\\"yaml\\\":\\n+        if snippet.type == \\\"chart\\\":\\n+            if snippet.lang == \\\"yaml\\\":\\n                 spec_yaml = str(snippet.input).strip()\\n                 spec_python = yaml.safe_load(spec_yaml)\\n                 spec = json.dumps(spec_python, ensure_ascii=False)\\n\",\"diff --git a/livemark/plugins/markup/plugin.py b/livemark/plugins/markup/plugin.py\\nindex c86d1bb..8ebd510 100644\\n--- a/livemark/plugins/markup/plugin.py\\n+++ b/livemark/plugins/markup/plugin.py\\n@@ -12,8 +12,8 @@ class MarkupPlugin(Plugin):\\n             return\\n \\n         # Update snippet\\n-        if snippet.modifier == \\\"markup\\\":\\n-            if snippet.language == \\\"html\\\":\\n+        if snippet.type == \\\"markup\\\":\\n+            if snippet.lang == \\\"html\\\":\\n                 markdown = marko.Markdown()\\n                 markdown.use(GFM)\\n                 markdown.use(HtmlExtension)\\n\",\"diff --git a/livemark/plugins/script/plugin.py b/livemark/plugins/script/plugin.py\\nindex e283906..d5aa265 100644\\n--- a/livemark/plugins/script/plugin.py\\n+++ b/livemark/plugins/script/plugin.py\\n@@ -4,18 +4,19 @@ from ...plugin import Plugin\\n from ... import helpers\\n \\n \\n+# TODO: support snippet.mode = 'default' | 'input' | 'output'\\n class ScriptPlugin(Plugin):\\n     def process_snippet(self, snippet):\\n \\n         # Update snippet\\n-        if snippet.modifier == \\\"script\\\":\\n-            if snippet.language == \\\"bash\\\":\\n+        if snippet.type == \\\"script\\\":\\n+            if snippet.lang == \\\"bash\\\":\\n                 try:\\n                     output = subprocess.check_output(snippet.input, shell=True)\\n                     output = output.decode().strip()\\n                 except Exception as exception:\\n                     output = exception.output.decode().strip()\\n-            elif snippet.language == \\\"python\\\":\\n+            elif snippet.lang == \\\"python\\\":\\n                 with helpers.capture_stdout() as stdout:\\n                     exec(snippet.input, {})\\n                 output = stdout.getvalue().strip()\\n\",\"diff --git a/livemark/plugins/table/plugin.py b/livemark/plugins/table/plugin.py\\nindex bd60023..4bd6f23 100644\\n--- a/livemark/plugins/table/plugin.py\\n+++ b/livemark/plugins/table/plugin.py\\n@@ -16,8 +16,8 @@ class TablePlugin(Plugin):\\n             return\\n \\n         # Update snippet\\n-        if snippet.modifier == \\\"table\\\":\\n-            if snippet.language == \\\"yaml\\\":\\n+        if snippet.type == \\\"table\\\":\\n+            if snippet.lang == \\\"yaml\\\":\\n                 spec_yaml = str(snippet.input).strip()\\n                 spec_python = yaml.safe_load(spec_yaml)\\n                 spec_python[\\\"licenseKey\\\"] = \\\"non-commercial-and-evaluation\\\"\\n\",\"diff --git a/livemark/program/__init__.py b/livemark/program/__init__.py\\nindex 6a7c82b..a596517 100644\\n--- a/livemark/program/__init__.py\\n+++ b/livemark/program/__init__.py\\n@@ -1,4 +1,4 @@\\n from .build import program_build\\n from .main import program, program_main\\n+from .merge import program_merge\\n from .start import program_start\\n-from .sync import program_sync\\n\",\"diff --git a/livemark/program/build.py b/livemark/program/build.py\\nindex 94c1bdb..a76b429 100644\\n--- a/livemark/program/build.py\\n+++ b/livemark/program/build.py\\n@@ -1,6 +1,6 @@\\n import sys\\n import typer\\n-from ..project import Project\\n+from ..server import Server\\n from ..document import Document\\n from .main import program\\n from . import common\\n@@ -11,9 +11,14 @@ def program_build(\\n     source: str = common.source,\\n     target: str = common.target,\\n     format: str = common.format,\\n+    config: str = common.config,\\n     print: bool = common.print,\\n+    diff: bool = common.diff,\\n+    live: bool = common.live,\\n+    host: str = common.host,\\n+    port: str = common.port,\\n ):\\n-    \\\"\\\"\\\"Build the article.\\\"\\\"\\\"\\n+    \\\"\\\"\\\"Build Markdown file into HTML by default.\\\"\\\"\\\"\\n \\n     try:\\n \\n@@ -22,12 +27,19 @@ def program_build(\\n             source,\\n             target=target,\\n             format=format,\\n-            project=Project(),\\n-            create=True,\\n+            config=config,\\n         )\\n \\n-        # Build document\\n-        document.build(print=print)\\n+        # Normal mode\\n+        if not live:\\n+            written = document.build(diff=diff, print=print)\\n+            if written and diff:\\n+                sys.exit(1)\\n+            sys.exit(0)\\n+\\n+        # Live mode\\n+        server = Server(document)\\n+        server.start(host=host, port=port)\\n \\n     except Exception as exception:\\n         typer.secho(str(exception), err=True, fg=typer.colors.RED, bold=True)\\n\",\"diff --git a/livemark/program/common.py b/livemark/program/common.py\\nindex 400fe73..2bd8af0 100644\\n--- a/livemark/program/common.py\\n+++ b/livemark/program/common.py\\n@@ -20,10 +20,31 @@ format = Option(\\n     help=\\\"Format of the target file\\\",\\n )\\n \\n+config = Option(\\n+    settings.DEFAULT_CONFIG,\\n+    help=\\\"Path to a config file\\\",\\n+)\\n+\\n+host = Option(\\n+    settings.DEFAULT_HOST,\\n+    help=\\\"Server host\\\",\\n+)\\n+\\n+port = Option(\\n+    settings.DEFAULT_PORT,\\n+    help=\\\"Server port\\\",\\n+)\\n+\\n \\n # Command\\n \\n \\n+live = Option(\\n+    default=False,\\n+    help=\\\"Live mode\\\",\\n+)\\n+\\n+\\n diff = Option(\\n     default=False,\\n     help=\\\"Return the diff\\\",\\n\",\"diff --git a/livemark/program/merge.py b/livemark/program/merge.py\\nnew file mode 100644\\nindex 0000000..6d06ee2\\n--- /dev/null\\n+++ b/livemark/program/merge.py\\n@@ -0,0 +1,41 @@\\n+import sys\\n+import typer\\n+from ..document import Document\\n+from .main import program\\n+from . import common\\n+\\n+\\n+@program.command(name=\\\"merge\\\")\\n+def program_merge(\\n+    source: str = common.source,\\n+    config: str = common.config,\\n+    print: bool = common.print,\\n+    diff: bool = common.diff,\\n+    live: bool = common.live,\\n+    host: str = common.host,\\n+    port: str = common.port,\\n+):\\n+    \\\"\\\"\\\"Merge Markdown file into itself.\\\"\\\"\\\"\\n+\\n+    try:\\n+\\n+        # Create document\\n+        document = Document(\\n+            source,\\n+            target=source,\\n+            config=config,\\n+        )\\n+\\n+        # Normal mode\\n+        if not live:\\n+            written = document.build(diff=diff, print=print)\\n+            if written and diff:\\n+                sys.exit(1)\\n+            sys.exit(0)\\n+\\n+        # TODO: implement\\n+        sys.exit(f\\\"Live mode is not implemented: {host}:{port}\\\")\\n+\\n+    except Exception as exception:\\n+        typer.secho(str(exception), err=True, fg=typer.colors.RED, bold=True)\\n+        sys.exit(1)\\n\",\"diff --git a/livemark/program/start.py b/livemark/program/start.py\\nindex 31916f6..9d79180 100644\\n--- a/livemark/program/start.py\\n+++ b/livemark/program/start.py\\n@@ -1,56 +1,42 @@\\n+import os\\n import sys\\n import typer\\n-from pathlib import Path\\n-from livereload import Server\\n from ..document import Document\\n-from ..project import Project\\n+from ..server import Server\\n from .main import program\\n+from .. import helpers\\n from . import common\\n \\n \\n-# NOTE:\\n-# We can make this logic more sophisticated by watching\\n-# config changes in livemark.yaml and the main source file\\n-\\n-\\n @program.command(name=\\\"start\\\")\\n def program_start(\\n     source: str = common.source,\\n     target: str = common.target,\\n     format: str = common.format,\\n+    config: str = common.config,\\n+    host: str = common.host,\\n+    port: str = common.port,\\n ):\\n     \\\"\\\"\\\"Start a Livemark server.\\\"\\\"\\\"\\n \\n     try:\\n \\n+        # Create source\\n+        # TODO: create a markdown document draft?\\n+        if not os.path.exists(source):\\n+            helpers.write_file(source)\\n+\\n         # Create document\\n         document = Document(\\n             source,\\n             target=target,\\n             format=format,\\n-            project=Project(),\\n-            create=True,\\n+            config=config,\\n         )\\n \\n-        # Create documents\\n-        document.read()\\n-        documents = [document]\\n-        for page in document.config[\\\"pages\\\"][\\\"items\\\"]:\\n-            page_target = page[\\\"path\\\"][1:] or \\\"index.html\\\"\\n-            page_source = str(Path(page_target).with_suffix(\\\".md\\\"))\\n-            if page_source != source:\\n-                page_document = Document(page_source, project=document.project)\\n-                documents.append(page_document)\\n-\\n-        # Build initially\\n-        for document in documents:\\n-            document.build()\\n-\\n         # Run server\\n-        server = Server()\\n-        for document in documents:\\n-            server.watch(document.source, document.build, delay=1)\\n-        server.serve(host=\\\"localhost\\\", port=7000, root=\\\".\\\", open_url_delay=1)\\n+        server = Server(document)\\n+        server.start(host=host, port=port)\\n \\n     except Exception as exception:\\n         typer.secho(str(exception), err=True, fg=typer.colors.RED, bold=True)\\n\",\"diff --git a/livemark/program/sync.py b/livemark/program/sync.py\\ndeleted file mode 100644\\nindex a3c29d7..0000000\\n--- a/livemark/program/sync.py\\n+++ /dev/null\\n@@ -1,46 +0,0 @@\\n-import sys\\n-import typer\\n-import difflib\\n-from ..project import Project\\n-from ..document import Document\\n-from .main import program\\n-from . import common\\n-\\n-\\n-@program.command(name=\\\"sync\\\")\\n-def program_sync(\\n-    source: str = common.source,\\n-    print: bool = common.print,\\n-    diff: bool = common.diff,\\n-):\\n-    \\\"\\\"\\\"Sync the article.\\\"\\\"\\\"\\n-\\n-    try:\\n-\\n-        # Create document\\n-        document = Document(source, target=source, project=Project())\\n-\\n-        # Process document\\n-        document.process()\\n-\\n-        # Diff document\\n-        if diff:\\n-            l1 = document.input.splitlines(keepends=True)\\n-            l2 = document.output.splitlines(keepends=True)\\n-            ld = list(difflib.unified_diff(l1, l2, fromfile=\\\"source\\\", tofile=\\\"target\\\"))\\n-            if ld:\\n-                typer.secho(\\\"\\\".join(ld), nl=False)\\n-                sys.exit(1)\\n-            sys.exit(0)\\n-\\n-        # Print document\\n-        if print:\\n-            document.print()\\n-            sys.exit()\\n-\\n-        # Write document\\n-        document.write()\\n-\\n-    except Exception as exception:\\n-        typer.secho(str(exception), err=True, fg=typer.colors.RED, bold=True)\\n-        sys.exit(1)\\n\",\"diff --git a/livemark/project.py b/livemark/project.py\\ndeleted file mode 100644\\nindex d0aea99..0000000\\n--- a/livemark/project.py\\n+++ /dev/null\\n@@ -1,34 +0,0 @@\\n-import os\\n-import yaml\\n-from . import settings\\n-\\n-\\n-class Project:\\n-    \\\"\\\"\\\"Livemark project\\n-\\n-    API      | Usage\\n-    -------- | --------\\n-    Public   | `from livemark import Project`\\n-\\n-    Parameters:\\n-        path? (str): a project path\\n-\\n-    \\\"\\\"\\\"\\n-\\n-    def __init__(self, path=\\\"\\\"):\\n-        self.__path = path\\n-\\n-        # Read config\\n-        self.__config = {}\\n-        config_path = os.path.join(path, settings.DEFAULT_CONFIG_PATH)\\n-        if os.path.isfile(config_path):\\n-            with open(config_path) as file:\\n-                self.__config = yaml.safe_load(file)\\n-\\n-    @property\\n-    def path(self):\\n-        return self.__path\\n-\\n-    @property\\n-    def config(self):\\n-        return self.__config\\n\",\"diff --git a/livemark/server.py b/livemark/server.py\\nnew file mode 100644\\nindex 0000000..694fd78\\n--- /dev/null\\n+++ b/livemark/server.py\\n@@ -0,0 +1,43 @@\\n+import livereload\\n+from pathlib import Path\\n+from .document import Document\\n+from . import settings\\n+\\n+\\n+# NOTE:\\n+# We can make this logic more sophisticated by watching\\n+# config changes in livemark.yaml and the main source file\\n+# We also might implement `server.stop` although it's not supported in livereload\\n+\\n+\\n+class Server:\\n+    def __init__(self, document):\\n+        self.__document = document\\n+        self.__server = livereload.Server()\\n+        self.__config = document.config.copy()\\n+\\n+    @property\\n+    def document(self):\\n+        return self.__document\\n+\\n+    def start(self, *, host=settings.DEFAULT_HOST, port=settings.DEFAULT_PORT):\\n+\\n+        # Create documents\\n+        self.__document.read()\\n+        documents = [self.__document]\\n+        if self.__document.format == \\\"html\\\":\\n+            for page in self.__document.config[\\\"pages\\\"][\\\"items\\\"]:\\n+                page_target = page[\\\"path\\\"][1:] or \\\"index.html\\\"\\n+                page_source = str(Path(page_target).with_suffix(\\\".md\\\"))\\n+                if page_source != self.__document.source:\\n+                    page_document = Document(page_source, config=self.__config)\\n+                    documents.append(page_document)\\n+\\n+        # Build initially\\n+        for document in documents:\\n+            document.build()\\n+\\n+        # Run server\\n+        for document in documents:\\n+            self.__server.watch(document.source, document.build, delay=1)\\n+        self.__server.serve(host=host, port=port, root=\\\".\\\", open_url_delay=1)\\n\",\"diff --git a/livemark/settings.py b/livemark/settings.py\\nindex 3692875..c9c5b8e 100644\\n--- a/livemark/settings.py\\n+++ b/livemark/settings.py\\n@@ -16,5 +16,7 @@ def read_asset(*paths):\\n VERSION = read_asset(\\\"VERSION\\\")\\n DEFAULT_SOURCE = \\\"index.md\\\"\\n DEFAULT_FORMAT = \\\"html\\\"\\n-DEFAULT_CONFIG_PATH = \\\"livemark.yaml\\\"\\n+DEFAULT_CONFIG = \\\"livemark.yaml\\\"\\n+DEFAULT_HOST = \\\"localhost\\\"\\n+DEFAULT_PORT = 7000\\n UNDEFINED = object()\\n\",\"diff --git a/livemark/snippet.py b/livemark/snippet.py\\nindex 6bcb865..0e98f4e 100644\\n--- a/livemark/snippet.py\\n+++ b/livemark/snippet.py\\n@@ -1,3 +1,6 @@\\n+from .helpers import cached_property\\n+\\n+\\n class Snippet:\\n     \\\"\\\"\\\"Livemark snippet\\n \\n@@ -32,19 +35,26 @@ class Snippet:\\n     def header(self):\\n         return self.__header\\n \\n-    @property\\n-    def language(self):\\n-        language = None\\n+    @cached_property\\n+    def lang(self):\\n+        lang = None\\n         if len(self.__header) >= 1:\\n-            language = self.__header[0]\\n-        return language\\n+            lang = self.__header[0]\\n+        return lang\\n \\n-    @property\\n-    def modifier(self):\\n-        modifier = None\\n+    @cached_property\\n+    def type(self):\\n+        type = None\\n         if len(self.__header) >= 2:\\n-            modifier = self.__header[1]\\n-        return modifier\\n+            type = self.__header[1]\\n+        return type\\n+\\n+    @cached_property\\n+    def mode(self):\\n+        mode = None\\n+        if len(self.__header) >= 3:\\n+            mode = self.__header[2]\\n+        return mode\\n \\n     # Process\\n \\n\"]", "test_patch": "[\"diff --git a/tests/test_document.py b/tests/test_document.py\\nindex 30c9d716..a6a1c909 100644\\n--- a/tests/test_document.py\\n+++ b/tests/test_document.py\\n@@ -1,4 +1,4 @@\\n-from livemark import Document, Project\\n+from livemark import Document\\n \\n \\n # General\\n@@ -9,7 +9,6 @@ def test_document():\\n     document.read()\\n     assert document.source == \\\"index.md\\\"\\n     assert document.target == \\\"index.html\\\"\\n-    assert document.project is None\\n     assert document.input\\n     assert document.output is None\\n \\n@@ -19,7 +18,6 @@ def test_document_update_output():\\n     document.read()\\n     document.output = \\\"output\\\"\\n     assert document.source == \\\"index.md\\\"\\n-    assert document.project is None\\n     assert document.input\\n     assert document.output == \\\"output\\\"\\n \\n@@ -31,11 +29,10 @@ def test_document_with_format():\\n     assert document.target == \\\"index.pdf\\\"\\n \\n \\n-def test_document_with_project():\\n-    document = Document(\\\"index.md\\\", project=Project())\\n+def test_document_with_config():\\n+    document = Document(\\\"index.md\\\", config=\\\"livemark.yaml\\\")\\n     document.read()\\n     assert document.source == \\\"index.md\\\"\\n-    assert document.project.path == \\\"\\\"\\n     assert document.config[\\\"github\\\"][\\\"repo\\\"] == \\\"livemark\\\"\\n     assert document.config[\\\"pages\\\"][\\\"items\\\"]\\n     assert document.input\\n\",\"diff --git a/tests/test_project.py b/tests/test_project.py\\ndeleted file mode 100644\\nindex 79a6903e..00000000\\n--- a/tests/test_project.py\\n+++ /dev/null\\n@@ -1,10 +0,0 @@\\n-from livemark import Project\\n-\\n-\\n-# General\\n-\\n-\\n-def test_project():\\n-    project = Project()\\n-    assert project.path == \\\"\\\"\\n-    assert project.config[\\\"github\\\"][\\\"repo\\\"] == \\\"livemark\\\"\\n\",\"diff --git a/tests/test_system.py b/tests/test_system.py\\nnew file mode 100644\\nindex 00000000..42f6f43c\\n--- /dev/null\\n+++ b/tests/test_system.py\\n@@ -0,0 +1,8 @@\\n+from livemark import system\\n+\\n+\\n+# General\\n+\\n+\\n+def test_system():\\n+    assert len(system.Plugins) > 20\\n\",\"diff --git a/tests/test_server.py b/tests/test_server.py\\nnew file mode 100644\\nindex 00000000..951e8134\\n--- /dev/null\\n+++ b/tests/test_server.py\\n@@ -0,0 +1,7 @@\\n+from livemark import Server, Document\\n+\\n+\\n+def test_server():\\n+    document = Document(\\\"index.md\\\")\\n+    server = Server(document)\\n+    assert server.document is document\\n\"]", "hints_text": ""}
