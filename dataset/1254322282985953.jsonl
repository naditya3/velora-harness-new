{"instance_id": "1254322282985953", "repo": "benoitc/gunicorn", "base_commit": "26aba9ed9d55f6465fd2271169b71bc119ea8186", "problem_statement": "Request smuggling vulnerability via stripping of Unicode whitespace:\\nI reported this bug privately back in June, but it still has not been fixed, so I am making a public issue here.\\r\\n\\r\\nGunicorn strips `\\xa0` and `\\x85` bytes from the ends of header names. Thus, `Transfer-Encoding\\xa0` is treated as equivalent to `Transfer-Encoding`, and `Content-Length\\x85` is treated as equivalent to `Content-Length`. This allows for request smuggling when Gunicorn is deployed behind a reverse proxy that allows through `\\xa0` or `\\x85`. One such proxy is Apache Traffic Server.\\r\\n\\r\\nPR #3059 fixes this vulnerability.\\nImproper handling of empty list elements in `Transfer-Encoding` header values:\\nGunicorn doesn't properly handle `Transfer-Encoding header` values with empty list elements. `Transfer-Encoding` is a list-valued header, and RFC 9110 says this about list-valued header parsing:\\r\\n> A recipient MUST parse and ignore a reasonable number of empty list elements: enough to handle common mistakes by senders that merge values, but not so much that they could be used as a denial-of-service mechanism.\\r\\n\\r\\nThus, `Transfer-Encoding: ,chunked` should be equivalent to `Transfer-Encoding: chunked`. Gunicorn does not make this distinction, and is thus vulnerable to request smuggling when deployed behind gateway servers that do (and also don't normalize out the comma). There are a few widely-deployed load balancers that exhibit this behavior.", "FAIL_TO_PASS": ["tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/031compat2.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_09.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_11.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/nonascii_03.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/nonascii_04.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/prefix_05.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/003.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_03.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/prefix_02.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/version_01.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/031compat.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_06.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_07.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_04.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_05.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/prefix_01.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/nonascii_01.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_02.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/nonascii_02.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/prefix_06.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_10.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_08.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/chunked_01.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/016.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/040.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/025.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/040.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/version_02.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/040_compat.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/025compat.http]"], "PASS_TO_PASS": ["tests/test_reload.py::test_reload_on_syntax_error", "tests/test_util.py::test_warn", "tests/test_pidfile.py::test_validate_file_pid_does_not_exist", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/013.http]", "tests/test_logger.py::test_get_username_from_basic_auth_header[BASIC", "tests/test_sock.py::test_unix_socket_close_unlink", "tests/test_util.py::test_parse_address[-expected4]", "tests/test_http.py::test_eof_reader_read", "tests/test_util.py::test_parse_address[unix://var/run/test.sock-var/run/test.sock]", "tests/test_config.py::test_load_config_module", "tests/test_config.py::test_defaults", "tests/test_pidfile.py::test_validate_file_pid_exists_kill_exception", "tests/test_util.py::test_split_request_uri[https://example.org/a/b?c=1#d-expected0]", "tests/test_util.py::test_split_request_uri[a/b?c=1#d-expected1]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/021.http]", "tests/test_config.py::test_cli_overrides_enviroment_variables_module", "tests/test_arbiter.py::test_arbiter_reexec_passing_gunicorn_sockets", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/099.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/028.http]", "tests/test_util.py::test_import_app_bad[a:app-ImportError-No", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/006.http]", "tests/test_config.py::test_callable_validation_for_string", "tests/test_util.py::test_parse_address[tcp://localhost:5000-expected3]", "tests/test_arbiter.py::test_arbiter_reap_workers", "tests/test_config.py::test_str_validation", "tests/test_systemd.py::test_listen_fds_ignores_wrong_pid[True]", "tests/workers/test_geventlet.py::test_import", "tests/test_util.py::test_parse_address[127.0.0.1:8000-expected9]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/017.http]", "tests/test_config.py::test_load_config_explicit_file", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/006.http]", "tests/test_pidfile.py::test_validate_file_pid_malformed", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/009.http]", "tests/test_config.py::test_invalid_enviroment_variables_config", "tests/test_util.py::test_import_app_good[support]", "tests/test_util.py::test_import_app_bad[support:create.app-AppImportError-attribute", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/021.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/018.http]", "tests/test_util.py::test_is_ipv6[1200:0000:AB00:1234:O000:2552:7777:1313-False]", "tests/test_util.py::test_parse_address[[::1]-expected7]", "tests/test_arbiter.py::test_arbiter_reexec_limit_parent", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/019.http]", "tests/test_util.py::test_is_ipv6[1200::AB00:1234::2552:7777:1313-False]", "tests/test_util.py::test_parse_address_invalid", "tests/test_systemd.py::test_listen_fds_ignores_wrong_pid[False]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/004.http]", "tests/test_ssl.py::test_cacerts", "tests/test_config.py::test_wsgi_app_config[options2-app:app]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/023.http]", "tests/test_config.py::test_config_file_environment_variable", "tests/test_arbiter.py::test_arbiter_reexec_passing_systemd_sockets", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/014.http]", "tests/test_statsd.py::test_statsd_fail", "tests/test_config.py::test_load_enviroment_variables_config", "tests/test_util.py::test_http_date", "tests/test_http.py::test_http_header_encoding", "tests/test_util.py::test_parse_address[tcp://localhost-expected2]", "tests/test_config.py::test_str_to_list_validation", "tests/test_logger.py::test_get_username_from_basic_auth_header[basic", "tests/test_config.py::test_reload[options2-True]", "tests/test_util.py::test_import_app_bad[support:error_factory(1)-AppImportError-error_factory()", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/019.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/009.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/011.http]", "tests/test_logger.py::test_atoms_zero_bytes", "tests/test_config.py::test_reload[options3-True]", "tests/test_util.py::test_parse_address[localhost:8000-expected8]", "tests/test_http.py::test_iter_unreader_chunk", "tests/test_config.py::test_cli_overrides_config", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/029.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/004.http]", "tests/test_util.py::test_split_request_uri[///a/b?c=1#d-expected4]", "tests/test_config.py::test_default_config_file", "tests/test_http.py::test_readline_zero_size", "tests/test_statsd.py::test_prefix", "tests/test_http.py::test_unreader_read_zero_size", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/010.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/100.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/001.http]", "tests/test_util.py::test_split_request_uri[/a/b?c=1#d-expected2]", "tests/test_util.py::test_parse_fd_invalid", "tests/test_statsd.py::test_prefix_no_dot", "tests/test_http.py::test_unreader_read_with_nonzero_size", "tests/test_statsd.py::test_statsd_host_initialization", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/005.http]", "tests/test_logger.py::test_get_username_handles_malformed_basic_auth_header", "tests/workers/test_ggevent.py::test_import", "tests/test_http.py::test_readline_buffer_loaded", "tests/test_statsd.py::test_prefix_multiple_dots", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/022.http]", "tests/test_util.py::test_import_app_py_ext", "tests/test_arbiter.py::test_arbiter_stop_child_does_not_unlink_listeners", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/pp_02.http]", "tests/test_config.py::test_pos_int_validation", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/022.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/015.http]", "tests/test_http.py::test_readline_new_line_before_size", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/pp_02.http]", "tests/test_config.py::test_cmd_line_invalid_setting", "tests/test_config.py::test_bool_validation", "tests/test_http.py::test_unreader_raises_excpetion_on_invalid_size", "tests/test_logger.py::test_get_username_from_basic_auth_header[Basic", "tests/test_util.py::test_parse_address[[::1]:5000-expected6]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/pp_01.http]", "tests/test_config.py::test_umask_config[options1-0]", "tests/test_config.py::test_umask_config[options2-0]", "tests/test_http.py::test_length_reader_read_invalid_size", "tests/test_util.py::test_import_app_bad[support:create_app(-AppImportError-Failed", "tests/test_statsd.py::test_instrument", "tests/test_sock.py::test_create_sockets_unix_strings", "tests/test_util.py::test_is_ipv6[21DA:D3:0:2F3B:2AA:FF:FE28:9C5A-True]", "tests/test_util.py::test_parse_address[fd://33-33]", "tests/test_systemd.py::test_listen_fds_returns_count[True]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/012.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/011.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/003.http]", "tests/test_config.py::test_repr", "tests/test_ssl.py::test_keyfile", "tests/test_http.py::test_http_invalid_response_header", "tests/test_util.py::test_parse_address[localhost-expected10]", "tests/test_config.py::test_non_wsgi_app[options0]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/002.http]", "tests/test_util.py::test_import_app_bad[support:create.app()-AppImportError-Function", "tests/test_logger.py::test_atoms_defaults", "tests/test_arbiter.py::test_arbiter_calls_worker_exit", "tests/test_config.py::test_reload[options1-True]", "tests/test_util.py::test_import_app_bad[support:wrong_app-AppImportError-find", "tests/test_http.py::test_readline_new_line_after_size", "tests/test_util.py::test_import_app_bad[support:create_app(Gunicorn)-AppImportError-literal", "tests/test_util.py::test_import_app_bad[support:error_factory()-TypeError-inner]", "tests/test_statsd.py::test_prefix_nested", "tests/test_reload.py::test_start_reloader_after_load_wsgi", "tests/test_config.py::test_wsgi_app_config[options1-app:app]", "tests/test_config.py::test_cmd_line", "tests/test_config.py::test_statsd_host_with_unix_as_hostname", "tests/test_util.py::test_import_app_bad[support:HOST-AppImportError-callable]", "tests/test_ssl.py::test_ciphers", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/024.http]", "tests/test_ssl.py::test_do_handshake_on_connect", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/005.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/007.http]", "tests/test_arbiter.py::test_arbiter_stop_does_not_unlink_when_using_reuse_port", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/020.http]", "tests/test_http.py::test_readline_buffer_loaded_with_size", "tests/test_config.py::test_nworkers_changed", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/027.http]", "tests/test_config.py::test_non_wsgi_app[options1]", "tests/test_pidfile.py::test_validate_no_file", "tests/test_util.py::test_parse_address[unix:/var/run/test.sock-/var/run/test.sock]", "tests/test_util.py::test_parse_address[[::1]:8000-expected5]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/023.http]", "tests/test_config.py::test_reload_engine_validation", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/008.http]", "tests/test_config.py::test_statsd_host", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/013.http]", "tests/test_util.py::test_import_app_good[support:create_app()]", "tests/test_sock.py::test_create_sockets_unix_bytes", "tests/test_http.py::test_eof_reader_read_invalid_size", "tests/test_util.py::test_import_app_bad[support:none_app-AppImportError-find", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/014.http]", "tests/test_http.py::test_unreader_unread", "tests/test_config.py::test_property_access", "tests/test_config.py::test_post_request", "tests/test_config.py::test_umask_config[options0-0]", "tests/test_util.py::test_import_app_good[support:create_app(count=3)]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/016.http]", "tests/test_config.py::test_bind_fd", "tests/test_ssl.py::test_suppress_ragged_eofs", "tests/test_util.py::test_import_app_good[support:create_app('Gunicorn',", "tests/test_config.py::test_umask_config[options4-18]", "tests/test_statsd.py::test_dogstatsd_tags", "tests/test_config.py::test_callable_validation", "tests/test_sock.py::test_unix_socket_close_without_unlink", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/020.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/024.http]", "tests/test_config.py::test_wsgi_app_config[options3-app1:app1]", "tests/test_util.py::test_to_bytestring", "tests/test_config.py::test_statsd_changes_logger", "tests/test_sock.py::test_socket_close", "tests/test_arbiter.py::test_env_vars_available_during_preload", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/017.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/002.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/012.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/001.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/030.http]", "tests/test_pidfile.py::test_validate_file_pid_exists", "tests/test_http.py::test_unreader_read_when_size_is_none", "tests/test_arbiter.py::test_arbiter_reexec_limit_child", "tests/test_systemd.py::test_listen_fds_returns_count[False]", "tests/test_config.py::test_str", "tests/test_util.py::test_is_ipv6[1200:0000:AB00:1234:0000:2552:7777:1313-True]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/015.http]", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/008.http]", "tests/test_config.py::test_wsgi_app_config[options0-app:app]", "tests/test_config.py::test_cli_overrides_config_module", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/026.http]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/010.http]", "tests/test_util.py::test_split_request_uri[//a/b?c=1#d-expected3]", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/007.http]", "tests/test_util.py::test_import_app_good[support:app]", "tests/test_config.py::test_always_use_configured_logger", "tests/test_config.py::test_load_config", "tests/test_ssl.py::test_certfile", "tests/test_config.py::test_app_config", "tests/test_arbiter.py::test_arbiter_stop_does_not_unlink_systemd_listeners", "tests/test_http.py::test_readline_no_new_line", "tests/test_arbiter.py::test_arbiter_stop_parent_does_not_unlink_listeners", "tests/test_valid_requests.py::test_http_parser[/app/repo/tests/requests/valid/pp_01.http]", "tests/test_http.py::test_socket_unreader_chunk", "tests/test_invalid_requests.py::test_http_parser[/app/repo/tests/requests/invalid/018.http]", "tests/test_http.py::test_readline_empty_body", "tests/test_http.py::test_length_reader_read", "tests/test_config.py::test_umask_config[options3-255]", "tests/test_arbiter.py::test_arbiter_stop_closes_listeners", "tests/test_config.py::test_reload[options0-False]"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && tox -- --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/benoitc_gunicorn:26aba9ed9d55f6465fd2271169b71bc119ea8186", "patch": "[\"diff --git a/gunicorn/http/body.py b/gunicorn/http/body.py\\nindex aa1af2cb3..41fe334bc 100644\\n--- a/gunicorn/http/body.py\\n+++ b/gunicorn/http/body.py\\n@@ -86,10 +86,9 @@ def parse_chunk_size(self, unreader, data=None):\\n         line, rest_chunk = data[:idx], data[idx + 2:]\\n \\n         chunk_size = line.split(b\\\";\\\", 1)[0].strip()\\n-        try:\\n-            chunk_size = int(chunk_size, 16)\\n-        except ValueError:\\n+        if any(n not in b\\\"0123456789abcdefABCDEF\\\" for n in chunk_size):\\n             raise InvalidChunkSize(chunk_size)\\n+        chunk_size = int(chunk_size, 16)\\n \\n         if chunk_size == 0:\\n             try:\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 1f93c7145..0006fa61b 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -21,7 +21,7 @@\\n MAX_HEADERS = 32768\\n DEFAULT_MAX_HEADERFIELD_SIZE = 8190\\n \\n-HEADER_RE = re.compile(r\\\"[\\\\x00-\\\\x1F\\\\x7F()<>@,;:\\\\[\\\\]={} \\\\t\\\\\\\\\\\\\\\"]\\\")\\n+HEADER_RE = re.compile(r\\\"[^!#$%&'*+\\\\-.\\\\^_`|~0-9a-zA-Z]\\\")\\n METH_RE = re.compile(r\\\"[A-Z0-9$-_.]{3,20}\\\")\\n VERSION_RE = re.compile(r\\\"HTTP/(\\\\d+)\\\\.(\\\\d+)\\\")\\n \\n\",\"diff --git a/gunicorn/http/wsgi.py b/gunicorn/http/wsgi.py\\nindex 25715eab7..10c5a3dd5 100644\\n--- a/gunicorn/http/wsgi.py\\n+++ b/gunicorn/http/wsgi.py\\n@@ -18,7 +18,7 @@\\n # with sending files in blocks over 2GB.\\n BLKSIZE = 0x3FFFFFFF\\n \\n-HEADER_VALUE_RE = re.compile(r'[\\\\x00-\\\\x1F\\\\x7F]')\\n+HEADER_VALUE_RE = re.compile(r'[^ \\\\t\\\\x21-\\\\x7e\\\\x80-\\\\xff]')\\n \\n log = logging.getLogger(__name__)\\n \\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 0006fa61b..11ee4d15c 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -83,7 +83,7 @@ def parse_headers(self, data):\\n             # Parse initial header name : value pair.\\n             curr = lines.pop(0)\\n             header_length = len(curr)\\n-            if curr.find(\\\":\\\") < 0:\\n+            if curr.find(\\\":\\\") <= 0:\\n                 raise InvalidHeader(curr.strip())\\n             name, value = curr.split(\\\":\\\", 1)\\n             if self.cfg.strip_header_spaces:\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 11ee4d15c..db3d44bb2 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -21,8 +21,7 @@\\n MAX_HEADERS = 32768\\n DEFAULT_MAX_HEADERFIELD_SIZE = 8190\\n \\n-HEADER_RE = re.compile(r\\\"[^!#$%&'*+\\\\-.\\\\^_`|~0-9a-zA-Z]\\\")\\n-METH_RE = re.compile(r\\\"[A-Z0-9$-_.]{3,20}\\\")\\n+TOKEN_RE = re.compile(r\\\"[!#$%&'*+\\\\-.\\\\^_`|~0-9a-zA-Z]+\\\")\\n VERSION_RE = re.compile(r\\\"HTTP/(\\\\d+)\\\\.(\\\\d+)\\\")\\n \\n \\n@@ -63,8 +62,8 @@ def parse_headers(self, data):\\n         cfg = self.cfg\\n         headers = []\\n \\n-        # Split lines on \\\\r\\\\n keeping the \\\\r\\\\n on each line\\n-        lines = [bytes_to_str(line) + \\\"\\\\r\\\\n\\\" for line in data.split(b\\\"\\\\r\\\\n\\\")]\\n+        # Split lines on \\\\r\\\\n\\n+        lines = [bytes_to_str(line) for line in data.split(b\\\"\\\\r\\\\n\\\")]\\n \\n         # handle scheme headers\\n         scheme_header = False\\n@@ -80,30 +79,30 @@ def parse_headers(self, data):\\n             if len(headers) >= self.limit_request_fields:\\n                 raise LimitRequestHeaders(\\\"limit request headers fields\\\")\\n \\n-            # Parse initial header name : value pair.\\n+            # Parse initial header name: value pair.\\n             curr = lines.pop(0)\\n-            header_length = len(curr)\\n+            header_length = len(curr) + len(\\\"\\\\r\\\\n\\\")\\n             if curr.find(\\\":\\\") <= 0:\\n-                raise InvalidHeader(curr.strip())\\n+                raise InvalidHeader(curr)\\n             name, value = curr.split(\\\":\\\", 1)\\n             if self.cfg.strip_header_spaces:\\n                 name = name.rstrip(\\\" \\\\t\\\").upper()\\n             else:\\n                 name = name.upper()\\n-            if HEADER_RE.search(name):\\n+            if not TOKEN_RE.fullmatch(name):\\n                 raise InvalidHeaderName(name)\\n \\n-            name, value = name.strip(), [value.lstrip()]\\n+            value = [value.lstrip(\\\" \\\\t\\\")]\\n \\n             # Consume value continuation lines\\n             while lines and lines[0].startswith((\\\" \\\", \\\"\\\\t\\\")):\\n                 curr = lines.pop(0)\\n-                header_length += len(curr)\\n+                header_length += len(curr) + len(\\\"\\\\r\\\\n\\\")\\n                 if header_length > self.limit_request_field_size > 0:\\n                     raise LimitRequestHeaders(\\\"limit request headers \\\"\\n                                               \\\"fields size\\\")\\n-                value.append(curr)\\n-            value = ''.join(value).rstrip()\\n+                value.append(curr.strip(\\\"\\\\t \\\"))\\n+            value = \\\" \\\".join(value)\\n \\n             if header_length > self.limit_request_field_size > 0:\\n                 raise LimitRequestHeaders(\\\"limit request headers fields size\\\")\\n@@ -156,7 +155,7 @@ def set_body_reader(self):\\n     def should_close(self):\\n         for (h, v) in self.headers:\\n             if h == \\\"CONNECTION\\\":\\n-                v = v.lower().strip()\\n+                v = v.lower().strip(\\\" \\\\t\\\")\\n                 if v == \\\"close\\\":\\n                     return True\\n                 elif v == \\\"keep-alive\\\":\\n@@ -283,7 +282,7 @@ def proxy_protocol_access_check(self):\\n             raise ForbiddenProxyRequest(self.peer_addr[0])\\n \\n     def parse_proxy_protocol(self, line):\\n-        bits = line.split()\\n+        bits = line.split(\\\" \\\")\\n \\n         if len(bits) != 6:\\n             raise InvalidProxyLine(line)\\n@@ -328,12 +327,12 @@ def parse_proxy_protocol(self, line):\\n         }\\n \\n     def parse_request_line(self, line_bytes):\\n-        bits = [bytes_to_str(bit) for bit in line_bytes.split(None, 2)]\\n+        bits = [bytes_to_str(bit) for bit in line_bytes.split(b\\\" \\\", 2)]\\n         if len(bits) != 3:\\n             raise InvalidRequestLine(bytes_to_str(line_bytes))\\n \\n         # Method\\n-        if not METH_RE.match(bits[0]):\\n+        if not TOKEN_RE.fullmatch(bits[0]):\\n             raise InvalidRequestMethod(bits[0])\\n         self.method = bits[0].upper()\\n \\n@@ -349,7 +348,7 @@ def parse_request_line(self, line_bytes):\\n         self.fragment = parts.fragment or \\\"\\\"\\n \\n         # Version\\n-        match = VERSION_RE.match(bits[2])\\n+        match = VERSION_RE.fullmatch(bits[2])\\n         if match is None:\\n             raise InvalidHTTPVersion(bits[2])\\n         self.version = (int(match.group(1)), int(match.group(2)))\\n\",\"diff --git a/gunicorn/http/wsgi.py b/gunicorn/http/wsgi.py\\nindex 10c5a3dd5..7fca61422 100644\\n--- a/gunicorn/http/wsgi.py\\n+++ b/gunicorn/http/wsgi.py\\n@@ -9,7 +9,7 @@\\n import re\\n import sys\\n \\n-from gunicorn.http.message import HEADER_RE\\n+from gunicorn.http.message import TOKEN_RE\\n from gunicorn.http.errors import InvalidHeader, InvalidHeaderName\\n from gunicorn import SERVER_SOFTWARE, SERVER\\n from gunicorn import util\\n@@ -18,7 +18,9 @@\\n # with sending files in blocks over 2GB.\\n BLKSIZE = 0x3FFFFFFF\\n \\n-HEADER_VALUE_RE = re.compile(r'[^ \\\\t\\\\x21-\\\\x7e\\\\x80-\\\\xff]')\\n+# RFC9110 5.5: field-vchar = VCHAR / obs-text\\n+# RFC4234 B.1: VCHAR = 0x21-x07E = printable ASCII\\n+HEADER_VALUE_RE = re.compile(r'[ \\\\t\\\\x21-\\\\x7e\\\\x80-\\\\xff]*')\\n \\n log = logging.getLogger(__name__)\\n \\n@@ -249,31 +251,32 @@ def process_headers(self, headers):\\n             if not isinstance(name, str):\\n                 raise TypeError('%r is not a string' % name)\\n \\n-            if HEADER_RE.search(name):\\n+            if not TOKEN_RE.fullmatch(name):\\n                 raise InvalidHeaderName('%r' % name)\\n \\n             if not isinstance(value, str):\\n                 raise TypeError('%r is not a string' % value)\\n \\n-            if HEADER_VALUE_RE.search(value):\\n+            if not HEADER_VALUE_RE.fullmatch(value):\\n                 raise InvalidHeader('%r' % value)\\n \\n-            value = value.strip()\\n-            lname = name.lower().strip()\\n+            # RFC9110 5.5\\n+            value = value.strip(\\\" \\\\t\\\")\\n+            lname = name.lower()\\n             if lname == \\\"content-length\\\":\\n                 self.response_length = int(value)\\n             elif util.is_hoppish(name):\\n                 if lname == \\\"connection\\\":\\n                     # handle websocket\\n-                    if value.lower().strip() == \\\"upgrade\\\":\\n+                    if value.lower() == \\\"upgrade\\\":\\n                         self.upgrade = True\\n                 elif lname == \\\"upgrade\\\":\\n-                    if value.lower().strip() == \\\"websocket\\\":\\n-                        self.headers.append((name.strip(), value))\\n+                    if value.lower() == \\\"websocket\\\":\\n+                        self.headers.append((name, value))\\n \\n                 # ignore hopbyhop headers\\n                 continue\\n-            self.headers.append((name.strip(), value))\\n+            self.headers.append((name, value))\\n \\n     def is_chunked(self):\\n         # Only use chunked responses when the client is\\n\",\"diff --git a/gunicorn/http/errors.py b/gunicorn/http/errors.py\\nindex 7839ef05a..05abd1ab0 100644\\n--- a/gunicorn/http/errors.py\\n+++ b/gunicorn/http/errors.py\\n@@ -22,6 +22,15 @@ def __str__(self):\\n         return \\\"No more data after: %r\\\" % self.buf\\n \\n \\n+class ConfigurationProblem(ParseException):\\n+    def __init__(self, info):\\n+        self.info = info\\n+        self.code = 500\\n+\\n+    def __str__(self):\\n+        return \\\"Configuration problem: %s\\\" % self.info\\n+\\n+\\n class InvalidRequestLine(ParseException):\\n     def __init__(self, req):\\n         self.req = req\\n\",\"diff --git a/gunicorn/http/wsgi.py b/gunicorn/http/wsgi.py\\nindex 7fca61422..bafed49eb 100644\\n--- a/gunicorn/http/wsgi.py\\n+++ b/gunicorn/http/wsgi.py\\n@@ -10,7 +10,7 @@\\n import sys\\n \\n from gunicorn.http.message import TOKEN_RE\\n-from gunicorn.http.errors import InvalidHeader, InvalidHeaderName\\n+from gunicorn.http.errors import ConfigurationProblem, InvalidHeader, InvalidHeaderName\\n from gunicorn import SERVER_SOFTWARE, SERVER\\n from gunicorn import util\\n \\n@@ -182,7 +182,11 @@ def create(req, sock, client, server, cfg):\\n     # set the path and script name\\n     path_info = req.path\\n     if script_name:\\n-        path_info = path_info.split(script_name, 1)[1]\\n+        if not path_info.startswith(script_name):\\n+            raise ConfigurationProblem(\\n+                \\\"Request path %r does not start with SCRIPT_NAME %r\\\" %\\n+                (path_info, script_name))\\n+        path_info = path_info[len(script_name):]\\n     environ['PATH_INFO'] = util.unquote_to_wsgi_str(path_info)\\n     environ['SCRIPT_NAME'] = script_name\\n \\n\",\"diff --git a/gunicorn/config.py b/gunicorn/config.py\\nindex 84e7619e4..808a4b046 100644\\n--- a/gunicorn/config.py\\n+++ b/gunicorn/config.py\\n@@ -2254,5 +2254,49 @@ class StripHeaderSpaces(Setting):\\n         This is known to induce vulnerabilities and is not compliant with the HTTP/1.1 standard.\\n         See https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn.\\n \\n-        Use with care and only if necessary.\\n+        Use with care and only if necessary. May be removed in a future version.\\n+\\n+        .. versionadded:: 20.0.1\\n+        \\\"\\\"\\\"\\n+\\n+\\n+class PermitUnconventionalHTTPMethod(Setting):\\n+    name = \\\"permit_unconventional_http_method\\\"\\n+    section = \\\"Server Mechanics\\\"\\n+    cli = [\\\"--permit-unconventional-http-method\\\"]\\n+    validator = validate_bool\\n+    action = \\\"store_true\\\"\\n+    default = False\\n+    desc = \\\"\\\"\\\"\\\\\\n+        Permit HTTP methods not matching conventions, such as IANA registration guidelines\\n+\\n+        This permits request methods of length less than 3 or more than 20,\\n+        methods with lowercase characters or methods containing the # character.\\n+        HTTP methods are case sensitive by definition, and merely uppercase by convention.\\n+\\n+        This option is provided to diagnose backwards-incompatible changes.\\n+\\n+        Use with care and only if necessary. May be removed in a future version.\\n+\\n+        .. versionadded:: 22.0.0\\n         \\\"\\\"\\\"\\n+\\n+\\n+class CasefoldHTTPMethod(Setting):\\n+    name = \\\"casefold_http_method\\\"\\n+    section = \\\"Server Mechanics\\\"\\n+    cli = [\\\"--casefold-http-method\\\"]\\n+    validator = validate_bool\\n+    action = \\\"store_true\\\"\\n+    default = False\\n+    desc = \\\"\\\"\\\"\\\\\\n+         Transform received HTTP methods to uppercase\\n+\\n+         HTTP methods are case sensitive by definition, and merely uppercase by convention.\\n+\\n+         This option is provided because previous versions of gunicorn defaulted to this behaviour.\\n+\\n+         Use with care and only if necessary. May be removed in a future version.\\n+\\n+         .. versionadded:: 22.0.0\\n+         \\\"\\\"\\\"\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex db3d44bb2..2aa021c8d 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -21,7 +21,10 @@\\n MAX_HEADERS = 32768\\n DEFAULT_MAX_HEADERFIELD_SIZE = 8190\\n \\n-TOKEN_RE = re.compile(r\\\"[!#$%&'*+\\\\-.\\\\^_`|~0-9a-zA-Z]+\\\")\\n+# verbosely on purpose, avoid backslash ambiguity\\n+RFC9110_5_6_2_TOKEN_SPECIALS = r\\\"!#$%&'*+-.^_`|~\\\"\\n+TOKEN_RE = re.compile(r\\\"[%s0-9a-zA-Z]+\\\" % (re.escape(RFC9110_5_6_2_TOKEN_SPECIALS)))\\n+METHOD_BADCHAR_RE = re.compile(\\\"[a-z#]\\\")\\n VERSION_RE = re.compile(r\\\"HTTP/(\\\\d+)\\\\.(\\\\d+)\\\")\\n \\n \\n@@ -331,10 +334,23 @@ def parse_request_line(self, line_bytes):\\n         if len(bits) != 3:\\n             raise InvalidRequestLine(bytes_to_str(line_bytes))\\n \\n-        # Method\\n-        if not TOKEN_RE.fullmatch(bits[0]):\\n-            raise InvalidRequestMethod(bits[0])\\n-        self.method = bits[0].upper()\\n+        # Method: RFC9110 Section 9\\n+        self.method = bits[0]\\n+\\n+        # nonstandard restriction, suitable for all IANA registered methods\\n+        # partially enforced in previous gunicorn versions\\n+        if not self.cfg.permit_unconventional_http_method:\\n+            if METHOD_BADCHAR_RE.search(self.method):\\n+                raise InvalidRequestMethod(self.method)\\n+            if not 3 <= len(bits[0]) <= 20:\\n+                raise InvalidRequestMethod(self.method)\\n+        # standard restriction: RFC9110 token\\n+        if not TOKEN_RE.fullmatch(self.method):\\n+            raise InvalidRequestMethod(self.method)\\n+        # nonstandard and dangerous\\n+        # methods are merely uppercase by convention, no case-insensitive treatment is intended\\n+        if self.cfg.casefold_http_method:\\n+            self.method = self.method.upper()\\n \\n         # URI\\n         self.uri = bits[1]\\n\",\"diff --git a/gunicorn/config.py b/gunicorn/config.py\\nindex 808a4b046..50baeb616 100644\\n--- a/gunicorn/config.py\\n+++ b/gunicorn/config.py\\n@@ -2300,3 +2300,47 @@ class CasefoldHTTPMethod(Setting):\\n \\n          .. versionadded:: 22.0.0\\n          \\\"\\\"\\\"\\n+\\n+\\n+def validate_header_map_behaviour(val):\\n+    # FIXME: refactor all of this subclassing stdlib argparse\\n+\\n+    if val is None:\\n+        return\\n+\\n+    if not isinstance(val, str):\\n+        raise TypeError(\\\"Invalid type for casting: %s\\\" % val)\\n+    if val.lower().strip() == \\\"drop\\\":\\n+        return \\\"drop\\\"\\n+    elif val.lower().strip() == \\\"refuse\\\":\\n+        return \\\"refuse\\\"\\n+    elif val.lower().strip() == \\\"dangerous\\\":\\n+        return \\\"dangerous\\\"\\n+    else:\\n+        raise ValueError(\\\"Invalid header map behaviour: %s\\\" % val)\\n+\\n+\\n+class HeaderMap(Setting):\\n+    name = \\\"header_map\\\"\\n+    section = \\\"Server Mechanics\\\"\\n+    cli = [\\\"--header-map\\\"]\\n+    validator = validate_header_map_behaviour\\n+    default = \\\"drop\\\"\\n+    desc = \\\"\\\"\\\"\\\\\\n+        Configure how header field names are mapped into environ\\n+\\n+        Headers containing underscores are permitted by RFC9110,\\n+        but gunicorn joining headers of different names into\\n+        the same environment variable will dangerously confuse applications as to which is which.\\n+\\n+        The safe default ``drop`` is to silently drop headers that cannot be unambiguously mapped.\\n+        The value ``refuse`` will return an error if a request contains *any* such header.\\n+        The value ``dangerous`` matches the previous, not advisabble, behaviour of mapping different\\n+        header field names into the same environ name.\\n+\\n+        Use with care and only if necessary and after considering if your problem could\\n+        instead be solved by specifically renaming or rewriting only the intended headers\\n+        on a proxy in front of Gunicorn.\\n+\\n+        .. versionadded:: 22.0.0\\n+        \\\"\\\"\\\"\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 2aa021c8d..59a780f6c 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -120,6 +120,23 @@ def parse_headers(self, data):\\n                     scheme_header = True\\n                     self.scheme = scheme\\n \\n+            # ambiguous mapping allows fooling downstream, e.g. merging non-identical headers:\\n+            # X-Forwarded-For: 2001:db8::ha:cc:ed\\n+            # X_Forwarded_For: 127.0.0.1,::1\\n+            # HTTP_X_FORWARDED_FOR = 2001:db8::ha:cc:ed,127.0.0.1,::1\\n+            # Only modify after fixing *ALL* header transformations; network to wsgi env\\n+            if \\\"_\\\" in name:\\n+                if self.cfg.header_map == \\\"dangerous\\\":\\n+                    # as if we did not know we cannot safely map this\\n+                    pass\\n+                elif self.cfg.header_map == \\\"drop\\\":\\n+                    # almost as if it never had been there\\n+                    # but still counts against resource limits\\n+                    continue\\n+                else:\\n+                    # fail-safe fallthrough: refuse\\n+                    raise InvalidHeaderName(name)\\n+\\n             headers.append((name, value))\\n \\n         return headers\\n\",\"diff --git a/gunicorn/http/wsgi.py b/gunicorn/http/wsgi.py\\nindex bafed49eb..6f3d9b68f 100644\\n--- a/gunicorn/http/wsgi.py\\n+++ b/gunicorn/http/wsgi.py\\n@@ -135,6 +135,8 @@ def create(req, sock, client, server, cfg):\\n             environ['CONTENT_LENGTH'] = hdr_value\\n             continue\\n \\n+        # do not change lightly, this is a common source of security problems\\n+        # RFC9110 Section 17.10 discourages ambiguous or incomplete mappings\\n         key = 'HTTP_' + hdr_name.replace('-', '_')\\n         if key in environ:\\n             hdr_value = \\\"%s,%s\\\" % (environ[key], hdr_value)\\n\",\"diff --git a/gunicorn/workers/base.py b/gunicorn/workers/base.py\\nindex f321dd2d4..f97d923c7 100644\\n--- a/gunicorn/workers/base.py\\n+++ b/gunicorn/workers/base.py\\n@@ -251,6 +251,8 @@ def handle_error(self, req, client, addr, exc):\\n         else:\\n             if hasattr(req, \\\"uri\\\"):\\n                 self.log.exception(\\\"Error handling request %s\\\", req.uri)\\n+            else:\\n+                self.log.exception(\\\"Error handling request (no URI read)\\\")\\n             status_int = 500\\n             reason = \\\"Internal Server Error\\\"\\n             mesg = \\\"\\\"\\n\",\"diff --git a/gunicorn/config.py b/gunicorn/config.py\\nindex 50baeb616..be9bb001c 100644\\n--- a/gunicorn/config.py\\n+++ b/gunicorn/config.py\\n@@ -2344,3 +2344,21 @@ class HeaderMap(Setting):\\n \\n         .. versionadded:: 22.0.0\\n         \\\"\\\"\\\"\\n+\\n+\\n+class TolerateDangerousFraming(Setting):\\n+    name = \\\"tolerate_dangerous_framing\\\"\\n+    section = \\\"Server Mechanics\\\"\\n+    cli = [\\\"--tolerate-dangerous-framing\\\"]\\n+    validator = validate_bool\\n+    action = \\\"store_true\\\"\\n+    default = False\\n+    desc = \\\"\\\"\\\"\\\\\\n+        Process requests with both Transfer-Encoding and Content-Length\\n+\\n+        This is known to induce vulnerabilities, but not strictly forbidden by RFC9112.\\n+\\n+        Use with care and only if necessary. May be removed in a future version.\\n+\\n+        .. versionadded:: 22.0.0\\n+        \\\"\\\"\\\"\\n\",\"diff --git a/gunicorn/http/errors.py b/gunicorn/http/errors.py\\nindex 05abd1ab0..340f0473c 100644\\n--- a/gunicorn/http/errors.py\\n+++ b/gunicorn/http/errors.py\\n@@ -73,6 +73,15 @@ def __str__(self):\\n         return \\\"Invalid HTTP header name: %r\\\" % self.hdr\\n \\n \\n+class UnsupportedTransferCoding(ParseException):\\n+    def __init__(self, hdr):\\n+        self.hdr = hdr\\n+        self.code = 501\\n+\\n+    def __str__(self):\\n+        return \\\"Unsupported transfer coding: %r\\\" % self.hdr\\n+\\n+\\n class InvalidChunkSize(IOError):\\n     def __init__(self, data):\\n         self.data = data\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 59a780f6c..75b36e330 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -12,6 +12,7 @@\\n     InvalidHeader, InvalidHeaderName, NoMoreData,\\n     InvalidRequestLine, InvalidRequestMethod, InvalidHTTPVersion,\\n     LimitRequestLine, LimitRequestHeaders,\\n+    UnsupportedTransferCoding,\\n )\\n from gunicorn.http.errors import InvalidProxyLine, ForbiddenProxyRequest\\n from gunicorn.http.errors import InvalidSchemeHeaders\\n@@ -39,6 +40,7 @@ def __init__(self, cfg, unreader, peer_addr):\\n         self.trailers = []\\n         self.body = None\\n         self.scheme = \\\"https\\\" if cfg.is_ssl else \\\"http\\\"\\n+        self.must_close = False\\n \\n         # set headers limits\\n         self.limit_request_fields = cfg.limit_request_fields\\n@@ -58,6 +60,9 @@ def __init__(self, cfg, unreader, peer_addr):\\n         self.unreader.unread(unused)\\n         self.set_body_reader()\\n \\n+    def force_close(self):\\n+        self.must_close = True\\n+\\n     def parse(self, unreader):\\n         raise NotImplementedError()\\n \\n@@ -152,9 +157,47 @@ def set_body_reader(self):\\n                 content_length = value\\n             elif name == \\\"TRANSFER-ENCODING\\\":\\n                 if value.lower() == \\\"chunked\\\":\\n+                    # DANGER: transer codings stack, and stacked chunking is never intended\\n+                    if chunked:\\n+                        raise InvalidHeader(\\\"TRANSFER-ENCODING\\\", req=self)\\n                     chunked = True\\n+                elif value.lower() == \\\"identity\\\":\\n+                    # does not do much, could still plausibly desync from what the proxy does\\n+                    # safe option: nuke it, its never needed\\n+                    if chunked:\\n+                        raise InvalidHeader(\\\"TRANSFER-ENCODING\\\", req=self)\\n+                elif value.lower() == \\\"\\\":\\n+                    # lacking security review on this case\\n+                    # offer the option to restore previous behaviour, but refuse by default, for now\\n+                    self.force_close()\\n+                    if not self.cfg.tolerate_dangerous_framing:\\n+                        raise UnsupportedTransferCoding(value)\\n+                # DANGER: do not change lightly; ref: request smuggling\\n+                # T-E is a list and we *could* support correctly parsing its elements\\n+                #  .. but that is only safe after getting all the edge cases right\\n+                #  .. for which no real-world need exists, so best to NOT open that can of worms\\n+                else:\\n+                    self.force_close()\\n+                    # even if parser is extended, retain this branch:\\n+                    #  the \\\"chunked not last\\\" case remains to be rejected!\\n+                    raise UnsupportedTransferCoding(value)\\n \\n         if chunked:\\n+            # two potentially dangerous cases:\\n+            #  a) CL + TE (TE overrides CL.. only safe if the recipient sees it that way too)\\n+            #  b) chunked HTTP/1.0 (always faulty)\\n+            if self.version < (1, 1):\\n+                # framing wonky, see RFC 9112 Section 6.1\\n+                self.force_close()\\n+                if not self.cfg.tolerate_dangerous_framing:\\n+                    raise InvalidHeader(\\\"TRANSFER-ENCODING\\\", req=self)\\n+            if content_length is not None:\\n+                # we cannot be certain the message framing we understood matches proxy intent\\n+                #  -> whatever happens next, remaining input must not be trusted\\n+                self.force_close()\\n+                # either processing or rejecting is permitted in RFC 9112 Section 6.1\\n+                if not self.cfg.tolerate_dangerous_framing:\\n+                    raise InvalidHeader(\\\"CONTENT-LENGTH\\\", req=self)\\n             self.body = Body(ChunkedReader(self, self.unreader))\\n         elif content_length is not None:\\n             try:\\n@@ -173,6 +216,8 @@ def set_body_reader(self):\\n             self.body = Body(EOFReader(self.unreader))\\n \\n     def should_close(self):\\n+        if self.must_close:\\n+            return True\\n         for (h, v) in self.headers:\\n             if h == \\\"CONNECTION\\\":\\n                 v = v.lower().strip(\\\" \\\\t\\\")\\n\",\"diff --git a/gunicorn/http/body.py b/gunicorn/http/body.py\\nindex 41fe334bc..2ae0eb848 100644\\n--- a/gunicorn/http/body.py\\n+++ b/gunicorn/http/body.py\\n@@ -51,7 +51,7 @@ def parse_trailers(self, unreader, data):\\n         if done:\\n             unreader.unread(buf.getvalue()[2:])\\n             return b\\\"\\\"\\n-        self.req.trailers = self.req.parse_headers(buf.getvalue()[:idx])\\n+        self.req.trailers = self.req.parse_headers(buf.getvalue()[:idx], from_trailer=True)\\n         unreader.unread(buf.getvalue()[idx + 4:])\\n \\n     def parse_chunked(self, unreader):\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 75b36e330..67fffd9e8 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -66,7 +66,7 @@ def force_close(self):\\n     def parse(self, unreader):\\n         raise NotImplementedError()\\n \\n-    def parse_headers(self, data):\\n+    def parse_headers(self, data, from_trailer=False):\\n         cfg = self.cfg\\n         headers = []\\n \\n@@ -76,9 +76,13 @@ def parse_headers(self, data):\\n         # handle scheme headers\\n         scheme_header = False\\n         secure_scheme_headers = {}\\n-        if ('*' in cfg.forwarded_allow_ips or\\n-            not isinstance(self.peer_addr, tuple)\\n-                or self.peer_addr[0] in cfg.forwarded_allow_ips):\\n+        if from_trailer:\\n+            # nonsense. either a request is https from the beginning\\n+            #  .. or we are just behind a proxy who does not remove conflicting trailers\\n+            pass\\n+        elif ('*' in cfg.forwarded_allow_ips or\\n+              not isinstance(self.peer_addr, tuple)\\n+              or self.peer_addr[0] in cfg.forwarded_allow_ips):\\n             secure_scheme_headers = cfg.secure_scheme_headers\\n \\n         # Parse headers into key/value pairs paying attention\\n@@ -294,7 +298,7 @@ def parse(self, unreader):\\n             self.unreader.unread(data[2:])\\n             return b\\\"\\\"\\n \\n-        self.headers = self.parse_headers(data[:idx])\\n+        self.headers = self.parse_headers(data[:idx], from_trailer=False)\\n \\n         ret = data[idx + 4:]\\n         buf = None\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 67fffd9e8..4e1c2fd55 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -98,12 +98,16 @@ def parse_headers(self, data, from_trailer=False):\\n                 raise InvalidHeader(curr)\\n             name, value = curr.split(\\\":\\\", 1)\\n             if self.cfg.strip_header_spaces:\\n-                name = name.rstrip(\\\" \\\\t\\\").upper()\\n-            else:\\n-                name = name.upper()\\n+                name = name.rstrip(\\\" \\\\t\\\")\\n             if not TOKEN_RE.fullmatch(name):\\n                 raise InvalidHeaderName(name)\\n \\n+            # this is still a dangerous place to do this\\n+            #  but it is more correct than doing it before the pattern match:\\n+            # after we entered Unicode wonderland, 8bits could case-shift into ASCII:\\n+            # b\\\"\\\\xDF\\\".decode(\\\"latin-1\\\").upper().encode(\\\"ascii\\\") == b\\\"SS\\\"\\n+            name = name.upper()\\n+\\n             value = [value.lstrip(\\\" \\\\t\\\")]\\n \\n             # Consume value continuation lines\\n\",\"diff --git a/gunicorn/config.py b/gunicorn/config.py\\nindex be9bb001c..e7e4fac54 100644\\n--- a/gunicorn/config.py\\n+++ b/gunicorn/config.py\\n@@ -2282,6 +2282,26 @@ class PermitUnconventionalHTTPMethod(Setting):\\n         \\\"\\\"\\\"\\n \\n \\n+class PermitUnconventionalHTTPVersion(Setting):\\n+    name = \\\"permit_unconventional_http_version\\\"\\n+    section = \\\"Server Mechanics\\\"\\n+    cli = [\\\"--permit-unconventional-http-version\\\"]\\n+    validator = validate_bool\\n+    action = \\\"store_true\\\"\\n+    default = False\\n+    desc = \\\"\\\"\\\"\\\\\\n+        Permit HTTP version not matching conventions of 2023\\n+\\n+        This disables the refusal of likely malformed request lines.\\n+        It is unusual to specify HTTP 1 versions other than 1.0 and 1.1.\\n+\\n+        This option is provided to diagnose backwards-incompatible changes.\\n+        Use with care and only if necessary. May be removed in a future version.\\n+\\n+        .. versionadded:: 22.0.0\\n+        \\\"\\\"\\\"\\n+\\n+\\n class CasefoldHTTPMethod(Setting):\\n     name = \\\"casefold_http_method\\\"\\n     section = \\\"Server Mechanics\\\"\\n\",\"diff --git a/gunicorn/http/message.py b/gunicorn/http/message.py\\nindex 4e1c2fd55..5e8d2427d 100644\\n--- a/gunicorn/http/message.py\\n+++ b/gunicorn/http/message.py\\n@@ -26,7 +26,8 @@\\n RFC9110_5_6_2_TOKEN_SPECIALS = r\\\"!#$%&'*+-.^_`|~\\\"\\n TOKEN_RE = re.compile(r\\\"[%s0-9a-zA-Z]+\\\" % (re.escape(RFC9110_5_6_2_TOKEN_SPECIALS)))\\n METHOD_BADCHAR_RE = re.compile(\\\"[a-z#]\\\")\\n-VERSION_RE = re.compile(r\\\"HTTP/(\\\\d+)\\\\.(\\\\d+)\\\")\\n+# usually 1.0 or 1.1 - RFC9112 permits restricting to single-digit versions\\n+VERSION_RE = re.compile(r\\\"HTTP/(\\\\d)\\\\.(\\\\d)\\\")\\n \\n \\n class Message(object):\\n@@ -438,6 +439,10 @@ def parse_request_line(self, line_bytes):\\n         if match is None:\\n             raise InvalidHTTPVersion(bits[2])\\n         self.version = (int(match.group(1)), int(match.group(2)))\\n+        if not (1, 0) <= self.version < (2, 0):\\n+            # if ever relaxing this, carefully review Content-Encoding processing\\n+            if not self.cfg.permit_unconventional_http_version:\\n+                raise InvalidHTTPVersion(self.version)\\n \\n     def set_body_reader(self):\\n         super().set_body_reader()\\n\",\"diff --git a/docs/source/2023-news.rst b/docs/source/2023-news.rst\\nindex 80f022248..971cfef38 100644\\n--- a/docs/source/2023-news.rst\\n+++ b/docs/source/2023-news.rst\\n@@ -2,6 +2,28 @@\\n Changelog - 2023\\n ================\\n \\n+22.0.0 - TBDTBDTBD\\n+==================\\n+\\n+- fix numerous security vulnerabilites in HTTP parser (closing some request smuggling vectors)\\n+- parsing additional requests is no longer attempted past unsupported request framing\\n+- on HTTP versions < 1.1 support for chunked transfer is refused (only used in exploits)\\n+- requests conflicting configured or passed SCRIPT_NAME now produce a verbose error\\n+- Trailer fields are no longer inspected for headers indicating secure scheme\\n+\\n+** Breaking changes **\\n+\\n+- the limitations on valid characters in the HTTP method have been bounded to Internet Standards\\n+- requests specifying unsupported transfer coding (order) are refused by default (rare)\\n+- HTTP methods are no longer casefolded by default (IANA method registry contains none affacted)\\n+- HTTP methods containing the number sign (#) are no longer accepted by default (rare)\\n+- HTTP versions < 1.0 or >= 2.0 are no longer accepted by default (rare, only HTTP/1.1 is supported)\\n+- HTTP versions consisting of multiple digits or containing a prefix/suffix are no longer accepted\\n+- HTTP header field names Gunicorn cannot safely map to variables are silently dropped, as in other software\\n+- HTTP headers with empty field name are refused by default (no legitimate use cases, used in exploits)\\n+- requests with both Transfer-Encoding and Content-Length are refused by default (such a message might indicate an attempt to perform request smuggling)\\n+- empty transfer codings are no longer permitted (reportedly seen with really old & broken proxies)\\n+\\n 21.2.0 - 2023-07-19\\n ===================\\n \\n\",\"diff --git a/gunicorn/http/body.py b/gunicorn/http/body.py\\nindex 2ae0eb848..78f03214a 100644\\n--- a/gunicorn/http/body.py\\n+++ b/gunicorn/http/body.py\\n@@ -85,7 +85,10 @@ def parse_chunk_size(self, unreader, data=None):\\n         data = buf.getvalue()\\n         line, rest_chunk = data[:idx], data[idx + 2:]\\n \\n-        chunk_size = line.split(b\\\";\\\", 1)[0].strip()\\n+        # RFC9112 7.1.1: BWS before chunk-ext - but ONLY then\\n+        chunk_size, *chunk_ext = line.split(b\\\";\\\", 1)\\n+        if chunk_ext:\\n+            chunk_size = chunk_size.rstrip(b\\\" \\\\t\\\")\\n         if any(n not in b\\\"0123456789abcdefABCDEF\\\" for n in chunk_size):\\n             raise InvalidChunkSize(chunk_size)\\n         chunk_size = int(chunk_size, 16)\\n\"]", "test_patch": "[\"diff --git a/tests/treq.py b/tests/treq.py\\nindex ffe0691fd..05adb1461 100644\\n--- a/tests/treq.py\\n+++ b/tests/treq.py\\n@@ -51,7 +51,9 @@ def __init__(self, fname, expect):\\n         with open(self.fname, 'rb') as handle:\\n             self.data = handle.read()\\n         self.data = self.data.replace(b\\\"\\\\n\\\", b\\\"\\\").replace(b\\\"\\\\\\\\r\\\\\\\\n\\\", b\\\"\\\\r\\\\n\\\")\\n-        self.data = self.data.replace(b\\\"\\\\\\\\0\\\", b\\\"\\\\000\\\")\\n+        self.data = self.data.replace(b\\\"\\\\\\\\0\\\", b\\\"\\\\000\\\").replace(b\\\"\\\\\\\\n\\\", b\\\"\\\\n\\\").replace(b\\\"\\\\\\\\t\\\", b\\\"\\\\t\\\")\\n+        if b\\\"\\\\\\\\\\\" in self.data:\\n+            raise AssertionError(\\\"Unexpected backslash in test data - only handling HTAB, NUL and CRLF\\\")\\n \\n     # Functions for sending data to the parser.\\n     # These functions mock out reading from a\\n@@ -262,7 +264,8 @@ def same(self, req, sizer, matcher, exp):\\n         assert req.trailers == exp.get(\\\"trailers\\\", [])\\n \\n \\n-class badrequest(object):\\n+class badrequest:\\n+    # FIXME: no good reason why this cannot match what the more extensive mechanism above\\n     def __init__(self, fname):\\n         self.fname = fname\\n         self.name = os.path.basename(fname)\\n@@ -270,7 +273,9 @@ def __init__(self, fname):\\n         with open(self.fname) as handle:\\n             self.data = handle.read()\\n         self.data = self.data.replace(\\\"\\\\n\\\", \\\"\\\").replace(\\\"\\\\\\\\r\\\\\\\\n\\\", \\\"\\\\r\\\\n\\\")\\n-        self.data = self.data.replace(\\\"\\\\\\\\0\\\", \\\"\\\\000\\\")\\n+        self.data = self.data.replace(\\\"\\\\\\\\0\\\", \\\"\\\\000\\\").replace(\\\"\\\\\\\\n\\\", \\\"\\\\n\\\").replace(\\\"\\\\\\\\t\\\", \\\"\\\\t\\\")\\n+        if \\\"\\\\\\\\\\\" in self.data:\\n+            raise AssertionError(\\\"Unexpected backslash in test data - only handling HTAB, NUL and CRLF\\\")\\n         self.data = self.data.encode('latin1')\\n \\n     def send(self):\\n@@ -283,4 +288,6 @@ def send(self):\\n \\n     def check(self, cfg):\\n         p = RequestParser(cfg, self.send(), None)\\n-        next(p)\\n+        # must fully consume iterator, otherwise EOF errors could go unnoticed\\n+        for _ in p:\\n+            pass\\n\",\"diff --git a/tests/requests/invalid/003.http b/tests/requests/invalid/003.http\\nindex cd1ab7fcb..5a9eaafcd 100644\\n--- a/tests/requests/invalid/003.http\\n+++ b/tests/requests/invalid/003.http\\n@@ -1,2 +1,2 @@\\n--blargh /foo HTTP/1.1\\\\r\\\\n\\n-\\\\r\\\\n\\n\\\\ No newline at end of file\\n+GET\\\\n/\\\\nHTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/003.py b/tests/requests/invalid/003.py\\nindex 86a0774e5..5a4ca8961 100644\\n--- a/tests/requests/invalid/003.py\\n+++ b/tests/requests/invalid/003.py\\n@@ -1,2 +1,2 @@\\n-from gunicorn.http.errors import InvalidRequestMethod\\n-request = InvalidRequestMethod\\n\\\\ No newline at end of file\\n+from gunicorn.http.errors import InvalidRequestLine\\n+request = InvalidRequestLine\\n\",\"diff --git a/tests/requests/valid/016.py b/tests/requests/valid/016.py\\nindex 139b27009..4e5144f8c 100644\\n--- a/tests/requests/valid/016.py\\n+++ b/tests/requests/valid/016.py\\n@@ -1,35 +1,35 @@\\n-certificate = \\\"\\\"\\\"-----BEGIN CERTIFICATE-----\\\\r\\\\n\\n-    MIIFbTCCBFWgAwIBAgICH4cwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVUsx\\\\r\\\\n\\n-    ETAPBgNVBAoTCGVTY2llbmNlMRIwEAYDVQQLEwlBdXRob3JpdHkxCzAJBgNVBAMT\\\\r\\\\n\\n-    AkNBMS0wKwYJKoZIhvcNAQkBFh5jYS1vcGVyYXRvckBncmlkLXN1cHBvcnQuYWMu\\\\r\\\\n\\n-    dWswHhcNMDYwNzI3MTQxMzI4WhcNMDcwNzI3MTQxMzI4WjBbMQswCQYDVQQGEwJV\\\\r\\\\n\\n-    SzERMA8GA1UEChMIZVNjaWVuY2UxEzARBgNVBAsTCk1hbmNoZXN0ZXIxCzAJBgNV\\\\r\\\\n\\n-    BAcTmrsogriqMWLAk1DMRcwFQYDVQQDEw5taWNoYWVsIHBhcmQYJKoZIhvcNAQEB\\\\r\\\\n\\n-    BQADggEPADCCAQoCggEBANPEQBgl1IaKdSS1TbhF3hEXSl72G9J+WC/1R64fAcEF\\\\r\\\\n\\n-    W51rEyFYiIeZGx/BVzwXbeBoNUK41OK65sxGuflMo5gLflbwJtHBRIEKAfVVp3YR\\\\r\\\\n\\n-    gW7cMA/s/XKgL1GEC7rQw8lIZT8RApukCGqOVHSi/F1SiFlPDxuDfmdiNzL31+sL\\\\r\\\\n\\n-    0iwHDdNkGjy5pyBSB8Y79dsSJtCW/iaLB0/n8Sj7HgvvZJ7x0fr+RQjYOUUfrePP\\\\r\\\\n\\n-    u2MSpFyf+9BbC/aXgaZuiCvSR+8Snv3xApQY+fULK/xY8h8Ua51iXoQ5jrgu2SqR\\\\r\\\\n\\n-    wgA7BUi3G8LFzMBl8FRCDYGUDy7M6QaHXx1ZWIPWNKsCAwEAAaOCAiQwggIgMAwG\\\\r\\\\n\\n-    1UdEwEB/wQCMAAwEQYJYIZIAYb4QgHTTPAQDAgWgMA4GA1UdDwEB/wQEAwID6DAs\\\\r\\\\n\\n-    BglghkgBhvhCAQ0EHxYdVUsgZS1TY2llbmNlIFVzZXIgQ2VydGlmaWNhdGUwHQYD\\\\r\\\\n\\n-    VR0OBBYEFDTt/sf9PeMaZDHkUIldrDYMNTBZMIGaBgNVHSMEgZIwgY+AFAI4qxGj\\\\r\\\\n\\n-    loCLDdMVKwiljjDastqooXSkcjBwMQswCQYDVQQGEwJVSzERMA8GA1UEChMIZVNj\\\\r\\\\n\\n-    aWVuY2UxEjAQBgNVBAsTCUF1dGhvcml0eTELMAkGA1UEAxMCQ0ExLTArBgkqhkiG\\\\r\\\\n\\n-    9w0BCQEWHmNhLW9wZXJhdG9yQGdyaWQtc3VwcG9ydC5hYy51a4IBADApBgNVHRIE\\\\r\\\\n\\n-    IjAggR5jYS1vcGVyYXRvckBncmlkLXN1cHBvcnQuYWMudWswGQYDVR0gBBIwEDAO\\\\r\\\\n\\n-    BgwrBgEEAdkvAQEBAQYwPQYJYIZIAYb4QgEEBDAWLmh0dHA6Ly9jYS5ncmlkLXN1\\\\r\\\\n\\n-    cHBvcnQuYWMudmT4sopwqlBWsvcHViL2NybC9jYWNybC5jcmwwPQYJYIZIAYb4Qg\\\\r\\\\n\\n-    EDBDAWLmh0dHA6Ly9jYS5ncmlkLXN1cHBvcnQuYWMudWsvcHViL2NybC9jYWNybC\\\\r\\\\n\\n-    5jcmwwPwYDVR0fBDgwNjA0oDKgMIYuaHR0cDovL2NhLmdyaWQt5hYy51ay9wdWIv\\\\r\\\\n\\n-    Y3JsL2NhY3JsLmNybDANBgkqhkiG9w0BAQUFAAOCAQEAS/U4iiooBENGW/Hwmmd3\\\\r\\\\n\\n-    XCy6Zrt08YjKCzGNjorT98g8uGsqYjSxv/hmi0qlnlHs+k/3Iobc3LjS5AMYr5L8\\\\r\\\\n\\n-    UO7OSkgFFlLHQyC9JzPfmLCAugvzEbyv4Olnsr8hbxF1MbKZoQxUZtMVu29wjfXk\\\\r\\\\n\\n-    hTeApBv7eaKCWpSp7MCbvgzm74izKhu3vlDk9w6qVrxePfGgpKPqfHiOoGhFnbTK\\\\r\\\\n\\n-    wTC6o2xq5y0qZ03JonF7OJspEd3I5zKY3E+ov7/ZhW6DqT8UFvsAdjvQbXyhV8Eu\\\\r\\\\n\\n-    Yhixw1aKEPzNjNowuIseVogKOLXxWI5vAi5HgXdS0/ES5gDGsABo4fqovUKlgop3\\\\r\\\\n\\n-    RA==\\\\r\\\\n\\n-    -----END CERTIFICATE-----\\\"\\\"\\\".replace(\\\"\\\\n\\\\n\\\", \\\"\\\\n\\\")\\n+certificate = \\\"\\\"\\\"-----BEGIN CERTIFICATE-----\\n+ MIIFbTCCBFWgAwIBAgICH4cwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVUsx\\n+ ETAPBgNVBAoTCGVTY2llbmNlMRIwEAYDVQQLEwlBdXRob3JpdHkxCzAJBgNVBAMT\\n+ AkNBMS0wKwYJKoZIhvcNAQkBFh5jYS1vcGVyYXRvckBncmlkLXN1cHBvcnQuYWMu\\n+ dWswHhcNMDYwNzI3MTQxMzI4WhcNMDcwNzI3MTQxMzI4WjBbMQswCQYDVQQGEwJV\\n+ SzERMA8GA1UEChMIZVNjaWVuY2UxEzARBgNVBAsTCk1hbmNoZXN0ZXIxCzAJBgNV\\n+ BAcTmrsogriqMWLAk1DMRcwFQYDVQQDEw5taWNoYWVsIHBhcmQYJKoZIhvcNAQEB\\n+ BQADggEPADCCAQoCggEBANPEQBgl1IaKdSS1TbhF3hEXSl72G9J+WC/1R64fAcEF\\n+ W51rEyFYiIeZGx/BVzwXbeBoNUK41OK65sxGuflMo5gLflbwJtHBRIEKAfVVp3YR\\n+ gW7cMA/s/XKgL1GEC7rQw8lIZT8RApukCGqOVHSi/F1SiFlPDxuDfmdiNzL31+sL\\n+ 0iwHDdNkGjy5pyBSB8Y79dsSJtCW/iaLB0/n8Sj7HgvvZJ7x0fr+RQjYOUUfrePP\\n+ u2MSpFyf+9BbC/aXgaZuiCvSR+8Snv3xApQY+fULK/xY8h8Ua51iXoQ5jrgu2SqR\\n+ wgA7BUi3G8LFzMBl8FRCDYGUDy7M6QaHXx1ZWIPWNKsCAwEAAaOCAiQwggIgMAwG\\n+ 1UdEwEB/wQCMAAwEQYJYIZIAYb4QgHTTPAQDAgWgMA4GA1UdDwEB/wQEAwID6DAs\\n+ BglghkgBhvhCAQ0EHxYdVUsgZS1TY2llbmNlIFVzZXIgQ2VydGlmaWNhdGUwHQYD\\n+ VR0OBBYEFDTt/sf9PeMaZDHkUIldrDYMNTBZMIGaBgNVHSMEgZIwgY+AFAI4qxGj\\n+ loCLDdMVKwiljjDastqooXSkcjBwMQswCQYDVQQGEwJVSzERMA8GA1UEChMIZVNj\\n+ aWVuY2UxEjAQBgNVBAsTCUF1dGhvcml0eTELMAkGA1UEAxMCQ0ExLTArBgkqhkiG\\n+ 9w0BCQEWHmNhLW9wZXJhdG9yQGdyaWQtc3VwcG9ydC5hYy51a4IBADApBgNVHRIE\\n+ IjAggR5jYS1vcGVyYXRvckBncmlkLXN1cHBvcnQuYWMudWswGQYDVR0gBBIwEDAO\\n+ BgwrBgEEAdkvAQEBAQYwPQYJYIZIAYb4QgEEBDAWLmh0dHA6Ly9jYS5ncmlkLXN1\\n+ cHBvcnQuYWMudmT4sopwqlBWsvcHViL2NybC9jYWNybC5jcmwwPQYJYIZIAYb4Qg\\n+ EDBDAWLmh0dHA6Ly9jYS5ncmlkLXN1cHBvcnQuYWMudWsvcHViL2NybC9jYWNybC\\n+ 5jcmwwPwYDVR0fBDgwNjA0oDKgMIYuaHR0cDovL2NhLmdyaWQt5hYy51ay9wdWIv\\n+ Y3JsL2NhY3JsLmNybDANBgkqhkiG9w0BAQUFAAOCAQEAS/U4iiooBENGW/Hwmmd3\\n+ XCy6Zrt08YjKCzGNjorT98g8uGsqYjSxv/hmi0qlnlHs+k/3Iobc3LjS5AMYr5L8\\n+ UO7OSkgFFlLHQyC9JzPfmLCAugvzEbyv4Olnsr8hbxF1MbKZoQxUZtMVu29wjfXk\\n+ hTeApBv7eaKCWpSp7MCbvgzm74izKhu3vlDk9w6qVrxePfGgpKPqfHiOoGhFnbTK\\n+ wTC6o2xq5y0qZ03JonF7OJspEd3I5zKY3E+ov7/ZhW6DqT8UFvsAdjvQbXyhV8Eu\\n+ Yhixw1aKEPzNjNowuIseVogKOLXxWI5vAi5HgXdS0/ES5gDGsABo4fqovUKlgop3\\n+ RA==\\n+ -----END CERTIFICATE-----\\\"\\\"\\\".replace(\\\"\\\\n\\\", \\\"\\\")\\n \\n request = {\\n     \\\"method\\\": \\\"GET\\\",\\n\",\"diff --git a/tests/requests/valid/031.http b/tests/requests/valid/031.http\\nnew file mode 100644\\nindex 000000000..cd1ab7fcb\\n--- /dev/null\\n+++ b/tests/requests/valid/031.http\\n@@ -0,0 +1,2 @@\\n+-blargh /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\\\\ No newline at end of file\\n\",\"diff --git a/tests/requests/valid/031.py b/tests/requests/valid/031.py\\nnew file mode 100644\\nindex 000000000..9691a002b\\n--- /dev/null\\n+++ b/tests/requests/valid/031.py\\n@@ -0,0 +1,7 @@\\n+request = {\\n+    \\\"method\\\": \\\"-BLARGH\\\",\\n+    \\\"uri\\\": uri(\\\"/foo\\\"),\\n+    \\\"version\\\": (1, 1),\\n+    \\\"headers\\\": [],\\n+    \\\"body\\\": b\\\"\\\"\\n+}\\n\",\"diff --git a/SECURITY.md b/SECURITY.md\\nnew file mode 100644\\nindex 000000000..3d1923540\\n--- /dev/null\\n+++ b/SECURITY.md\\n@@ -0,0 +1,22 @@\\n+# Security Policy\\n+\\n+## Reporting a Vulnerability\\n+\\n+**Please note that public Github issues are open for everyone to see!**\\n+\\n+If you believe you are found a problem in Gunicorn software, examples or documentation, we encourage you to send your report privately via email, or via Github using the *Report a vulnerability* button in the [Security](https://github.com/benoitc/gunicorn/security) section.\\n+\\n+## Supported Releases\\n+\\n+At this time, **only the latest release** receives any security attention whatsoever.\\n+\\n+| Version | Status          |\\n+| ------- | ------------------ |\\n+| latest release  | :white_check_mark: |\\n+| 21.2.0  | :x: |\\n+| 20.0.0  | :x: |\\n+| < 20.0  | :x: |\\n+\\n+## Python Versions\\n+\\n+Gunicorn runs on Python 3.7+, we *highly recommend* the latest release of a [supported series](https://devguide.python.org/version/) and will not prioritize issues exclusively affecting in EoL environments.\\n\",\"diff --git a/tests/test_http.py b/tests/test_http.py\\nindex b6ca46b22..0eb694601 100644\\n--- a/tests/test_http.py\\n+++ b/tests/test_http.py\\n@@ -10,6 +10,17 @@\\n from gunicorn.http.wsgi import Response\\n from gunicorn.http.unreader import Unreader, IterUnreader, SocketUnreader\\n from gunicorn.http.errors import InvalidHeader, InvalidHeaderName\\n+from gunicorn.http.message import TOKEN_RE\\n+\\n+\\n+def test_method_pattern():\\n+    assert TOKEN_RE.fullmatch(\\\"GET\\\")\\n+    assert TOKEN_RE.fullmatch(\\\"MKCALENDAR\\\")\\n+    assert not TOKEN_RE.fullmatch(\\\"GET:\\\")\\n+    assert not TOKEN_RE.fullmatch(\\\"GET;\\\")\\n+    RFC9110_5_6_2_TOKEN_DELIM = r'\\\"(),/:;<=>?@[\\\\]{}'\\n+    for bad_char in RFC9110_5_6_2_TOKEN_DELIM:\\n+        assert not TOKEN_RE.match(bad_char)\\n \\n \\n def assert_readline(payload, size, expected):\\n\",\"diff --git a/tests/requests/invalid/003b.http b/tests/requests/invalid/003b.http\\nnew file mode 100644\\nindex 000000000..e05fd9897\\n--- /dev/null\\n+++ b/tests/requests/invalid/003b.http\\n@@ -0,0 +1,2 @@\\n+bla:rgh /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/003b.py b/tests/requests/invalid/003b.py\\nnew file mode 100644\\nindex 000000000..86a0774e5\\n--- /dev/null\\n+++ b/tests/requests/invalid/003b.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+request = InvalidRequestMethod\\n\\\\ No newline at end of file\\n\",\"diff --git a/tests/requests/invalid/003c.http b/tests/requests/invalid/003c.http\\nnew file mode 100644\\nindex 000000000..98bd20bf1\\n--- /dev/null\\n+++ b/tests/requests/invalid/003c.http\\n@@ -0,0 +1,2 @@\\n+-bl /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/003c.py b/tests/requests/invalid/003c.py\\nnew file mode 100644\\nindex 000000000..1dac27c04\\n--- /dev/null\\n+++ b/tests/requests/invalid/003c.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+request = InvalidRequestMethod\\n\",\"diff --git a/tests/requests/valid/031.http b/tests/requests/valid/031.http\\nindex cd1ab7fcb..ab3529da3 100644\\n--- a/tests/requests/valid/031.http\\n+++ b/tests/requests/valid/031.http\\n@@ -1,2 +1,2 @@\\n--blargh /foo HTTP/1.1\\\\r\\\\n\\n-\\\\r\\\\n\\n\\\\ No newline at end of file\\n+-BLARGH /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/031compat.http b/tests/requests/valid/031compat.http\\nnew file mode 100644\\nindex 000000000..cd1ab7fcb\\n--- /dev/null\\n+++ b/tests/requests/valid/031compat.http\\n@@ -0,0 +1,2 @@\\n+-blargh /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\\\\ No newline at end of file\\n\",\"diff --git a/tests/requests/valid/031compat.py b/tests/requests/valid/031compat.py\\nnew file mode 100644\\nindex 000000000..424b7cb47\\n--- /dev/null\\n+++ b/tests/requests/valid/031compat.py\\n@@ -0,0 +1,13 @@\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"permit_unconventional_http_method\\\", True)\\n+cfg.set(\\\"casefold_http_method\\\", True)\\n+\\n+request = {\\n+    \\\"method\\\": \\\"-BLARGH\\\",\\n+    \\\"uri\\\": uri(\\\"/foo\\\"),\\n+    \\\"version\\\": (1, 1),\\n+    \\\"headers\\\": [],\\n+    \\\"body\\\": b\\\"\\\"\\n+}\\n\",\"diff --git a/tests/requests/valid/031compat2.http b/tests/requests/valid/031compat2.http\\nnew file mode 100644\\nindex 000000000..dcbf4f134\\n--- /dev/null\\n+++ b/tests/requests/valid/031compat2.http\\n@@ -0,0 +1,2 @@\\n+-blargh /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/031compat2.py b/tests/requests/valid/031compat2.py\\nnew file mode 100644\\nindex 000000000..594a8b6a8\\n--- /dev/null\\n+++ b/tests/requests/valid/031compat2.py\\n@@ -0,0 +1,12 @@\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"permit_unconventional_http_method\\\", True)\\n+\\n+request = {\\n+    \\\"method\\\": \\\"-blargh\\\",\\n+    \\\"uri\\\": uri(\\\"/foo\\\"),\\n+    \\\"version\\\": (1, 1),\\n+    \\\"headers\\\": [],\\n+    \\\"body\\\": b\\\"\\\"\\n+}\\n\",\"diff --git a/tests/requests/invalid/040.http b/tests/requests/invalid/040.http\\nnew file mode 100644\\nindex 000000000..be03929d5\\n--- /dev/null\\n+++ b/tests/requests/invalid/040.http\\n@@ -0,0 +1,6 @@\\n+GET /keep/same/as?invalid/040 HTTP/1.0\\\\r\\\\n\\n+Transfer_Encoding: tricked\\\\r\\\\n\\n+Content-Length: 7\\\\r\\\\n\\n+Content_Length: -1E23\\\\r\\\\n\\n+\\\\r\\\\n\\n+tricked\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/040.py b/tests/requests/invalid/040.py\\nnew file mode 100644\\nindex 000000000..643289fab\\n--- /dev/null\\n+++ b/tests/requests/invalid/040.py\\n@@ -0,0 +1,7 @@\\n+from gunicorn.http.errors import InvalidHeaderName\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"header_map\\\", \\\"refuse\\\")\\n+\\n+request = InvalidHeaderName\\n\",\"diff --git a/tests/requests/invalid/chunked_07.http b/tests/requests/invalid/chunked_07.http\\nnew file mode 100644\\nindex 000000000..a78db48b7\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_07.http\\n@@ -0,0 +1,10 @@\\n+POST /chunked_ambiguous_header_mapping HTTP/1.1\\\\r\\\\n\\n+Transfer_Encoding: gzip\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+0\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_07.py b/tests/requests/invalid/chunked_07.py\\nnew file mode 100644\\nindex 000000000..643289fab\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_07.py\\n@@ -0,0 +1,7 @@\\n+from gunicorn.http.errors import InvalidHeaderName\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"header_map\\\", \\\"refuse\\\")\\n+\\n+request = InvalidHeaderName\\n\",\"diff --git a/tests/requests/valid/040.http b/tests/requests/valid/040.http\\nnew file mode 100644\\nindex 000000000..be03929d5\\n--- /dev/null\\n+++ b/tests/requests/valid/040.http\\n@@ -0,0 +1,6 @@\\n+GET /keep/same/as?invalid/040 HTTP/1.0\\\\r\\\\n\\n+Transfer_Encoding: tricked\\\\r\\\\n\\n+Content-Length: 7\\\\r\\\\n\\n+Content_Length: -1E23\\\\r\\\\n\\n+\\\\r\\\\n\\n+tricked\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/040.py b/tests/requests/valid/040.py\\nnew file mode 100644\\nindex 000000000..7c2243d9f\\n--- /dev/null\\n+++ b/tests/requests/valid/040.py\\n@@ -0,0 +1,9 @@\\n+request = {\\n+    \\\"method\\\": \\\"GET\\\",\\n+    \\\"uri\\\": uri(\\\"/keep/same/as?invalid/040\\\"),\\n+    \\\"version\\\": (1, 0),\\n+    \\\"headers\\\": [\\n+        (\\\"CONTENT-LENGTH\\\", \\\"7\\\")\\n+    ],\\n+    \\\"body\\\": b'tricked'\\n+}\\n\",\"diff --git a/tests/requests/valid/040_compat.http b/tests/requests/valid/040_compat.http\\nnew file mode 100644\\nindex 000000000..be03929d5\\n--- /dev/null\\n+++ b/tests/requests/valid/040_compat.http\\n@@ -0,0 +1,6 @@\\n+GET /keep/same/as?invalid/040 HTTP/1.0\\\\r\\\\n\\n+Transfer_Encoding: tricked\\\\r\\\\n\\n+Content-Length: 7\\\\r\\\\n\\n+Content_Length: -1E23\\\\r\\\\n\\n+\\\\r\\\\n\\n+tricked\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/040_compat.py b/tests/requests/valid/040_compat.py\\nnew file mode 100644\\nindex 000000000..5f13487c4\\n--- /dev/null\\n+++ b/tests/requests/valid/040_compat.py\\n@@ -0,0 +1,16 @@\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"header_map\\\", \\\"dangerous\\\")\\n+\\n+request = {\\n+    \\\"method\\\": \\\"GET\\\",\\n+    \\\"uri\\\": uri(\\\"/keep/same/as?invalid/040\\\"),\\n+    \\\"version\\\": (1, 0),\\n+    \\\"headers\\\": [\\n+        (\\\"TRANSFER_ENCODING\\\", \\\"tricked\\\"),\\n+        (\\\"CONTENT-LENGTH\\\", \\\"7\\\"),\\n+        (\\\"CONTENT_LENGTH\\\", \\\"-1E23\\\"),\\n+    ],\\n+    \\\"body\\\": b'tricked'\\n+}\\n\",\"diff --git a/tests/requests/invalid/chunked_01.http b/tests/requests/invalid/chunked_01.http\\nnew file mode 100644\\nindex 000000000..7a8e55d2e\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_01.http\\n@@ -0,0 +1,12 @@\\n+POST /chunked_w_underscore_chunk_size HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6_0\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+0\\\\r\\\\n\\n+\\\\r\\\\n\\n+POST /after HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: identity\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_01.py b/tests/requests/invalid/chunked_01.py\\nnew file mode 100644\\nindex 000000000..0571e1183\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_01.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidChunkSize\\n+request = InvalidChunkSize\\n\",\"diff --git a/tests/requests/invalid/chunked_02.http b/tests/requests/invalid/chunked_02.http\\nnew file mode 100644\\nindex 000000000..9ae49e525\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_02.http\\n@@ -0,0 +1,9 @@\\n+POST /chunked_with_prefixed_value HTTP/1.1\\\\r\\\\n\\n+Content-Length: 12\\\\r\\\\n\\n+Transfer-Encoding: \\\\tchunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_02.py b/tests/requests/invalid/chunked_02.py\\nnew file mode 100644\\nindex 000000000..1541eb70b\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_02.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHeader\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/chunked_03.http b/tests/requests/invalid/chunked_03.http\\nnew file mode 100644\\nindex 000000000..0bbbfe6ef\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_03.http\\n@@ -0,0 +1,8 @@\\n+POST /double_chunked HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: identity, chunked, identity, chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_03.py b/tests/requests/invalid/chunked_03.py\\nnew file mode 100644\\nindex 000000000..58a34600c\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_03.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import UnsupportedTransferCoding\\n+request = UnsupportedTransferCoding\\n\",\"diff --git a/tests/requests/invalid/chunked_04.http b/tests/requests/invalid/chunked_04.http\\nnew file mode 100644\\nindex 000000000..d47109e31\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_04.http\\n@@ -0,0 +1,11 @@\\n+POST /chunked_twice HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: identity\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+Transfer-Encoding: identity\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_04.py b/tests/requests/invalid/chunked_04.py\\nnew file mode 100644\\nindex 000000000..1541eb70b\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_04.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHeader\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/chunked_05.http b/tests/requests/invalid/chunked_05.http\\nnew file mode 100644\\nindex 000000000..014e85ac0\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_05.http\\n@@ -0,0 +1,11 @@\\n+POST /chunked_HTTP_1.0 HTTP/1.0\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+0\\\\r\\\\n\\n+Vary: *\\\\r\\\\n\\n+Content-Type: text/plain\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_05.py b/tests/requests/invalid/chunked_05.py\\nnew file mode 100644\\nindex 000000000..1541eb70b\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_05.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHeader\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/chunked_06.http b/tests/requests/invalid/chunked_06.http\\nnew file mode 100644\\nindex 000000000..ef70faab9\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_06.http\\n@@ -0,0 +1,9 @@\\n+POST /chunked_not_last HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+Transfer-Encoding: gzip\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_06.py b/tests/requests/invalid/chunked_06.py\\nnew file mode 100644\\nindex 000000000..58a34600c\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_06.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import UnsupportedTransferCoding\\n+request = UnsupportedTransferCoding\\n\",\"diff --git a/tests/requests/invalid/chunked_08.http b/tests/requests/invalid/chunked_08.http\\nnew file mode 100644\\nindex 000000000..8d4aaa6e9\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_08.http\\n@@ -0,0 +1,9 @@\\n+POST /chunked_not_last HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+Transfer-Encoding: identity\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_08.py b/tests/requests/invalid/chunked_08.py\\nnew file mode 100644\\nindex 000000000..1541eb70b\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_08.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHeader\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/nonascii_01.http b/tests/requests/invalid/nonascii_01.http\\nnew file mode 100644\\nindex 000000000..30d18cd6f\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_01.http\\n@@ -0,0 +1,4 @@\\n+GET /germans.. HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+\\n\",\"diff --git a/tests/requests/invalid/nonascii_01.py b/tests/requests/invalid/nonascii_01.py\\nnew file mode 100644\\nindex 000000000..0da10f426\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_01.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+\\n+cfg = Config()\\n+request = InvalidRequestMethod\\n\",\"diff --git a/tests/requests/invalid/nonascii_02.http b/tests/requests/invalid/nonascii_02.http\\nnew file mode 100644\\nindex 000000000..36a617039\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_02.http\\n@@ -0,0 +1,4 @@\\n+GET /french.. HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+\\n\",\"diff --git a/tests/requests/invalid/nonascii_02.py b/tests/requests/invalid/nonascii_02.py\\nnew file mode 100644\\nindex 000000000..0da10f426\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_02.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+\\n+cfg = Config()\\n+request = InvalidRequestMethod\\n\",\"diff --git a/tests/requests/invalid/nonascii_04.http b/tests/requests/invalid/nonascii_04.http\\nnew file mode 100644\\nindex 000000000..be0b15661\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_04.http\\n@@ -0,0 +1,5 @@\\n+GET /french.. HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+\\n\",\"diff --git a/tests/requests/invalid/nonascii_04.py b/tests/requests/invalid/nonascii_04.py\\nnew file mode 100644\\nindex 000000000..d336fbc85\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_04.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidHeaderName\\n+\\n+cfg = Config()\\n+request = InvalidHeaderName\\n\",\"diff --git a/tests/requests/invalid/prefix_01.http b/tests/requests/invalid/prefix_01.http\\nnew file mode 100644\\nindex 000000000..f8bdeb352\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_01.http\\n@@ -0,0 +1,2 @@\\n+GET\\\\0PROXY /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/prefix_01.py b/tests/requests/invalid/prefix_01.py\\nnew file mode 100644\\nindex 000000000..86a0774e5\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_01.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+request = InvalidRequestMethod\\n\\\\ No newline at end of file\\n\",\"diff --git a/tests/requests/invalid/prefix_02.http b/tests/requests/invalid/prefix_02.http\\nnew file mode 100644\\nindex 000000000..8a9b155c4\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_02.http\\n@@ -0,0 +1,2 @@\\n+GET\\\\0 /foo HTTP/1.1\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/prefix_02.py b/tests/requests/invalid/prefix_02.py\\nnew file mode 100644\\nindex 000000000..86a0774e5\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_02.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+request = InvalidRequestMethod\\n\\\\ No newline at end of file\\n\",\"diff --git a/tests/requests/invalid/prefix_03.http b/tests/requests/invalid/prefix_03.http\\nnew file mode 100644\\nindex 000000000..7803935cc\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_03.http\\n@@ -0,0 +1,4 @@\\n+GET /stuff/here?foo=bar HTTP/1.1\\\\r\\\\n\\n+Content-Length: 0 1\\\\r\\\\n\\n+\\\\r\\\\n\\n+x\\n\",\"diff --git a/tests/requests/invalid/prefix_03.py b/tests/requests/invalid/prefix_03.py\\nnew file mode 100644\\nindex 000000000..95b0581ae\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_03.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidHeader\\n+\\n+cfg = Config()\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/prefix_04.http b/tests/requests/invalid/prefix_04.http\\nnew file mode 100644\\nindex 000000000..712631c8f\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_04.http\\n@@ -0,0 +1,5 @@\\n+GET /stuff/here?foo=bar HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3 1\\\\r\\\\n\\n+\\\\r\\\\n\\n+xyz\\n+abc123\\n\",\"diff --git a/tests/requests/invalid/prefix_04.py b/tests/requests/invalid/prefix_04.py\\nnew file mode 100644\\nindex 000000000..95b0581ae\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_04.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidHeader\\n+\\n+cfg = Config()\\n+request = InvalidHeader\\n\",\"diff --git a/tests/requests/invalid/prefix_05.http b/tests/requests/invalid/prefix_05.http\\nnew file mode 100644\\nindex 000000000..120b6577d\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_05.http\\n@@ -0,0 +1,4 @@\\n+GET: /stuff/here?foo=bar HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+xyz\\n\",\"diff --git a/tests/requests/invalid/prefix_05.py b/tests/requests/invalid/prefix_05.py\\nnew file mode 100644\\nindex 000000000..0da10f426\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_05.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidRequestMethod\\n+\\n+cfg = Config()\\n+request = InvalidRequestMethod\\n\",\"diff --git a/tests/requests/valid/025.http b/tests/requests/valid/025.http\\nindex 62267add0..f8d7fae2e 100644\\n--- a/tests/requests/valid/025.http\\n+++ b/tests/requests/valid/025.http\\n@@ -1,5 +1,4 @@\\n POST /chunked_cont_h_at_first HTTP/1.1\\\\r\\\\n\\n-Content-Length: -1\\\\r\\\\n\\n Transfer-Encoding: chunked\\\\r\\\\n\\n \\\\r\\\\n\\n 5; some; parameters=stuff\\\\r\\\\n\\n@@ -16,4 +15,10 @@ Content-Length: -1\\\\r\\\\n\\n hello\\\\r\\\\n\\n 6; blahblah; blah\\\\r\\\\n\\n  world\\\\r\\\\n\\n-0\\\\r\\\\n\\n\\\\ No newline at end of file\\n+0\\\\r\\\\n\\n+\\\\r\\\\n\\n+PUT /ignored_after_dangerous_framing HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+foo\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/025.py b/tests/requests/valid/025.py\\nindex 12ea9ab76..33f5845cb 100644\\n--- a/tests/requests/valid/025.py\\n+++ b/tests/requests/valid/025.py\\n@@ -1,9 +1,13 @@\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"tolerate_dangerous_framing\\\", True)\\n+\\n req1 = {\\n     \\\"method\\\": \\\"POST\\\",\\n     \\\"uri\\\": uri(\\\"/chunked_cont_h_at_first\\\"),\\n     \\\"version\\\": (1, 1),\\n     \\\"headers\\\": [\\n-        (\\\"CONTENT-LENGTH\\\", \\\"-1\\\"),\\n         (\\\"TRANSFER-ENCODING\\\", \\\"chunked\\\")\\n     ],\\n     \\\"body\\\": b\\\"hello world\\\"\\n\",\"diff --git a/tests/requests/valid/025compat.http b/tests/requests/valid/025compat.http\\nnew file mode 100644\\nindex 000000000..828f6fb71\\n--- /dev/null\\n+++ b/tests/requests/valid/025compat.http\\n@@ -0,0 +1,18 @@\\n+POST /chunked_cont_h_at_first HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5; some; parameters=stuff\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6; blahblah; blah\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+0\\\\r\\\\n\\n+\\\\r\\\\n\\n+PUT /chunked_cont_h_at_last HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+Content-Length: -1\\\\r\\\\n\\n+\\\\r\\\\n\\n+5; some; parameters=stuff\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+6; blahblah; blah\\\\r\\\\n\\n+ world\\\\r\\\\n\\n+0\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/025compat.py b/tests/requests/valid/025compat.py\\nnew file mode 100644\\nindex 000000000..33f5845cb\\n--- /dev/null\\n+++ b/tests/requests/valid/025compat.py\\n@@ -0,0 +1,27 @@\\n+from gunicorn.config import Config\\n+\\n+cfg = Config()\\n+cfg.set(\\\"tolerate_dangerous_framing\\\", True)\\n+\\n+req1 = {\\n+    \\\"method\\\": \\\"POST\\\",\\n+    \\\"uri\\\": uri(\\\"/chunked_cont_h_at_first\\\"),\\n+    \\\"version\\\": (1, 1),\\n+    \\\"headers\\\": [\\n+        (\\\"TRANSFER-ENCODING\\\", \\\"chunked\\\")\\n+    ],\\n+    \\\"body\\\": b\\\"hello world\\\"\\n+}\\n+\\n+req2 = {\\n+    \\\"method\\\": \\\"PUT\\\",\\n+    \\\"uri\\\": uri(\\\"/chunked_cont_h_at_last\\\"),\\n+    \\\"version\\\": (1, 1),\\n+    \\\"headers\\\": [\\n+        (\\\"TRANSFER-ENCODING\\\", \\\"chunked\\\"),\\n+        (\\\"CONTENT-LENGTH\\\", \\\"-1\\\"),\\n+    ],\\n+    \\\"body\\\": b\\\"hello world\\\"\\n+}\\n+\\n+request = [req1, req2]\\n\",\"diff --git a/tests/requests/valid/029.http b/tests/requests/valid/029.http\\nindex c8611dbd3..5d029dd91 100644\\n--- a/tests/requests/valid/029.http\\n+++ b/tests/requests/valid/029.http\\n@@ -1,6 +1,6 @@\\n GET /stuff/here?foo=bar HTTP/1.1\\\\r\\\\n\\n-Transfer-Encoding: chunked\\\\r\\\\n\\n Transfer-Encoding: identity\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n \\\\r\\\\n\\n 5\\\\r\\\\n\\n hello\\\\r\\\\n\\n\",\"diff --git a/tests/requests/valid/029.py b/tests/requests/valid/029.py\\nindex f25449d15..64d026604 100644\\n--- a/tests/requests/valid/029.py\\n+++ b/tests/requests/valid/029.py\\n@@ -7,8 +7,8 @@\\n     \\\"uri\\\": uri(\\\"/stuff/here?foo=bar\\\"),\\n     \\\"version\\\": (1, 1),\\n     \\\"headers\\\": [\\n+        ('TRANSFER-ENCODING', 'identity'),\\n         ('TRANSFER-ENCODING', 'chunked'),\\n-        ('TRANSFER-ENCODING', 'identity')\\n     ],\\n     \\\"body\\\": b\\\"hello\\\"\\n }\\n\",\"diff --git a/tests/treq.py b/tests/treq.py\\nindex 05adb1461..aeaae151f 100644\\n--- a/tests/treq.py\\n+++ b/tests/treq.py\\n@@ -248,8 +248,10 @@ def test_req(sn, sz, mt):\\n     def check(self, cfg, sender, sizer, matcher):\\n         cases = self.expect[:]\\n         p = RequestParser(cfg, sender(), None)\\n-        for req in p:\\n+        parsed_request_idx = -1\\n+        for parsed_request_idx, req in enumerate(p):\\n             self.same(req, sizer, matcher, cases.pop(0))\\n+        assert len(self.expect) == parsed_request_idx + 1\\n         assert not cases\\n \\n     def same(self, req, sizer, matcher, exp):\\n\",\"diff --git a/tests/requests/invalid/nonascii_03.http b/tests/requests/invalid/nonascii_03.http\\nnew file mode 100644\\nindex 000000000..eda5d010f\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_03.http\\n@@ -0,0 +1,5 @@\\n+GET /germans.. HTTP/1.1\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+Content-Length: 3\\\\r\\\\n\\n+\\\\r\\\\n\\n+\\n\",\"diff --git a/tests/requests/invalid/nonascii_03.py b/tests/requests/invalid/nonascii_03.py\\nnew file mode 100644\\nindex 000000000..d336fbc85\\n--- /dev/null\\n+++ b/tests/requests/invalid/nonascii_03.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidHeaderName\\n+\\n+cfg = Config()\\n+request = InvalidHeaderName\\n\",\"diff --git a/tests/requests/invalid/prefix_06.http b/tests/requests/invalid/prefix_06.http\\nnew file mode 100644\\nindex 000000000..536c586a3\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_06.http\\n@@ -0,0 +1,4 @@\\n+GET /the/future HTTP/1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111.1\\\\r\\\\n\\n+Content-Length: 7\\\\r\\\\n\\n+\\\\r\\\\n\\n+Old Man\\n\",\"diff --git a/tests/requests/invalid/prefix_06.py b/tests/requests/invalid/prefix_06.py\\nnew file mode 100644\\nindex 000000000..b2286d428\\n--- /dev/null\\n+++ b/tests/requests/invalid/prefix_06.py\\n@@ -0,0 +1,5 @@\\n+from gunicorn.config import Config\\n+from gunicorn.http.errors import InvalidHTTPVersion\\n+\\n+cfg = Config()\\n+request = InvalidHTTPVersion\\n\",\"diff --git a/tests/requests/invalid/version_01.http b/tests/requests/invalid/version_01.http\\nnew file mode 100644\\nindex 000000000..0a222ce12\\n--- /dev/null\\n+++ b/tests/requests/invalid/version_01.http\\n@@ -0,0 +1,2 @@\\n+GET /foo HTTP/0.99\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/version_01.py b/tests/requests/invalid/version_01.py\\nnew file mode 100644\\nindex 000000000..760840b69\\n--- /dev/null\\n+++ b/tests/requests/invalid/version_01.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHTTPVersion\\n+request = InvalidHTTPVersion\\n\",\"diff --git a/tests/requests/invalid/version_02.http b/tests/requests/invalid/version_02.http\\nnew file mode 100644\\nindex 000000000..6d29ac5fe\\n--- /dev/null\\n+++ b/tests/requests/invalid/version_02.http\\n@@ -0,0 +1,2 @@\\n+GET /foo HTTP/2.0\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/version_02.py b/tests/requests/invalid/version_02.py\\nnew file mode 100644\\nindex 000000000..760840b69\\n--- /dev/null\\n+++ b/tests/requests/invalid/version_02.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidHTTPVersion\\n+request = InvalidHTTPVersion\\n\",\"diff --git a/tests/requests/invalid/chunked_09.http b/tests/requests/invalid/chunked_09.http\\nnew file mode 100644\\nindex 000000000..6207310cf\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_09.http\\n@@ -0,0 +1,7 @@\\n+POST /chunked_ows_without_ext HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+0 \\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_09.py b/tests/requests/invalid/chunked_09.py\\nnew file mode 100644\\nindex 000000000..0571e1183\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_09.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidChunkSize\\n+request = InvalidChunkSize\\n\",\"diff --git a/tests/requests/invalid/chunked_10.http b/tests/requests/invalid/chunked_10.http\\nnew file mode 100644\\nindex 000000000..db1e4c38d\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_10.http\\n@@ -0,0 +1,7 @@\\n+POST /chunked_ows_before HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+ 0\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_10.py b/tests/requests/invalid/chunked_10.py\\nnew file mode 100644\\nindex 000000000..0571e1183\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_10.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidChunkSize\\n+request = InvalidChunkSize\\n\",\"diff --git a/tests/requests/invalid/chunked_11.http b/tests/requests/invalid/chunked_11.http\\nnew file mode 100644\\nindex 000000000..da1f72e58\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_11.http\\n@@ -0,0 +1,7 @@\\n+POST /chunked_ows_before HTTP/1.1\\\\r\\\\n\\n+Transfer-Encoding: chunked\\\\r\\\\n\\n+\\\\r\\\\n\\n+5\\\\n;\\\\r\\\\n\\n+hello\\\\r\\\\n\\n+0\\\\r\\\\n\\n+\\\\r\\\\n\\n\",\"diff --git a/tests/requests/invalid/chunked_11.py b/tests/requests/invalid/chunked_11.py\\nnew file mode 100644\\nindex 000000000..0571e1183\\n--- /dev/null\\n+++ b/tests/requests/invalid/chunked_11.py\\n@@ -0,0 +1,2 @@\\n+from gunicorn.http.errors import InvalidChunkSize\\n+request = InvalidChunkSize\\n\",\"diff --git a/tests/requests/valid/025.http b/tests/requests/valid/025.http\\nindex f8d7fae2e..214f3094c 100644\\n--- a/tests/requests/valid/025.http\\n+++ b/tests/requests/valid/025.http\\n@@ -3,7 +3,7 @@ Transfer-Encoding: chunked\\\\r\\\\n\\n \\\\r\\\\n\\n 5; some; parameters=stuff\\\\r\\\\n\\n hello\\\\r\\\\n\\n-6; blahblah; blah\\\\r\\\\n\\n+6 \\\\t;\\\\tblahblah; blah\\\\r\\\\n\\n  world\\\\r\\\\n\\n 0\\\\r\\\\n\\n \\\\r\\\\n\"]", "hints_text": ""}
