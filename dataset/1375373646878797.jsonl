{"instance_id": "1375373646878797", "repo": "haidaram/ansible-playbook-grapher", "base_commit": "2ce66443dc3129b2bb9ba6365e4c099855ff6165", "problem_statement": "Clicking on a node should open the corresponding file:\\n**Is your feature request related to a problem? Please describe.**\\r\\nSometimes when I try to understand a bunch of ansible playbooks, I want to navigate to the playbook that I am looking in the graph. Currently I do it by doing find tool but its very hectic. It would be much better If I click on the node and it should open the file corresponding to that node.\\r\\n\\r\\n**Describe the solution you'd like**\\r\\nIt wouldn't be difficult to implement this feature. Just a hint, you could use: `graph.attr(\"node\", URL=\"file name\")`\\r\\n\\r\\n**Describe alternatives you've considered**\\r\\nI dont know yet, will update soon if have any\\r\\n", "FAIL_TO_PASS": ["tests/test_cli.py::test_cli_open_protocol_custom_formats_invalid_inputs[{}-The", "tests/test_cli.py::test_cli_open_protocol_custom_formats_invalid_inputs[invalid_json-JSONDecodeError]", "tests/test_cli.py::test_cli_open_protocol_custom_formats_not_provided", "tests/test_cli.py::test_cli_open_protocol_custom_formats"], "PASS_TO_PASS": ["tests/test_cli.py::test_skip_tags[multiple-skip-tags]", "tests/test_cli.py::test_cli_help[-h]", "tests/test_cli.py::test_cli_tags[multiple-tags2]", "tests/test_cli.py::test_cli_multiple_playbooks", "tests/test_graph.py::test_links_structure", "tests/test_cli.py::test_cli_tags[no_tags_provided]", "tests/test_cli.py::test_cli_verbosity_options[no_verbose]", "tests/test_cli.py::test_cli_tags[multiple-tags]", "tests/test_cli.py::test_cli_output_filename[output-filename-short-option]", "tests/test_cli.py::test_cli_include_role_tasks[default]", "tests/test_cli.py::test_cli_save_dot_file[save-dot-file-long-option]", "tests/test_cli.py::test_cli_tags[one-tag]", "tests/test_cli.py::test_cli_help[--help]", "tests/test_cli.py::test_skip_tags[no_skip_tags_provided]", "tests/test_cli.py::test_cli_include_role_tasks[include]", "tests/test_graph.py::test_get_all_tasks_nodes", "tests/test_cli.py::test_cli_output_filename[default]", "tests/test_cli.py::test_cli_verbosity_options[double_verbose]", "tests/test_cli.py::test_cli_version", "tests/test_cli.py::test_cli_verbosity_options[simple_verbose]", "tests/test_cli.py::test_skip_tags[one-skip-tag]", "tests/test_cli.py::test_cli_no_playbook", "tests/test_cli.py::test_cli_verbosity_options[triple_verbose]", "tests/test_cli.py::test_cli_save_dot_file[save-dot-file-short-option]", "tests/test_cli.py::test_cli_save_dot_file[default]", "tests/test_cli.py::test_skip_tags[multiple-skip-tags2]", "tests/test_cli.py::test_cli_output_filename[output-filename-long-option]"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/haidaram_ansible-playbook-grapher:2ce66443dc3129b2bb9ba6365e4c099855ff6165", "patch": "", "test_patch": "[\"diff --git a/tests/test_parser.py b/tests/test_parser.py\\nindex d9dc7be1..1e780e42 100644\\n--- a/tests/test_parser.py\\n+++ b/tests/test_parser.py\\n@@ -1,3 +1,4 @@\\n+import os\\n from typing import List\\n \\n import pytest\\n@@ -6,6 +7,10 @@\\n from ansibleplaybookgrapher import PlaybookParser\\n from ansibleplaybookgrapher.cli import PlaybookGrapherCLI\\n from ansibleplaybookgrapher.graph import TaskNode, BlockNode, RoleNode, get_all_tasks_nodes, CompositeNode\\n+from tests import FIXTURES_DIR\\n+\\n+# This file directory path\\n+DIR_PATH = os.path.dirname(os.path.realpath(__file__))\\n \\n \\n def get_all_tasks(composites: List[CompositeNode]) -> List[TaskNode]:\\n@@ -44,6 +49,8 @@ def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display,\\n     # first include_role\\n     include_role_1 = tasks[0].destination\\n     assert isinstance(include_role_1, RoleNode)\\n+    assert include_role_1.path == os.path.join(DIR_PATH, FIXTURES_DIR, \\\"include_role.yml\\\")\\n+    assert include_role_1.line == 6\\n     assert len(include_role_1.tasks) == 0, \\\"We don't support adding tasks from include_role with loop\\\"\\n \\n     # first task\\n@@ -97,7 +104,10 @@ def test_block_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n \\n     # Check pre tasks\\n     assert isinstance(pre_tasks[0].destination, RoleNode), \\\"The first edge should have a RoleNode as destination\\\"\\n-    assert isinstance(pre_tasks[1].destination, BlockNode), \\\"The second edge should have a BlockNode as destination\\\"\\n+    pre_task_block = pre_tasks[1].destination\\n+    assert isinstance(pre_task_block, BlockNode), \\\"The second edge should have a BlockNode as destination\\\"\\n+    assert pre_task_block.path == os.path.join(DIR_PATH, FIXTURES_DIR, \\\"with_block.yml\\\")\\n+    assert pre_task_block.line == 7\\n \\n     # Check tasks\\n     task_1 = tasks[0].destination\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex ca2807cc..810238cf 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -23,7 +23,11 @@ def run_grapher(playbook_file: str, output_filename: str = None, additional_args\\n     additional_args.insert(0, \\\"-vv\\\")\\n \\n     if os.environ.get(\\\"TEST_VIEW_GENERATED_FILE\\\") == \\\"1\\\":\\n-        additional_args.insert(1, \\\"--view\\\")\\n+        additional_args.insert(0, \\\"--view\\\")\\n+\\n+    # Easier to test with vscode\\n+    additional_args.insert(0, \\\"--open-protocol\\\")\\n+    additional_args.insert(1, \\\"vscode\\\")\\n \\n     playbook_path = os.path.join(FIXTURES_DIR, playbook_file)\\n     args = [__prog__]\\n@@ -163,7 +167,7 @@ def test_include_role(request, include_role_tasks_option, expected_tasks_number)\\n \\n def test_with_block(request):\\n     \\\"\\\"\\\"\\n-    Test with_roles.yml, an example with roles\\n+    Test with_block.yml, an example with roles\\n     \\\"\\\"\\\"\\n     svg_path, playbook_path = run_grapher(\\\"with_block.yml\\\", output_filename=request.node.name,\\n                                           additional_args=[\\\"--include-role-tasks\\\"])\\n\",\"diff --git a/tests/fixtures/with_roles.yml b/tests/fixtures/with_roles.yml\\nindex 8fb1bc99..19d09748 100644\\n--- a/tests/fixtures/with_roles.yml\\n+++ b/tests/fixtures/with_roles.yml\\n@@ -23,7 +23,7 @@\\n       when: ansible_distribution == \\\"Debian\\\"\\n       tags:\\n         - role_tag\\n-\\n+    - role: display_some_facts\\n   tasks:\\n     - name: Add backport {{backport}}\\n       become: yes\\n@@ -32,7 +32,6 @@\\n         filename: \\\"{{backport}}\\\"\\n         state: present\\n         update_cache: yes\\n-\\n     - name: Install packages\\n       become: yes\\n       apt:\\n\",\"diff --git a/tests/test_parser.py b/tests/test_parser.py\\nindex 1e780e42..b3e2be0b 100644\\n--- a/tests/test_parser.py\\n+++ b/tests/test_parser.py\\n@@ -9,13 +9,15 @@\\n from ansibleplaybookgrapher.graph import TaskNode, BlockNode, RoleNode, get_all_tasks_nodes, CompositeNode\\n from tests import FIXTURES_DIR\\n \\n-# This file directory path\\n+# This file directory abspath\\n DIR_PATH = os.path.dirname(os.path.realpath(__file__))\\n+# Fixtures abspath\\n+FIXTURES_PATH = os.path.join(DIR_PATH, FIXTURES_DIR)\\n \\n \\n def get_all_tasks(composites: List[CompositeNode]) -> List[TaskNode]:\\n     \\\"\\\"\\\"\\n-\\n+    Get all tasks from a list of composite nodes\\n     :param composites:\\n     :return:\\n     \\\"\\\"\\\"\\n@@ -27,6 +29,28 @@ def get_all_tasks(composites: List[CompositeNode]) -> List[TaskNode]:\\n     return tasks\\n \\n \\n+@pytest.mark.parametrize('grapher_cli', [[\\\"with_roles.yml\\\"]], indirect=True)\\n+def test_with_roles_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n+    \\\"\\\"\\\"\\n+\\n+    :param grapher_cli:\\n+    :param display:\\n+    :return:\\n+    \\\"\\\"\\\"\\n+    parser = PlaybookParser(grapher_cli.options.playbook_filename)\\n+    playbook_node = parser.parse()\\n+    assert len(playbook_node.plays) == 1\\n+    play_node = playbook_node.plays[0].destination\\n+    assert len(play_node.roles) == 2\\n+\\n+    fake_role = play_node.roles[0].destination\\n+    assert isinstance(fake_role, RoleNode)\\n+    assert not fake_role.include_role\\n+    assert fake_role.path == os.path.join(FIXTURES_PATH, \\\"roles\\\", \\\"fake_role\\\")\\n+    assert fake_role.line is None\\n+    assert fake_role.column is None\\n+\\n+\\n @pytest.mark.parametrize('grapher_cli', [[\\\"include_role.yml\\\"]], indirect=True)\\n def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display, capsys):\\n     \\\"\\\"\\\"\\n@@ -49,7 +73,8 @@ def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display,\\n     # first include_role\\n     include_role_1 = tasks[0].destination\\n     assert isinstance(include_role_1, RoleNode)\\n-    assert include_role_1.path == os.path.join(DIR_PATH, FIXTURES_DIR, \\\"include_role.yml\\\")\\n+    assert include_role_1.include_role\\n+    assert include_role_1.path == os.path.join(FIXTURES_PATH, \\\"include_role.yml\\\")\\n     assert include_role_1.line == 6\\n     assert len(include_role_1.tasks) == 0, \\\"We don't support adding tasks from include_role with loop\\\"\\n \\n@@ -60,6 +85,7 @@ def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display,\\n     # second include_role\\n     include_role_2 = tasks[2].destination\\n     assert isinstance(include_role_2, RoleNode)\\n+    assert include_role_2.include_role\\n     assert len(include_role_2.tasks) == 3\\n \\n     # second task\\n@@ -69,11 +95,13 @@ def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display,\\n     include_role_3 = tasks[4].destination\\n     assert tasks[4].name == \\\"[when: x is not defined]\\\"\\n     assert isinstance(include_role_3, RoleNode)\\n+    assert include_role_3.include_role\\n     assert len(include_role_3.tasks) == 3\\n \\n     # fourth include_role\\n     include_role_4 = tasks[5].destination\\n     assert isinstance(include_role_4, RoleNode)\\n+    assert include_role_4.include_role\\n     assert len(include_role_4.tasks) == 0, \\\"We don't support adding tasks from include_role with loop\\\"\\n \\n \\n@@ -106,7 +134,7 @@ def test_block_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n     assert isinstance(pre_tasks[0].destination, RoleNode), \\\"The first edge should have a RoleNode as destination\\\"\\n     pre_task_block = pre_tasks[1].destination\\n     assert isinstance(pre_task_block, BlockNode), \\\"The second edge should have a BlockNode as destination\\\"\\n-    assert pre_task_block.path == os.path.join(DIR_PATH, FIXTURES_DIR, \\\"with_block.yml\\\")\\n+    assert pre_task_block.path == os.path.join(FIXTURES_PATH, \\\"with_block.yml\\\")\\n     assert pre_task_block.line == 7\\n \\n     # Check tasks\\n@@ -122,6 +150,7 @@ def test_block_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n \\n     # Check the second block (nested block)\\n     nested_block = first_block.tasks[2].destination\\n+    assert isinstance(nested_block, BlockNode)\\n     assert len(nested_block.tasks) == 2\\n     assert nested_block.tasks[0].destination.name == \\\"get_url\\\"\\n     assert nested_block.tasks[1].destination.name == \\\"command\\\"\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex 810238cf..4b6ac2e3 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -137,7 +137,7 @@ def test_import_tasks(request):\\n \\n \\n @pytest.mark.parametrize([\\\"include_role_tasks_option\\\", \\\"expected_tasks_number\\\"],\\n-                         [(\\\"--\\\", 2), (\\\"--include-role-tasks\\\", 5)],\\n+                         [(\\\"--\\\", 2), (\\\"--include-role-tasks\\\", 8)],\\n                          ids=[\\\"no_include_role_tasks_option\\\", \\\"include_role_tasks_option\\\"])\\n def test_with_roles(request, include_role_tasks_option, expected_tasks_number):\\n     \\\"\\\"\\\"\\n@@ -148,7 +148,7 @@ def test_with_roles(request, include_role_tasks_option, expected_tasks_number):\\n                                           additional_args=[include_role_tasks_option])\\n \\n     _common_tests(svg_path=svg_path, playbook_path=playbook_path, plays_number=1, tasks_number=expected_tasks_number,\\n-                  post_tasks_number=2, pre_tasks_number=2, roles_number=1)\\n+                  post_tasks_number=2, pre_tasks_number=2, roles_number=2)\\n \\n \\n @pytest.mark.parametrize([\\\"include_role_tasks_option\\\", \\\"expected_tasks_number\\\"],\\n\",\"diff --git a/tests/fixtures/import_role.yml b/tests/fixtures/import_role.yml\\nindex b23e24ab..7f9f5579 100644\\n--- a/tests/fixtures/import_role.yml\\n+++ b/tests/fixtures/import_role.yml\\n@@ -13,4 +13,4 @@\\n         msg: Hello world\\n     - name: Import role\\n       import_role:\\n-        name: display_some_facts\\n\\\\ No newline at end of file\\n+        name: display_some_facts\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex 4b6ac2e3..6e80f5f2 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -25,9 +25,8 @@ def run_grapher(playbook_file: str, output_filename: str = None, additional_args\\n     if os.environ.get(\\\"TEST_VIEW_GENERATED_FILE\\\") == \\\"1\\\":\\n         additional_args.insert(0, \\\"--view\\\")\\n \\n-    # Easier to test with vscode\\n-    additional_args.insert(0, \\\"--open-protocol\\\")\\n-    additional_args.insert(1, \\\"vscode\\\")\\n+    additional_args.insert(0, \\\"--open-protocol-handler\\\")\\n+    additional_args.insert(1, os.environ.get(\\\"TEST_OPEN_PROTOCOL\\\", \\\"browser\\\"))\\n \\n     playbook_path = os.path.join(FIXTURES_DIR, playbook_file)\\n     args = [__prog__]\\n\",\"diff --git a/tests/test_parser.py b/tests/test_parser.py\\nindex b3e2be0b..036a219e 100644\\n--- a/tests/test_parser.py\\n+++ b/tests/test_parser.py\\n@@ -29,10 +29,10 @@ def get_all_tasks(composites: List[CompositeNode]) -> List[TaskNode]:\\n     return tasks\\n \\n \\n-@pytest.mark.parametrize('grapher_cli', [[\\\"with_roles.yml\\\"]], indirect=True)\\n-def test_with_roles_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n+@pytest.mark.parametrize('grapher_cli', [[\\\"example.yml\\\"]], indirect=True)\\n+def test_example_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n     \\\"\\\"\\\"\\n-\\n+    Test the parsing of example.yml\\n     :param grapher_cli:\\n     :param display:\\n     :return:\\n@@ -41,6 +41,28 @@ def test_with_roles_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n     playbook_node = parser.parse()\\n     assert len(playbook_node.plays) == 1\\n     play_node = playbook_node.plays[0].destination\\n+    assert play_node.path == os.path.join(FIXTURES_PATH, \\\"example.yml\\\")\\n+    assert play_node.line == 2\\n+\\n+    pre_tasks = play_node.pre_tasks\\n+    tasks = play_node.tasks\\n+    post_tasks = play_node.post_tasks\\n+    assert len(pre_tasks) == 2\\n+    assert len(tasks) == 4\\n+    assert len(post_tasks) == 2\\n+\\n+\\n+@pytest.mark.parametrize('grapher_cli', [[\\\"with_roles.yml\\\"]], indirect=True)\\n+def test_with_roles_parsing(grapher_cli: PlaybookGrapherCLI):\\n+    \\\"\\\"\\\"\\n+    Test the parsing of with_roles.yml\\n+    :param grapher_cli:\\n+    :return:\\n+    \\\"\\\"\\\"\\n+    parser = PlaybookParser(grapher_cli.options.playbook_filename)\\n+    playbook_node = parser.parse()\\n+    assert len(playbook_node.plays) == 1\\n+    play_node = playbook_node.plays[0].destination\\n     assert len(play_node.roles) == 2\\n \\n     fake_role = play_node.roles[0].destination\\n@@ -52,11 +74,10 @@ def test_with_roles_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n \\n \\n @pytest.mark.parametrize('grapher_cli', [[\\\"include_role.yml\\\"]], indirect=True)\\n-def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display, capsys):\\n+def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, capsys):\\n     \\\"\\\"\\\"\\n     Test parsing of include_role\\n     :param grapher_cli:\\n-    :param display:\\n     :return:\\n     \\\"\\\"\\\"\\n     parser = PlaybookParser(grapher_cli.options.playbook_filename, include_role_tasks=True)\\n@@ -106,11 +127,10 @@ def test_include_role_parsing(grapher_cli: PlaybookGrapherCLI, display: Display,\\n \\n \\n @pytest.mark.parametrize('grapher_cli', [[\\\"with_block.yml\\\"]], indirect=True)\\n-def test_block_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n+def test_block_parsing(grapher_cli: PlaybookGrapherCLI):\\n     \\\"\\\"\\\"\\n     The parsing of a playbook with blocks\\n     :param grapher_cli:\\n-    :param display:\\n     :return:\\n     \\\"\\\"\\\"\\n     parser = PlaybookParser(grapher_cli.options.playbook_filename, include_role_tasks=True)\\n\",\"diff --git a/tests/test_parser.py b/tests/test_parser.py\\nindex 036a219e..73620f5f 100644\\n--- a/tests/test_parser.py\\n+++ b/tests/test_parser.py\\n@@ -40,6 +40,10 @@ def test_example_parsing(grapher_cli: PlaybookGrapherCLI, display: Display):\\n     parser = PlaybookParser(grapher_cli.options.playbook_filename)\\n     playbook_node = parser.parse()\\n     assert len(playbook_node.plays) == 1\\n+    assert playbook_node.path == os.path.join(FIXTURES_PATH, \\\"example.yml\\\")\\n+    assert playbook_node.line == 1\\n+    assert playbook_node.column == 1\\n+\\n     play_node = playbook_node.plays[0].destination\\n     assert play_node.path == os.path.join(FIXTURES_PATH, \\\"example.yml\\\")\\n     assert play_node.line == 2\\n\",\"diff --git a/tests/test_cli.py b/tests/test_cli.py\\nindex 4e055cfa..33157820 100644\\n--- a/tests/test_cli.py\\n+++ b/tests/test_cli.py\\n@@ -128,7 +128,7 @@ def test_cli_tags(tags_option, expected):\\n def test_skip_tags(skip_tags_option, expected):\\n     \\\"\\\"\\\"\\n \\n-    :param tags_option:\\n+    :param skip_tags_option:\\n     :param expected:\\n     :return:\\n     \\\"\\\"\\\"\\n@@ -181,3 +181,50 @@ def test_cli_verbosity_options(verbosity, verbosity_number):\\n     cli.parse()\\n \\n     assert cli.options.verbosity == verbosity_number\\n+\\n+\\n+def test_cli_open_protocol_custom_formats():\\n+    \\\"\\\"\\\"\\n+    The provided format should be converted to a dict\\n+    :return:\\n+    \\\"\\\"\\\"\\n+    formats_str = '{\\\"file\\\": \\\"{path}\\\", \\\"folder\\\": \\\"{path}\\\"}'\\n+    args = [__prog__, '--open-protocol-handler', 'custom', '--open-protocol-custom-formats', formats_str,\\n+            'playbook1.yml']\\n+\\n+    cli = get_cli_class()(args)\\n+    cli.parse()\\n+    assert cli.options.open_protocol_custom_formats == {\\\"file\\\": \\\"{path}\\\",\\n+                                                        \\\"folder\\\": \\\"{path}\\\"}, \\\"The formats should be converted to json\\\"\\n+\\n+\\n+def test_cli_open_protocol_custom_formats_not_provided():\\n+    \\\"\\\"\\\"\\n+    The custom formats must be provided when the protocol handler is set to custom\\n+    :return:\\n+    \\\"\\\"\\\"\\n+    args = [__prog__, '--open-protocol-handler', 'custom', 'playbook1.yml']\\n+\\n+    cli = get_cli_class()(args)\\n+    with pytest.raises(AnsibleOptionsError) as exception_info:\\n+        cli.parse()\\n+\\n+    assert \\\"you must provide the formats to use with --open-protocol-custom-formats\\\" in exception_info.value.message\\n+\\n+\\n+@pytest.mark.parametrize(\\\"formats, expected_message\\\",\\n+                         [['invalid_json', \\\"JSONDecodeError\\\"],\\n+                          ['{}', \\\"The field 'file' or 'folder' is missing\\\"]])\\n+def test_cli_open_protocol_custom_formats_invalid_inputs(formats, expected_message, capsys):\\n+    \\\"\\\"\\\"\\n+    The custom formats must be a valid json data\\n+    :return:\\n+    \\\"\\\"\\\"\\n+    args = [__prog__, '--open-protocol-handler', 'custom', '--open-protocol-custom-formats', formats, 'playbook1.yml']\\n+\\n+    cli = get_cli_class()(args)\\n+    with pytest.raises(SystemExit) as exception_info:\\n+        cli.parse()\\n+\\n+    error_msg = capsys.readouterr().err\\n+    assert expected_message in error_msg\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex 6e80f5f2..674ceb03 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -67,7 +67,7 @@ def _common_tests(svg_path: str, playbook_path: str, plays_number: int = 0, task\\n \\n     # test if the file exist. It will exist only if we write in it.\\n     assert os.path.isfile(svg_path), \\\"The svg file should exist\\\"\\n-    assert pq('#root_node text').text() == playbook_path\\n+    assert pq('g[id^=playbook_] text').text() == playbook_path\\n \\n     plays = pq(\\\"g[id^='play_']\\\")\\n     tasks = pq(\\\"g[id^='task_']\\\")\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex 674ceb03..6fd7c866 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -9,6 +9,9 @@\\n from ansibleplaybookgrapher.cli import get_cli_class\\n from tests import FIXTURES_DIR\\n \\n+# This file directory abspath\\n+DIR_PATH = os.path.dirname(os.path.realpath(__file__))\\n+\\n \\n def run_grapher(playbook_file: str, output_filename: str = None, additional_args: List[str] = None) -> Tuple[str, str]:\\n     \\\"\\\"\\\"\\n@@ -25,8 +28,9 @@ def run_grapher(playbook_file: str, output_filename: str = None, additional_args\\n     if os.environ.get(\\\"TEST_VIEW_GENERATED_FILE\\\") == \\\"1\\\":\\n         additional_args.insert(0, \\\"--view\\\")\\n \\n-    additional_args.insert(0, \\\"--open-protocol-handler\\\")\\n-    additional_args.insert(1, os.environ.get(\\\"TEST_OPEN_PROTOCOL\\\", \\\"browser\\\"))\\n+    if \\\"--open-protocol-handler\\\" not in additional_args:\\n+        additional_args.insert(0, \\\"--open-protocol-handler\\\")\\n+        additional_args.insert(1, os.environ.get(\\\"TEST_OPEN_PROTOCOL\\\", \\\"browser\\\"))\\n \\n     playbook_path = os.path.join(FIXTURES_DIR, playbook_file)\\n     args = [__prog__]\\n@@ -34,8 +38,7 @@ def run_grapher(playbook_file: str, output_filename: str = None, additional_args\\n     if output_filename:  # the default filename is the playbook file name minus .yml\\n         # put the generated svg in a dedicated folder\\n         output_filename = output_filename.replace(\\\"[\\\", \\\"-\\\").replace(\\\"]\\\", \\\"\\\")\\n-        dir_path = os.path.dirname(os.path.realpath(__file__))  # current file directory\\n-        args.extend(['-o', os.path.join(dir_path, \\\"generated_svg\\\", output_filename)])\\n+        args.extend(['-o', os.path.join(DIR_PATH, \\\"generated_svg\\\", output_filename)])\\n \\n     args.extend(additional_args)\\n \\n@@ -250,3 +253,24 @@ def test_skip_tags(request):\\n                                           additional_args=[\\\"--skip-tags\\\", \\\"pre_task_tag_1\\\", \\\"--include-role-tasks\\\"])\\n     _common_tests(svg_path=svg_path, playbook_path=playbook_path, plays_number=1, pre_tasks_number=1, roles_number=1,\\n                   tasks_number=3)\\n+\\n+\\n+def test_with_roles_with_custom_protocol_handlers(request):\\n+    \\\"\\\"\\\"\\n+    Test with_roles.yml with a custom protocol handlers\\n+    \\\"\\\"\\\"\\n+    formats_str = '{\\\"file\\\": \\\"vscode://file/{path}:{line}\\\", \\\"folder\\\": \\\"{path}\\\"}'\\n+    svg_path, playbook_path = run_grapher(\\\"with_roles.yml\\\", output_filename=request.node.name,\\n+                                          additional_args=[\\\"--open-protocol-handler\\\", \\\"custom\\\",\\n+                                                           \\\"--open-protocol-custom-formats\\\", formats_str])\\n+\\n+    res = _common_tests(svg_path=svg_path, playbook_path=playbook_path, plays_number=1, tasks_number=2,\\n+                        post_tasks_number=2, pre_tasks_number=2, roles_number=2)\\n+\\n+    xlink_ref_selector = \\\"{http://www.w3.org/1999/xlink}href\\\"\\n+    for t in res[\\\"tasks\\\"]:\\n+        assert t.find(\\\"g/a\\\").get(xlink_ref_selector).startswith(\\n+            f\\\"vscode://file/{DIR_PATH}\\\"), \\\"Tasks should be open with vscode\\\"\\n+\\n+    for r in res[\\\"roles\\\"]:\\n+        assert r.find(\\\"g/a\\\").get(xlink_ref_selector).startswith(DIR_PATH)\\n\",\"diff --git a/tests/test_playbook_grapher.py b/tests/test_playbook_grapher.py\\nindex 6fd7c866..033bce5b 100644\\n--- a/tests/test_playbook_grapher.py\\n+++ b/tests/test_playbook_grapher.py\\n@@ -30,7 +30,7 @@ def run_grapher(playbook_file: str, output_filename: str = None, additional_args\\n \\n     if \\\"--open-protocol-handler\\\" not in additional_args:\\n         additional_args.insert(0, \\\"--open-protocol-handler\\\")\\n-        additional_args.insert(1, os.environ.get(\\\"TEST_OPEN_PROTOCOL\\\", \\\"browser\\\"))\\n+        additional_args.insert(1, \\\"vscode\\\")\\n \\n     playbook_path = os.path.join(FIXTURES_DIR, playbook_file)\\n     args = [__prog__]\"]", "hints_text": ""}
