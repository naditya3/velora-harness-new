{"instance_id": "1257345955997888", "repo": "game-as-a-service/loveletter", "base_commit": "f15607706f2eec526c68d46adf25aad56b09366e", "problem_statement": "串接大平台項目:\\n- [ ] 新增API `心跳(/heath)`，固定回傳status = 200\\r\\n- [ ] 驗證JWT是否正確\\r\\n![image](https://github.com/Game-as-a-Service/LoveLetter/assets/44540755/ac6d7180-689e-4e0c-a8e8-02c9f1418a5f)\\r\\n- [ ] 新增API `開始遊戲(/games)`，把既有的`create_game()、join_game()、start_game()`整合在同一支API中\\r\\n![image](https://github.com/Game-as-a-Service/LoveLetter/assets/44540755/39a50815-76b8-4f4d-bce0-aec400fcb570)\\r\\n- [ ] 新增API `取得遊戲狀態(/games/{gameId}/{playerJwt}/status)`，透過playerJWT，去訪問大平台的`GET /users/me`取得該用戶ID，就能透過用戶ID、gameID辨別是哪一場遊戲中的玩家\\r\\n![image](https://github.com/Game-as-a-Service/LoveLetter/assets/44540755/b967b876-f828-4862-9475-f6421a2b73c1)\\r\\n- [ ] 增加前端入口`https://{遊戲前端主機}/games/{gameId}?token={playerJwt}`，顯示遊戲畫面，再去呼叫後端API(`/games/{gameId}/{playerJwt}/status`)取得遊戲狀態\\r\\n![image](https://github.com/Game-as-a-Service/LoveLetter/assets/44540755/3e99f064-d1ff-4ef0-b2f2-43ddfe05f7ce)", "FAIL_TO_PASS": ["tests/test_game_data.py::GameDataTest::test_to_domain", "tests/test_simple_path_e2e.py::LoveLetterSimpleCaseEndToEndTests::test_start_game_with_predefined_state"], "PASS_TO_PASS": ["tests/test_game_rules.py::FirstRoundRandomPickerTests::test_uniform_random_picker", "tests/test_game_service.py::PlayerContextTest::test_prompt_player_only_discard_countess_because_has_prince", "tests/test_game_rules.py::GetGameStartedTests::test_game_can_not_start_less_than_two_players", "tests/test_players.py::PlayersTest::test_compare_total_value_if_tie", "tests/test_players.py::PlayersTest::test_compare_hand_card", "tests/test_game_service.py::GameServiceTests::test_create_and_join_game", "tests/test_game_service.py::PlayerContextTest::test_prompt_player_discard_baron_and_prince", "tests/test_game_service.py::PlayerContextTest::test_prompt_player_discard_guard_and_prince", "tests/test_deck.py::DeckTest::test_shuffle_with_different_number_of_players", "tests/test_card_behave.py::DiscardPrinceCardTests::test_discard_prince_card_and_chosen_player_get_other_card_from_deck", "tests/test_card_behave.py::DiscardBaronCardTests::test_retire_opponent_if_greater_hand_card_value", "tests/test_game_rules.py::PlayingGameRoundByRoundTests::test_after_game_start_every_player_get_1_card_and_turn_player_get_extra_1", "tests/test_game_rules.py::PlayingGameRoundByRoundTests::test_move_to_next_round_by_only_one_player_alive", "tests/test_game_rules.py::GetGameStartedTests::test_players_cannot_join_game_after_4th_player", "tests/test_game_rules.py::PlayingGameRoundByRoundTests::test_shift_turn_player_one_by_one", "tests/test_example_apis.py::ExampleApiTests::test_http_post", "tests/test_game_service.py::PlayerContextTest::test_just_1_can_see_opponent_card_by_priest_card", "tests/test_players.py::PlayersTest::test_unable_to_compare", "tests/test_game_rules.py::GetGameStartedTests::test_players_can_join_game_before_it_started", "tests/test_example_apis.py::ExampleApiTests::test_http_post_with_response_model", "tests/test_players.py::PlayersTest::test_find_winner", "tests/test_card_behave.py::DiscardPrinceCardTests::test_discard_prince_card_and_chosen_player_get_other_card_from_deck_and_deck_card_is_empty", "tests/test_card_behave.py::DiscardPrinceCardTests::test_discard_prince_card_and_chosen_player_get_other_card_from_remove_by_rule_card", "tests/test_card_behave.py::EndRoundTests::test_with_no_card_in_deck_the_player_has_biggest_card_is_the_winner", "tests/test_card_behave.py::DiscardPrinceCardTests::test_discard_prince_card_and_chosen_player_out_and_not_get_other_card_from_deck", "tests/test_example_apis.py::ExampleApiTests::test_http_get_read_item", "tests/test_card_behave.py::LoseHandMaidProtected::test_finish_one_round_lose_handmaid_protected", "tests/test_card_behave.py::DiscardBaronCardTests::test_if_equal_hand_card_value", "tests/test_game_service.py::GameServiceTests::test_get_status", "tests/test_deck.py::DeckTest::test_player_draw", "tests/test_example_apis.py::ExampleApiTests::test_http_get_read_item_with_parameters", "tests/test_game_rules.py::GetGameStartedTests::test_game_can_start_at_least_two_players", "tests/test_card_behave.py::EndRoundTests::test_left_one_player_winner_get_token_of_affection", "tests/test_game_service.py::PlayerContextTest::test_prompt_player_discard_king_and_priest", "tests/test_card_behave.py::EndGameTest::test_with_no_card_in_deck_more_than_one_player_has_biggest_card", "tests/test_card_behave.py::EndRoundTests::test_with_no_card_in_deck_more_than_one_player_has_biggest_card", "tests/test_card_behave.py::DiscardBaronCardTests::test_retire_self_if_smaller_hand_card_value", "tests/test_game_rules.py::PlayingGameRoundByRoundTests::test_move_to_next_round_by_empty_deck", "tests/test_game_rules.py::TurnPlayerCannotDiscardCardNotInTheirHandTests::test_turn_player_cannot_discard_cards_not_in_their_hand"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/game-as-a-service_loveletter:f15607706f2eec526c68d46adf25aad56b09366e", "patch": "[\"diff --git a/love_letter/config.py b/love_letter/config.py\\nindex 26cec2b..992481e 100644\\n--- a/love_letter/config.py\\n+++ b/love_letter/config.py\\n@@ -7,3 +7,4 @@\\n DB_PASSWORD = os.environ.get(\\\"DB_PASSWORD\\\")\\n DB_NAME = os.environ.get(\\\"DB_NAME\\\", \\\"love_letter\\\")\\n DB_COLLECTION = os.environ.get(\\\"DB_COLLECTION\\\", \\\"love_letter\\\")\\n+FRONTEND_HOST = os.environ.get(\\\"FRONTEND_HOST\\\", \\\"http://127.0.0.1\\\")\\n\",\"diff --git a/love_letter/models/__init__.py b/love_letter/models/__init__.py\\nindex e3fb9d0..8483e54 100644\\n--- a/love_letter/models/__init__.py\\n+++ b/love_letter/models/__init__.py\\n@@ -333,7 +333,8 @@ class Seen:\\n \\n \\n class Player:\\n-    def __init__(self, name: str):\\n+    def __init__(self, name: str, _id: Union[str] = None):\\n+        self.id = _id\\n         self.name = name\\n         self.cards: List[Card] = []\\n         self.am_i_out: bool = False\\n\",\"diff --git a/love_letter/models/event.py b/love_letter/models/event.py\\nindex 8dca765..2531820 100644\\n--- a/love_letter/models/event.py\\n+++ b/love_letter/models/event.py\\n@@ -32,3 +32,8 @@ class CardPlayedEvent(DomainEvent):\\n @dataclass\\n class GetStatusEvent(DomainEvent):\\n     game: \\\"Game\\\"\\n+\\n+\\n+@dataclass\\n+class GameEvent(DomainEvent):\\n+    url: str\\n\",\"diff --git a/love_letter/repository/data/__init__.py b/love_letter/repository/data/__init__.py\\nindex f960901..c6f46f2 100644\\n--- a/love_letter/repository/data/__init__.py\\n+++ b/love_letter/repository/data/__init__.py\\n@@ -45,11 +45,12 @@ def to_dict(player: \\\"Player\\\", last_round: \\\"Round\\\") -> Dict:\\n                 for x in player.cards\\n             ],\\n             score=player.tokens_of_affection,\\n+            id=player.id,\\n         )\\n \\n     @staticmethod\\n     def to_domain(player_dict: Dict) -> \\\"Player\\\":\\n-        player = Player(player_dict[\\\"name\\\"])\\n+        player = Player(player_dict[\\\"name\\\"], player_dict[\\\"id\\\"])\\n         player.am_i_out = player_dict[\\\"out\\\"]\\n         player.cards = [CardData.to_domain(c) for c in player_dict[\\\"cards\\\"]]\\n         player.seen_cards = [SeenData.to_domain(s) for s in player_dict[\\\"seen_cards\\\"]]\\n\",\"diff --git a/love_letter/usecase/lobby_start_game.py b/love_letter/usecase/lobby_start_game.py\\nnew file mode 100644\\nindex 0000000..9215913\\n--- /dev/null\\n+++ b/love_letter/usecase/lobby_start_game.py\\n@@ -0,0 +1,14 @@\\n+from love_letter.config import FRONTEND_HOST\\n+from love_letter.models import Game, Player\\n+from love_letter.models.event import GameEvent\\n+from love_letter.usecase.common import Presenter, game_repository\\n+\\n+\\n+class LobbyStartGame:\\n+    def execute(self, input: \\\"LobbyPlayers\\\", presenter: Presenter):\\n+        game = Game()\\n+        for player in input.players:\\n+            game.join(Player(player.nickname, player.id))\\n+        game.start()\\n+        game_repository.save_or_update(game)\\n+        presenter.present([GameEvent(url=f\\\"{FRONTEND_HOST}/games/{game.id}\\\")])\\n\",\"diff --git a/love_letter/web/app.py b/love_letter/web/app.py\\nindex 6ade6ad..eba3818 100644\\n--- a/love_letter/web/app.py\\n+++ b/love_letter/web/app.py\\n@@ -8,9 +8,10 @@\\n from love_letter.usecase.create_game import CreateGame\\n from love_letter.usecase.get_status import GetStatus\\n from love_letter.usecase.join_game import JoinGame\\n+from love_letter.usecase.lobby_start_game import LobbyStartGame\\n from love_letter.usecase.play_card import PlayCard\\n from love_letter.usecase.start_game import StartGame\\n-from love_letter.web.dto import GameStatus\\n+from love_letter.web.dto import GameStatus, LobbyPlayers\\n \\n # isort: off\\n from love_letter.web.presenter import (\\n@@ -20,6 +21,7 @@\\n     build_player_view,\\n     PlayCardPresenter,\\n     GetStatusPresenter,\\n+    LobbyStartGamePresenter,\\n )\\n \\n # isort: on\\n@@ -89,6 +91,13 @@ async def get_status(game_id: str, player_id: str):\\n     return build_player_view(game, player_id)\\n \\n \\n+@app.post(\\\"/games\\\")\\n+def lobby_start_game(players: LobbyPlayers):\\n+    presenter = LobbyStartGamePresenter.presenter()\\n+    LobbyStartGame().execute(players, presenter)\\n+    return presenter.as_view_model()\\n+\\n+\\n def run():\\n     uvicorn.run(\\\"love_letter.web.app:app\\\", host=\\\"0.0.0.0\\\", port=8080, reload=True)\\n \\n\",\"diff --git a/love_letter/web/dto/__init__.py b/love_letter/web/dto/__init__.py\\nindex 825f8fe..b53eeac 100644\\n--- a/love_letter/web/dto/__init__.py\\n+++ b/love_letter/web/dto/__init__.py\\n@@ -32,6 +32,7 @@ class RoundModel(BaseModel):\\n class NamedPlayer(BaseModel):\\n     name: str | None\\n     score: int\\n+    id: str | None\\n \\n \\n class GameStatus(BaseModel):\\n@@ -40,3 +41,12 @@ class GameStatus(BaseModel):\\n     events: List[Dict]\\n     rounds: List[RoundModel]\\n     final_winner: str | None\\n+\\n+\\n+class LobbyPlayer(BaseModel):\\n+    id: str\\n+    nickname: str\\n+\\n+\\n+class LobbyPlayers(BaseModel):\\n+    players: List[LobbyPlayer]\\n\",\"diff --git a/love_letter/web/presenter.py b/love_letter/web/presenter.py\\nindex fc159c3..f6a9265 100644\\n--- a/love_letter/web/presenter.py\\n+++ b/love_letter/web/presenter.py\\n@@ -3,7 +3,12 @@\\n from love_letter.models import Game, PlayerJoinedEvent\\n \\n # isort: off\\n-from love_letter.models.event import CardPlayedEvent, GetStatusEvent, StartGameEvent\\n+from love_letter.models.event import (\\n+    CardPlayedEvent,\\n+    GetStatusEvent,\\n+    StartGameEvent,\\n+    GameEvent,\\n+)\\n \\n # isort: on\\n from love_letter.repository.data import GameData\\n@@ -141,3 +146,15 @@ def as_view_model(self) -> Game:\\n     @classmethod\\n     def presenter(cls) -> \\\"GetStatusPresenter\\\":\\n         return GetStatusPresenter()\\n+\\n+\\n+class LobbyStartGamePresenter(Presenter):\\n+    def as_view_model(self):\\n+        for event in self.events:\\n+            if isinstance(event, GameEvent):\\n+                return event\\n+        raise BaseException(\\\"Game is unavailable.\\\")\\n+\\n+    @classmethod\\n+    def presenter(cls) -> \\\"LobbyStartGamePresenter\\\":\\n+        return LobbyStartGamePresenter()\\n\",\"diff --git a/README.md b/README.md\\nindex df1e6fe..afa9b44 100644\\n--- a/README.md\\n+++ b/README.md\\n@@ -12,7 +12,7 @@\\n \\n ### Practice Stack\\n \\n-- 三層式架構 (MVC）\\n+- 三層式架構 (MVC）=> clean architecture(CA)\\n - 用 event storming，找出遊戲的功能與流程\\n - 用 example mapping，確定需求的具體內容\\n - Test-Driven Development: ATDD\\n\",\"diff --git a/love_letter/config.py b/love_letter/config.py\\nindex 992481e..0d8342d 100644\\n--- a/love_letter/config.py\\n+++ b/love_letter/config.py\\n@@ -8,3 +8,7 @@\\n DB_NAME = os.environ.get(\\\"DB_NAME\\\", \\\"love_letter\\\")\\n DB_COLLECTION = os.environ.get(\\\"DB_COLLECTION\\\", \\\"love_letter\\\")\\n FRONTEND_HOST = os.environ.get(\\\"FRONTEND_HOST\\\", \\\"http://127.0.0.1\\\")\\n+LOBBY_ISSUER = os.environ.get(\\n+    \\\"LOBBY_ISSUER\\\", \\\"https://dev-1l0ixjw8yohsluoi.us.auth0.com/\\\"\\n+)\\n+LOBBY_AUDIENCE = os.environ.get(\\\"LOBBY_ISSUER\\\", \\\"https://api.gaas.waterballsa.tw\\\")\\n\",\"diff --git a/love_letter/web/app.py b/love_letter/web/app.py\\nindex eba3818..8e0c7b1 100644\\n--- a/love_letter/web/app.py\\n+++ b/love_letter/web/app.py\\n@@ -1,7 +1,7 @@\\n from typing import Union\\n \\n import uvicorn\\n-from fastapi import FastAPI\\n+from fastapi import Depends, FastAPI\\n from fastapi.middleware.cors import CORSMiddleware\\n \\n from love_letter.models import GuessCard, ToSomeoneCard\\n@@ -11,6 +11,7 @@\\n from love_letter.usecase.lobby_start_game import LobbyStartGame\\n from love_letter.usecase.play_card import PlayCard\\n from love_letter.usecase.start_game import StartGame\\n+from love_letter.web.auth import JWTBearer\\n from love_letter.web.dto import GameStatus, LobbyPlayers\\n \\n # isort: off\\n@@ -91,7 +92,7 @@ async def get_status(game_id: str, player_id: str):\\n     return build_player_view(game, player_id)\\n \\n \\n-@app.post(\\\"/games\\\")\\n+@app.post(\\\"/games\\\", dependencies=[Depends(JWTBearer())])\\n def lobby_start_game(players: LobbyPlayers):\\n     presenter = LobbyStartGamePresenter.presenter()\\n     LobbyStartGame().execute(players, presenter)\\n\",\"diff --git a/love_letter/web/auth.py b/love_letter/web/auth.py\\nnew file mode 100644\\nindex 0000000..322eacd\\n--- /dev/null\\n+++ b/love_letter/web/auth.py\\n@@ -0,0 +1,49 @@\\n+import time\\n+\\n+from fastapi import HTTPException\\n+from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer\\n+from jose import jwt\\n+from starlette.requests import Request\\n+\\n+from love_letter import config\\n+\\n+\\n+class JWTBearer(HTTPBearer):\\n+    def __init__(self, auto_error: bool = True):\\n+        super().__init__(auto_error=auto_error)\\n+\\n+    async def __call__(self, request: Request):\\n+        credentials: HTTPAuthorizationCredentials = await super().__call__(request)\\n+        if credentials:\\n+            if not credentials.scheme == \\\"Bearer\\\":\\n+                raise HTTPException(\\n+                    status_code=403, detail=\\\"Invalid authentication scheme.\\\"\\n+                )\\n+            if not self.verify_jwt(credentials.credentials):\\n+                raise HTTPException(\\n+                    status_code=403, detail=\\\"Invalid token or expired token.\\\"\\n+                )\\n+            return credentials.credentials\\n+        else:\\n+            raise HTTPException(status_code=403, detail=\\\"Invalid authorization code.\\\")\\n+\\n+    @staticmethod\\n+    def verify_jwt(token: str) -> bool:\\n+        \\\"\\\"\\\"\\n+        Issuer / Authority / Domain: https://dev-1l0ixjw8yohsluoi.us.auth0.com/\\n+        Audience: https://api.gaas.waterballsa.tw\\n+        :param token:\\n+        :return:\\n+        \\\"\\\"\\\"\\n+        try:\\n+            token = jwt.get_unverified_claims(token)\\n+            print(token)\\n+            if (\\n+                token[\\\"iss\\\"] == config.LOBBY_ISSUER\\n+                and config.LOBBY_AUDIENCE in token[\\\"aud\\\"]\\n+                and token[\\\"exp\\\"] >= time.time()\\n+            ):\\n+                return True\\n+        except Exception as e:\\n+            print(e)\\n+        return False\\n\",\"diff --git a/love_letter/web/app.py b/love_letter/web/app.py\\nindex 8e0c7b1..7281b93 100644\\n--- a/love_letter/web/app.py\\n+++ b/love_letter/web/app.py\\n@@ -46,21 +46,21 @@\\n \\n \\n @app.post(\\\"/games/create/by_player/{player_id}\\\")\\n-async def create_game(player_id: str) -> str:\\n+def create_game(player_id: str) -> str:\\n     presenter = CreateGamePresenter.presenter()\\n     CreateGame().execute(CreateGame.input(player_id), presenter)\\n     return presenter.as_view_model()\\n \\n \\n @app.post(\\\"/games/{game_id}/player/{player_id}/join\\\")\\n-async def join_game(game_id: str, player_id: str) -> bool:\\n+def join_game(game_id: str, player_id: str) -> bool:\\n     presenter = JoinGamePresenter.presenter()\\n     JoinGame().execute(JoinGame.input(game_id, player_id), presenter)\\n     return presenter.as_view_model()\\n \\n \\n @app.post(\\\"/games/{game_id}/start\\\")\\n-async def start_game(game_id: str):\\n+def start_game(game_id: str):\\n     presenter = StartGamePresenter.presenter()\\n     StartGame().execute(StartGame.input(game_id), presenter)\\n     return presenter.as_view_model()\\n@@ -70,7 +70,7 @@ async def start_game(game_id: str):\\n     \\\"/games/{game_id}/player/{player_id}/card/{card_name}/play\\\",\\n     response_model=GameStatus,\\n )\\n-async def play_card(\\n+def play_card(\\n     game_id: str,\\n     player_id: str,\\n     card_name: str,\\n@@ -85,7 +85,7 @@ async def play_card(\\n \\n \\n @app.get(\\\"/games/{game_id}/player/{player_id}/status\\\", response_model=GameStatus)\\n-async def get_status(game_id: str, player_id: str):\\n+def get_status(game_id: str, player_id: str):\\n     presenter = GetStatusPresenter.presenter()\\n     GetStatus().execute(GetStatus.input(game_id, player_id), presenter)\\n     game = presenter.as_view_model()\\n@@ -99,6 +99,11 @@ def lobby_start_game(players: LobbyPlayers):\\n     return presenter.as_view_model()\\n \\n \\n+@app.get(\\\"/heath\\\")\\n+def heath():\\n+    return {\\\"success\\\": True}\\n+\\n+\\n def run():\\n     uvicorn.run(\\\"love_letter.web.app:app\\\", host=\\\"0.0.0.0\\\", port=8080, reload=True)\\n \\n\",\"diff --git a/love_letter/web/auth.py b/love_letter/web/auth.py\\nindex 322eacd..1ad1ac2 100644\\n--- a/love_letter/web/auth.py\\n+++ b/love_letter/web/auth.py\\n@@ -37,7 +37,6 @@ def verify_jwt(token: str) -> bool:\\n         \\\"\\\"\\\"\\n         try:\\n             token = jwt.get_unverified_claims(token)\\n-            print(token)\\n             if (\\n                 token[\\\"iss\\\"] == config.LOBBY_ISSUER\\n                 and config.LOBBY_AUDIENCE in token[\\\"aud\\\"]\\n\",\"diff --git a/love_letter/web/app.py b/love_letter/web/app.py\\nindex 7281b93..b11e5d6 100644\\n--- a/love_letter/web/app.py\\n+++ b/love_letter/web/app.py\\n@@ -46,21 +46,21 @@\\n \\n \\n @app.post(\\\"/games/create/by_player/{player_id}\\\")\\n-def create_game(player_id: str) -> str:\\n+async def create_game(player_id: str) -> str:\\n     presenter = CreateGamePresenter.presenter()\\n     CreateGame().execute(CreateGame.input(player_id), presenter)\\n     return presenter.as_view_model()\\n \\n \\n @app.post(\\\"/games/{game_id}/player/{player_id}/join\\\")\\n-def join_game(game_id: str, player_id: str) -> bool:\\n+async def join_game(game_id: str, player_id: str) -> bool:\\n     presenter = JoinGamePresenter.presenter()\\n     JoinGame().execute(JoinGame.input(game_id, player_id), presenter)\\n     return presenter.as_view_model()\\n \\n \\n @app.post(\\\"/games/{game_id}/start\\\")\\n-def start_game(game_id: str):\\n+async def start_game(game_id: str):\\n     presenter = StartGamePresenter.presenter()\\n     StartGame().execute(StartGame.input(game_id), presenter)\\n     return presenter.as_view_model()\\n@@ -70,7 +70,7 @@ def start_game(game_id: str):\\n     \\\"/games/{game_id}/player/{player_id}/card/{card_name}/play\\\",\\n     response_model=GameStatus,\\n )\\n-def play_card(\\n+async def play_card(\\n     game_id: str,\\n     player_id: str,\\n     card_name: str,\\n@@ -85,7 +85,7 @@ def play_card(\\n \\n \\n @app.get(\\\"/games/{game_id}/player/{player_id}/status\\\", response_model=GameStatus)\\n-def get_status(game_id: str, player_id: str):\\n+async def get_status(game_id: str, player_id: str):\\n     presenter = GetStatusPresenter.presenter()\\n     GetStatus().execute(GetStatus.input(game_id, player_id), presenter)\\n     game = presenter.as_view_model()\\n@@ -93,14 +93,14 @@ def get_status(game_id: str, player_id: str):\\n \\n \\n @app.post(\\\"/games\\\", dependencies=[Depends(JWTBearer())])\\n-def lobby_start_game(players: LobbyPlayers):\\n+async def lobby_start_game(players: LobbyPlayers):\\n     presenter = LobbyStartGamePresenter.presenter()\\n     LobbyStartGame().execute(players, presenter)\\n     return presenter.as_view_model()\\n \\n \\n @app.get(\\\"/heath\\\")\\n-def heath():\\n+async def heath():\\n     return {\\\"success\\\": True}\\n \\n \\n\",\"diff --git a/love_letter/web/auth.py b/love_letter/web/auth.py\\nindex 1ad1ac2..c923acb 100644\\n--- a/love_letter/web/auth.py\\n+++ b/love_letter/web/auth.py\\n@@ -1,8 +1,8 @@\\n-import time\\n+import datetime\\n \\n+import jwt\\n from fastapi import HTTPException\\n from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer\\n-from jose import jwt\\n from starlette.requests import Request\\n \\n from love_letter import config\\n@@ -30,19 +30,36 @@ async def __call__(self, request: Request):\\n     @staticmethod\\n     def verify_jwt(token: str) -> bool:\\n         \\\"\\\"\\\"\\n-        Issuer / Authority / Domain: https://dev-1l0ixjw8yohsluoi.us.auth0.com/\\n-        Audience: https://api.gaas.waterballsa.tw\\n+        Verify jwt token iss and aud are as expected, and not expired\\n         :param token:\\n         :return:\\n         \\\"\\\"\\\"\\n         try:\\n-            token = jwt.get_unverified_claims(token)\\n-            if (\\n-                token[\\\"iss\\\"] == config.LOBBY_ISSUER\\n-                and config.LOBBY_AUDIENCE in token[\\\"aud\\\"]\\n-                and token[\\\"exp\\\"] >= time.time()\\n-            ):\\n-                return True\\n+            jwt.decode(\\n+                token,\\n+                options={\\n+                    \\\"verify_signature\\\": False,\\n+                    \\\"verify_iss\\\": True,\\n+                    \\\"verify_aud\\\": True,\\n+                    \\\"verify_exp\\\": True,\\n+                },\\n+                audience=config.LOBBY_AUDIENCE,\\n+                issuer=config.LOBBY_ISSUER,\\n+            )\\n+            return True\\n         except Exception as e:\\n             print(e)\\n         return False\\n+\\n+    @staticmethod\\n+    def create_jwt():\\n+        now = datetime.datetime.now()\\n+        token = jwt.encode(\\n+            payload={\\n+                \\\"aud\\\": config.LOBBY_AUDIENCE,\\n+                \\\"iss\\\": config.LOBBY_ISSUER,\\n+                \\\"exp\\\": now + datetime.timedelta(hours=1),\\n+            },\\n+            key=\\\"\\\",\\n+        )\\n+        return f\\\"Bearer {token}\\\"\\n\",\"diff --git a/love_letter/config.py b/love_letter/config.py\\nindex 0d8342d..68548ae 100644\\n--- a/love_letter/config.py\\n+++ b/love_letter/config.py\\n@@ -1,14 +1,19 @@\\n import os\\n \\n-REPOSITORY_IMPL = os.environ.get(\\\"repository_impl\\\")\\n-DB_HOST = os.environ.get(\\\"DB_HOST\\\", \\\"127.0.0.1\\\")\\n-DB_PORT = os.environ.get(\\\"DB_PORT\\\", 27017)\\n-DB_USER = os.environ.get(\\\"DB_USER\\\")\\n-DB_PASSWORD = os.environ.get(\\\"DB_PASSWORD\\\")\\n-DB_NAME = os.environ.get(\\\"DB_NAME\\\", \\\"love_letter\\\")\\n-DB_COLLECTION = os.environ.get(\\\"DB_COLLECTION\\\", \\\"love_letter\\\")\\n-FRONTEND_HOST = os.environ.get(\\\"FRONTEND_HOST\\\", \\\"http://127.0.0.1\\\")\\n-LOBBY_ISSUER = os.environ.get(\\n-    \\\"LOBBY_ISSUER\\\", \\\"https://dev-1l0ixjw8yohsluoi.us.auth0.com/\\\"\\n-)\\n-LOBBY_AUDIENCE = os.environ.get(\\\"LOBBY_ISSUER\\\", \\\"https://api.gaas.waterballsa.tw\\\")\\n+\\n+class Configuration:\\n+    REPOSITORY_IMPL = os.environ.get(\\\"repository_impl\\\")\\n+    DB_HOST = os.environ.get(\\\"DB_HOST\\\", \\\"127.0.0.1\\\")\\n+    DB_PORT = os.environ.get(\\\"DB_PORT\\\", 27017)\\n+    DB_USER = os.environ.get(\\\"DB_USER\\\")\\n+    DB_PASSWORD = os.environ.get(\\\"DB_PASSWORD\\\")\\n+    DB_NAME = os.environ.get(\\\"DB_NAME\\\", \\\"love_letter\\\")\\n+    DB_COLLECTION = os.environ.get(\\\"DB_COLLECTION\\\", \\\"love_letter\\\")\\n+    FRONTEND_HOST = os.environ.get(\\\"FRONTEND_HOST\\\", \\\"http://127.0.0.1\\\")\\n+    LOBBY_ISSUER = os.environ.get(\\n+        \\\"LOBBY_ISSUER\\\", \\\"https://dev-1l0ixjw8yohsluoi.us.auth0.com/\\\"\\n+    )\\n+    LOBBY_AUDIENCE = os.environ.get(\\\"LOBBY_ISSUER\\\", \\\"https://api.gaas.waterballsa.tw\\\")\\n+\\n+\\n+config = Configuration()\\n\",\"diff --git a/love_letter/models/__init__.py b/love_letter/models/__init__.py\\nindex 8483e54..9685cd4 100644\\n--- a/love_letter/models/__init__.py\\n+++ b/love_letter/models/__init__.py\\n@@ -333,8 +333,8 @@ class Seen:\\n \\n \\n class Player:\\n-    def __init__(self, name: str, _id: Union[str] = None):\\n-        self.id = _id\\n+    def __init__(self, name: str, user_id: Union[str] = None):\\n+        self.id = user_id\\n         self.name = name\\n         self.cards: List[Card] = []\\n         self.am_i_out: bool = False\\n\",\"diff --git a/love_letter/repository/__init__.py b/love_letter/repository/__init__.py\\nindex e9c7878..55b7d9a 100644\\n--- a/love_letter/repository/__init__.py\\n+++ b/love_letter/repository/__init__.py\\n@@ -9,7 +9,7 @@\\n from pymongo import MongoClient\\n from pymongo.collection import Collection\\n \\n-from love_letter import config\\n+from love_letter.config import config\\n from love_letter.models import Game\\n from love_letter.repository.data import GameData\\n \\n\",\"diff --git a/love_letter/usecase/lobby_start_game.py b/love_letter/usecase/lobby_start_game.py\\nindex 9215913..561cf85 100644\\n--- a/love_letter/usecase/lobby_start_game.py\\n+++ b/love_letter/usecase/lobby_start_game.py\\n@@ -1,4 +1,4 @@\\n-from love_letter.config import FRONTEND_HOST\\n+from love_letter.config import config\\n from love_letter.models import Game, Player\\n from love_letter.models.event import GameEvent\\n from love_letter.usecase.common import Presenter, game_repository\\n@@ -11,4 +11,4 @@ def execute(self, input: \\\"LobbyPlayers\\\", presenter: Presenter):\\n             game.join(Player(player.nickname, player.id))\\n         game.start()\\n         game_repository.save_or_update(game)\\n-        presenter.present([GameEvent(url=f\\\"{FRONTEND_HOST}/games/{game.id}\\\")])\\n+        presenter.present([GameEvent(url=f\\\"{config.FRONTEND_HOST}/games/{game.id}\\\")])\\n\",\"diff --git a/love_letter/web/auth.py b/love_letter/web/auth.py\\nindex c923acb..ba7f5f8 100644\\n--- a/love_letter/web/auth.py\\n+++ b/love_letter/web/auth.py\\n@@ -5,7 +5,7 @@\\n from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer\\n from starlette.requests import Request\\n \\n-from love_letter import config\\n+from love_letter.config import config\\n \\n \\n class JWTBearer(HTTPBearer):\\n\"]", "test_patch": "", "hints_text": ""}
