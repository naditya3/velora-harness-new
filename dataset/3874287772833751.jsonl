{"instance_id": "3874287772833751", "repo": "metomi/fab", "base_commit": "514c30c45a7e8da1bf5994757616ef908a2596f6", "problem_statement": "Implement link transformation:\\n", "FAIL_TO_PASS": ["unit-tests/language/fortran_test.py::TestFortranPreProcessor::test_preprocssor_output"], "PASS_TO_PASS": ["unit-tests/language/fortran_test.py::TestFortranAnalyser::test_analyser_program_units", "unit-tests/reader_test.py::TestTextReaderAdler32::test_all", "unit-tests/language/fortran_test.py::TestFortranAnalyser::test_harvested_data", "unit-tests/reader_test.py::TestFileTextReader::test_constructor", "unit-tests/reader_test.py::TestStringTextReader::test_constructor", "unit-tests/source_tree_test.py::test_extension_visitor", "unit-tests/source_tree_test.py::test_nested_visit", "unit-tests/language/fortran_test.py::TestFortranWorkingSpace::test_add_remove_sequence", "unit-tests/reader_test.py::TestStringTextReader::test_reading", "unit-tests/database_test.py::TestFileInfoDatabase::test_file_info", "unit-tests/language/fortran_test.py::TestFortranAnalyser::test_analyser_scope", "unit-tests/language/fortran_test.py::TestFortranAnalyser::test_naked_use", "unit-tests/source_tree_test.py::test_descent", "unit-tests/reader_test.py::TestFileTextReader::test_reading", "unit-tests/language/fortran_test.py::TestFortranWorkingSpace::test_unit_iterator", "unit-tests/database_test.py::TestSQLiteStateDatabase::test_constructor"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/metomi_fab:514c30c45a7e8da1bf5994757616ef908a2596f6", "patch": "[\"diff --git a/source/fab/language/__init__.py b/source/fab/language/__init__.py\\nindex 0f804f65..7e57be72 100644\\n--- a/source/fab/language/__init__.py\\n+++ b/source/fab/language/__init__.py\\n@@ -36,8 +36,7 @@ def database(self):\\n class Command(ABC):\\n     stdout = False\\n \\n-    def __init__(self, filename: Path, workspace: Path, flags: List[str]):\\n-        self._filename = filename\\n+    def __init__(self, workspace: Path, flags: List[str]):\\n         self._workspace = workspace\\n         self._flags = flags\\n \\n@@ -52,6 +51,12 @@ def output_filename(self) -> Path:\\n         raise NotImplementedError('Abstract methods must be implemented')\\n \\n \\n+class SingleFileCommand(Command):\\n+    def __init__(self, filename: Path, workspace: Path, flags: List[str]):\\n+        super().__init__(workspace, flags)\\n+        self._filename = filename\\n+\\n+\\n class CommandTask(Task):\\n     def __init__(self, command: Command):\\n         self._command = command\\n@@ -62,3 +67,26 @@ def run(self) -> List[Path]:\\n             with open(self._command.output_filename, 'wb') as out_file:\\n                 out_file.write(process.stdout)\\n         return [self._command.output_filename, ]\\n+\\n+\\n+class Linker(Command):\\n+    def __init__(self,\\n+                 workspace: Path,\\n+                 flags: List[str],\\n+                 output_filename: Path):\\n+        super().__init__(workspace, flags)\\n+        self._output_filename = output_filename\\n+        self._filenames: List[Path] = []\\n+\\n+    def add_object(self, object_filename: Path):\\n+        self._filenames.append(object_filename)\\n+\\n+    @property\\n+    def as_list(self) -> List[str]:\\n+        base_command = ['ld', '-o', str(self.output_filename)]\\n+        objects = [str(filename) for filename in self._filenames]\\n+        return base_command + self._flags + objects\\n+\\n+    @property\\n+    def output_filename(self) -> Path:\\n+        return self._output_filename\\n\",\"diff --git a/source/fab/language/fortran.py b/source/fab/language/fortran.py\\nindex bfc70716..681a45c3 100644\\n--- a/source/fab/language/fortran.py\\n+++ b/source/fab/language/fortran.py\\n@@ -23,7 +23,7 @@\\n                           StateDatabase,\\n                           SqliteStateDatabase,\\n                           WorkingStateException)\\n-from fab.language import Analyser, TaskException, Command\\n+from fab.language import Analyser, TaskException, SingleFileCommand\\n from fab.reader import TextReader, TextReaderDecorator\\n \\n \\n@@ -397,7 +397,7 @@ def run(self) -> List[Path]:\\n         return []\\n \\n \\n-class FortranPreProcessor(Command):\\n+class FortranPreProcessor(SingleFileCommand):\\n \\n     @property\\n     def as_list(self) -> List[str]:\\n\",\"diff --git a/source/fab/source_tree.py b/source/fab/source_tree.py\\nindex d14434d7..483afeae 100644\\n--- a/source/fab/source_tree.py\\n+++ b/source/fab/source_tree.py\\n@@ -11,7 +11,12 @@\\n from typing import Mapping, List, Union, Type\\n \\n from fab.database import FileInfoDatabase, SqliteStateDatabase\\n-from fab.language import Task, Analyser, CommandTask, Command\\n+from fab.language import \\\\\\n+    Task, \\\\\\n+    Analyser, \\\\\\n+    CommandTask, \\\\\\n+    Command, \\\\\\n+    SingleFileCommand\\n from fab.reader import TextReader, FileTextReader, TextReaderAdler32\\n \\n \\n@@ -40,7 +45,7 @@ def visit(self, candidate: Path) -> List[Path]:\\n \\n             if issubclass(task_class, Analyser):\\n                 task: Task = task_class(hasher, self._state)\\n-            elif issubclass(task_class, Command):\\n+            elif issubclass(task_class, SingleFileCommand):\\n                 flags = self._command_flags_map.get(task_class, [])\\n                 task = CommandTask(\\n                     task_class(Path(hasher.filename), self._workspace, flags))\\n\",\"diff --git a/source/fab/language/fortran.py b/source/fab/language/fortran.py\\nindex 681a45c3..f3c72df5 100644\\n--- a/source/fab/language/fortran.py\\n+++ b/source/fab/language/fortran.py\\n@@ -408,3 +408,22 @@ def as_list(self) -> List[str]:\\n     @property\\n     def output_filename(self) -> Path:\\n         return self._workspace / self._filename.with_suffix('.f90').name\\n+\\n+\\n+class FortranCompiler(SingleFileCommand):\\n+\\n+    @property\\n+    def as_list(self) -> List[str]:\\n+        base_command = ['gfortran',\\n+                        '-c',\\n+                        '-J' + str(self._workspace),\\n+                        ]\\n+        file_args = [str(self._filename),\\n+                     '-o',\\n+                     str(self.output_filename),\\n+                     ]\\n+        return base_command + self._flags + file_args\\n+\\n+    @property\\n+    def output_filename(self) -> Path:\\n+        return self._workspace / self._filename.with_suffix('.o').name\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex 2373ac55..a414d09a 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -8,11 +8,17 @@\\n from typing import Dict, List, Type, Union\\n \\n from fab.database import SqliteStateDatabase\\n-from fab.language import Task, Command\\n+from fab.language import \\\\\\n+    Task, \\\\\\n+    Command, \\\\\\n+    CommandTask, \\\\\\n+    SingleFileCommand, \\\\\\n+    Linker\\n from fab.language.fortran import \\\\\\n     FortranAnalyser, \\\\\\n     FortranWorkingState, \\\\\\n-    FortranPreProcessor\\n+    FortranPreProcessor, \\\\\\n+    FortranCompiler\\n from fab.source_tree import TreeDescent, ExtensionVisitor, FileInfoDatabase\\n \\n \\n@@ -21,6 +27,9 @@ class Fab(object):\\n         '.f90': FortranAnalyser,\\n         '.F90': FortranPreProcessor,\\n     }\\n+    _compiler_map: Dict[str, Type[SingleFileCommand]] = {\\n+        '.f90': FortranCompiler,\\n+    }\\n \\n     def __init__(self, workspace: Path, fpp_flags: str):\\n         self._state = SqliteStateDatabase(workspace)\\n@@ -58,6 +67,60 @@ def run(self, source: Path):\\n                 print('    found in: ' + str(filename))\\n                 print('    depends on: ' + str(fortran_db.depends_on(unit)))\\n \\n+        # TODO: get name of top level unit here from the command line\\n+        unit_to_process = [\\\"some_program\\\"]\\n+\\n+        # Initialise linker\\n+        # TODO: again, the linker needs flags passing, and\\n+        #       an executable name\\n+        executable = Path(self._workspace / \\\"fab_exec.exe\\\")\\n+        link_command = Linker(self._workspace, [], executable)\\n+\\n+        processed_units = []\\n+\\n+        while unit_to_process:\\n+            # Pop pending items from start of the list\\n+            unit = unit_to_process.pop(0)\\n+            dependencies = fortran_db.depends_on(unit)\\n+\\n+            # First prune any dependencies that have already\\n+            # been compiled\\n+            for dependee in list(dependencies):\\n+                if dependee in processed_units:\\n+                    dependencies.remove(dependee)\\n+\\n+            # Add unhandled dependencies to end of list\\n+            if dependencies:\\n+                for dependee in dependencies:\\n+                    if dependee not in unit_to_process:\\n+                        unit_to_process.append(dependee)\\n+                # Re-add this unit after them for reconsideration\\n+                # note that we *do not* do this in the else branch\\n+                unit_to_process.append(unit)\\n+            else:\\n+                filenames = fortran_db.filenames_from_program_unit(unit)\\n+                # TODO: should this be done by the database?\\n+                #       preprocessing should ensure no duplicate units\\n+                if len(filenames) == 1:\\n+                    filename = filenames[0]\\n+                else:\\n+                    raise ValueError(\\\"Duplicate program unit found\\\")\\n+\\n+                compiler_class = self._compiler_map[filename.suffix]\\n+                # TODO: Like the preprocessor need to pass any flags\\n+                #       through to this point eventually\\n+                compiler = CommandTask(\\n+                    compiler_class(filename, self._workspace, []))\\n+                # Add the object files to the linker\\n+                link_command.add_object(compiler.run()[0])\\n+                # And indicate that this unit has been processed\\n+                processed_units.append(unit)\\n+\\n+        # Hopefully by this point the list is exhausted and\\n+        # everything has been compiled, and the linker is primed\\n+        linker = CommandTask(link_command)\\n+        linker.run()\\n+\\n \\n class Dump(object):\\n     def __init__(self, workspace: Path):\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex a414d09a..ea8386d3 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -12,7 +12,6 @@\\n     Task, \\\\\\n     Command, \\\\\\n     CommandTask, \\\\\\n-    SingleFileCommand, \\\\\\n     Linker\\n from fab.language.fortran import \\\\\\n     FortranAnalyser, \\\\\\n@@ -27,7 +26,7 @@ class Fab(object):\\n         '.f90': FortranAnalyser,\\n         '.F90': FortranPreProcessor,\\n     }\\n-    _compiler_map: Dict[str, Type[SingleFileCommand]] = {\\n+    _compiler_map: Dict[str, Type[Command]] = {\\n         '.f90': FortranCompiler,\\n     }\\n \\n@@ -42,6 +41,10 @@ def __init__(self, workspace: Path, fpp_flags: str):\\n             )\\n \\n     def run(self, source: Path):\\n+\\n+        # TODO: This is where the threads first separate\\n+        #       master thread stays to manage queue workers.\\n+        #       One thread performs descent below.\\n         visitor = ExtensionVisitor(self._extension_map,\\n                                    self._command_flags_map,\\n                                    self._state,\\n@@ -81,44 +84,68 @@ def run(self, source: Path):\\n         while unit_to_process:\\n             # Pop pending items from start of the list\\n             unit = unit_to_process.pop(0)\\n+            if unit in processed_units:\\n+                continue\\n+\\n             dependencies = fortran_db.depends_on(unit)\\n+            unit_to_process.extend(dependencies)\\n \\n-            # First prune any dependencies that have already\\n-            # been compiled\\n-            for dependee in list(dependencies):\\n-                if dependee in processed_units:\\n-                    dependencies.remove(dependee)\\n-\\n-            # Add unhandled dependencies to end of list\\n-            if dependencies:\\n-                for dependee in dependencies:\\n-                    if dependee not in unit_to_process:\\n-                        unit_to_process.append(dependee)\\n-                # Re-add this unit after them for reconsideration\\n-                # note that we *do not* do this in the else branch\\n-                unit_to_process.append(unit)\\n+            filenames = fortran_db.filenames_from_program_unit(unit)\\n+            # TODO: should this be done by the database?\\n+            #       preprocessing should ensure no duplicate units\\n+            if len(filenames) == 1:\\n+                filename = filenames[0]\\n             else:\\n-                filenames = fortran_db.filenames_from_program_unit(unit)\\n-                # TODO: should this be done by the database?\\n-                #       preprocessing should ensure no duplicate units\\n-                if len(filenames) == 1:\\n-                    filename = filenames[0]\\n-                else:\\n-                    raise ValueError(\\\"Duplicate program unit found\\\")\\n-\\n-                compiler_class = self._compiler_map[filename.suffix]\\n-                # TODO: Like the preprocessor need to pass any flags\\n-                #       through to this point eventually\\n+                raise ValueError(\\\"Duplicate program unit found\\\")\\n+\\n+            # Construct names of any expected module files to\\n+            # pass to the compiler constructor\\n+            mod_files = [Path(self._workspace /\\n+                              dependee).with_suffix('.mod')\\n+                         for dependee in dependencies]\\n+\\n+            compiler_class = self._compiler_map[filename.suffix]\\n+            # TODO: Like the preprocessor need to pass any flags\\n+            #       through to this point eventually\\n+            if issubclass(compiler_class, FortranCompiler):\\n                 compiler = CommandTask(\\n-                    compiler_class(filename, self._workspace, []))\\n-                # Add the object files to the linker\\n-                link_command.add_object(compiler.run()[0])\\n-                # And indicate that this unit has been processed\\n+                    compiler_class(\\n+                        filename,\\n+                        self._workspace,\\n+                        [],\\n+                        mod_files))\\n+            else:\\n+                message = 'Unhandled class \\\"{cls}\\\" in compiler map.'\\n+                raise TypeError(\\n+                    message.format(cls=compiler_class))\\n+\\n+            # TODO: At this point we would add this to the queue\\n+            #       rather than running it here.  Noting that\\n+            #       the queue worked can extract the prerequisites\\n+            #       from the Task object.  For now we are going\\n+            #       to have to fake that logic here:\\n+            if all([prereq.exists for prereq in compiler.prerequisites]):\\n+                compiler.run()\\n+                # Indicate that this unit has been processed, so we\\n+                # don't do it again if we encounter it a second time\\n                 processed_units.append(unit)\\n+                # Add the object files to the linker\\n+                # TODO: For right now products is a list, though the\\n+                #       compiler only ever produces a single entry;\\n+                #       maybe add_object should accept Union[Path, List[Path]]?\\n+                link_command.add_object(compiler.products[0])\\n+            else:\\n+                # Re-add this to the set of units to process\\n+                # (at the end, so that it is reconsidered after\\n+                # other tasks have resolved)\\n+                unit_to_process.append(unit)\\n \\n         # Hopefully by this point the list is exhausted and\\n         # everything has been compiled, and the linker is primed\\n         linker = CommandTask(link_command)\\n+        # TODO: Like the others, this would go on the queue\\n+        #       now that it has knowledge of all its prerequisite\\n+        #       object files\\n         linker.run()\\n \\n \\n\",\"diff --git a/source/fab/language/__init__.py b/source/fab/language/__init__.py\\nindex 7e57be72..a93c638a 100644\\n--- a/source/fab/language/__init__.py\\n+++ b/source/fab/language/__init__.py\\n@@ -19,7 +19,17 @@ class TaskException(Exception):\\n \\n class Task(ABC):\\n     @abstractmethod\\n-    def run(self) -> List[Path]:\\n+    def run(self):\\n+        raise NotImplementedError('Abstract methods must be implemented')\\n+\\n+    @property\\n+    @abstractmethod\\n+    def prerequisites(self) -> List[Path]:\\n+        raise NotImplementedError('Abstract methods must be implemented')\\n+\\n+    @property\\n+    @abstractmethod\\n+    def products(self) -> List[Path]:\\n         raise NotImplementedError('Abstract methods must be implemented')\\n \\n \\n@@ -32,6 +42,14 @@ def __init__(self, reader: TextReader, database: SqliteStateDatabase):\\n     def database(self):\\n         return self._database\\n \\n+    @property\\n+    def prerequisites(self) -> List[Path]:\\n+        return [Path(self._reader.filename)]\\n+\\n+    @property\\n+    def products(self) -> List[Path]:\\n+        return []\\n+\\n \\n class Command(ABC):\\n     stdout = False\\n@@ -47,7 +65,12 @@ def as_list(self) -> List[str]:\\n \\n     @property\\n     @abstractmethod\\n-    def output_filename(self) -> Path:\\n+    def output(self) -> List[Path]:\\n+        raise NotImplementedError('Abstract methods must be implemented')\\n+\\n+    @property\\n+    @abstractmethod\\n+    def input(self) -> List[Path]:\\n         raise NotImplementedError('Abstract methods must be implemented')\\n \\n \\n@@ -56,17 +79,28 @@ def __init__(self, filename: Path, workspace: Path, flags: List[str]):\\n         super().__init__(workspace, flags)\\n         self._filename = filename\\n \\n+    @property\\n+    def input(self) -> List[Path]:\\n+        return [self._filename]\\n+\\n \\n class CommandTask(Task):\\n     def __init__(self, command: Command):\\n         self._command = command\\n \\n-    def run(self) -> List[Path]:\\n+    def run(self):\\n         process = subprocess.run(self._command.as_list, check=True)\\n         if self._command.stdout:\\n             with open(self._command.output_filename, 'wb') as out_file:\\n                 out_file.write(process.stdout)\\n-        return [self._command.output_filename, ]\\n+\\n+    @property\\n+    def prerequisites(self) -> List[Path]:\\n+        return self._command.input\\n+\\n+    @property\\n+    def products(self) -> List[Path]:\\n+        return self._command.output\\n \\n \\n class Linker(Command):\\n@@ -83,10 +117,14 @@ def add_object(self, object_filename: Path):\\n \\n     @property\\n     def as_list(self) -> List[str]:\\n-        base_command = ['ld', '-o', str(self.output_filename)]\\n+        base_command = ['ld', '-o', str(self._output_filename)]\\n         objects = [str(filename) for filename in self._filenames]\\n         return base_command + self._flags + objects\\n \\n     @property\\n-    def output_filename(self) -> Path:\\n-        return self._output_filename\\n+    def output(self) -> List[Path]:\\n+        return [self._output_filename]\\n+\\n+    @property\\n+    def input(self) -> List[Path]:\\n+        return self._filenames\\n\",\"diff --git a/source/fab/language/fortran.py b/source/fab/language/fortran.py\\nindex f3c72df5..0cf5af4f 100644\\n--- a/source/fab/language/fortran.py\\n+++ b/source/fab/language/fortran.py\\n@@ -23,7 +23,11 @@\\n                           StateDatabase,\\n                           SqliteStateDatabase,\\n                           WorkingStateException)\\n-from fab.language import Analyser, TaskException, SingleFileCommand\\n+from fab.language import \\\\\\n+    Analyser, \\\\\\n+    TaskException, \\\\\\n+    Command, \\\\\\n+    SingleFileCommand\\n from fab.reader import TextReader, TextReaderDecorator\\n \\n \\n@@ -292,7 +296,7 @@ def __init__(self, reader: TextReader, database: SqliteStateDatabase):\\n     _end_block_pattern: Pattern = re.compile(_end_block_re, re.IGNORECASE)\\n     _use_pattern: Pattern = re.compile(_use_statement_re, re.IGNORECASE)\\n \\n-    def run(self) -> List[Path]:\\n+    def run(self):\\n         logger = logging.getLogger(__name__)\\n \\n         self._state.remove_fortran_file(self._reader.filename)\\n@@ -394,7 +398,6 @@ def run(self) -> List[Path]:\\n                                       'found': end_name}\\n                         raise TaskException(\\n                             end_message.format(**end_values))\\n-        return []\\n \\n \\n class FortranPreProcessor(SingleFileCommand):\\n@@ -402,15 +405,25 @@ class FortranPreProcessor(SingleFileCommand):\\n     @property\\n     def as_list(self) -> List[str]:\\n         base_command = ['cpp', '-traditional-cpp', '-P']\\n-        file_args = [str(self._filename), str(self.output_filename)]\\n+        file_args = [str(self._filename), str(self.output[0])]\\n         return base_command + self._flags + file_args\\n \\n     @property\\n-    def output_filename(self) -> Path:\\n-        return self._workspace / self._filename.with_suffix('.f90').name\\n+    def output(self) -> List[Path]:\\n+        return [self._workspace /\\n+                self._filename.with_suffix('.f90').name]\\n \\n \\n-class FortranCompiler(SingleFileCommand):\\n+class FortranCompiler(Command):\\n+\\n+    def __init__(self,\\n+                 filename: Path,\\n+                 workspace: Path,\\n+                 flags: List[str],\\n+                 prerequisites: List[Path]):\\n+        super().__init__(workspace, flags)\\n+        self._filename = filename\\n+        self._prerequisites = prerequisites\\n \\n     @property\\n     def as_list(self) -> List[str]:\\n@@ -420,10 +433,12 @@ def as_list(self) -> List[str]:\\n                         ]\\n         file_args = [str(self._filename),\\n                      '-o',\\n-                     str(self.output_filename),\\n+                     str(self.output[0]),\\n                      ]\\n         return base_command + self._flags + file_args\\n \\n     @property\\n-    def output_filename(self) -> Path:\\n-        return self._workspace / self._filename.with_suffix('.o').name\\n+    def output(self) -> List[Path]:\\n+        object_file = (\\n+            self._workspace / self._filename.with_suffix('.o').name)\\n+        return self._prerequisites + [object_file]\\n\",\"diff --git a/source/fab/source_tree.py b/source/fab/source_tree.py\\nindex 483afeae..4b81aae4 100644\\n--- a/source/fab/source_tree.py\\n+++ b/source/fab/source_tree.py\\n@@ -53,8 +53,15 @@ def visit(self, candidate: Path) -> List[Path]:\\n                 message = 'Unhandled class \\\"{cls}\\\" in extension map.'\\n                 raise TypeError(\\n                     message.format(cls=task_class))\\n-            # TODO: Eventually add to the queue here rather than running\\n-            new_candidates = task.run()\\n+            # TODO: This is where we start calling \\\"add_to_queue\\\"\\n+            #       rather then running the task right here.\\n+            #       Noting that it can at this point access\\n+            #       task.prerequisites to find out what files\\n+            #       (if any) the task depends on\\n+            task.run()\\n+            new_candidates.extend(task.products)\\n+            # TODO: The hasher part here likely needs to be\\n+            #       moved once the task is run by the queue\\n             for _ in hasher.line_by_line():\\n                 pass  # Make sure we've read the whole file.\\n             file_info = FileInfoDatabase(self._state)\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex ea8386d3..eb88d625 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -11,13 +11,13 @@\\n from fab.language import \\\\\\n     Task, \\\\\\n     Command, \\\\\\n-    CommandTask, \\\\\\n-    Linker\\n+    CommandTask\\n from fab.language.fortran import \\\\\\n     FortranAnalyser, \\\\\\n     FortranWorkingState, \\\\\\n     FortranPreProcessor, \\\\\\n-    FortranCompiler\\n+    FortranCompiler, \\\\\\n+    FortranLinker\\n from fab.source_tree import TreeDescent, ExtensionVisitor, FileInfoDatabase\\n \\n \\n@@ -77,7 +77,7 @@ def run(self, source: Path):\\n         # TODO: again, the linker needs flags passing, and\\n         #       an executable name\\n         executable = Path(self._workspace / \\\"fab_exec.exe\\\")\\n-        link_command = Linker(self._workspace, [], executable)\\n+        link_command = FortranLinker(self._workspace, [], executable)\\n \\n         processed_units = []\\n \\n@@ -124,7 +124,7 @@ def run(self, source: Path):\\n             #       the queue worked can extract the prerequisites\\n             #       from the Task object.  For now we are going\\n             #       to have to fake that logic here:\\n-            if all([prereq.exists for prereq in compiler.prerequisites]):\\n+            if all([prereq.exists() for prereq in compiler.prerequisites]):\\n                 compiler.run()\\n                 # Indicate that this unit has been processed, so we\\n                 # don't do it again if we encounter it a second time\\n\",\"diff --git a/source/fab/language/__init__.py b/source/fab/language/__init__.py\\nindex a93c638a..fffd9f62 100644\\n--- a/source/fab/language/__init__.py\\n+++ b/source/fab/language/__init__.py\\n@@ -101,30 +101,3 @@ def prerequisites(self) -> List[Path]:\\n     @property\\n     def products(self) -> List[Path]:\\n         return self._command.output\\n-\\n-\\n-class Linker(Command):\\n-    def __init__(self,\\n-                 workspace: Path,\\n-                 flags: List[str],\\n-                 output_filename: Path):\\n-        super().__init__(workspace, flags)\\n-        self._output_filename = output_filename\\n-        self._filenames: List[Path] = []\\n-\\n-    def add_object(self, object_filename: Path):\\n-        self._filenames.append(object_filename)\\n-\\n-    @property\\n-    def as_list(self) -> List[str]:\\n-        base_command = ['ld', '-o', str(self._output_filename)]\\n-        objects = [str(filename) for filename in self._filenames]\\n-        return base_command + self._flags + objects\\n-\\n-    @property\\n-    def output(self) -> List[Path]:\\n-        return [self._output_filename]\\n-\\n-    @property\\n-    def input(self) -> List[Path]:\\n-        return self._filenames\\n\",\"diff --git a/source/fab/language/fortran.py b/source/fab/language/fortran.py\\nindex 0cf5af4f..6037576c 100644\\n--- a/source/fab/language/fortran.py\\n+++ b/source/fab/language/fortran.py\\n@@ -437,8 +437,39 @@ def as_list(self) -> List[str]:\\n                      ]\\n         return base_command + self._flags + file_args\\n \\n+    @property\\n+    def input(self) -> List[Path]:\\n+        return self._prerequisites + [self._filename]\\n+\\n     @property\\n     def output(self) -> List[Path]:\\n         object_file = (\\n             self._workspace / self._filename.with_suffix('.o').name)\\n-        return self._prerequisites + [object_file]\\n+        return [object_file]\\n+\\n+\\n+class FortranLinker(Command):\\n+    def __init__(self,\\n+                 workspace: Path,\\n+                 flags: List[str],\\n+                 output_filename: Path):\\n+        super().__init__(workspace, flags)\\n+        self._output_filename = output_filename\\n+        self._filenames: List[Path] = []\\n+\\n+    def add_object(self, object_filename: Path):\\n+        self._filenames.append(object_filename)\\n+\\n+    @property\\n+    def as_list(self) -> List[str]:\\n+        base_command = ['gfortran', '-o', str(self._output_filename)]\\n+        objects = [str(filename) for filename in self._filenames]\\n+        return base_command + self._flags + objects\\n+\\n+    @property\\n+    def output(self) -> List[Path]:\\n+        return [self._output_filename]\\n+\\n+    @property\\n+    def input(self) -> List[Path]:\\n+        return self._filenames\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex eb88d625..0e6076d2 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -30,9 +30,10 @@ class Fab(object):\\n         '.f90': FortranCompiler,\\n     }\\n \\n-    def __init__(self, workspace: Path, fpp_flags: str):\\n+    def __init__(self, workspace: Path, target: str, fpp_flags: str):\\n         self._state = SqliteStateDatabase(workspace)\\n         self._workspace = workspace\\n+        self._target = target\\n \\n         self._command_flags_map: Dict[Type[Command], List[str]] = {}\\n         if fpp_flags != '':\\n@@ -70,13 +71,13 @@ def run(self, source: Path):\\n                 print('    found in: ' + str(filename))\\n                 print('    depends on: ' + str(fortran_db.depends_on(unit)))\\n \\n-        # TODO: get name of top level unit here from the command line\\n-        unit_to_process = [\\\"some_program\\\"]\\n+        # Start with the top level program unit\\n+        unit_to_process = [self._target]\\n \\n         # Initialise linker\\n         # TODO: again, the linker needs flags passing, and\\n         #       an executable name\\n-        executable = Path(self._workspace / \\\"fab_exec.exe\\\")\\n+        executable = Path(self._workspace / self._target).with_suffix(\\\".exe\\\")\\n         link_command = FortranLinker(self._workspace, [], executable)\\n \\n         processed_units = []\\n\",\"diff --git a/source/fab/entry.py b/source/fab/entry.py\\nindex cf303a90..81693032 100644\\n--- a/source/fab/entry.py\\n+++ b/source/fab/entry.py\\n@@ -34,6 +34,8 @@ def fab_cli() -> argparse.Namespace:\\n     #       our configuration system\\n     parser.add_argument('--fpp-flags', action='store', type=str, default='',\\n                         help='Provide flags for Fortran PreProcessor ')\\n+    parser.add_argument('target', action='store', type=str,\\n+                        help='The top level unit name to compile')\\n     parser.add_argument('source', type=Path,\\n                         help='The path of the source tree to build')\\n     return parser.parse_args()\\n@@ -57,6 +59,7 @@ def fab_entry() -> None:\\n         arguments.workspace = arguments.source / 'working'\\n \\n     application = fab.application.Fab(arguments.workspace,\\n+                                      arguments.target,\\n                                       arguments.fpp_flags)\\n     application.run(arguments.source)\\n \\n\",\"diff --git a/source/fab/__main__.py b/source/fab/__main__.py\\ndeleted file mode 100644\\nindex baae58a7..00000000\\n--- a/source/fab/__main__.py\\n+++ /dev/null\\n@@ -1,65 +0,0 @@\\n-##############################################################################\\n-# (c) Crown copyright Met Office. All rights reserved.\\n-# For further details please refer to the file COPYRIGHT\\n-# which you should have received as part of this distribution\\n-##############################################################################\\n-'''\\n-Command-line interface to Fab build tool.\\n-'''\\n-import argparse\\n-import logging\\n-from pathlib import Path\\n-import sys\\n-\\n-import fab.application\\n-\\n-\\n-def parse_cli() -> argparse.Namespace:\\n-    '''\\n-    Parse the command line for arguments.\\n-    '''\\n-    description = 'Flexible build system for scientific software.'\\n-    parser = argparse.ArgumentParser(add_help=False,\\n-                                     description=description)\\n-    parser.add_argument('-h', '-help', '--help', action='help',\\n-                        help='Print this help and exit')\\n-    parser.add_argument('-V', '--version', action='version',\\n-                        version=fab.__version__,\\n-                        help='Print version identifier and exit')\\n-    parser.add_argument('-v', '--verbose', action='store_true',\\n-                        help='Produce a running commentary on progress')\\n-    parser.add_argument('-w', '--workspace', metavar='FILENAME', type=Path,\\n-                        help='Directory for working files')\\n-    # TODO: Details like these flags will eventually come from\\n-    #       our configuration system\\n-    parser.add_argument('--fpp-flags', action='store', type=str, default='',\\n-                        help='Provide flags for Fortran PreProcessor ')\\n-    parser.add_argument('source', type=Path,\\n-                        help='The path of the source tree to build')\\n-    return parser.parse_args()\\n-\\n-\\n-def main() -> None:\\n-    '''\\n-    Entry point for command-line tool.\\n-    '''\\n-    logger = logging.getLogger('fab')\\n-    logger.addHandler(logging.StreamHandler(sys.stdout))\\n-\\n-    arguments = parse_cli()\\n-\\n-    if arguments.verbose:\\n-        logger.setLevel(logging.INFO)\\n-    else:\\n-        logger.setLevel(logging.WARNING)\\n-\\n-    if not arguments.workspace:\\n-        arguments.workspace = arguments.source / 'working'\\n-\\n-    application = fab.application.Fab(arguments.workspace,\\n-                                      arguments.fpp_flags)\\n-    application.run(arguments.source)\\n-\\n-\\n-if __name__ == '__main__':\\n-    main()\\n\",\"diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\\nindex 1c3f26cd..45f3cade 100644\\n--- a/.github/workflows/build.yml\\n+++ b/.github/workflows/build.yml\\n@@ -19,6 +19,7 @@ jobs:\\n         python-version: ${{ matrix.python-version }}\\n     - name: Install dependencies\\n       run: |\\n+        sudo apt-get -y install build-essential\\n         python -m pip install --upgrade pip\\n         pip install -e .\\n     - name: Type check with mypy\\n\",\"diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\\nindex 45f3cade..8adac84b 100644\\n--- a/.github/workflows/build.yml\\n+++ b/.github/workflows/build.yml\\n@@ -19,7 +19,7 @@ jobs:\\n         python-version: ${{ matrix.python-version }}\\n     - name: Install dependencies\\n       run: |\\n-        sudo apt-get -y install build-essential\\n+        sudo apt-get -y install gcc\\n         python -m pip install --upgrade pip\\n         pip install -e .\\n     - name: Type check with mypy\\n\",\"diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\\nindex 8adac84b..1c3f26cd 100644\\n--- a/.github/workflows/build.yml\\n+++ b/.github/workflows/build.yml\\n@@ -19,7 +19,6 @@ jobs:\\n         python-version: ${{ matrix.python-version }}\\n     - name: Install dependencies\\n       run: |\\n-        sudo apt-get -y install gcc\\n         python -m pip install --upgrade pip\\n         pip install -e .\\n     - name: Type check with mypy\\n\",\"diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\\nindex 1c3f26cd..0d52cf26 100644\\n--- a/.github/workflows/build.yml\\n+++ b/.github/workflows/build.yml\\n@@ -17,6 +17,9 @@ jobs:\\n       uses: actions/setup-python@v1\\n       with:\\n         python-version: ${{ matrix.python-version }}\\n+    - name: Setup Compiler\\n+      run: |\\n+        sudo apt-get -y install gfortran\\n     - name: Install dependencies\\n       run: |\\n         python -m pip install --upgrade pip\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex 0e6076d2..da41971c 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -30,16 +30,32 @@ class Fab(object):\\n         '.f90': FortranCompiler,\\n     }\\n \\n-    def __init__(self, workspace: Path, target: str, fpp_flags: str):\\n+    def __init__(self,\\n+                 workspace: Path,\\n+                 target: str,\\n+                 exec_name: str,\\n+                 fpp_flags: str,\\n+                 fc_flags: str,\\n+                 ld_flags: str):\\n+\\n         self._state = SqliteStateDatabase(workspace)\\n         self._workspace = workspace\\n         self._target = target\\n+        self._exec_name = exec_name\\n \\n         self._command_flags_map: Dict[Type[Command], List[str]] = {}\\n         if fpp_flags != '':\\n             self._command_flags_map[FortranPreProcessor] = (\\n                 fpp_flags.split()\\n             )\\n+        if fc_flags != '':\\n+            self._command_flags_map[FortranCompiler] = (\\n+                fc_flags.split()\\n+            )\\n+        if ld_flags != '':\\n+            self._command_flags_map[FortranLinker] = (\\n+                ld_flags.split()\\n+            )\\n \\n     def run(self, source: Path):\\n \\n@@ -75,10 +91,14 @@ def run(self, source: Path):\\n         unit_to_process = [self._target]\\n \\n         # Initialise linker\\n-        # TODO: again, the linker needs flags passing, and\\n-        #       an executable name\\n-        executable = Path(self._workspace / self._target).with_suffix(\\\".exe\\\")\\n-        link_command = FortranLinker(self._workspace, [], executable)\\n+        if self._exec_name != \\\"\\\":\\n+            executable = Path(self._workspace) / self._exec_name\\n+        else:\\n+            executable = \\\\\\n+                Path(self._workspace / self._target).with_suffix(\\\".exe\\\")\\n+\\n+        flags = self._command_flags_map.get(FortranLinker, [])\\n+        link_command = FortranLinker(self._workspace, flags, executable)\\n \\n         processed_units = []\\n \\n@@ -106,14 +126,14 @@ def run(self, source: Path):\\n                          for dependee in dependencies]\\n \\n             compiler_class = self._compiler_map[filename.suffix]\\n-            # TODO: Like the preprocessor need to pass any flags\\n-            #       through to this point eventually\\n+\\n             if issubclass(compiler_class, FortranCompiler):\\n+                flags = self._command_flags_map.get(compiler_class, [])\\n                 compiler = CommandTask(\\n                     compiler_class(\\n                         filename,\\n                         self._workspace,\\n-                        [],\\n+                        flags,\\n                         mod_files))\\n             else:\\n                 message = 'Unhandled class \\\"{cls}\\\" in compiler map.'\\n\",\"diff --git a/source/fab/entry.py b/source/fab/entry.py\\nindex 81693032..3554d7d3 100644\\n--- a/source/fab/entry.py\\n+++ b/source/fab/entry.py\\n@@ -30,10 +30,20 @@ def fab_cli() -> argparse.Namespace:\\n                         help='Produce a running commentary on progress')\\n     parser.add_argument('-w', '--workspace', metavar='FILENAME', type=Path,\\n                         help='Directory for working files.')\\n-    # TODO: Details like these flags will eventually come from\\n-    #       our configuration system\\n+    # TODO: Flags will eventually come from configuration\\n     parser.add_argument('--fpp-flags', action='store', type=str, default='',\\n                         help='Provide flags for Fortran PreProcessor ')\\n+    # TODO: Flags will eventually come from configuration\\n+    parser.add_argument('--fc-flags', action='store', type=str, default='',\\n+                        help='Provide flags for Fortran Compiler')\\n+    # TODO: Flags will eventually come from configuration\\n+    parser.add_argument('--ld-flags', action='store', type=str, default='',\\n+                        help='Provide flags for Fortran Linker')\\n+    # TODO: Name for executable will eventually come from configuration\\n+    parser.add_argument('--exec-name', action='store', type=str, default='',\\n+                        help='Name of executable (default is the name of '\\n+                        'the program with extentsion \\\".exe\\\")')\\n+    # TODO: Target/s will eventually come from configuration\\n     parser.add_argument('target', action='store', type=str,\\n                         help='The top level unit name to compile')\\n     parser.add_argument('source', type=Path,\\n@@ -60,7 +70,10 @@ def fab_entry() -> None:\\n \\n     application = fab.application.Fab(arguments.workspace,\\n                                       arguments.target,\\n-                                      arguments.fpp_flags)\\n+                                      arguments.exec_name,\\n+                                      arguments.fpp_flags,\\n+                                      arguments.fc_flags,\\n+                                      arguments.ld_flags)\\n     application.run(arguments.source)\\n \\n \\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex da41971c..38fb9d87 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -112,8 +112,9 @@ def run(self, source: Path):\\n             unit_to_process.extend(dependencies)\\n \\n             filenames = fortran_db.filenames_from_program_unit(unit)\\n-            # TODO: should this be done by the database?\\n-            #       preprocessing should ensure no duplicate units\\n+            # TODO: For now we simply can't handle this returning\\n+            #       multiple names; later we may be able to deal with\\n+            #       this via extra information in the configuration\\n             if len(filenames) == 1:\\n                 filename = filenames[0]\\n             else:\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex 38fb9d87..eb03eabf 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -94,8 +94,7 @@ def run(self, source: Path):\\n         if self._exec_name != \\\"\\\":\\n             executable = Path(self._workspace) / self._exec_name\\n         else:\\n-            executable = \\\\\\n-                Path(self._workspace / self._target).with_suffix(\\\".exe\\\")\\n+            executable = Path(self._workspace / self._target)\\n \\n         flags = self._command_flags_map.get(FortranLinker, [])\\n         link_command = FortranLinker(self._workspace, flags, executable)\\n\",\"diff --git a/source/fab/entry.py b/source/fab/entry.py\\nindex 3554d7d3..0cd9c07e 100644\\n--- a/source/fab/entry.py\\n+++ b/source/fab/entry.py\\n@@ -42,7 +42,7 @@ def fab_cli() -> argparse.Namespace:\\n     # TODO: Name for executable will eventually come from configuration\\n     parser.add_argument('--exec-name', action='store', type=str, default='',\\n                         help='Name of executable (default is the name of '\\n-                        'the program with extentsion \\\".exe\\\")')\\n+                        'the target program)')\\n     # TODO: Target/s will eventually come from configuration\\n     parser.add_argument('target', action='store', type=str,\\n                         help='The top level unit name to compile')\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex eb03eabf..90248219 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -121,10 +121,19 @@ def run(self, source: Path):\\n \\n             # Construct names of any expected module files to\\n             # pass to the compiler constructor\\n+            # TODO: Note that this currently assumes all of the\\n+            #       dependencies we found were modules; we are\\n+            #       going to need a way to get that information\\n+            #       from the database\\n             mod_files = [Path(self._workspace /\\n                               dependee).with_suffix('.mod')\\n                          for dependee in dependencies]\\n \\n+            # TODO: It would also be good here to be able to\\n+            #       generate a list of mod files which we\\n+            #       expect to be *produced* by the compile\\n+            #       and pass this to the constructor for\\n+            #       inclusion in the task's \\\"products\\\"\\n             compiler_class = self._compiler_map[filename.suffix]\\n \\n             if issubclass(compiler_class, FortranCompiler):\\n@@ -142,7 +151,7 @@ def run(self, source: Path):\\n \\n             # TODO: At this point we would add this to the queue\\n             #       rather than running it here.  Noting that\\n-            #       the queue worked can extract the prerequisites\\n+            #       the queue worker can extract the prerequisites\\n             #       from the Task object.  For now we are going\\n             #       to have to fake that logic here:\\n             if all([prereq.exists() for prereq in compiler.prerequisites]):\\n\",\"diff --git a/source/fab/language/__init__.py b/source/fab/language/__init__.py\\nindex fffd9f62..de9d2473 100644\\n--- a/source/fab/language/__init__.py\\n+++ b/source/fab/language/__init__.py\\n@@ -19,7 +19,7 @@ class TaskException(Exception):\\n \\n class Task(ABC):\\n     @abstractmethod\\n-    def run(self):\\n+    def run(self) -> None:\\n         raise NotImplementedError('Abstract methods must be implemented')\\n \\n     @property\\n\",\"diff --git a/source/fab/application.py b/source/fab/application.py\\nindex 90248219..4a3350d4 100644\\n--- a/source/fab/application.py\\n+++ b/source/fab/application.py\\n@@ -145,9 +145,9 @@ def run(self, source: Path):\\n                         flags,\\n                         mod_files))\\n             else:\\n-                message = 'Unhandled class \\\"{cls}\\\" in compiler map.'\\n-                raise TypeError(\\n-                    message.format(cls=compiler_class))\\n+                message = \\\\\\n+                    f'Unhandled class \\\"{compiler_class}\\\" in compiler map.'\\n+                raise TypeError(message)\\n \\n             # TODO: At this point we would add this to the queue\\n             #       rather than running it here.  Noting that\\n\",\"diff --git a/source/fab/source_tree.py b/source/fab/source_tree.py\\nindex 4b81aae4..23d019ef 100644\\n--- a/source/fab/source_tree.py\\n+++ b/source/fab/source_tree.py\\n@@ -50,9 +50,9 @@ def visit(self, candidate: Path) -> List[Path]:\\n                 task = CommandTask(\\n                     task_class(Path(hasher.filename), self._workspace, flags))\\n             else:\\n-                message = 'Unhandled class \\\"{cls}\\\" in extension map.'\\n-                raise TypeError(\\n-                    message.format(cls=task_class))\\n+                message = \\\\\\n+                    f'Unhandled class \\\"{task_class}\\\" in extension map.'\\n+                raise TypeError(message)\\n             # TODO: This is where we start calling \\\"add_to_queue\\\"\\n             #       rather then running the task right here.\\n             #       Noting that it can at this point access\\n\"]", "test_patch": "[\"diff --git a/unit-tests/source_tree_test.py b/unit-tests/source_tree_test.py\\nindex fa38133d..8bfc6d7f 100644\\n--- a/unit-tests/source_tree_test.py\\n+++ b/unit-tests/source_tree_test.py\\n@@ -7,7 +7,7 @@\\n from typing import Iterator, Union, List, Mapping, Dict, Type\\n \\n from fab.database import SqliteStateDatabase, FileInfoDatabase, FileInfo\\n-from fab.language import Analyser, Command, Task\\n+from fab.language import Analyser, Command, SingleFileCommand, Task\\n from fab.reader import TextReader\\n from fab.source_tree import ExtensionVisitor, TreeDescent, TreeVisitor\\n \\n@@ -64,7 +64,7 @@ def run(self):\\n         return []\\n \\n \\n-class DummyCommand(Command):\\n+class DummyCommand(SingleFileCommand):\\n     @property\\n     def as_list(self) -> List[str]:\\n         tracker['command'].append(self._filename)\\n\",\"diff --git a/unit-tests/language/fortran_test.py b/unit-tests/language/fortran_test.py\\nindex 3787fe60..9141d82c 100644\\n--- a/unit-tests/language/fortran_test.py\\n+++ b/unit-tests/language/fortran_test.py\\n@@ -355,8 +355,8 @@ def test_preprocssor_output(self, caplog, tmp_path):\\n         test_unit = CommandTask(preprocessor)\\n         test_unit.run()\\n \\n-        assert preprocessor.output_filename.exists\\n-        with open(preprocessor.output_filename, 'r') as outfile:\\n+        assert preprocessor.output[0].exists\\n+        with open(preprocessor.output[0], 'r') as outfile:\\n             outfile_content = outfile.read().strip()\\n \\n         assert outfile_content == dedent('''\\\\\\n@@ -375,8 +375,8 @@ def test_preprocssor_output(self, caplog, tmp_path):\\n         test_unit = CommandTask(preprocessor)\\n         test_unit.run()\\n \\n-        assert preprocessor.output_filename.exists\\n-        with open(preprocessor.output_filename, 'r') as outfile:\\n+        assert preprocessor.output[0].exists\\n+        with open(preprocessor.output[0], 'r') as outfile:\\n             outfile_content = outfile.read().strip()\\n \\n         assert outfile_content == dedent('''\\\\\\n\",\"diff --git a/unit-tests/source_tree_test.py b/unit-tests/source_tree_test.py\\nindex 8bfc6d7f..778c66f7 100644\\n--- a/unit-tests/source_tree_test.py\\n+++ b/unit-tests/source_tree_test.py\\n@@ -61,18 +61,17 @@ def setup_function():\\n class DummyAnalyser(Analyser):\\n     def run(self):\\n         tracker['analyser'].append(self._reader.filename)\\n-        return []\\n \\n \\n class DummyCommand(SingleFileCommand):\\n     @property\\n     def as_list(self) -> List[str]:\\n         tracker['command'].append(self._filename)\\n-        return ['cp', str(self._filename), str(self.output_filename)]\\n+        return ['cp', str(self._filename), str(self.output[0])]\\n \\n     @property\\n-    def output_filename(self) -> Path:\\n-        return self._filename.with_suffix('.baz')\\n+    def output(self) -> List[Path]:\\n+        return [self._filename.with_suffix('.baz')]\\n \\n \\n def test_extension_visitor(tmp_path: Path):\\n\",\"diff --git a/system-tests/FortranDependencies/constants_mod.f90 b/system-tests/FortranDependencies/constants_mod.f90\\nnew file mode 100644\\nindex 00000000..d2b3c24b\\n--- /dev/null\\n+++ b/system-tests/FortranDependencies/constants_mod.f90\\n@@ -0,0 +1,4 @@\\n+module constants_mod\\n+    implicit none\\n+    integer, parameter :: str_len = 20\\n+end module constants_mod\\n\\\\ No newline at end of file\\n\",\"diff --git a/system-tests/FortranDependencies/expected.dump.txt b/system-tests/FortranDependencies/expected.dump.txt\\nindex da1fc278..f6f4fa2b 100644\\n--- a/system-tests/FortranDependencies/expected.dump.txt\\n+++ b/system-tests/FortranDependencies/expected.dump.txt\\n@@ -1,6 +1,8 @@\\n File View\\n   File   : system-tests/FortranDependencies/bye_mod.f90\\n     Hash : 2054258567\\n+  File   : system-tests/FortranDependencies/constants_mod.f90\\n+    Hash : 420094826\\n   File   : system-tests/FortranDependencies/first.f90\\n     Hash : 1577883012\\n   File   : system-tests/FortranDependencies/greeting_mod.f90\\n@@ -11,6 +13,9 @@ Fortran View\\n   Program unit    : bye_mod\\n     Found in      : system-tests/FortranDependencies/bye_mod.f90\\n     Prerequisites : constants_mod\\n+  Program unit    : constants_mod\\n+    Found in      : system-tests/FortranDependencies/constants_mod.f90\\n+    Prerequisites : \\n   Program unit    : first\\n     Found in      : system-tests/FortranDependencies/first.f90\\n     Prerequisites : constants_mod, greeting_mod\\n\",\"diff --git a/system-tests/FortranDependencies/expected.fab.txt b/system-tests/FortranDependencies/expected.fab.txt\\nindex b87c9e37..f033577c 100644\\n--- a/system-tests/FortranDependencies/expected.fab.txt\\n+++ b/system-tests/FortranDependencies/expected.fab.txt\\n@@ -1,5 +1,7 @@\\n system-tests/FortranDependencies/bye_mod.f90\\n     hash: 2054258567\\n+system-tests/FortranDependencies/constants_mod.f90\\n+    hash: 420094826\\n system-tests/FortranDependencies/first.f90\\n     hash: 1577883012\\n system-tests/FortranDependencies/greeting_mod.f90\\n@@ -9,6 +11,9 @@ system-tests/FortranDependencies/two.f90\\n bye_mod\\n     found in: system-tests/FortranDependencies/bye_mod.f90\\n     depends on: ['constants_mod']\\n+constants_mod\\n+    found in: system-tests/FortranDependencies/constants_mod.f90\\n+    depends on: []\\n first\\n     found in: system-tests/FortranDependencies/first.f90\\n     depends on: ['constants_mod', 'greeting_mod']\\n\",\"diff --git a/system-tests/FortranPreProcess/clash.F90 b/system-tests/FortranPreProcess/clash.F90\\nindex 7b783053..a7f8f62b 100644\\n--- a/system-tests/FortranPreProcess/clash.F90\\n+++ b/system-tests/FortranPreProcess/clash.F90\\n@@ -4,7 +4,9 @@\\n !\\n program stay_or_go_now\\n \\n+    use iso_fortran_env, only: output_unit\\n     use constants_mod, only : str_len\\n+    \\n #if defined(SHOULD_I_STAY)\\n     use stay_mod,     only  : stay\\n #else\\n\",\"diff --git a/system-tests/FortranPreProcess/constants_mod.f90 b/system-tests/FortranPreProcess/constants_mod.f90\\nnew file mode 100644\\nindex 00000000..d2b3c24b\\n--- /dev/null\\n+++ b/system-tests/FortranPreProcess/constants_mod.f90\\n@@ -0,0 +1,4 @@\\n+module constants_mod\\n+    implicit none\\n+    integer, parameter :: str_len = 20\\n+end module constants_mod\\n\\\\ No newline at end of file\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.dump.go.txt b/system-tests/FortranPreProcess/expected.dump.go.txt\\nindex b7cba2e3..d60153b3 100644\\n--- a/system-tests/FortranPreProcess/expected.dump.go.txt\\n+++ b/system-tests/FortranPreProcess/expected.dump.go.txt\\n@@ -1,6 +1,8 @@\\n File View\\n   File   : system-tests/FortranPreProcess/clash.F90\\n-    Hash : 1901506991\\n+    Hash : 1656734134\\n+  File   : system-tests/FortranPreProcess/constants_mod.f90\\n+    Hash : 420094826\\n   File   : system-tests/FortranPreProcess/go_now_mod.f90\\n     Hash : 374511745\\n   File   : system-tests/FortranPreProcess/stay_mod.f90\\n@@ -8,6 +10,9 @@ File View\\n   File   : system-tests/FortranPreProcess/working/clash.f90\\n     Hash : --hidden-- (generated file)\\n Fortran View\\n+  Program unit    : constants_mod\\n+    Found in      : system-tests/FortranPreProcess/constants_mod.f90\\n+    Prerequisites : \\n   Program unit    : go_now_mod\\n     Found in      : system-tests/FortranPreProcess/go_now_mod.f90\\n     Prerequisites : constants_mod\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.dump.stay.txt b/system-tests/FortranPreProcess/expected.dump.stay.txt\\nindex b2fa9a7b..c774d496 100644\\n--- a/system-tests/FortranPreProcess/expected.dump.stay.txt\\n+++ b/system-tests/FortranPreProcess/expected.dump.stay.txt\\n@@ -1,6 +1,8 @@\\n File View\\n   File   : system-tests/FortranPreProcess/clash.F90\\n-    Hash : 1901506991\\n+    Hash : 1656734134\\n+  File   : system-tests/FortranPreProcess/constants_mod.f90\\n+    Hash : 420094826\\n   File   : system-tests/FortranPreProcess/go_now_mod.f90\\n     Hash : 374511745\\n   File   : system-tests/FortranPreProcess/stay_mod.f90\\n@@ -8,6 +10,9 @@ File View\\n   File   : system-tests/FortranPreProcess/working/clash.f90\\n     Hash : --hidden-- (generated file)\\n Fortran View\\n+  Program unit    : constants_mod\\n+    Found in      : system-tests/FortranPreProcess/constants_mod.f90\\n+    Prerequisites : \\n   Program unit    : go_now_mod\\n     Found in      : system-tests/FortranPreProcess/go_now_mod.f90\\n     Prerequisites : constants_mod\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.fab.go.txt b/system-tests/FortranPreProcess/expected.fab.go.txt\\nindex ecaa02fd..7a93b626 100644\\n--- a/system-tests/FortranPreProcess/expected.fab.go.txt\\n+++ b/system-tests/FortranPreProcess/expected.fab.go.txt\\n@@ -1,11 +1,16 @@\\n system-tests/FortranPreProcess/clash.F90\\n-    hash: 1901506991\\n+    hash: 1656734134\\n+system-tests/FortranPreProcess/constants_mod.f90\\n+    hash: 420094826\\n system-tests/FortranPreProcess/go_now_mod.f90\\n     hash: 374511745\\n system-tests/FortranPreProcess/stay_mod.f90\\n     hash: 3960444120\\n system-tests/FortranPreProcess/working/clash.f90\\n     hash: --hidden-- (generated file)\\n+constants_mod\\n+    found in: system-tests/FortranPreProcess/constants_mod.f90\\n+    depends on: []\\n go_now_mod\\n     found in: system-tests/FortranPreProcess/go_now_mod.f90\\n     depends on: ['constants_mod']\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.fab.stay.txt b/system-tests/FortranPreProcess/expected.fab.stay.txt\\nindex f80d84f6..690843c8 100644\\n--- a/system-tests/FortranPreProcess/expected.fab.stay.txt\\n+++ b/system-tests/FortranPreProcess/expected.fab.stay.txt\\n@@ -1,11 +1,16 @@\\n system-tests/FortranPreProcess/clash.F90\\n-    hash: 1901506991\\n+    hash: 1656734134\\n+system-tests/FortranPreProcess/constants_mod.f90\\n+    hash: 420094826\\n system-tests/FortranPreProcess/go_now_mod.f90\\n     hash: 374511745\\n system-tests/FortranPreProcess/stay_mod.f90\\n     hash: 3960444120\\n system-tests/FortranPreProcess/working/clash.f90\\n     hash: --hidden-- (generated file)\\n+constants_mod\\n+    found in: system-tests/FortranPreProcess/constants_mod.f90\\n+    depends on: []\\n go_now_mod\\n     found in: system-tests/FortranPreProcess/go_now_mod.f90\\n     depends on: ['constants_mod']\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex cb623d21..6f3e4dc5 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -107,11 +107,13 @@ class FabTestCase(RunTestCase):\\n     #\\n     def __init__(self,\\n                  test_directory: Path,\\n+                 target: str,\\n                  expectation_prefix: str = '',\\n                  fpp_flags: str = None):\\n         args: List[str] = []\\n         if fpp_flags:\\n             args.append('--fpp-flags=' + fpp_flags)\\n+        args.append(target)\\n         args.append(str(test_directory))\\n \\n         expectation_file = 'expected.fab'\\n@@ -214,23 +216,23 @@ def teardown(self):\\n     #\\n     sequence = (\\n         [\\n-            FabTestCase(root_dir / 'MinimalFortran'),\\n+            FabTestCase(root_dir / 'MinimalFortran', 'test'),\\n             DumpTestCase(root_dir / 'MinimalFortran')\\n         ],\\n         [\\n-            FabTestCase(root_dir / 'FortranDependencies'),\\n+            FabTestCase(root_dir / 'FortranDependencies', 'first'),\\n             DumpTestCase(root_dir / 'FortranDependencies')\\n         ],\\n         [\\n             [\\n-                FabTestCase(root_dir / 'FortranPreProcess',\\n+                FabTestCase(root_dir / 'FortranPreProcess', 'stay_or_go_now',\\n                             expectation_prefix='stay',\\n                             fpp_flags='-DSHOULD_I_STAY=yes'),\\n                 DumpTestCase(root_dir / 'FortranPreProcess',\\n                              expectation_prefix='stay')\\n             ],\\n             [\\n-                FabTestCase(root_dir / 'FortranPreProcess',\\n+                FabTestCase(root_dir / 'FortranPreProcess', 'stay_or_go_now',\\n                             expectation_prefix='go'),\\n                 DumpTestCase(root_dir / 'FortranPreProcess',\\n                              expectation_prefix='go')\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex 6f3e4dc5..71751b50 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -52,6 +52,8 @@ def run(self):\\n                    '-w', self._working_dir]\\n         command.extend(self._arguments)\\n \\n+        os.system(\\\"which gfortran\\\")\\n+\\n         user_path: List[str] = os.environ.get('PATH').split(':')\\n         try:\\n             while True:\\n@@ -60,6 +62,8 @@ def run(self):\\n             pass  # No empty entries to be removed.\\n         user_path.append(os.path.dirname(sys.executable))\\n \\n+        print(user_path)\\n+\\n         environment = {'PATH': ':'.join(user_path),\\n                        'PYTHONPATH': 'source'}\\n         thread: subprocess.Popen = subprocess.Popen(command,\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex 71751b50..68035c1c 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -52,8 +52,6 @@ def run(self):\\n                    '-w', self._working_dir]\\n         command.extend(self._arguments)\\n \\n-        os.system(\\\"which gfortran\\\")\\n-\\n         user_path: List[str] = os.environ.get('PATH').split(':')\\n         try:\\n             while True:\\n@@ -62,10 +60,10 @@ def run(self):\\n             pass  # No empty entries to be removed.\\n         user_path.append(os.path.dirname(sys.executable))\\n \\n-        print(user_path)\\n+        environment = os.environ\\n+        environment.update({'PATH': ':'.join(user_path),\\n+                            'PYTHONPATH': 'source'})\\n \\n-        environment = {'PATH': ':'.join(user_path),\\n-                       'PYTHONPATH': 'source'}\\n         thread: subprocess.Popen = subprocess.Popen(command,\\n                                                     env=environment,\\n                                                     stdout=subprocess.PIPE,\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex 68035c1c..13363c0b 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -60,9 +60,8 @@ def run(self):\\n             pass  # No empty entries to be removed.\\n         user_path.append(os.path.dirname(sys.executable))\\n \\n-        environment = os.environ\\n-        environment.update({'PATH': ':'.join(user_path),\\n-                            'PYTHONPATH': 'source'})\\n+        environment = {'PATH': ':'.join(user_path),\\n+                       'PYTHONPATH': 'source'}\\n \\n         thread: subprocess.Popen = subprocess.Popen(command,\\n                                                     env=environment,\\n\",\"diff --git a/system-tests/FortranDependencies/expected.exec.txt b/system-tests/FortranDependencies/expected.exec.txt\\nnew file mode 100644\\nindex 00000000..5f2024c6\\n--- /dev/null\\n+++ b/system-tests/FortranDependencies/expected.exec.txt\\n@@ -0,0 +1 @@\\n+Hello               \\n\",\"diff --git a/system-tests/FortranPreProcess/expected.exec.go.txt b/system-tests/FortranPreProcess/expected.exec.go.txt\\nnew file mode 100644\\nindex 00000000..1d8ed92f\\n--- /dev/null\\n+++ b/system-tests/FortranPreProcess/expected.exec.go.txt\\n@@ -0,0 +1 @@\\n+I should go now     \\n\",\"diff --git a/system-tests/FortranPreProcess/expected.exec.stay.txt b/system-tests/FortranPreProcess/expected.exec.stay.txt\\nnew file mode 100644\\nindex 00000000..bbd57e5a\\n--- /dev/null\\n+++ b/system-tests/FortranPreProcess/expected.exec.stay.txt\\n@@ -0,0 +1 @@\\n+I should stay       \\n\",\"diff --git a/system-tests/MinimalFortran/expected.exec.txt b/system-tests/MinimalFortran/expected.exec.txt\\nnew file mode 100644\\nindex 00000000..cd087558\\n--- /dev/null\\n+++ b/system-tests/MinimalFortran/expected.exec.txt\\n@@ -0,0 +1 @@\\n+Hello world!\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex 13363c0b..7e97a81e 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -110,10 +110,17 @@ def __init__(self,\\n                  test_directory: Path,\\n                  target: str,\\n                  expectation_prefix: str = '',\\n-                 fpp_flags: str = None):\\n+                 fpp_flags: str = None,\\n+                 fc_flags: str = None,\\n+                 ld_flags: str = None):\\n         args: List[str] = []\\n         if fpp_flags:\\n             args.append('--fpp-flags=' + fpp_flags)\\n+        if fc_flags:\\n+            args.append('--fc-flags=' + fc_flags)\\n+        if ld_flags:\\n+            args.append('--ld-flags=' + ld_flags)\\n+        args.extend(['--exec-name', 'fab_test.exe'])\\n         args.append(target)\\n         args.append(str(test_directory))\\n \\n@@ -122,12 +129,42 @@ def __init__(self,\\n             expectation_file += '.' + expectation_prefix\\n         expectation_file += '.txt'\\n \\n+        expected_exec_file = 'expected.exec'\\n+        if expectation_prefix != '':\\n+            expected_exec_file += '.' + expectation_prefix\\n+        expected_exec_file += '.txt'\\n+\\n+        self._expected_exec = \\\\\\n+            (test_directory / expected_exec_file).read_text('utf-8') \\\\\\n+            .splitlines(keepends=True)\\n+\\n         super().__init__(test_directory,\\n                          test_directory / 'working',\\n                          test_directory / expectation_file,\\n                          'fab_entry',\\n                          args)\\n \\n+    def run(self):\\n+        super().run()\\n+        expected_exec = self._test_directory / 'working' / 'fab_test.exe'\\n+        self.assert_true(expected_exec.exists)\\n+        thread: subprocess.Popen = subprocess.Popen(\\n+            [expected_exec],\\n+            stdout=subprocess.PIPE,\\n+            stderr=subprocess.PIPE)\\n+\\n+        stdout: bytes\\n+        stderr: bytes\\n+        stdout, stderr = thread.communicate()\\n+        if thread.returncode != 0:\\n+            print('Running fab_test.exe failed: ', file=sys.stderr)\\n+            print('    stdout: ' + stdout.decode('utf-8'))\\n+            print('    stderr: ' + stderr.decode('utf-8'))\\n+\\n+        self.assert_true(thread.returncode == 0)\\n+        self._assert_diff(stdout.decode('utf-8').splitlines(keepends=True),\\n+                          self._expected_exec)\\n+\\n     def setup(self):\\n         working_dir: Path = self._test_directory / 'working'\\n         if working_dir.is_dir():\\n\",\"diff --git a/system-tests/FortranDependencies/constants_mod.f90 b/system-tests/FortranDependencies/constants_mod.f90\\nindex d2b3c24b..145256a1 100644\\n--- a/system-tests/FortranDependencies/constants_mod.f90\\n+++ b/system-tests/FortranDependencies/constants_mod.f90\\n@@ -1,4 +1,4 @@\\n module constants_mod\\n     implicit none\\n     integer, parameter :: str_len = 20\\n-end module constants_mod\\n\\\\ No newline at end of file\\n+end module constants_mod\\n\",\"diff --git a/system-tests/FortranDependencies/expected.dump.txt b/system-tests/FortranDependencies/expected.dump.txt\\nindex f6f4fa2b..303f5264 100644\\n--- a/system-tests/FortranDependencies/expected.dump.txt\\n+++ b/system-tests/FortranDependencies/expected.dump.txt\\n@@ -2,7 +2,7 @@ File View\\n   File   : system-tests/FortranDependencies/bye_mod.f90\\n     Hash : 2054258567\\n   File   : system-tests/FortranDependencies/constants_mod.f90\\n-    Hash : 420094826\\n+    Hash : 1014899572\\n   File   : system-tests/FortranDependencies/first.f90\\n     Hash : 1577883012\\n   File   : system-tests/FortranDependencies/greeting_mod.f90\\n\",\"diff --git a/system-tests/FortranDependencies/expected.fab.txt b/system-tests/FortranDependencies/expected.fab.txt\\nindex f033577c..67053041 100644\\n--- a/system-tests/FortranDependencies/expected.fab.txt\\n+++ b/system-tests/FortranDependencies/expected.fab.txt\\n@@ -1,7 +1,7 @@\\n system-tests/FortranDependencies/bye_mod.f90\\n     hash: 2054258567\\n system-tests/FortranDependencies/constants_mod.f90\\n-    hash: 420094826\\n+    hash: 1014899572\\n system-tests/FortranDependencies/first.f90\\n     hash: 1577883012\\n system-tests/FortranDependencies/greeting_mod.f90\\n\",\"diff --git a/system-tests/FortranPreProcess/constants_mod.f90 b/system-tests/FortranPreProcess/constants_mod.f90\\nindex d2b3c24b..145256a1 100644\\n--- a/system-tests/FortranPreProcess/constants_mod.f90\\n+++ b/system-tests/FortranPreProcess/constants_mod.f90\\n@@ -1,4 +1,4 @@\\n module constants_mod\\n     implicit none\\n     integer, parameter :: str_len = 20\\n-end module constants_mod\\n\\\\ No newline at end of file\\n+end module constants_mod\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.dump.go.txt b/system-tests/FortranPreProcess/expected.dump.go.txt\\nindex d60153b3..893325d5 100644\\n--- a/system-tests/FortranPreProcess/expected.dump.go.txt\\n+++ b/system-tests/FortranPreProcess/expected.dump.go.txt\\n@@ -2,7 +2,7 @@ File View\\n   File   : system-tests/FortranPreProcess/clash.F90\\n     Hash : 1656734134\\n   File   : system-tests/FortranPreProcess/constants_mod.f90\\n-    Hash : 420094826\\n+    Hash : 1014899572\\n   File   : system-tests/FortranPreProcess/go_now_mod.f90\\n     Hash : 374511745\\n   File   : system-tests/FortranPreProcess/stay_mod.f90\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.dump.stay.txt b/system-tests/FortranPreProcess/expected.dump.stay.txt\\nindex c774d496..18429032 100644\\n--- a/system-tests/FortranPreProcess/expected.dump.stay.txt\\n+++ b/system-tests/FortranPreProcess/expected.dump.stay.txt\\n@@ -2,7 +2,7 @@ File View\\n   File   : system-tests/FortranPreProcess/clash.F90\\n     Hash : 1656734134\\n   File   : system-tests/FortranPreProcess/constants_mod.f90\\n-    Hash : 420094826\\n+    Hash : 1014899572\\n   File   : system-tests/FortranPreProcess/go_now_mod.f90\\n     Hash : 374511745\\n   File   : system-tests/FortranPreProcess/stay_mod.f90\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.fab.go.txt b/system-tests/FortranPreProcess/expected.fab.go.txt\\nindex 7a93b626..d8de99c5 100644\\n--- a/system-tests/FortranPreProcess/expected.fab.go.txt\\n+++ b/system-tests/FortranPreProcess/expected.fab.go.txt\\n@@ -1,7 +1,7 @@\\n system-tests/FortranPreProcess/clash.F90\\n     hash: 1656734134\\n system-tests/FortranPreProcess/constants_mod.f90\\n-    hash: 420094826\\n+    hash: 1014899572\\n system-tests/FortranPreProcess/go_now_mod.f90\\n     hash: 374511745\\n system-tests/FortranPreProcess/stay_mod.f90\\n\",\"diff --git a/system-tests/FortranPreProcess/expected.fab.stay.txt b/system-tests/FortranPreProcess/expected.fab.stay.txt\\nindex 690843c8..c6229ba4 100644\\n--- a/system-tests/FortranPreProcess/expected.fab.stay.txt\\n+++ b/system-tests/FortranPreProcess/expected.fab.stay.txt\\n@@ -1,7 +1,7 @@\\n system-tests/FortranPreProcess/clash.F90\\n     hash: 1656734134\\n system-tests/FortranPreProcess/constants_mod.f90\\n-    hash: 420094826\\n+    hash: 1014899572\\n system-tests/FortranPreProcess/go_now_mod.f90\\n     hash: 374511745\\n system-tests/FortranPreProcess/stay_mod.f90\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex 7e97a81e..a7a256c9 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -120,7 +120,7 @@ def __init__(self,\\n             args.append('--fc-flags=' + fc_flags)\\n         if ld_flags:\\n             args.append('--ld-flags=' + ld_flags)\\n-        args.extend(['--exec-name', 'fab_test.exe'])\\n+        args.extend(['--exec-name', 'fab_test'])\\n         args.append(target)\\n         args.append(str(test_directory))\\n \\n@@ -146,7 +146,7 @@ def __init__(self,\\n \\n     def run(self):\\n         super().run()\\n-        expected_exec = self._test_directory / 'working' / 'fab_test.exe'\\n+        expected_exec = self._test_directory / 'working' / 'fab_test'\\n         self.assert_true(expected_exec.exists)\\n         thread: subprocess.Popen = subprocess.Popen(\\n             [expected_exec],\\n@@ -157,7 +157,7 @@ def run(self):\\n         stderr: bytes\\n         stdout, stderr = thread.communicate()\\n         if thread.returncode != 0:\\n-            print('Running fab_test.exe failed: ', file=sys.stderr)\\n+            print('Running fab_test failed: ', file=sys.stderr)\\n             print('    stdout: ' + stdout.decode('utf-8'))\\n             print('    stderr: ' + stderr.decode('utf-8'))\\n \\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex a7a256c9..abf8aba2 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -20,24 +20,102 @@\\n import sys\\n import os\\n import traceback\\n-from typing import List, Sequence\\n+from typing import List, Sequence, Dict\\n \\n import systest  # type: ignore\\n from systest import Sequencer\\n \\n \\n class RunTestCase(systest.TestCase):\\n-    \\\"\\\"\\\"\\n-    Runs a tool from the fab collection and compares output with expected one.\\n-    \\\"\\\"\\\"\\n+    '''\\n+    Base class for tests containing useful utility functions.\\n+    '''\\n+\\n+    def run_command_check_output(self,\\n+                                 command: List[str],\\n+                                 environment: Dict,\\n+                                 expected: str):\\n+        '''\\n+        Run ``command`` in the given ``environment`` and then compare\\n+        its stdout to some ``expected`` output, raising an exception\\n+        if either the command fails or the output disagrees.\\n+        '''\\n+        thread: subprocess.Popen = subprocess.Popen(command,\\n+                                                    env=environment,\\n+                                                    stdout=subprocess.PIPE,\\n+                                                    stderr=subprocess.PIPE)\\n+        stdout: bytes\\n+        stderr: bytes\\n+        stdout, stderr = thread.communicate()\\n+        if thread.returncode != 0:\\n+            print('Running command failed: ', file=sys.stderr)\\n+            print('    command: ' + ' '.join(command), file=sys.stderr)\\n+            print('    stdout: ' + stdout.decode('utf-8'))\\n+            print('    stderr: ' + stderr.decode('utf-8'))\\n+\\n+        self.assert_true(thread.returncode == 0)\\n+        self._assert_diff(stdout.decode('utf-8').splitlines(keepends=True),\\n+                          expected)\\n+\\n+    @staticmethod\\n+    def _assert_diff(first, second):\\n+        '''\\n+        Raise an exception if ``first`` and ``seconds`` are not the same.\\n+\\n+        It is assumed that the arguments are multi-line strings and the\\n+        exception will contain a \\\"diff\\\" dervied from them.\\n+        '''\\n+        if first != second:\\n+            filename, line, _, _ = traceback.extract_stack()[-2]\\n+            differ = difflib.Differ()\\n+            diff = differ.compare(first, second)\\n+\\n+            text = ''.join(diff)\\n+            raise systest.TestCaseFailedError(\\n+                '{}:{}: Mismatch found:\\\\n{}'.format(filename,\\n+                                                    line,\\n+                                                    text))\\n+\\n+\\n+class ExecTestCase(RunTestCase):\\n+    '''\\n+    Test case which expects to run an executable and\\n+    compare its output with an expected result.\\n+    '''\\n+\\n+    def __init__(self,\\n+                 test_directory: Path,\\n+                 expectation_file: Path,\\n+                 executable: Path,\\n+                 name: str,\\n+                 args: Sequence[str] = ()):\\n+        super().__init__(name=name)\\n+        self._arguments = args\\n+        self._executable = executable\\n+        self._expected = expectation_file.read_text('utf-8') \\\\\\n+            .splitlines(keepends=True)\\n+\\n+    def run(self):\\n+        command = [str(self._executable)] + self._arguments\\n+\\n+        self.run_command_check_output(\\n+            command, {}, self._expected)\\n+\\n+\\n+class PythonTestCase(RunTestCase):\\n+    '''\\n+    Test case which expects to run a Python entry point and\\n+    compare its output with an expected result.\\n+    '''\\n \\n     def __init__(self,\\n                  test_directory: Path,\\n                  working_dir: Path,\\n                  expectation_file: Path,\\n                  entry_point: str,\\n+                 name: str,\\n                  args: Sequence[str] = ()):\\n-        super().__init__(name=test_directory.stem)\\n+        super().__init__(name=name)\\n         self._test_directory: Path = test_directory\\n         self._working_dir: Path = working_dir\\n         self._entry_point = entry_point\\n@@ -46,8 +124,8 @@ def __init__(self,\\n             .splitlines(keepends=True)\\n \\n     def run(self):\\n-        script = \\\"import sys; import fab.entry; \\\" \\\\\\n-                 f\\\"sys.exit(fab.entry.{self._entry_point}())\\\"\\n+        script = 'import sys; import fab.entry; ' \\\\\\n+                 f'sys.exit(fab.entry.{self._entry_point}())'\\n         command = ['python3', '-c', script,\\n                    '-w', self._working_dir]\\n         command.extend(self._arguments)\\n@@ -63,44 +141,38 @@ def run(self):\\n         environment = {'PATH': ':'.join(user_path),\\n                        'PYTHONPATH': 'source'}\\n \\n-        thread: subprocess.Popen = subprocess.Popen(command,\\n-                                                    env=environment,\\n-                                                    stdout=subprocess.PIPE,\\n-                                                    stderr=subprocess.PIPE)\\n-        stdout: bytes\\n-        stderr: bytes\\n-        stdout, stderr = thread.communicate()\\n-        if thread.returncode != 0:\\n-            print('Running Fab failed: ', file=sys.stderr)\\n-            print('    stdout: ' + stdout.decode('utf-8'))\\n-            print('    stderr: ' + stderr.decode('utf-8'))\\n+        self.run_command_check_output(\\n+            command, environment, self._expected)\\n \\n-        self.assert_true(thread.returncode == 0)\\n-        self._assert_diff(stdout.decode('utf-8').splitlines(keepends=True),\\n-                          self._expected)\\n \\n-    @staticmethod\\n-    def _assert_diff(first, second):\\n-        '''\\n-        Raise an exception if ``first`` and ``seconds`` are not the same.\\n+class CompiledExecTestCase(ExecTestCase):\\n+    '''Run the exec produced by Fab and check its output.'''\\n \\n-        It is assumed that the arguments are multi-line strings and the\\n-        exception will contain a \\\"diff\\\" dervied from them.\\n-        '''\\n-        if first != second:\\n-            filename, line, _, _ = traceback.extract_stack()[-2]\\n-            differ = difflib.Differ()\\n-            diff = differ.compare(first, second)\\n+    # The result is held in a file 'expected.exec.txt' in the test directory.\\n+    #\\n+    # This comment exists as the framework hijacks the docstring for output.\\n+    #\\n+    def __init__(self,\\n+                 test_directory: Path,\\n+                 expectation_prefix: str = '',):\\n+        args: List[str] = []\\n \\n-            text = ''.join(diff)\\n-            raise systest.TestCaseFailedError(\\n-                '{}:{}: Mismatch found:\\\\n{}'.format(filename,\\n-                                                    line,\\n-                                                    text))\\n+        expectation_file = 'expected.exec'\\n+        if expectation_prefix != '':\\n+            expectation_file += '.' + expectation_prefix\\n+        expectation_file += '.txt'\\n+\\n+        executable = test_directory / 'working' / 'fab_test'\\n+\\n+        super().__init__(test_directory,\\n+                         test_directory / expectation_file,\\n+                         executable,\\n+                         f'{test_directory.stem} - Running Executable',\\n+                         args)\\n \\n \\n-class FabTestCase(RunTestCase):\\n-    \\\"\\\"\\\"Run Fab build tool against source tree and validate result.\\\"\\\"\\\"\\n+class FabTestCase(PythonTestCase):\\n+    '''Run Fab build tool against source tree and validate result.'''\\n \\n     # The result is held in a file 'expected.fab.txt' in the test directory.\\n     #\\n@@ -113,6 +185,7 @@ def __init__(self,\\n                  fpp_flags: str = None,\\n                  fc_flags: str = None,\\n                  ld_flags: str = None):\\n+\\n         args: List[str] = []\\n         if fpp_flags:\\n             args.append('--fpp-flags=' + fpp_flags)\\n@@ -120,6 +193,7 @@ def __init__(self,\\n             args.append('--fc-flags=' + fc_flags)\\n         if ld_flags:\\n             args.append('--ld-flags=' + ld_flags)\\n+\\n         args.extend(['--exec-name', 'fab_test'])\\n         args.append(target)\\n         args.append(str(test_directory))\\n@@ -129,50 +203,21 @@ def __init__(self,\\n             expectation_file += '.' + expectation_prefix\\n         expectation_file += '.txt'\\n \\n-        expected_exec_file = 'expected.exec'\\n-        if expectation_prefix != '':\\n-            expected_exec_file += '.' + expectation_prefix\\n-        expected_exec_file += '.txt'\\n-\\n-        self._expected_exec = \\\\\\n-            (test_directory / expected_exec_file).read_text('utf-8') \\\\\\n-            .splitlines(keepends=True)\\n-\\n         super().__init__(test_directory,\\n                          test_directory / 'working',\\n                          test_directory / expectation_file,\\n                          'fab_entry',\\n+                         f'{test_directory.stem} - Running Fab',\\n                          args)\\n \\n-    def run(self):\\n-        super().run()\\n-        expected_exec = self._test_directory / 'working' / 'fab_test'\\n-        self.assert_true(expected_exec.exists)\\n-        thread: subprocess.Popen = subprocess.Popen(\\n-            [expected_exec],\\n-            stdout=subprocess.PIPE,\\n-            stderr=subprocess.PIPE)\\n-\\n-        stdout: bytes\\n-        stderr: bytes\\n-        stdout, stderr = thread.communicate()\\n-        if thread.returncode != 0:\\n-            print('Running fab_test failed: ', file=sys.stderr)\\n-            print('    stdout: ' + stdout.decode('utf-8'))\\n-            print('    stderr: ' + stderr.decode('utf-8'))\\n-\\n-        self.assert_true(thread.returncode == 0)\\n-        self._assert_diff(stdout.decode('utf-8').splitlines(keepends=True),\\n-                          self._expected_exec)\\n-\\n     def setup(self):\\n         working_dir: Path = self._test_directory / 'working'\\n         if working_dir.is_dir():\\n             shutil.rmtree(str(working_dir))\\n \\n \\n-class DumpTestCase(RunTestCase):\\n-    \\\"\\\"\\\"Run Fab dump tool against working directory and validate result.\\\"\\\"\\\"\\n+class DumpTestCase(PythonTestCase):\\n+    '''Run Fab dump tool against working directory and validate result.'''\\n \\n     # The result is held in a file 'expected.dump.txt' in the test directory.\\n     #\\n@@ -191,6 +236,7 @@ def __init__(self,\\n                          test_directory / 'working',\\n                          test_directory / expectation_file,\\n                          'dump_entry',\\n+                         f'{test_directory.stem} - Running Fab dump',\\n                          [])\\n \\n     def teardown(self):\\n@@ -255,10 +301,12 @@ def teardown(self):\\n     sequence = (\\n         [\\n             FabTestCase(root_dir / 'MinimalFortran', 'test'),\\n+            CompiledExecTestCase(root_dir / 'MinimalFortran'),\\n             DumpTestCase(root_dir / 'MinimalFortran')\\n         ],\\n         [\\n             FabTestCase(root_dir / 'FortranDependencies', 'first'),\\n+            CompiledExecTestCase(root_dir / 'FortranDependencies'),\\n             DumpTestCase(root_dir / 'FortranDependencies')\\n         ],\\n         [\\n@@ -266,12 +314,16 @@ def teardown(self):\\n                 FabTestCase(root_dir / 'FortranPreProcess', 'stay_or_go_now',\\n                             expectation_prefix='stay',\\n                             fpp_flags='-DSHOULD_I_STAY=yes'),\\n+                CompiledExecTestCase(root_dir / 'FortranPreProcess',\\n+                                     expectation_prefix='stay'),\\n                 DumpTestCase(root_dir / 'FortranPreProcess',\\n                              expectation_prefix='stay')\\n             ],\\n             [\\n                 FabTestCase(root_dir / 'FortranPreProcess', 'stay_or_go_now',\\n                             expectation_prefix='go'),\\n+                CompiledExecTestCase(root_dir / 'FortranPreProcess',\\n+                                     expectation_prefix='go'),\\n                 DumpTestCase(root_dir / 'FortranPreProcess',\\n                              expectation_prefix='go')\\n             ]\\n\",\"diff --git a/system-tests/test.py b/system-tests/test.py\\nindex abf8aba2..fb61c291 100644\\n--- a/system-tests/test.py\\n+++ b/system-tests/test.py\\n@@ -127,7 +127,7 @@ def run(self):\\n         script = 'import sys; import fab.entry; ' \\\\\\n                  f'sys.exit(fab.entry.{self._entry_point}())'\\n         command = ['python3', '-c', script,\\n-                   '-w', self._working_dir]\\n+                   '-w', str(self._working_dir)]\\n         command.extend(self._arguments)\\n \\n         user_path: List[str] = os.environ.get('PATH').split(':')\"]", "hints_text": ""}
