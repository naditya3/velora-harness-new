{"instance_id": "758587713189461", "repo": "randovania/randovania", "base_commit": "b828509f9bbe1fbe6dcfae4dc0bdd1d336bd2240", "problem_statement": "prepare first major release of open-dread-rando:\\nhttps://github.com/randovania/open-dread-rando/milestone/1\\r\\n\\r\\ndread testing cannot be useful until at least all pickups are being placed", "FAIL_TO_PASS": ["test/games/patchers/test_randomprime_patcher.py::test_prime1_pickup_details_to_patcher_shiny_missile[True]", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list_random_data_source[True]", "test/games/patchers/test_randomprime_patcher.py::test_prime1_pickup_details_to_patcher_shiny_missile[False]", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list[PickupModelStyle.HIDE_SCAN]", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list[PickupModelStyle.HIDE_ALL]", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_multi_create_pickup_data_for_other", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list_random_data_source[False]", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_multi_create_pickup_data_for_self", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_solo_create_pickup_data", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list[PickupModelStyle.HIDE_MODEL]", "test/games/prime/test_patcher_file.py::test_run_validated_hud_text", "test/games/prime/patcher_file_lib/test_pickup_exporter.py::test_create_pickup_list[PickupModelStyle.ALL_VISIBLE]"], "PASS_TO_PASS": [], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/randovania_randovania:b828509f9bbe1fbe6dcfae4dc0bdd1d336bd2240", "patch": "[\"diff --git a/randovania/games/dread/item_database/item-database.json b/randovania/games/dread/item_database/item-database.json\\nindex 527f7c8004..a2d7af5422 100644\\n--- a/randovania/games/dread/item_database/item-database.json\\n+++ b/randovania/games/dread/item_database/item-database.json\\n@@ -656,7 +656,9 @@\\n                 \\\"PBAmmo\\\"\\n             ],\\n             \\\"broad_category\\\": \\\"morph_ball_related\\\",\\n-            \\\"extra\\\": {}\\n+            \\\"extra\\\": {},\\n+            \\\"temporary\\\": \\\"PBAmmo\\\",\\n+            \\\"unlocked_by\\\": \\\"MainPB\\\"\\n         }\\n     },\\n     \\\"default_items\\\": {}\\n\",\"diff --git a/randovania/games/dread/json_data/Artaria.json b/randovania/games/dread/json_data/Artaria.json\\nindex 52634a1add..b94afbecdb 100644\\n--- a/randovania/games/dread/json_data/Artaria.json\\n+++ b/randovania/games/dread/json_data/Artaria.json\\n@@ -8137,7 +8137,12 @@\\n                         \\\"z\\\": 0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"corpius\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/scorpius/charclasses/scorpius.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_OPTICAL_CAMO\\\",\\n+                        \\\"callback_function\\\": \\\"OnCutscene0057Finished\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 138,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n@@ -12547,7 +12552,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmycave/charclasses/emmycave.bmsad\\\",\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_SPIDER_MAGNET\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmyCaveDead\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 139,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Artaria.txt b/randovania/games/dread/json_data/Artaria.txt\\nindex fc19a76f14..fc2dd56dc5 100644\\n--- a/randovania/games/dread/json_data/Artaria.txt\\n+++ b/randovania/games/dread/json_data/Artaria.txt\\n@@ -1856,6 +1856,10 @@ Extra - asset_id: collision_camera_020\\n \\n > Pickup (Phantom Cloak); Heals? False\\n   * Pickup 138; Major Location? True\\n+  * Extra - pickup_type: corpius\\n+  * Extra - actor_def: actors/characters/scorpius/charclasses/scorpius.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_OPTICAL_CAMO\\n+  * Extra - callback_function: OnCutscene0057Finished\\n   > Start Point\\n       Trivial\\n \\n@@ -2801,6 +2805,10 @@ Extra - asset_id: collision_camera_049\\n \\n > Pickup (Spider Magnet); Heals? False\\n   * Pickup 139; Major Location? True\\n+  * Extra - actor_def: actors/characters/emmycave/charclasses/emmycave.bmsad\\n+  * Extra - pickup_type: emmi\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_SPIDER_MAGNET\\n+  * Extra - callback_function: OnEmmyCaveDead\\n   > Door to collision_camera_017 (A) (Bottom)\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/Cataris.json b/randovania/games/dread/json_data/Cataris.json\\nindex c62c28db23..0ed7e05602 100644\\n--- a/randovania/games/dread/json_data/Cataris.json\\n+++ b/randovania/games/dread/json_data/Cataris.json\\n@@ -14642,7 +14642,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmymagma/charclasses/emmymagma.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_MORPH_BALL\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmyMagmaDead\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 144,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Cataris.txt b/randovania/games/dread/json_data/Cataris.txt\\nindex 20be3c6671..4e4f743c1f 100644\\n--- a/randovania/games/dread/json_data/Cataris.txt\\n+++ b/randovania/games/dread/json_data/Cataris.txt\\n@@ -2735,6 +2735,10 @@ Extra - asset_id: collision_camera_036\\n \\n > Pickup (Morph Ball); Heals? False\\n   * Pickup 144; Major Location? True\\n+  * Extra - pickup_type: emmi\\n+  * Extra - actor_def: actors/characters/emmymagma/charclasses/emmymagma.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_MORPH_BALL\\n+  * Extra - callback_function: OnEmmyMagmaDead\\n   > Door to Central Unit Room\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/Dairon.json b/randovania/games/dread/json_data/Dairon.json\\nindex efb54e719b..7c5033f494 100644\\n--- a/randovania/games/dread/json_data/Dairon.json\\n+++ b/randovania/games/dread/json_data/Dairon.json\\n@@ -14734,7 +14734,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmylab/charclasses/emmylab.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRE_SPEED_BOOSTER\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmyLabDead\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 147,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Dairon.txt b/randovania/games/dread/json_data/Dairon.txt\\nindex a0c5dccec0..2ec5e7be4a 100644\\n--- a/randovania/games/dread/json_data/Dairon.txt\\n+++ b/randovania/games/dread/json_data/Dairon.txt\\n@@ -3052,6 +3052,10 @@ Extra - asset_id: collision_camera_040\\n \\n > Pickup (Speedbooster); Heals? False\\n   * Pickup 147; Major Location? True\\n+  * Extra - pickup_type: emmi\\n+  * Extra - actor_def: actors/characters/emmylab/charclasses/emmylab.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRE_SPEED_BOOSTER\\n+  * Extra - callback_function: OnEmmyLabDead\\n   > Door to Central Unit Room\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/Ferenia.json b/randovania/games/dread/json_data/Ferenia.json\\nindex 606a814e84..a9b9af8ed0 100644\\n--- a/randovania/games/dread/json_data/Ferenia.json\\n+++ b/randovania/games/dread/json_data/Ferenia.json\\n@@ -10318,7 +10318,13 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"corex\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/core_x_superquetzoa/charclasses/core_x_superquetzoa.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_MULTI_LOCK\\\",\\n+                        \\\"callback_function\\\": \\\"Post_SuperQuetzoa_Dead\\\",\\n+                        \\\"callback_args\\\": 2\\n+                    },\\n                     \\\"pickup_index\\\": 142,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n@@ -13791,7 +13797,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmysanc/charclasses/emmysanc.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_WAVE_BEAM\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmySancDead\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 143,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Ferenia.txt b/randovania/games/dread/json_data/Ferenia.txt\\nindex 19344752d4..5bc856ef1a 100644\\n--- a/randovania/games/dread/json_data/Ferenia.txt\\n+++ b/randovania/games/dread/json_data/Ferenia.txt\\n@@ -2177,6 +2177,11 @@ Extra - asset_id: collision_camera_027\\n \\n > Pickup (Storm Missiles); Heals? False\\n   * Pickup 142; Major Location? True\\n+  * Extra - pickup_type: corex\\n+  * Extra - actor_def: actors/characters/core_x_superquetzoa/charclasses/core_x_superquetzoa.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_MULTI_LOCK\\n+  * Extra - callback_function: Post_SuperQuetzoa_Dead\\n+  * Extra - callback_args: 2\\n   > Door to Escue Eyedoor Room\\n       Trivial\\n \\n@@ -2856,6 +2861,10 @@ Extra - asset_id: collision_camera_034\\n \\n > Pickup (Wave Beam); Heals? False\\n   * Pickup 143; Major Location? True\\n+  * Extra - pickup_type: emmi\\n+  * Extra - actor_def: actors/characters/emmysanc/charclasses/emmysanc.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_WAVE_BEAM\\n+  * Extra - callback_function: OnEmmySancDead\\n   > Lower-Right Alcove\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/Ghavoran.json b/randovania/games/dread/json_data/Ghavoran.json\\nindex 6e88bd3fd2..366fa334f8 100644\\n--- a/randovania/games/dread/json_data/Ghavoran.json\\n+++ b/randovania/games/dread/json_data/Ghavoran.json\\n@@ -5519,7 +5519,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmyforest/charclasses/emmyforest.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_ICE_MISSILE\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmyForestDead\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 146,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n@@ -9476,7 +9481,13 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"corex\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/core_x/charclasses/core_x.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_LINE_BOMB\\\",\\n+                        \\\"callback_function\\\": \\\"OnEnter_trigger_LineBoomObtained\\\",\\n+                        \\\"callback_args\\\": 2\\n+                    },\\n                     \\\"pickup_index\\\": 145,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Ghavoran.txt b/randovania/games/dread/json_data/Ghavoran.txt\\nindex 13af0c033c..f65e406421 100644\\n--- a/randovania/games/dread/json_data/Ghavoran.txt\\n+++ b/randovania/games/dread/json_data/Ghavoran.txt\\n@@ -1172,6 +1172,10 @@ Extra - asset_id: collision_camera_019\\n \\n > Pickup (Ice Missiles); Heals? False\\n   * Pickup 146; Major Location? True\\n+  * Extra - pickup_type: emmi\\n+  * Extra - actor_def: actors/characters/emmyforest/charclasses/emmyforest.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_ICE_MISSILE\\n+  * Extra - callback_function: OnEmmyForestDead\\n   > Room Center\\n       Trivial\\n \\n@@ -2037,6 +2041,11 @@ Extra - asset_id: collision_camera_026\\n \\n > Pickup (Cross Bombs); Heals? False\\n   * Pickup 145; Major Location? True\\n+  * Extra - pickup_type: corex\\n+  * Extra - actor_def: actors/characters/core_x/charclasses/core_x.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_LINE_BOMB\\n+  * Extra - callback_function: OnEnter_trigger_LineBoomObtained\\n+  * Extra - callback_args: 2\\n   > Door to Cross Bomb Tutorial\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/Hanubia.json b/randovania/games/dread/json_data/Hanubia.json\\nindex 928376c28c..e64c6e0cb2 100644\\n--- a/randovania/games/dread/json_data/Hanubia.json\\n+++ b/randovania/games/dread/json_data/Hanubia.json\\n@@ -3636,7 +3636,12 @@\\n                         \\\"z\\\": 0.0\\n                     },\\n                     \\\"description\\\": \\\"\\\",\\n-                    \\\"extra\\\": {},\\n+                    \\\"extra\\\": {\\n+                        \\\"pickup_type\\\": \\\"emmi\\\",\\n+                        \\\"actor_def\\\": \\\"actors/characters/emmyshipyard/charclasses/emmyshipyard.bmsad\\\",\\n+                        \\\"string_key\\\": \\\"GUI_ITEM_ACQUIRED_POWER_BOMB\\\",\\n+                        \\\"callback_function\\\": \\\"OnEmmyShipyardAbilityObtained\\\"\\n+                    },\\n                     \\\"pickup_index\\\": 137,\\n                     \\\"major_location\\\": true,\\n                     \\\"connections\\\": {\\n\",\"diff --git a/randovania/games/dread/json_data/Hanubia.txt b/randovania/games/dread/json_data/Hanubia.txt\\nindex f201eb241d..036234b2bf 100644\\n--- a/randovania/games/dread/json_data/Hanubia.txt\\n+++ b/randovania/games/dread/json_data/Hanubia.txt\\n@@ -869,6 +869,10 @@ Extra - asset_id: collision_camera_014\\n \\n > Pickup (Red E.M.M.I.); Heals? False\\n   * Pickup 137; Major Location? True\\n+  * Extra - pickup_type: emmi\\n+  * Extra - actor_def: actors/characters/emmyshipyard/charclasses/emmyshipyard.bmsad\\n+  * Extra - string_key: GUI_ITEM_ACQUIRED_POWER_BOMB\\n+  * Extra - callback_function: OnEmmyShipyardAbilityObtained\\n   > Start Point\\n       Trivial\\n \\n\",\"diff --git a/randovania/games/dread/json_data/header.json b/randovania/games/dread/json_data/header.json\\nindex d0c8dafd92..f1cfd26b42 100644\\n--- a/randovania/games/dread/json_data/header.json\\n+++ b/randovania/games/dread/json_data/header.json\\n@@ -6,7 +6,9 @@\\n             \\\"Nothing\\\": {\\n                 \\\"long_name\\\": \\\"Nothing\\\",\\n                 \\\"max_capacity\\\": 1,\\n-                \\\"extra\\\": {}\\n+                \\\"extra\\\": {\\n+                    \\\"item_id\\\": \\\"ITEM_NONE\\\"\\n+                }\\n             },\\n             \\\"Power\\\": {\\n                 \\\"long_name\\\": \\\"Power Beam\\\",\\n\",\"diff --git a/randovania/games/dread/layout/preset_describer.py b/randovania/games/dread/layout/preset_describer.py\\nindex 50ff470dd0..d490178524 100644\\n--- a/randovania/games/dread/layout/preset_describer.py\\n+++ b/randovania/games/dread/layout/preset_describer.py\\n@@ -3,7 +3,7 @@\\n from randovania.games.dread.layout.dread_configuration import DreadConfiguration\\n from randovania.layout.base.major_items_configuration import MajorItemsConfiguration\\n from randovania.layout.preset_describer import format_params_base, fill_template_strings_from_tree, has_shuffled_item, \\\\\\n-    has_vanilla_item\\n+    has_vanilla_item, message_for_required_mains\\n \\n \\n def dread_format_params(configuration: DreadConfiguration) -> Dict[str, List[str]]:\\n@@ -28,7 +28,13 @@ def dread_format_params(configuration: DreadConfiguration) -> Dict[str, List[str\\n             {f\\\"Elevators/Shuttles: {configuration.elevators.description()}\\\": not configuration.elevators.is_vanilla}\\n         ],\\n         \\\"Game Changes\\\": [\\n-            {\\\"ADAM cutscenes removed\\\": configuration.disable_adam_convos}\\n+            {\\\"ADAM cutscenes removed\\\": configuration.disable_adam_convos},\\n+            message_for_required_mains(\\n+                configuration.ammo_configuration,\\n+                {\\n+                    \\\"Power Bomb needs Main\\\": \\\"Power Bomb Expansion\\\",\\n+                }\\n+            )\\n         ]\\n     }\\n     fill_template_strings_from_tree(template_strings, extra_message_tree)\\n\",\"diff --git a/randovania/games/dread/patcher/open_dread_patcher.py b/randovania/games/dread/patcher/open_dread_patcher.py\\nindex 6f7c55a16c..6c175dc3ee 100644\\n--- a/randovania/games/dread/patcher/open_dread_patcher.py\\n+++ b/randovania/games/dread/patcher/open_dread_patcher.py\\n@@ -1,4 +1,5 @@\\n import json\\n+import logging\\n import os\\n from pathlib import Path\\n from random import Random\\n@@ -9,6 +10,7 @@\\n from randovania.game_description import default_database\\n from randovania.game_description.assignment import PickupTarget\\n from randovania.game_description.resources.item_resource_info import ItemResourceInfo\\n+from randovania.game_description.resources.pickup_entry import ConditionalResources\\n from randovania.game_description.resources.resource_info import CurrentResources\\n from randovania.game_description.world.area_identifier import AreaIdentifier\\n from randovania.game_description.world.node import Node\\n@@ -28,7 +30,10 @@\\n def _get_item_id_for_item(item: ItemResourceInfo) -> str:\\n     if \\\"item_capacity_id\\\" in item.extra:\\n         return item.extra[\\\"item_capacity_id\\\"]\\n-    return item.extra[\\\"item_id\\\"]\\n+    try:\\n+        return item.extra[\\\"item_id\\\"]\\n+    except KeyError as e:\\n+        raise KeyError(f\\\"{item.long_name} has no item ID.\\\") from e\\n \\n \\n class OpenDreadPatcher(Patcher):\\n@@ -76,6 +81,7 @@ def create_patch_data(self, description: LayoutDescription, players_config: Play\\n                           cosmetic_patches: DreadCosmeticPatches):\\n         patches = description.all_patches[players_config.player_index]\\n         db = default_database.game_description_for(RandovaniaGame.METROID_DREAD)\\n+        item_db = default_database.item_database_for_game(RandovaniaGame.METROID_DREAD)\\n         configuration = description.get_preset(players_config.player_index).configuration\\n         assert isinstance(configuration, DreadConfiguration)\\n         rng = Random(description.get_seed_for_player(players_config.player_index))\\n@@ -111,18 +117,29 @@ def _start_point_ref_for(node: Node) -> dict:\\n             except KeyError as e:\\n                 raise KeyError(f\\\"{node} has no extra {e}\\\")\\n \\n-        def _teleporter_ref_for(node: Node) -> dict:\\n+        def _level_name_for(node: Node) -> str:\\n             world = db.world_list.nodes_to_world(node)\\n-            level_name: str = os.path.splitext(os.path.split(world.extra[\\\"asset_id\\\"])[1])[0]\\n+            return os.path.splitext(os.path.split(world.extra[\\\"asset_id\\\"])[1])[0]\\n \\n+        def _teleporter_ref_for(node: Node) -> dict:\\n             try:\\n                 return {\\n-                    \\\"scenario\\\": level_name,\\n+                    \\\"scenario\\\": _level_name_for(node),\\n                     \\\"layer\\\": node.extra.get(\\\"actor_layer\\\", \\\"default\\\"),\\n                     \\\"actor\\\": node.extra[\\\"actor_name\\\"],\\n                 }\\n             except KeyError as e:\\n                 raise KeyError(f\\\"{node} has no extra {e}\\\")\\n+        \\n+        def _callback_ref_for(node: Node) -> dict:\\n+            try:\\n+                return {\\n+                    \\\"scenario\\\": _level_name_for(node),\\n+                    \\\"function\\\": node.extra[\\\"callback_function\\\"],\\n+                    \\\"args\\\": node.extra.get(\\\"callback_args\\\", 0)\\n+                }\\n+            except KeyError as e:\\n+                raise KeyError(f\\\"{node} has no extra {e}\\\")\\n \\n         def _pickup_detail_for_target(detail: ExportedPickupDetails) -> Optional[dict]:\\n             # target.\\n@@ -131,29 +148,65 @@ def _pickup_detail_for_target(detail: ExportedPickupDetails) -> Optional[dict]:\\n                 model_name = \\\"itemsphere\\\"\\n             else:\\n                 model_name = detail.model.name\\n-\\n-            item_id = \\\"ITEM_NONE\\\"\\n-            quantity = 1\\n-            for r, q in detail.conditional_resources[0].resources:\\n-                try:\\n-                    item_id = _get_item_id_for_item(r)\\n-                    quantity = q\\n-                    break\\n-                except KeyError:\\n-                    continue\\n-\\n-            if item_id is None:\\n-                raise ValueError(f\\\"Missing item id: {detail.hud_text}\\\")\\n+            \\n+            ammoconfig = configuration.ammo_configuration.items_state\\n+            pbammo = item_db.ammo[\\\"Power Bomb Expansion\\\"]\\n+\\n+            def get_resource(res: ConditionalResources) -> dict:\\n+                item_id = \\\"ITEM_NONE\\\"\\n+                quantity = 1\\n+                ids = [_get_item_id_for_item(r) for r, q in res.resources]\\n+                for r, q in res.resources:\\n+                    try:\\n+                        item_id = _get_item_id_for_item(r)\\n+                        quantity = q\\n+                        break\\n+                    except KeyError:\\n+                        continue\\n+                \\n+                if \\\"ITEM_WEAPON_POWER_BOMB\\\" in ids:\\n+                    item_id = \\\"ITEM_WEAPON_POWER_BOMB\\\"\\n+                \\n+                # non-required mains\\n+                if (item_id == \\\"ITEM_WEAPON_POWER_BOMB_MAX\\\"\\n+                    and not ammoconfig[pbammo].requires_major_item):\\n+                    item_id = \\\"ITEM_WEAPON_POWER_BOMB\\\"\\n+\\n+                return {\\\"item_id\\\": item_id, \\\"quantity\\\": quantity}\\n+            \\n+            # ugly hack\\n+            resources = [get_resource(res) for res in detail.conditional_resources]\\n+            if resources[0][\\\"item_id\\\"] == \\\"ITEM_WEAPON_POWER_BOMB_MAX\\\":\\n+                resources = [resources[-1]]\\n+\\n+            pickup_node = db.world_list.node_from_pickup_index(detail.index)\\n+            pickup_type = pickup_node.extra.get(\\\"pickup_type\\\", \\\"actor\\\")\\n+\\n+            hud_text = detail.hud_text[0]\\n+            if len(detail.hud_text) > 1:\\n+                hud_text = DreadAcquiredMemo()[detail.original_pickup.name]\\n+\\n+            details = {\\n+                \\\"pickup_type\\\": pickup_type,\\n+                \\\"caption\\\": hud_text,\\n+                \\\"resources\\\": resources\\n+            }\\n \\n             try:\\n-                return {\\n-                    \\\"pickup_actor\\\": _teleporter_ref_for(db.world_list.node_from_pickup_index(detail.index)),\\n-                    \\\"caption\\\": \\\"\\\\n\\\".join(detail.hud_text),\\n-                    \\\"item_id\\\": item_id,\\n-                    \\\"quantity\\\": quantity,\\n-                    \\\"model\\\": model_name,\\n-                }\\n-            except KeyError:\\n+                if pickup_type == \\\"actor\\\":\\n+                    details.update({\\n+                        \\\"pickup_actor\\\": _teleporter_ref_for(pickup_node),\\n+                        \\\"model\\\": model_name,\\n+                    })\\n+                else:\\n+                    details.update({\\n+                        \\\"pickup_actordef\\\": pickup_node.extra[\\\"actor_def\\\"],\\n+                        \\\"pickup_string_key\\\": pickup_node.extra[\\\"string_key\\\"],\\n+                        \\\"pickup_lua_callback\\\": _callback_ref_for(pickup_node),\\n+                    })\\n+                return details\\n+            except KeyError as e:\\n+                logging.warn(e)\\n                 return None\\n \\n         starting_location = _start_point_ref_for(_node_for(patches.starting_location))\\n@@ -169,7 +222,7 @@ def _pickup_detail_for_target(detail: ExportedPickupDetails) -> Optional[dict]:\\n             rng,\\n             configuration.pickup_model_style,\\n             configuration.pickup_model_data_source,\\n-            exporter=pickup_exporter.create_pickup_exporter(db, pickup_exporter.GenericAcquiredMemo(), players_config),\\n+            exporter=pickup_exporter.create_pickup_exporter(db, DreadAcquiredMemo(), players_config),\\n             visual_etm=pickup_creator.create_visual_etm(),\\n         )\\n \\n@@ -197,3 +250,7 @@ def patch_game(self, input_file: Optional[Path], output_file: Path, patch_data:\\n         with output_file.joinpath(\\\"patcher.json\\\").open(\\\"w\\\") as f:\\n             json.dump(patch_data, f, indent=4)\\n         open_dread_rando.patch(input_file, output_file, patch_data)\\n+\\n+class DreadAcquiredMemo(dict):\\n+    def __missing__(self, key):\\n+        return \\\"{} acquired.\\\".format(key)\\n\\\\ No newline at end of file\\n\",\"diff --git a/randovania/patching/prime/patcher_file_lib/pickup_exporter.py b/randovania/patching/prime/patcher_file_lib/pickup_exporter.py\\nindex 2cbe79a5f5..3039e9785e 100644\\n--- a/randovania/patching/prime/patcher_file_lib/pickup_exporter.py\\n+++ b/randovania/patching/prime/patcher_file_lib/pickup_exporter.py\\n@@ -131,6 +131,7 @@ class ExportedPickupDetails:\\n     conversion: List[ResourceConversion]\\n     model: PickupModel\\n     other_player: bool\\n+    original_pickup: PickupEntry\\n \\n \\n class PickupExporter:\\n@@ -180,6 +181,7 @@ def create_details(self,\\n             conversion=list(pickup.convert_resources),\\n             model=model,\\n             other_player=False,\\n+            original_pickup=pickup,\\n         )\\n \\n \\n@@ -217,6 +219,7 @@ def create_details(self,\\n                 conversion=[],\\n                 model=model,\\n                 other_player=True,\\n+                original_pickup=pickup_target.pickup,\\n             )\\n \\n \\n\",\"diff --git a/requirements-small.txt b/requirements-small.txt\\nindex 72a02f7c16..cd4b25c20f 100644\\n--- a/requirements-small.txt\\n+++ b/requirements-small.txt\\n@@ -20,13 +20,13 @@ idna==3.3\\n kiwisolver==1.3.2\\n Markdown==3.3.6\\n matplotlib==3.5.1\\n-mercury-engine-data-structures==0.9.5\\n+mercury-engine-data-structures==0.9.6\\n mp2hudcolor==1.0.11\\n multidict==6.0.2\\n networkx==2.6.3\\n nod==1.6.0\\n numpy==1.22.1\\n-open-dread-rando==0.3.0\\n+open-dread-rando==0.4.0\\n pid==3.0.4\\n Pillow==9.0.1\\n psutil==5.9.0\\n\",\"diff --git a/requirements.txt b/requirements.txt\\nindex 83a094263b..79d694546d 100644\\n--- a/requirements.txt\\n+++ b/requirements.txt\\n@@ -42,7 +42,7 @@ kiwisolver==1.3.2\\n Markdown==3.3.6\\n MarkupSafe==2.0.1\\n matplotlib==3.5.1\\n-mercury-engine-data-structures==0.9.5\\n+mercury-engine-data-structures==0.9.6\\n mock==4.0.3\\n mp2hudcolor==1.0.11\\n multidict==6.0.2\\n@@ -50,7 +50,7 @@ networkx==2.6.3\\n nod==1.6.0\\n numpy==1.22.1\\n oauthlib==3.2.0\\n-open-dread-rando==0.3.0\\n+open-dread-rando==0.4.0\\n packaging==21.3\\n peewee==3.14.8\\n pefile==2021.9.3\\n\",\"diff --git a/setup.cfg b/setup.cfg\\nindex 78f4961e12..150ae7b9b6 100644\\n--- a/setup.cfg\\n+++ b/setup.cfg\\n@@ -40,7 +40,7 @@ install_requires =\\n     mp2hudcolor>=1.0.10\\n     retro-data-structures>=0.6.0\\n     SuperDuperMetroid>=1.2.0\\n-    open-dread-rando>=0.3.0\\n+    open-dread-rando>=0.4.0\\n     cave-story-randomizer>=1.0.0\\n     tsc-utils>=0.2.0\\n \\n\",\"diff --git a/setup.py b/setup.py\\nindex c43365e7d1..4ae720cf74 100644\\n--- a/setup.py\\n+++ b/setup.py\\n@@ -32,7 +32,7 @@ def version_scheme(version):\\n     Path(version.config.absolute_root).joinpath(\\\"randovania/version_hash.py\\\").write_text(f\\\"\\\"\\\"# coding: utf-8\\n # file generated by setuptools_scm + setup.py\\n # don't change, don't track in version control\\n-git_hash = {repr(bytes.fromhex(version.node[1:]))}\\n+git_hash = {repr(bytes.fromhex(version.node[1:9]))}\\n \\\"\\\"\\\")\\n \\n     if version.exact:\\n\"]", "test_patch": "[\"diff --git a/test/games/patchers/test_randomprime_patcher.py b/test/games/patchers/test_randomprime_patcher.py\\nindex eb2120c930..d0e9df72b5 100644\\n--- a/test/games/patchers/test_randomprime_patcher.py\\n+++ b/test/games/patchers/test_randomprime_patcher.py\\n@@ -31,6 +31,7 @@ def test_prime1_pickup_details_to_patcher_shiny_missile(prime1_resource_database\\n         conversion=[],\\n         model=PickupModel(RandovaniaGame.METROID_PRIME, \\\"Missile\\\"),\\n         other_player=other_player,\\n+        original_pickup=None,\\n     )\\n     if other_player:\\n         shiny_stuff = {\\n\",\"diff --git a/test/games/prime/patcher_file_lib/test_pickup_exporter.py b/test/games/prime/patcher_file_lib/test_pickup_exporter.py\\nindex 08ddeef995..456fed1988 100644\\n--- a/test/games/prime/patcher_file_lib/test_pickup_exporter.py\\n+++ b/test/games/prime/patcher_file_lib/test_pickup_exporter.py\\n@@ -153,6 +153,7 @@ def test_create_pickup_list(model_style: PickupModelStyle, empty_patches, generi\\n         conversion=[],\\n         model=model_1 if model_style == PickupModelStyle.ALL_VISIBLE else useless_model,\\n         other_player=False,\\n+        original_pickup=pickup_a,\\n     )\\n     assert result[1] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(1),\\n@@ -162,6 +163,7 @@ def test_create_pickup_list(model_style: PickupModelStyle, empty_patches, generi\\n         conversion=[],\\n         model=model_0 if model_style == PickupModelStyle.ALL_VISIBLE else useless_model,\\n         other_player=False,\\n+        original_pickup=useless_pickup,\\n     )\\n     assert result[2] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(2),\\n@@ -175,6 +177,7 @@ def test_create_pickup_list(model_style: PickupModelStyle, empty_patches, generi\\n         conversion=[],\\n         model=model_2 if model_style == PickupModelStyle.ALL_VISIBLE else useless_model,\\n         other_player=False,\\n+        original_pickup=pickup_b,\\n     )\\n     assert result[3] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(3),\\n@@ -184,6 +187,7 @@ def test_create_pickup_list(model_style: PickupModelStyle, empty_patches, generi\\n         conversion=[],\\n         model=model_1 if model_style == PickupModelStyle.ALL_VISIBLE else useless_model,\\n         other_player=False,\\n+        original_pickup=pickup_a,\\n     )\\n     assert result[4] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(4),\\n@@ -195,6 +199,7 @@ def test_create_pickup_list(model_style: PickupModelStyle, empty_patches, generi\\n         conversion=[ResourceConversion(source=useless_resource, target=resource_a)],\\n         model=model_2 if model_style == PickupModelStyle.ALL_VISIBLE else useless_model,\\n         other_player=False,\\n+        original_pickup=pickup_c,\\n     )\\n \\n \\n@@ -267,6 +272,7 @@ def test_create_pickup_list_random_data_source(has_memo_data: bool, empty_patche\\n         conversion=[],\\n         model=model_1,\\n         other_player=False,\\n+        original_pickup=pickup_a,\\n     )\\n     assert result[1] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(1),\\n@@ -276,6 +282,7 @@ def test_create_pickup_list_random_data_source(has_memo_data: bool, empty_patche\\n         conversion=[],\\n         model=model_1,\\n         other_player=False,\\n+        original_pickup=useless_pickup,\\n     )\\n     assert result[2] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(2),\\n@@ -288,6 +295,7 @@ def test_create_pickup_list_random_data_source(has_memo_data: bool, empty_patche\\n         conversion=[],\\n         model=model_2,\\n         other_player=False,\\n+        original_pickup=pickup_b,\\n     )\\n     assert result[3] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(3),\\n@@ -297,6 +305,7 @@ def test_create_pickup_list_random_data_source(has_memo_data: bool, empty_patche\\n         conversion=[],\\n         model=model_2,\\n         other_player=False,\\n+        original_pickup=pickup_a,\\n     )\\n     assert result[4] == pickup_exporter.ExportedPickupDetails(\\n         index=PickupIndex(4),\\n@@ -306,6 +315,7 @@ def test_create_pickup_list_random_data_source(has_memo_data: bool, empty_patche\\n         conversion=[],\\n         model=model_1,\\n         other_player=False,\\n+        original_pickup=pickup_c,\\n     )\\n \\n \\n@@ -373,6 +383,7 @@ def test_solo_create_pickup_data(pickup_for_create_pickup_data):\\n         conversion=[],\\n         model=model,\\n         other_player=False,\\n+        original_pickup=pickup_for_create_pickup_data,\\n     )\\n \\n \\n@@ -401,6 +412,7 @@ def test_multi_create_pickup_data_for_self(pickup_for_create_pickup_data):\\n         conversion=[],\\n         model=model,\\n         other_player=False,\\n+        original_pickup=pickup_for_create_pickup_data,\\n     )\\n \\n \\n@@ -429,4 +441,5 @@ def test_multi_create_pickup_data_for_other(pickup_for_create_pickup_data):\\n         conversion=[],\\n         model=model,\\n         other_player=True,\\n+        original_pickup=pickup_for_create_pickup_data,\\n     )\\n\",\"diff --git a/test/games/prime/test_patcher_file.py b/test/games/prime/test_patcher_file.py\\nindex 17b078633e..18767f0278 100644\\n--- a/test/games/prime/test_patcher_file.py\\n+++ b/test/games/prime/test_patcher_file.py\\n@@ -443,6 +443,7 @@ def test_run_validated_hud_text():\\n             name=\\\"EnergyTransferModule\\\",\\n         ),\\n         other_player=False,\\n+        original_pickup=None,\\n     )\\n \\n     # Run\"]", "hints_text": ""}
