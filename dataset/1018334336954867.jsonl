{"instance_id": "1018334336954867", "repo": "hitsz-ids/duetector", "base_commit": "2b75221450f8e98890e6ad4c641f61e4288ffddf", "problem_statement": "Build PIP Server:\\n> Policy Information Point (PIP): Serves as the retrieval source of attributes, or the data required for policy evaluation to provide the information needed by the PDP to make the decisions. NIST SP 800-162.\\r\\n\\r\\nIn version 0.1.0 we will provide the base PIP service, which should not be limited to the existing `tracer` and `collector` implementations, and I think we should introduce an indirection layer to isolate the PIP service from the existing `trace`/`collection` mechanisms. And maybe this indirection layer is what's called an `analyzer`.\\r\\n\\r\\n- [x] #40\\r\\n- [x] #50\\r\\n- [x] #41\\r\\n- [ ] #59\\nPIP Server Implementation:\\n", "FAIL_TO_PASS": ["tests/test_db_analyzer.py::test_brief"], "PASS_TO_PASS": ["tests/test_filter.py::test_filter[data_args5-False]", "tests/test_sh_monitor.py::test_sh_monitor", "tests/test_config.py::test_generate", "tests/test_daemon.py::test_daemon", "tests/test_filter.py::test_filter[data_args2-False]", "tests/test_filter.py::test_filter[data_args1-False]", "tests/test_filter.py::test_filter[data_args3-False]", "tests/test_filter.py::test_filter[data_args0-True]", "tests/test_filter.py::test_filter_envs[data_args1-False]", "tests/test_config.py::test_config", "tests/test_bcc_monitor.py::test_bcc_monitor", "tests/test_collector.py::test_dbcollector", "tests/test_filter.py::test_filter_envs[data_args0-True]", "tests/test_filter.py::test_filter_envs[data_args2-False]", "tests/test_db_analyzer.py::test_query", "tests/test_repo.py::test_repo_config_uptodate", "tests/test_config.py::test_load_env", "tests/test_filter.py::test_filter[data_args4-False]", "tests/test_poller.py::test_poller"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/hitsz-ids_duetector:2b75221450f8e98890e6ad4c641f61e4288ffddf", "patch": "[\"diff --git a/.coveragerc b/.coveragerc\\nnew file mode 100644\\nindex 0000000..a12e979\\n--- /dev/null\\n+++ b/.coveragerc\\n@@ -0,0 +1,2 @@\\n+[run]\\n+omit = duetector/cli/*\\n\",\"diff --git a/dev-tools/entrypoint-server.py b/dev-tools/entrypoint-server.py\\nindex 01d09ed..2d03e4d 100644\\n--- a/dev-tools/entrypoint-server.py\\n+++ b/dev-tools/entrypoint-server.py\\n@@ -1,5 +1,7 @@\\n import os\\n \\n+import importlib_metadata\\n+\\n os.chdir(os.path.dirname(os.path.abspath(__file__)))\\n os.environ[\\\"DUETECTOR_LOG_LEVEL\\\"] = \\\"DEBUG\\\"\\n \\n@@ -7,7 +9,14 @@ import re\\n import sys\\n from pathlib import Path\\n \\n-from pkg_resources import load_entry_point\\n+\\n+def load_entry_point(distribution, group, name):\\n+    dist_obj = importlib_metadata.distribution(distribution)\\n+    eps = [ep for ep in dist_obj.entry_points if ep.group == group and ep.name == name]\\n+    if not eps:\\n+        raise ImportError(\\\"Entry point %r not found\\\" % ((group, name),))\\n+    return eps[0].load()\\n+\\n \\n db_file = Path(\\\"./duetector-dbcollector.sqlite3\\\")\\n config_file = Path(\\\"./config.toml\\\")\\n\",\"diff --git a/dev-tools/entrypoint.py b/dev-tools/entrypoint.py\\nindex e638dff..7d4a4d8 100644\\n--- a/dev-tools/entrypoint.py\\n+++ b/dev-tools/entrypoint.py\\n@@ -1,5 +1,7 @@\\n import os\\n \\n+import importlib_metadata\\n+\\n os.chdir(os.path.dirname(os.path.abspath(__file__)))\\n os.environ[\\\"DUETECTOR_LOG_LEVEL\\\"] = \\\"DEBUG\\\"\\n \\n@@ -7,7 +9,14 @@ import re\\n import sys\\n from pathlib import Path\\n \\n-from pkg_resources import load_entry_point\\n+\\n+def load_entry_point(distribution, group, name):\\n+    dist_obj = importlib_metadata.distribution(distribution)\\n+    eps = [ep for ep in dist_obj.entry_points if ep.group == group and ep.name == name]\\n+    if not eps:\\n+        raise ImportError(\\\"Entry point %r not found\\\" % ((group, name),))\\n+    return eps[0].load()\\n+\\n \\n db_file = Path(\\\"./duetector-dbcollector.sqlite3\\\")\\n config_file = Path(\\\"./config.toml\\\")\\n\",\"diff --git a/duetector/analyzer/base.py b/duetector/analyzer/base.py\\nindex 52600d5..8c5c8b9 100644\\n--- a/duetector/analyzer/base.py\\n+++ b/duetector/analyzer/base.py\\n@@ -82,6 +82,7 @@ class Analyzer(Configuable):\\n         end_datetime: Optional[datetime] = None,\\n         with_details: bool = True,\\n         distinct: bool = False,\\n+        inspect_type: bool = False,\\n     ) -> AnalyzerBrief:\\n         \\\"\\\"\\\"\\n         Get a brief of this analyzer.\\n@@ -97,6 +98,7 @@ class Analyzer(Configuable):\\n             end_datetime (Optional[datetime], optional): End time. Defaults to None.\\n             with_details (bool, optional): With details. Defaults to True.\\n             distinct (bool, optional): Distinct. Defaults to False.\\n+            inspect_type (bool, optional): Weather fileds's value is type or type name. Defaults to False, type name.\\n \\n         Returns:\\n             AnalyzerBrief: A brief of this analyzer.\\n\",\"diff --git a/duetector/analyzer/db.py b/duetector/analyzer/db.py\\nindex 5e8a3b2..df9fdee 100644\\n--- a/duetector/analyzer/db.py\\n+++ b/duetector/analyzer/db.py\\n@@ -6,6 +6,7 @@ from sqlalchemy import func, select\\n from duetector.analyzer.base import Analyzer\\n from duetector.analyzer.models import AnalyzerBrief, Brief, Tracking\\n from duetector.db import SessionManager\\n+from duetector.log import logger\\n \\n \\n class DBAnalyzer(Analyzer):\\n@@ -140,6 +141,7 @@ class DBAnalyzer(Analyzer):\\n             if order_by_desc:\\n                 statm = statm.order_by(*[getattr(m, k).desc() for k in order_by_desc])\\n \\n+            logger.debug(f\\\"Querying {tracer}@{collector_id} with statm: {statm}\\\")\\n             with self.sm.begin() as session:\\n                 r.extend(\\n                     [\\n@@ -174,6 +176,7 @@ class DBAnalyzer(Analyzer):\\n         start_datetime: Optional[datetime] = None,\\n         end_datetime: Optional[datetime] = None,\\n         inspect: bool = True,\\n+        inspect_type: bool = False,\\n         distinct: bool = False,\\n     ) -> Brief:\\n         \\\"\\\"\\\"\\n@@ -191,7 +194,12 @@ class DBAnalyzer(Analyzer):\\n         m = self.sm.get_tracking_model(tracer, collector_id)\\n \\n         if not inspect:\\n-            return Brief(tracer=tracer, collector_id=collector_id, fields=m.inspect_fields())\\n+            logger.debug(f\\\"Briefing {tracer}@{collector_id} without inspect\\\")\\n+            return Brief(\\n+                tracer=tracer,\\n+                collector_id=collector_id,\\n+                fields=m.inspect_fields(value_as_type=inspect_type),\\n+            )\\n         columns = m.inspect_fields().keys()\\n         statm = select(*[getattr(m, k) for k in columns])\\n         if distinct:\\n@@ -204,6 +212,7 @@ class DBAnalyzer(Analyzer):\\n         start_statm = statm.order_by(m.dt.asc())\\n         end_statm = statm.order_by(m.dt.desc())\\n         count_statm = select(func.count()).select_from(statm.subquery())\\n+        logger.debug(f\\\"Briefing {tracer}@{collector_id} with statm: {start_statm}\\\")\\n         with self.sm.begin() as session:\\n             start_tracking = self._convert_row_to_tracking(\\n                 columns, session.execute(start_statm).first(), tracer\\n@@ -218,7 +227,7 @@ class DBAnalyzer(Analyzer):\\n                 start=start_tracking.dt,\\n                 end=end_tracking.dt,\\n                 count=session.execute(count_statm).scalar(),\\n-                fields=m.inspect_fields(),\\n+                fields=m.inspect_fields(value_as_type=inspect_type),\\n             )\\n \\n     def _convert_row_to_tracking(self, columns: List[str], row: Any, tracer: str) -> Tracking:\\n@@ -246,6 +255,7 @@ class DBAnalyzer(Analyzer):\\n         end_datetime: Optional[datetime] = None,\\n         with_details: bool = True,\\n         distinct: bool = False,\\n+        inspect_type: bool = False,\\n     ) -> AnalyzerBrief:\\n         \\\"\\\"\\\"\\n         Get a brief of this analyzer.\\n@@ -265,15 +275,21 @@ class DBAnalyzer(Analyzer):\\n         Returns:\\n             AnalyzerBrief: A brief of this analyzer.\\n         \\\"\\\"\\\"\\n+\\n         tables = self.sm.inspect_all_tables()\\n         if tracers:\\n             tables = [t for t in tables if self.sm.table_name_to_tracer(t) in tracers]\\n         if collector_ids:\\n             tables = [t for t in tables if self.sm.table_name_to_collector_id(t) in collector_ids]\\n \\n-        briefs = [\\n+        briefs: List[Brief] = [\\n             self._table_brief(\\n-                t, start_datetime, end_datetime, inspect=with_details, distinct=distinct\\n+                t,\\n+                start_datetime,\\n+                end_datetime,\\n+                inspect=with_details,\\n+                distinct=distinct,\\n+                inspect_type=inspect_type,\\n             )\\n             for t in tables\\n         ]\\n@@ -281,5 +297,5 @@ class DBAnalyzer(Analyzer):\\n         return AnalyzerBrief(\\n             tracers=set([brief.tracer for brief in briefs]),\\n             collector_ids=set([brief.collector_id for brief in briefs]),\\n-            briefs=briefs,\\n+            briefs={f\\\"{brief.tracer}@{brief.collector_id}\\\": brief for brief in briefs},\\n         )\\n\",\"diff --git a/duetector/analyzer/models.py b/duetector/analyzer/models.py\\nindex da50e1d..1093278 100644\\n--- a/duetector/analyzer/models.py\\n+++ b/duetector/analyzer/models.py\\n@@ -68,7 +68,7 @@ class Brief(pydantic.BaseModel):\\n     fields: Dict[str, Any] = {}\\n \\n     def __repr__(self):\\n-        fields_repr = \\\", \\\".join([f\\\"{k}: {v.__name__}\\\" for k, v in self.fields.items()])\\n+        fields_repr = \\\", \\\".join([f\\\"{k}: {v}\\\" for k, v in self.fields.items()])\\n \\n         s = f\\\"\\\"\\\"\\n {self.tracer}@{self.collector_id} with {self.count} records\\n@@ -97,10 +97,12 @@ class AnalyzerBrief(pydantic.BaseModel):\\n     Set of collector ids\\n     \\\"\\\"\\\"\\n \\n-    briefs: List[Brief]\\n+    briefs: Dict[str, Brief]\\n \\n     def __repr__(self):\\n-        briefs_repr = \\\"\\\\n\\\".join([f\\\"\\\\n----------------{b}----------------\\\" for b in self.briefs])\\n+        briefs_repr = \\\"\\\\n\\\".join(\\n+            [f\\\"\\\\n----------------{b}----------------\\\" for b in self.briefs.values()]\\n+        )\\n         s = f\\\"\\\"\\\"\\n Available tracers: {self.tracers}\\n Available collector ids: {self.collector_ids}\\n\",\"diff --git a/duetector/cli/main.py b/duetector/cli/main.py\\nindex 75d8830..2654f6f 100644\\n--- a/duetector/cli/main.py\\n+++ b/duetector/cli/main.py\\n@@ -170,7 +170,7 @@ def start(\\n         if brief:\\n             try:\\n                 logger.info(\\\"Generating brief...\\\")\\n-                logger.info(str(DBAnalyzer(c).brief()))\\n+                logger.info(str(DBAnalyzer(c).brief(inspect_type=False)))\\n             except Exception as e:\\n                 logger.error(\\\"Exception when generating brief\\\")\\n                 logger.exception(e)\\n\",\"diff --git a/duetector/db.py b/duetector/db.py\\nindex ebcf18e..5cd4bd9 100644\\n--- a/duetector/db.py\\n+++ b/duetector/db.py\\n@@ -61,10 +61,10 @@ class TrackingInterface:\\n         raise NotImplementedError\\n \\n     @classmethod\\n-    def inspect_fields(cls) -> Dict[str, Any]:\\n-        \\\"\\\"\\\"\\n-        Inspect fields of this model.\\n-        \\\"\\\"\\\"\\n+    def inspect_fields(\\n+        cls,\\n+        value_as_type: bool = False,\\n+    ) -> Dict[str, Any]:\\n         raise NotImplementedError\\n \\n \\n@@ -210,6 +210,8 @@ class SessionManager(Configuable):\\n         Returns:\\n             type: a sqlalchemy model for tracking\\n         \\\"\\\"\\\"\\n+        if tracer in self._tracking_models:\\n+            return self._tracking_models[tracer]\\n \\n         with self.mutex:\\n             if tracer in self._tracking_models:\\n@@ -248,9 +250,14 @@ class SessionManager(Configuable):\\n                     )\\n \\n                 @classmethod\\n-                def inspect_fields(cls) -> Dict[str, Any]:\\n+                def inspect_fields(\\n+                    cls,\\n+                    value_as_type: bool = False,\\n+                ) -> Dict[str, Any]:\\n                     return {\\n-                        c.name: c.type.python_type for c in cls.__table__.columns if c.name != \\\"id\\\"\\n+                        c.name: c.type.python_type if value_as_type else c.type.python_type.__name__\\n+                        for c in cls.__table__.columns\\n+                        if c.name != \\\"id\\\"\\n                     }\\n \\n             try:\\n\",\"diff --git a/duetector/service/app.py b/duetector/service/app.py\\nindex 0a9aeb7..75f8c39 100644\\n--- a/duetector/service/app.py\\n+++ b/duetector/service/app.py\\n@@ -1,13 +1,34 @@\\n-from fastapi import FastAPI\\n+from fastapi import Depends, FastAPI, HTTPException\\n+from fastapi.security import APIKeyQuery\\n+from starlette.status import HTTP_403_FORBIDDEN\\n \\n from duetector.__init__ import __version__\\n+from duetector.service.config import Config, get_server_config\\n from duetector.service.control.routes import r as cr\\n from duetector.service.query.routes import r as qr\\n \\n+\\n+async def verify_token(\\n+    server_config: Config = Depends(get_server_config),\\n+    token: str = Depends(APIKeyQuery(name=\\\"token\\\", auto_error=False)),\\n+):\\n+    if server_config.token and token != server_config.token:\\n+        raise HTTPException(status_code=HTTP_403_FORBIDDEN, detail=\\\"Not authenticated\\\")\\n+\\n+\\n app = FastAPI(\\n     title=\\\"Duetector\\\",\\n     description=\\\"Data Usage Extensible Detector for data usage observability\\\",\\n     version=__version__,\\n+    dependencies=[Depends(verify_token)],\\n )\\n app.include_router(qr)\\n app.include_router(cr)\\n+\\n+\\n+@app.get(\\\"/\\\")\\n+async def root():\\n+    \\\"\\\"\\\"\\n+    Just a simple health check, returns a message.\\n+    \\\"\\\"\\\"\\n+    return {\\\"message\\\": \\\"Hello World\\\"}\\n\",\"diff --git a/duetector/service/base.py b/duetector/service/base.py\\nnew file mode 100644\\nindex 0000000..cd14fcb\\n--- /dev/null\\n+++ b/duetector/service/base.py\\n@@ -0,0 +1,22 @@\\n+from typing import Any, Dict, Optional\\n+\\n+from fastapi import Depends\\n+\\n+from duetector.config import Configuable\\n+from duetector.service.config import get_config\\n+\\n+\\n+class Controller(Configuable):\\n+    config_scope = None\\n+\\n+    default_config = {}\\n+\\n+    def __init__(self, config: Optional[Dict[str, Any]] = None, *args, **kwargs):\\n+        super().__init__(config, *args, **kwargs)\\n+\\n+\\n+def get_controller(controller_type: type):\\n+    def _(config: dict = Depends(get_config)) -> Controller:\\n+        return controller_type(config)\\n+\\n+    return _\\n\",\"diff --git a/duetector/service/config.py b/duetector/service/config.py\\nindex c352135..570c208 100644\\n--- a/duetector/service/config.py\\n+++ b/duetector/service/config.py\\n@@ -1,12 +1,14 @@\\n import os\\n from typing import Any, Dict\\n \\n+from fastapi import Depends\\n+\\n try:\\n     from functools import cache\\n except ImportError:\\n     from functools import lru_cache as cache\\n \\n-from duetector.config import ConfigLoader\\n+from duetector.config import Config, ConfigLoader, Configuable\\n \\n CONFIG_PATH_ENV = \\\"DUETECTOR_SERVER_CONFIG_PATH\\\"\\n \\n@@ -24,3 +26,14 @@ def get_config() -> Dict[str, Any]:\\n         load_env=False,\\n         dump_when_load=False,\\n     ).load_config()\\n+\\n+\\n+class ServerConfig(Configuable):\\n+    config_scope = \\\"server\\\"\\n+    default_config = {\\\"token\\\": \\\"\\\"}\\n+\\n+\\n+def get_server_config(\\n+    config: Dict[str, Any] = Depends(get_config),\\n+) -> Config:\\n+    return ServerConfig(config).config\\n\",\"diff --git a/duetector/service/control/controller.py b/duetector/service/control/controller.py\\nnew file mode 100644\\nindex 0000000..4c55957\\n--- /dev/null\\n+++ b/duetector/service/control/controller.py\\n@@ -0,0 +1,5 @@\\n+from duetector.service.base import Controller\\n+\\n+\\n+class DaemonControler(Controller):\\n+    pass\\n\",\"diff --git a/duetector/service/control/models.py b/duetector/service/control/models.py\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/duetector/service/control/models.py\\n\",\"diff --git a/duetector/service/control/routes.py b/duetector/service/control/routes.py\\nindex 9cac799..ca5042d 100644\\n--- a/duetector/service/control/routes.py\\n+++ b/duetector/service/control/routes.py\\n@@ -4,9 +4,10 @@ from duetector.service.config import get_config\\n \\n r = APIRouter(\\n     prefix=\\\"/control\\\",\\n+    tags=[\\\"control\\\"],\\n )\\n \\n \\n @r.get(\\\"/\\\")\\n async def root(config: dict = Depends(get_config)):\\n-    return config\\n+    pass\\n\",\"diff --git a/duetector/service/exceptions.py b/duetector/service/exceptions.py\\nnew file mode 100644\\nindex 0000000..85b264f\\n--- /dev/null\\n+++ b/duetector/service/exceptions.py\\n@@ -0,0 +1,9 @@\\n+from fastapi import HTTPException\\n+from starlette.status import HTTP_404_NOT_FOUND\\n+\\n+\\n+class NotFoundError(HTTPException):\\n+    def __init__(self, what: str = \\\"\\\"):\\n+        if what:\\n+            what = f\\\"{what} \\\"\\n+        super().__init__(status_code=HTTP_404_NOT_FOUND, detail=f\\\"{what}Not found\\\")\\n\",\"diff --git a/duetector/service/query/controller.py b/duetector/service/query/controller.py\\nnew file mode 100644\\nindex 0000000..fd5a29a\\n--- /dev/null\\n+++ b/duetector/service/query/controller.py\\n@@ -0,0 +1,52 @@\\n+from typing import Any, Dict, List, Optional\\n+\\n+from duetector.analyzer.base import Analyzer\\n+from duetector.analyzer.db import DBAnalyzer\\n+from duetector.service.base import Controller\\n+from duetector.service.exceptions import NotFoundError\\n+\\n+\\n+class AnalyzerController(Controller):\\n+    def __init__(self, config: Optional[Dict[str, Any]] = None, *args, **kwargs):\\n+        super().__init__(config, *args, **kwargs)\\n+\\n+        # TODO: Make this configurable, may intro a manager for analyzer\\n+        self._avaliable_analyzers = [DBAnalyzer]\\n+\\n+        self._analyzers: Dict[str, Analyzer] = {\\n+            analyzer.config_scope: self._init_analyzer(analyzer)\\n+            for analyzer in self._avaliable_analyzers\\n+        }\\n+\\n+    def _init_analyzer(self, analyzer: type):\\n+        analyzer_config = getattr(self.config, analyzer.config_scope)._config_dict\\n+        return analyzer(analyzer_config)\\n+\\n+    @property\\n+    def avaliable_analyzer_names(self) -> List[str]:\\n+        return [a.config_scope for a in self._avaliable_analyzers]\\n+\\n+    def get_analyzer(self, analyzer_name: str) -> Analyzer:\\n+        \\\"\\\"\\\"\\n+        Get analyzer by name\\n+\\n+        Args:\\n+            analyzer_name (str): analyzer name, should be one of avaliable_analyzer_names\\n+\\n+        Raises:\\n+            NotFoundError: if analyzer not found\\n+\\n+        Returns:\\n+            Analyzer: analyzer instance\\n+\\n+        Allow use \\\"-\\\" or \\\"_\\\" in analyzer name, for example, both \\\"db-analyzer\\\" and \\\"db_analyzer\\\" are ok.\\n+\\n+        Examples:\\n+            >>> controller.get_analyzer(\\\"db-analyzer\\\")\\n+        \\\"\\\"\\\"\\n+        a = self._analyzers.get(analyzer_name) or self._analyzers.get(\\n+            analyzer_name.replace(\\\"-\\\", \\\"_\\\")\\n+        )\\n+        if not a:\\n+            raise NotFoundError(analyzer_name)\\n+        return a\\n\",\"diff --git a/duetector/service/query/models.py b/duetector/service/query/models.py\\nnew file mode 100644\\nindex 0000000..c74df63\\n--- /dev/null\\n+++ b/duetector/service/query/models.py\\n@@ -0,0 +1,54 @@\\n+from datetime import datetime\\n+from typing import Any, Dict, List, Optional\\n+\\n+from pydantic import BaseModel\\n+\\n+from duetector.analyzer.models import AnalyzerBrief, Tracking\\n+\\n+\\n+class AvaliableAnalyzers(BaseModel):\\n+    analyzers: List[str]\\n+\\n+\\n+class QueryBody(BaseModel):\\n+    tracers: Optional[List[str]] = None\\n+    collector_ids: Optional[List[str]] = None\\n+    start_datetime: Optional[datetime] = None\\n+    end_datetime: Optional[datetime] = None\\n+    start: int = 0\\n+    limit: int = 0\\n+    columns: Optional[List[str]] = None\\n+    where: Optional[Dict[str, Any]] = None\\n+    distinct: bool = False\\n+    order_by_asc: Optional[List[str]] = None\\n+    order_by_desc: Optional[List[str]] = None\\n+\\n+    model_config = {\\n+        \\\"json_schema_extra\\\": {\\n+            \\\"examples\\\": [\\n+                {\\n+                    \\\"tracers\\\": [],\\n+                    \\\"collector_ids\\\": [],\\n+                    \\\"start_datetime\\\": datetime.fromtimestamp(0),\\n+                    \\\"end_datetime\\\": datetime.now(),\\n+                    \\\"start\\\": 0,\\n+                    \\\"limit\\\": 0,\\n+                    \\\"columns\\\": [],\\n+                    \\\"where\\\": {},\\n+                    \\\"distinct\\\": False,\\n+                    \\\"order_by_asc\\\": [],\\n+                    \\\"order_by_desc\\\": [],\\n+                }\\n+            ]\\n+        }\\n+    }\\n+\\n+\\n+class QueryResult(BaseModel):\\n+    trackings: List[Tracking]\\n+    count: int\\n+\\n+\\n+class BriefResult(BaseModel):\\n+    brief: AnalyzerBrief\\n+    analyzer_name: str\\n\",\"diff --git a/duetector/service/query/routes.py b/duetector/service/query/routes.py\\nindex e8671e7..7700760 100644\\n--- a/duetector/service/query/routes.py\\n+++ b/duetector/service/query/routes.py\\n@@ -1,12 +1,57 @@\\n-from fastapi import APIRouter, Depends\\n+from fastapi import APIRouter, Body, Depends\\n \\n-from duetector.service.config import get_config\\n+from duetector.service.base import get_controller\\n+from duetector.service.query.controller import AnalyzerController\\n+from duetector.service.query.models import (\\n+    AvaliableAnalyzers,\\n+    BriefResult,\\n+    QueryBody,\\n+    QueryResult,\\n+)\\n \\n r = APIRouter(\\n     prefix=\\\"/query\\\",\\n+    tags=[\\\"query\\\"],\\n )\\n \\n \\n-@r.get(\\\"/\\\")\\n-async def root(config: dict = Depends(get_config)):\\n-    return config\\n+@r.get(\\\"/\\\", response_model=AvaliableAnalyzers)\\n+async def root(\\n+    controller: AnalyzerController = Depends(get_controller(AnalyzerController)),\\n+):\\n+    \\\"\\\"\\\"\\n+    Response available analyzer\\n+    \\\"\\\"\\\"\\n+    return AvaliableAnalyzers(analyzers=controller.avaliable_analyzer_names)\\n+\\n+\\n+@r.post(\\\"/{analyzer_name}\\\", response_model=QueryResult)\\n+async def query(\\n+    analyzer_name: str,\\n+    query_param: QueryBody = Body(default=QueryBody()),\\n+    controller: AnalyzerController = Depends(get_controller(AnalyzerController)),\\n+):\\n+    \\\"\\\"\\\"\\n+    Query data from analyzer\\n+    \\\"\\\"\\\"\\n+    analyzer = controller.get_analyzer(analyzer_name)\\n+    trackings = analyzer.query(**query_param.model_dump())\\n+\\n+    return QueryResult(\\n+        trackings=trackings,\\n+        count=len(trackings),\\n+    )\\n+\\n+\\n+@r.get(\\\"/{analyzer_name}/brief\\\", response_model=BriefResult)\\n+async def query_brief(\\n+    analyzer_name: str,\\n+    controller: AnalyzerController = Depends(get_controller(AnalyzerController)),\\n+):\\n+    # type is not serializable, so we need to get analyzer without inspect type\\n+    analyzer = controller.get_analyzer(analyzer_name)\\n+\\n+    return BriefResult(\\n+        brief=analyzer.brief(inspect_type=False),\\n+        analyzer_name=analyzer_name,\\n+    )\\n\",\"diff --git a/duetector/static/config.toml b/duetector/static/config.toml\\nindex c5ea18d..6f5d8d1 100644\\n--- a/duetector/static/config.toml\\n+++ b/duetector/static/config.toml\\n@@ -104,3 +104,6 @@ table_prefix = \\\"duetector_tracking\\\"\\n \\n [db_analyzer.db.engine]\\n url = \\\"sqlite:///duetector-dbcollector.sqlite3\\\"\\n+\\n+[server]\\n+token = \\\"\\\"\\n\",\"diff --git a/duetector/tools/config_generator.py b/duetector/tools/config_generator.py\\nindex 7b6703d..05962e1 100644\\n--- a/duetector/tools/config_generator.py\\n+++ b/duetector/tools/config_generator.py\\n@@ -9,6 +9,7 @@ from duetector.config import ConfigLoader\\n from duetector.log import logger\\n from duetector.managers import CollectorManager, FilterManager, TracerManager\\n from duetector.monitors import BccMonitor, ShMonitor\\n+from duetector.service.config import ServerConfig\\n \\n \\n def _recursive_load(config_scope: str, config_dict: dict, default_config: dict):\\n@@ -62,6 +63,8 @@ class ConfigGenerator:\\n     All analyzers to inspect.\\n     \\\"\\\"\\\"\\n \\n+    others = [ServerConfig]\\n+\\n     def __init__(\\n         self,\\n         load: bool = True,\\n@@ -87,6 +90,9 @@ class ConfigGenerator:\\n \\n         for a in self.analyzer:\\n             _recursive_load(a.config_scope, self.dynamic_config, a.default_config)\\n+\\n+        for o in self.others:\\n+            _recursive_load(o.config_scope, self.dynamic_config, o.default_config)\\n         # This will generate default config file if not exists\\n         if load:\\n             self.loaded_config = ConfigLoader(path, load_env, dump_when_load=False).load_config()\\n\"]", "test_patch": "[\"diff --git a/tests/config.toml b/tests/config.toml\\nindex 7b3dc63..5c04b52 100644\\n--- a/tests/config.toml\\n+++ b/tests/config.toml\\n@@ -71,3 +71,6 @@ table_prefix = \\\"duetector_tracking\\\"\\n \\n [db_analyzer.db.engine]\\n url = \\\"sqlite:///:memory:\\\"\\n+\\n+[server]\\n+token = \\\"\\\"\\n\",\"diff --git a/tests/service/test_token.py b/tests/service/test_token.py\\nnew file mode 100644\\nindex 0000000..3bef7b9\\n--- /dev/null\\n+++ b/tests/service/test_token.py\\n@@ -0,0 +1,24 @@\\n+import pytest\\n+from fastapi.testclient import TestClient\\n+\\n+from duetector.service.app import app\\n+from duetector.service.config import get_config\\n+\\n+app.dependency_overrides = {\\n+    get_config: lambda: {\\n+        \\\"server\\\": {\\n+            \\\"token\\\": \\\"test_token\\\",\\n+        }\\n+    }\\n+}\\n+\\n+\\n+@pytest.fixture\\n+def client():\\n+    with TestClient(app) as client:\\n+        yield client\\n+\\n+\\n+def test_root(client: TestClient):\\n+    response = client.get(\\\"/\\\", params={\\\"token\\\": \\\"test_token\\\"})\\n+    assert response.status_code == 200\\n\",\"diff --git a/pyproject.toml b/pyproject.toml\\nindex 88fdf08..51283ee 100644\\n--- a/pyproject.toml\\n+++ b/pyproject.toml\\n@@ -29,7 +29,7 @@ classifiers = [\\n     'Programming Language :: Python :: 3.11',\\n ]\\n [project.optional-dependencies]\\n-test = [\\\"pytest\\\", \\\"pytest-cov\\\", \\\"pytype\\\"]\\n+test = [\\\"pytest\\\", \\\"pytest-cov\\\", \\\"pytype\\\", \\\"httpx\\\"]\\n docs = [\\\"Sphinx<=7.2.4\\\", \\\"sphinx-rtd-theme\\\", \\\"sphinx-click\\\", \\\"autodoc_pydantic\\\"]\\n \\n [project.scripts]\\n\",\"diff --git a/tests/test_db_analyzer.py b/tests/test_db_analyzer.py\\nindex 1595687..ba4a05f 100644\\n--- a/tests/test_db_analyzer.py\\n+++ b/tests/test_db_analyzer.py\\n@@ -101,8 +101,12 @@ def test_brief(db_analyzer: DBAnalyzer, a_tracking, collector_id):\\n \\n     assert not db_analyzer.brief(tracers=[\\\"not-exist\\\"]).tracers\\n     assert not db_analyzer.brief(collector_ids=[\\\"not-exist\\\"]).collector_ids\\n-    assert not db_analyzer.brief(start_datetime=now + timedelta(days=1)).briefs[0].count\\n-    assert not db_analyzer.brief(end_datetime=now - timedelta(days=1)).briefs[0].count\\n+    assert not list(db_analyzer.brief(start_datetime=now + timedelta(days=1)).briefs.values())[\\n+        0\\n+    ].count\\n+    assert not list(db_analyzer.brief(end_datetime=now - timedelta(days=1)).briefs.values())[\\n+        0\\n+    ].count\\n \\n \\n if __name__ == \\\"__main__\\\":\\n\",\"diff --git a/tests/config.toml b/tests/config.toml\\nindex 5c04b52..72129ac 100644\\n--- a/tests/config.toml\\n+++ b/tests/config.toml\\n@@ -7,7 +7,7 @@\\n \\n [filter]\\n disabled = false\\n-\\n+include_extension = true\\n \\n [filter.patternfilter]\\n disabled = false\\n@@ -31,6 +31,16 @@ re_exclude_gcustom = [\\\"ignore_custom*\\\"]\\n \\n [tracer]\\n disabled = false\\n+include_extension = true\\n+\\n+[tracer.clonetracer]\\n+disabled = false\\n+attach_event = \\\"__x64_sys_clone\\\"\\n+poll_timeout = 10\\n+\\n+[tracer.tcpconnecttracer]\\n+disabled = false\\n+poll_timeout = 10\\n \\n [tracer.unametracer]\\n disabled = false\\n@@ -38,14 +48,20 @@ enable_cache = true\\n \\n [tracer.opentracer]\\n disabled = false\\n+attach_event = \\\"do_sys_openat2\\\"\\n+poll_timeout = 10\\n \\n [collector]\\n disabled = false\\n+include_extension = true\\n \\n [collector.dbcollector]\\n disabled = false\\n id = \\\"unittest\\\"\\n \\n+[collector.dbcollector.backend_args]\\n+max_workers = 10\\n+\\n [collector.dbcollector.db]\\n table_prefix = \\\"duetector_tracking\\\"\\n \\n@@ -57,15 +73,31 @@ disabled = true\\n id = \\\"unittest\\\"\\n maxlen = 1024\\n \\n+[collector.dequecollector.backend_args]\\n+max_workers = 10\\n+\\n [monitor.bcc]\\n disabled = false\\n auto_init = true\\n+continue_on_exception = true\\n+\\n+[monitor.bcc.backend_args]\\n+max_workers = 10\\n+\\n+[monitor.bcc.poller]\\n+interval_ms = 500\\n \\n [monitor.sh]\\n disabled = false\\n auto_init = true\\n timeout = 5\\n \\n+[monitor.sh.backend_args]\\n+max_workers = 10\\n+\\n+[monitor.sh.poller]\\n+interval_ms = 500\\n+\\n [db_analyzer.db]\\n table_prefix = \\\"duetector_tracking\\\"\\n \\n\",\"diff --git a/tests/service/test_query.py b/tests/service/test_query.py\\nnew file mode 100644\\nindex 0000000..48378a0\\n--- /dev/null\\n+++ b/tests/service/test_query.py\\n@@ -0,0 +1,40 @@\\n+import pytest\\n+from fastapi.testclient import TestClient\\n+\\n+from duetector.analyzer.db import DBAnalyzer\\n+from duetector.service.app import app\\n+from duetector.service.config import get_config\\n+\\n+\\n+@pytest.fixture\\n+def configed_app(full_config):\\n+    app.dependency_overrides = {get_config: lambda: full_config}\\n+    return app\\n+\\n+\\n+@pytest.fixture\\n+def client(configed_app):\\n+    with TestClient(configed_app) as client:\\n+        yield client\\n+\\n+\\n+def test_query(client: TestClient):\\n+    response = client.get(f\\\"/query/\\\")\\n+    assert response.status_code == 200\\n+    assert response.json() == {\\\"analyzers\\\": [DBAnalyzer.config_scope]}\\n+\\n+\\n+def test_query_brief(client: TestClient):\\n+    response = client.get(f\\\"/query/{DBAnalyzer.config_scope}/brief\\\")\\n+    assert response.status_code == 200\\n+    assert response.json()\\n+\\n+\\n+def test_query_analyzer(client: TestClient):\\n+    response = client.post(f\\\"/query/{DBAnalyzer.config_scope}\\\")\\n+    assert response.status_code == 200\\n+    assert response.json()\\n+\\n+\\n+if __name__ == \\\"__main__\\\":\\n+    pytest.main([\\\"-vv\\\", \\\"-s\\\", __file__])\\n\",\"diff --git a/tests/service/test_token.py b/tests/service/test_token.py\\nindex 3bef7b9..bb43ec2 100644\\n--- a/tests/service/test_token.py\\n+++ b/tests/service/test_token.py\\n@@ -22,3 +22,7 @@ def client():\\n def test_root(client: TestClient):\\n     response = client.get(\\\"/\\\", params={\\\"token\\\": \\\"test_token\\\"})\\n     assert response.status_code == 200\\n+\\n+\\n+if __name__ == \\\"__main__\\\":\\n+    pytest.main([\\\"-vv\\\", \\\"-s\\\", __file__])\\n\",\"diff --git a/tests/test_service.py b/tests/test_service.py\\ndeleted file mode 100644\\nindex 15c51b9..0000000\\n--- a/tests/test_service.py\\n+++ /dev/null\\n@@ -1,5 +0,0 @@\\n-# TODO\\n-\\n-\\n-def test_service():\\n-    pass\"]", "hints_text": ""}
