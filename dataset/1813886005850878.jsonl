{"instance_id": "1813886005850878", "repo": "heikomuller/histore", "base_commit": "4fe279b88c9bebd2498c99b8d0a490d1c34383c1", "problem_statement": "Environment Variable for JSONEncode configuration:\\nIn combination with Issue #4 , we should add an environment variable to configure the JSONEncoder that is used by the [ArchiveFileStore](https://github.com/heikomuller/histore/blob/master/histore/archive/store/fs/base.py). Alternatively, make the JSONEncoder/Writer a parameter for the constructor and pass this further up in the chain", "FAIL_TO_PASS": ["tests/archive/manager/test_persistent_manager.py::test_default_json_encoder", "tests/archive/test_snapshot.py::test_create_snapshot_descriptor", "tests/archive/manager/test_persistent_manager.py::test_custom_json_encoder", "tests/archive/test_archive_serializer.py::test_invalid_label", "tests/archive/manager/test_volatile_manager.py::test_volatile_archive_manager", "tests/archive/manager/test_persistent_manager.py::test_persistent_archive_manager", "tests/archive/manager/test_archive_descriptor.py::test_archive_descriptor"], "PASS_TO_PASS": ["tests/archive/test_snapshot.py::test_append_snapshots", "tests/archive/store/test_archive_provenance.py::test_archive_read_write", "tests/document/test_csv_document.py::test_read_csv_error", "tests/archive/test_merge_unkeyed.py::test_full_snapshot_merge", "tests/archive/test_archive_serializer.py::test_serialize_timestamp", "tests/document/test_json_document.py::test_json_document_with_pk", "tests/document/test_document_schema.py::test_column_index", "tests/document/test_json_document.py::test_json_document_with_readindex", "tests/archive/test_snapshot.py::test_snapshot_listing", "tests/document/test_partial_document.py::test_align_partial_document", "tests/document/test_dataframe_document.py::test_dataframe_rows", "tests/document/test_csv_sort.py::test_split_file", "tests/document/test_json_document.py::test_json_document_without_key", "tests/test_util.py::test_iostream", "tests/archive/test_archive_row.py::test_row_provenance", "tests/archive/store/test_persistent_archive.py::test_watershed_archive", "tests/archive/test_archive_value.py::test_extend_cell_value_timestamp", "tests/document/test_dataframe_document.py::test_dataframe_document", "tests/document/test_json_document.py::test_json_document_with_errors", "tests/archive/test_archive_row.py::test_extend_archive_row", "tests/annotate/test_annotate_readorder.py::test_rowindex_keys", "tests/archive/test_timestamp.py::test_timestamp_append", "tests/archive/test_timestamp.py::test_timestamp_tostring", "tests/archive/schema/test_match_by_idname.py::test_complete_match_by_idname", "tests/archive/test_timestamp.py::test_interval", "tests/archive/schema/test_match_by_id.py::test_partial_match_by_id", "tests/annotate/test_key_sort.py::test_sort_scalar_values", "tests/document/test_csv_document.py::test_read_unkeyed_file", "tests/document/test_csv_document.py::test_read_keyed_mem_document", "tests/archive/test_archive_serializer.py::test_serialize_value", "tests/archive/test_timestamp.py::test_timestamp_is_equal", "tests/archive/test_timestamp.py::test_timestamp_from_string", "tests/archive/schema/test_match_by_name.py::test_incomplete_match_by_name", "tests/test_util.py::test_createdir", "tests/test_version.py::test_version", "tests/archive/schema/test_match_by_name.py::test_complete_match_by_name", "tests/archive/test_timestamp.py::test_timestamp_init", "tests/archive/schema/test_match_by_id.py::test_complete_match_by_id", "tests/archive/store/test_persistent_archive.py::test_persistent_archive", "tests/document/test_mem_document.py::test_partial_array_document_reader", "tests/annotate/test_annotate_readorder.py::test_primarykey_keys", "tests/test_util.py::test_datetime", "tests/document/test_mem_document.py::test_array_document_reader", "tests/archive/test_archive_serializer.py::test_serialize_row", "tests/document/test_csv_document.py::test_read_keyed_external_document", "tests/archive/test_archive_serializer.py::test_serialize_column", "tests/archive/test_archive_row.py::test_merge_archive_rows", "tests/document/test_document_schema.py::test_document_columns", "tests/archive/schema/test_schema_provenance.py::test_column_provenance", "tests/archive/test_timestamp.py::test_timestamp_contains", "tests/annotate/test_key_sort.py::test_sort_tuples", "tests/archive/test_archive_serializer.py::test_serialize_snapshot", "tests/archive/test_archive_value.py::test_cell_history", "tests/archive/test_archive_row.py::test_compare_row_keys"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/heikomuller_histore:4fe279b88c9bebd2498c99b8d0a490d1c34383c1", "patch": "", "test_patch": "[\"diff --git a/histore/tests/encode.py b/histore/tests/encode.py\\nnew file mode 100644\\nindex 0000000..5e9b8c9\\n--- /dev/null\\n+++ b/histore/tests/encode.py\\n@@ -0,0 +1,30 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Test encoders and decoders for Json objects.\\\"\\\"\\\"\\n+\\n+import json\\n+\\n+from datetime import datetime\\n+\\n+\\n+class TestEncoder(json.JSONEncoder):\\n+    \\\"\\\"\\\"Json encoder that handles datetime objects.\\\"\\\"\\\"\\n+    def default(self, obj):\\n+        \\\"\\\"\\\"Convert datatime to dictionary.\\\"\\\"\\\"\\n+        if isinstance(obj, datetime):\\n+            return {'$dt': obj.isoformat()}\\n+        return obj.value  # Assumes histore.key.base.KeyValue\\n+\\n+\\n+def test_decoder(obj):\\n+    \\\"\\\"\\\"Decode objects generated by the TestEncoder. Returns datetime object\\n+    as string instead of datetime instances.\\n+    \\\"\\\"\\\"\\n+    if '$dt' in obj:\\n+        return obj['$dt']\\n+    return obj\\n\",\"diff --git a/setup.py b/setup.py\\nindex 97e6e41..182bb24 100644\\n--- a/setup.py\\n+++ b/setup.py\\n@@ -18,7 +18,8 @@\\n     'jsonschema>=3.2.0',\\n     'python-dateutil',\\n     'pyyaml',\\n-    'psutil'\\n+    'psutil',\\n+    'Click>=7.0'\\n ]\\n \\n \\n@@ -73,6 +74,11 @@\\n     extras_require=extras_require,\\n     tests_require=tests_require,\\n     install_requires=install_requires,\\n+    entry_points={\\n+        'console_scripts': [\\n+            'histore = histore.cli.base:cli',\\n+        ]\\n+    },\\n     classifiers=[\\n         'License :: OSI Approved :: BSD License',\\n         'Operating System :: OS Independent',\\n\",\"diff --git a/tests/archive/manager/test_archive_descriptor.py b/tests/archive/manager/test_archive_descriptor.py\\nindex 0494d8f..56a86c7 100644\\n--- a/tests/archive/manager/test_archive_descriptor.py\\n+++ b/tests/archive/manager/test_archive_descriptor.py\\n@@ -13,22 +13,29 @@\\n \\n from histore.archive.manager.descriptor import ArchiveDescriptor\\n \\n+import histore.util as util\\n+\\n \\n def test_archive_descriptor():\\n     \\\"\\\"\\\"Test methods for creating archive descriptors.\\\"\\\"\\\"\\n     # Create descriptor using a dictionary.\\n     doc = {\\n         'id': '0000',\\n+        'createdAt': util.utc_now().isoformat(),\\n         'name': 'My Archive',\\n         'description': 'This is my archive',\\n-        'primaryKey': ['SSN']\\n+        'primaryKey': ['SSN'],\\n+        'encoder': 'myencoder',\\n+        'decoder': 'mydecoder'\\n     }\\n     descriptor = ArchiveDescriptor(doc)\\n     assert descriptor.identifier() == '0000'\\n     assert descriptor.name() == 'My Archive'\\n     assert descriptor.description() == 'This is my archive'\\n     assert descriptor.primary_key() == ['SSN']\\n-    doc = {'id': '0001'}\\n+    assert descriptor.encoder() == 'myencoder'\\n+    assert descriptor.decoder() == 'mydecoder'\\n+    doc = {'id': '0001', 'createdAt': util.utc_now().isoformat()}\\n     descriptor = ArchiveDescriptor(doc)\\n     assert descriptor.identifier() == '0001'\\n     assert descriptor.name() == '0001'\\n@@ -38,12 +45,16 @@ def test_archive_descriptor():\\n     descriptor = ArchiveDescriptor.create(\\n         name='My Archive',\\n         description='This is my archive',\\n-        primary_key='SSN'\\n+        primary_key='SSN',\\n+        encoder='myencoder',\\n+        decoder='mydecoder'\\n     )\\n     assert descriptor.identifier() is not None\\n     assert descriptor.name() == 'My Archive'\\n     assert descriptor.description() == 'This is my archive'\\n     assert descriptor.primary_key() == ['SSN']\\n+    assert descriptor.encoder() == 'myencoder'\\n+    assert descriptor.decoder() == 'mydecoder'\\n     descriptor = ArchiveDescriptor.create()\\n     assert descriptor.identifier() is not None\\n     assert descriptor.name() == descriptor.identifier()\\n\",\"diff --git a/tests/archive/manager/test_persistent_manager.py b/tests/archive/manager/test_persistent_manager.py\\nindex e29e626..33c0210 100644\\n--- a/tests/archive/manager/test_persistent_manager.py\\n+++ b/tests/archive/manager/test_persistent_manager.py\\n@@ -8,8 +8,11 @@\\n \\\"\\\"\\\"Unit tests for the archive descriptor.\\\"\\\"\\\"\\n \\n import os\\n+import pandas as pd\\n import pytest\\n \\n+from datetime import datetime\\n+\\n from histore.archive.manager.fs import PersistentArchiveManager\\n \\n import histore.config as config\\n@@ -40,7 +43,7 @@ def test_persistent_archive_manager(tmpdir):\\n         manager.get('unknown')\\n     # Reload the archive manager.\\n     os.environ[config.ENV_HISTORE_BASEDIR] = str(tmpdir)\\n-    manager = PersistentArchiveManager()\\n+    manager = PersistentArchiveManager(exists=True)\\n     assert len(manager.archives()) == 1\\n     archive = manager.get(descriptor.identifier())\\n     assert archive is not None\\n@@ -53,3 +56,42 @@ def test_persistent_archive_manager(tmpdir):\\n         manager.get(descriptor.identifier())\\n     # Cleanup the environment\\n     del os.environ[config.ENV_HISTORE_BASEDIR]\\n+    # Error case when using the exist flag.\\n+    with pytest.raises(ValueError):\\n+        PersistentArchiveManager(\\n+            basedir=os.path.join(str(tmpdir), 'ABC'),\\n+            exists=True\\n+        )\\n+\\n+\\n+def test_default_json_encoder(tmpdir):\\n+    \\\"\\\"\\\"Test persistent archives with default Json encoder.\\\"\\\"\\\"\\n+    # Use the default encoder and decoder.\\n+    manager = PersistentArchiveManager(basedir=str(tmpdir))\\n+    descriptor = manager.create(name='Archive')\\n+    archive = manager.get(descriptor.identifier())\\n+    dt = datetime.now()\\n+    archive.commit(pd.DataFrame(data=[[dt]]))\\n+    df = archive.checkout()\\n+    assert df.shape == (1, 1)\\n+    assert df.iloc[0][0] == dt\\n+    assert isinstance(df.iloc[0][0], datetime)\\n+\\n+\\n+def test_custom_json_encoder(tmpdir):\\n+    \\\"\\\"\\\"Test persistent archives with custom Json encoder.\\\"\\\"\\\"\\n+    # Use the default encoder and decoder.\\n+    manager = PersistentArchiveManager(basedir=str(tmpdir))\\n+    descriptor = manager.create(\\n+        name='Archive',\\n+        encoder='histore.tests.encode.TestEncoder',\\n+        decoder='histore.tests.encode.test_decoder'\\n+    )\\n+    manager = PersistentArchiveManager(basedir=str(tmpdir))\\n+    archive = manager.get(descriptor.identifier())\\n+    dt = datetime.now()\\n+    archive.commit(pd.DataFrame(data=[[dt, 'A']]))\\n+    df = archive.checkout()\\n+    assert df.shape == (1, 2)\\n+    assert df.iloc[0][0] == dt.isoformat()\\n+    assert isinstance(df.iloc[0][0], str)\\n\",\"diff --git a/tests/archive/manager/test_volatile_manager.py b/tests/archive/manager/test_volatile_manager.py\\nindex 24b9c51..e2ff4b3 100644\\n--- a/tests/archive/manager/test_volatile_manager.py\\n+++ b/tests/archive/manager/test_volatile_manager.py\\n@@ -16,6 +16,7 @@ def test_volatile_archive_manager():\\n     \\\"\\\"\\\"Test functionality of the volatile archive manager.\\\"\\\"\\\"\\n     manager = VolatileArchiveManager()\\n     assert len(manager.archives()) == 0\\n+    # Create archive\\n     descriptor = manager.create(\\n         name='First archive',\\n         description='My first archive',\\n@@ -26,6 +27,10 @@ def test_volatile_archive_manager():\\n     assert descriptor.description() == 'My first archive'\\n     assert descriptor.primary_key() == ['SSN']\\n     assert len(manager.archives()) == 1\\n+    # Create archive with existing name.\\n+    with pytest.raises(ValueError):\\n+        manager.create(name='First archive')\\n+    # List archive(s)\\n     descriptor = manager.list()[0]\\n     assert descriptor.identifier() is not None\\n     assert descriptor.name() == 'First archive'\\n@@ -33,10 +38,23 @@ def test_volatile_archive_manager():\\n     assert descriptor.primary_key() == ['SSN']\\n     archive = manager.get(descriptor.identifier())\\n     assert archive is not None\\n+    # Rename the archive.\\n+    manager.rename(descriptor.identifier(), 'Some archive')\\n+    assert manager.get_by_name('My first archive') is None\\n+    assert manager.get_by_name('Some archive') is not None\\n+    # No error when archive name is identical to new name\\n+    manager.rename(descriptor.identifier(), 'Some archive')\\n+    # Error when renaming an unknown archive.\\n+    with pytest.raises(ValueError):\\n+        manager.rename('unknown', 'My archive')\\n+    # Error when renaming to an existing archive.\\n+    manager.create(name='First archive')\\n+    with pytest.raises(ValueError):\\n+        manager.rename(descriptor.identifier(), 'First archive')\\n     # Delete the archive\\n     manager.delete(descriptor.identifier())\\n-    assert len(manager.archives()) == 0\\n+    assert len(manager.archives()) == 1\\n     manager.delete(descriptor.identifier())\\n-    # Error cases\\n+    # Error when accessing non-existing archive\\n     with pytest.raises(ValueError):\\n         manager.get(descriptor.identifier())\\n\",\"diff --git a/tests/archive/store/test_buffered_reader.py b/tests/archive/store/test_buffered_reader.py\\nnew file mode 100644\\nindex 0000000..7f3950a\\n--- /dev/null\\n+++ b/tests/archive/store/test_buffered_reader.py\\n@@ -0,0 +1,29 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit tests for the buffered archive reader.\\\"\\\"\\\"\\n+\\n+import pandas as pd\\n+\\n+from histore.archive.base import Archive\\n+\\n+\\n+def test_archive_reader_iterate(tmpdir):\\n+    \\\"\\\"\\\"Test reading rows in an archive using the row iterator provided by the\\n+    archive reader.\\n+    \\\"\\\"\\\"\\n+    # Create archive in main memory\\n+    archive = Archive()\\n+    # First snapshot\\n+    df = pd.DataFrame(\\n+        data=[['Alice', 32], ['Bob', 45], ['Claire', 27], ['Alice', 23]],\\n+        columns=['Name', 'Age']\\n+    )\\n+    archive.commit(df)\\n+    reader = archive.reader()\\n+    for row in reader:\\n+        assert row.rowid >= 0\\n\",\"diff --git a/tests/archive/store/test_json_encode.py b/tests/archive/store/test_json_encode.py\\nnew file mode 100644\\nindex 0000000..bcf93a9\\n--- /dev/null\\n+++ b/tests/archive/store/test_json_encode.py\\n@@ -0,0 +1,41 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit test for the default JSON encoder and decoder.\\\"\\\"\\\"\\n+\\n+import json\\n+import numpy as np\\n+\\n+from datetime import datetime, time\\n+\\n+from histore.archive.store.fs.reader import default_decoder\\n+from histore.archive.store.fs.writer import DefaultEncoder\\n+\\n+\\n+def test_datetime_objects():\\n+    \\\"\\\"\\\"Test encoding and decoding date time objects.\\\"\\\"\\\"\\n+    dt = datetime.now()\\n+    d = dt.date()\\n+    t = dt.time()\\n+    doc = {'a': 'X', 'b': dt, 'c': d, 'd': t, 'e': time(11, 15)}\\n+    obj = json.dumps(doc, cls=DefaultEncoder)\\n+    doc = json.loads(obj, object_hook=default_decoder)\\n+    assert doc['a'] == 'X'\\n+    assert doc['b'] == dt\\n+    assert doc['c'] == d\\n+    assert doc['d'] == t\\n+    assert doc['e'] == time(11, 15)\\n+\\n+\\n+def test_numpy_objects():\\n+    \\\"\\\"\\\"Test encoding numpy objects.\\\"\\\"\\\"\\n+    doc = {'a': 'X', 'b': np.int(1), 'c': np.float(1.2), 'd': np.array([1, 2])}\\n+    doc = json.loads(json.dumps(doc, cls=DefaultEncoder))\\n+    assert doc['a'] == 'X'\\n+    assert doc['b'] == 1\\n+    assert doc['c'] == 1.2\\n+    assert doc['d'] == [1, 2]\\n\",\"diff --git a/tests/archive/test_archive_cases.py b/tests/archive/test_archive_cases.py\\nnew file mode 100644\\nindex 0000000..b1217ff\\n--- /dev/null\\n+++ b/tests/archive/test_archive_cases.py\\n@@ -0,0 +1,45 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit tests for special (error) cases for the archive object.\\\"\\\"\\\"\\n+\\n+import pandas as pd\\n+import pytest\\n+\\n+from histore.archive.base import Archive\\n+from histore.document.mem.dataframe import DataFrameDocument\\n+\\n+\\n+def test_special_checkout_cases():\\n+    \\\"\\\"\\\"Test various special (error) cases for commit and checkout.\\\"\\\"\\\"\\n+    archive = Archive()\\n+    # Version 0\\n+    df = pd.DataFrame(\\n+        data=[['Alice', 1], ['Bob', 1], ['Claire', 1], ['Alice', 2]],\\n+        columns=['Name', 'Index']\\n+    )\\n+    s = archive.commit(DataFrameDocument(df))\\n+    assert s.version == 0\\n+    # Last version is checked out by default.\\n+    df = archive.checkout(version=0)\\n+    assert list(df.index) == [0, 1, 2, 3]\\n+    df = archive.checkout()\\n+    assert list(df.index) == [0, 1, 2, 3]\\n+    # Partial merge with given origin.\\n+    df = pd.DataFrame(data=[['Alice', 1]], columns=df.columns)\\n+    s = archive.commit(df, origin=0)\\n+    assert s.version == 1\\n+    # Checkout an unknown version.\\n+    with pytest.raises(ValueError):\\n+        archive.checkout(version=10)\\n+\\n+\\n+def test_partial_commit_to_empty_archive():\\n+    \\\"\\\"\\\"Test error when committing a partial snapshot to an empty archive.\\\"\\\"\\\"\\n+    df = pd.DataFrame(data=[[1]])\\n+    with pytest.raises(ValueError):\\n+        Archive().commit(df, partial=True)\\n\",\"diff --git a/tests/archive/test_archive_row.py b/tests/archive/test_archive_row.py\\nindex 8927421..7587424 100644\\n--- a/tests/archive/test_archive_row.py\\n+++ b/tests/archive/test_archive_row.py\\n@@ -67,6 +67,14 @@ def test_extend_archive_row():\\n         cells=dict(),\\n         timestamp=ts\\n     )\\n+    assert str(row) == '\\\\n'.join([\\n+        '<ArchiveRow (',\\n+        '\\\\tid=0',\\n+        '\\\\tkey=0',\\n+        '\\\\ttimestamp=[1]',\\n+        '\\\\tpos=(0 [1])',\\n+        '\\\\tvalues={})>'\\n+    ])\\n     row = row.merge(pos=1, values={1: 'A', 2: 1, 3: 'a'}, version=2)\\n     row = row.merge(pos=1, values={1: 'B', 2: 1, 3: 'b'}, version=3)\\n     row = row.extend(version=4, origin=2)\\n@@ -74,8 +82,15 @@ def test_extend_archive_row():\\n     assert pos == 1\\n     assert values == ['A', 1, 'a']\\n     row = row.extend(version=5, origin=1)\\n+    # Error for unknown version.\\n     with pytest.raises(ValueError):\\n-        row.at_version(version=5, columns=[1, 2, 3])\\n+        row.at_version(version=5, columns=[1, 2])\\n+    # Error for unknown column.\\n+    with pytest.raises(ValueError):\\n+        row.at_version(version=4, columns=[1, 5], raise_error=True)\\n+    pos, values = row.at_version(version=4, columns=[1, 5], raise_error=False)\\n+    assert pos == 1\\n+    assert values == ['A', None]\\n     pos, values = row.at_version(\\n         version=5,\\n         columns=[1, 2, 3],\\n@@ -171,6 +186,7 @@ def test_row_provenance():\\n         }),\\n         timestamp=Timestamp(intervals=TimeInterval(1, 5))\\n     )\\n+    assert row.diff(0, 0) is None\\n     assert row.diff(0, 1).is_insert()\\n     assert row.diff(5, 6).is_delete()\\n     prov = row.diff(1, 2)\\n\",\"diff --git a/tests/archive/test_archive_serializer.py b/tests/archive/test_archive_serializer.py\\nindex 1d14670..1c66f5d 100644\\n--- a/tests/archive/test_archive_serializer.py\\n+++ b/tests/archive/test_archive_serializer.py\\n@@ -22,6 +22,14 @@\\n import histore.util as util\\n \\n \\n+def test_invalid_label():\\n+    \\\"\\\"\\\"Test error when creating a serializer with an invalid label value.\\\"\\\"\\\"\\n+    s = DefaultSerializer(timestamp='ts')\\n+    assert s.timestamp == 'ts'\\n+    with pytest.raises(ValueError):\\n+        DefaultSerializer(timestamp='$ts')\\n+\\n+\\n def test_serialize_column():\\n     \\\"\\\"\\\"Test (de-)serialization of archive schema columns.\\\"\\\"\\\"\\n     serializer = DefaultSerializer()\\n@@ -80,6 +88,15 @@ def test_serialize_snapshot():\\n     assert s.valid_time == snapshot.valid_time\\n     assert s.transaction_time == snapshot.transaction_time\\n     assert s.description == snapshot.description\\n+    # For completeness, test deserializing a snapshot object without\\n+    # description element.\\n+    snapshot.description = None\\n+    obj = serializer.serialize_snapshot(snapshot)\\n+    s = serializer.deserialize_snapshot(obj)\\n+    assert s.version == snapshot.version\\n+    assert s.valid_time == snapshot.valid_time\\n+    assert s.transaction_time == snapshot.transaction_time\\n+    assert s.description == ''\\n     # -- Snapshot with description --------------------------------------------\\n     snapshot = Snapshot(0, valid_time=vt, description='First snapshot')\\n     obj = serializer.serialize_snapshot(snapshot)\\n@@ -124,6 +141,9 @@ def test_serialize_value():\\n     value = serializer.deserialize_value(obj=obj, ts=ts)\\n     assert value.timestamp.is_equal(Timestamp(version=1))\\n     assert value.value == 1\\n+    # Error case for invalid object\\n+    with pytest.raises(ValueError):\\n+        serializer.deserialize_value(obj='A', ts=ts)\\n     # -- Multi-version value --------------------------------------------------\\n     value = SingleVersionValue(value=1, timestamp=Timestamp(version=1))\\n     value = value.merge(value='A', version=2)\\n\",\"diff --git a/tests/archive/test_snapshot.py b/tests/archive/test_snapshot.py\\nindex 2eeb2dd..14fdb3e 100644\\n--- a/tests/archive/test_snapshot.py\\n+++ b/tests/archive/test_snapshot.py\\n@@ -24,6 +24,7 @@ def test_append_snapshots():\\n     assert snapshots.last_snapshot() is not None\\n     s = snapshots.last_snapshot()\\n     assert s.version == 0\\n+    assert str(s).startswith('<Snapshot')\\n     snapshots = snapshots.append(description='some text')\\n     s = snapshots.last_snapshot()\\n     assert s.version == 1\\n@@ -40,6 +41,7 @@ def test_create_snapshot_descriptor():\\n     assert s.version == 0\\n     assert s.valid_time == util.to_datetime('2020-05-01')\\n     assert s.transaction_time is not None\\n+    assert s.transaction_time == s.created_at\\n     assert s.description == ''\\n     s = Snapshot(\\n         version=0,\\n@@ -68,11 +70,14 @@ def test_snapshot_listing():\\n     assert s.version == 0\\n     s = listing.at_time(util.to_datetime('2020-05-10'))\\n     assert s.version == 2\\n-    # Error cases\\n+    # Empty listing returns None for any time\\n+    assert SnapshotListing().at_time(util.to_datetime('2020-04-01')) is None\\n+    # Error case for snapshots with invalid 'vaid_time' order\\n     with pytest.raises(ValueError):\\n         SnapshotListing(snapshots=[s1, s3, s2])\\n     s1 = Snapshot(version=0, valid_time=util.to_datetime('2020-05-01'))\\n     s2 = Snapshot(version=1, valid_time=util.to_datetime('2020-05-03'))\\n     s3 = Snapshot(version=2, valid_time=util.to_datetime('2020-05-02'))\\n+    # Error case for snapshots with invalid 'vaid_time'\\n     with pytest.raises(ValueError):\\n         SnapshotListing(snapshots=[s1, s2, s3])\\n\",\"diff --git a/tests/archive/test_timestamp.py b/tests/archive/test_timestamp.py\\nindex 44bf671..0d0aa31 100644\\n--- a/tests/archive/test_timestamp.py\\n+++ b/tests/archive/test_timestamp.py\\n@@ -35,6 +35,11 @@ def test_interval():\\n     assert i1.overlap(interval=TimeInterval(start=19, end=25))\\n     assert i1.overlap(interval=TimeInterval(start=20, end=25))\\n     assert not i1.overlap(interval=TimeInterval(start=21, end=25))\\n+    with pytest.raises(ValueError):\\n+        i1.contains()\\n+    # String representation\\n+    assert str(i1) == '10-20'\\n+    assert str(TimeInterval(start=10)) == '10'\\n     # Initialize\\n     with pytest.raises(ValueError):\\n         TimeInterval(start=10, end=9)\\n@@ -60,6 +65,8 @@ def test_timestamp_append():\\n     assert t4.contains(3)\\n     assert not t4.contains(4)\\n     assert t4.contains(5)\\n+    with pytest.raises(ValueError):\\n+        t4.append(1)\\n \\n \\n def test_timestamp_contains():\\n\",\"diff --git a/tests/cli/test_cli_archive.py b/tests/cli/test_cli_archive.py\\nnew file mode 100644\\nindex 0000000..c78e010\\n--- /dev/null\\n+++ b/tests/cli/test_cli_archive.py\\n@@ -0,0 +1,115 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit tests for the command-line archive commands.\\\"\\\"\\\"\\n+\\n+import os\\n+import pytest\\n+\\n+from click.testing import CliRunner\\n+\\n+from histore.cli.base import cli\\n+\\n+import histore.config as config\\n+\\n+\\n+# -- Fixtures and Helper Functions --------------------------------------------\\n+\\n+@pytest.fixture\\n+def test_runner(tmpdir):\\n+    \\\"\\\"\\\"Initialize archive manager in temporary directory and set basedir\\n+    environment variable.\\n+    \\\"\\\"\\\"\\n+    basedir = os.path.abspath(str(tmpdir))\\n+    runner = CliRunner()\\n+    os.environ[config.ENV_HISTORE_BASEDIR] = basedir\\n+    runner = CliRunner()\\n+    runner.invoke(cli, ['init'])\\n+    return runner\\n+\\n+\\n+def cleanup():\\n+    \\\"\\\"\\\"Clear base dire environment variable.\\\"\\\"\\\"\\n+    del os.environ[config.ENV_HISTORE_BASEDIR]\\n+\\n+\\n+# -- Unit tests ---------------------------------------------------------------\\n+\\n+def test_create_archive(test_runner):\\n+    \\\"\\\"\\\"Test creating a new archive.\\\"\\\"\\\"\\n+    result = test_runner.invoke(cli, ['create', 'myarchive'])\\n+    assert result.exit_code == 0\\n+    assert result.output == 'Archive created!\\\\n'\\n+    result = test_runner.invoke(cli, ['create', 'myarchive'])\\n+    assert result.exit_code == -1\\n+    assert result.output == \\\"archive 'myarchive' already exists\\\\n\\\"\\n+    # Cleanup environment\\n+    cleanup()\\n+\\n+\\n+def test_delete_archive(test_runner):\\n+    \\\"\\\"\\\"Test deleting an existing archive.\\\"\\\"\\\"\\n+    test_runner.invoke(cli, ['create', 'a_archive'])\\n+    test_runner.invoke(cli, ['create', 'myarchive'])\\n+    # Abort deletion.\\n+    result = test_runner.invoke(cli, ['delete', 'myarchive'], input='n')\\n+    assert result.exit_code == 1\\n+    assert 'Aborted!\\\\n' in result.output\\n+    result = test_runner.invoke(cli, ['delete', 'myarchive'], input='Y')\\n+    assert result.exit_code == 0\\n+    assert \\\"Archive 'myarchive' deleted!\\\\n\\\" in result.output\\n+    # Delete with force option\\n+    result = test_runner.invoke(cli, ['delete', '--force', 'a_archive'])\\n+    assert result.exit_code == 0\\n+    assert \\\"Archive 'a_archive' deleted!\\\\n\\\" in result.output\\n+    result = test_runner.invoke(cli, ['delete', '--force', 'a_archive'])\\n+    assert result.exit_code == -1\\n+    assert result.output == \\\"Unknown archive 'a_archive'.\\\\n\\\"\\n+    # Cleanup environment\\n+    cleanup()\\n+\\n+\\n+def test_list_archives(test_runner):\\n+    \\\"\\\"\\\"Test listing an existing archive.\\\"\\\"\\\"\\n+    test_runner.invoke(cli, ['create', 'archive B'])\\n+    test_runner.invoke(cli, ['create', 'archive A'])\\n+    # Order by name\\n+    result = test_runner.invoke(cli, ['list'])\\n+    assert result.exit_code == 0\\n+    lines = result.output.split('\\\\n')\\n+    assert lines[3].startswith('archive A')\\n+    assert lines[4].startswith('archive B')\\n+    # Order by created_at timestamp\\n+    result = test_runner.invoke(cli, ['list', '-d'])\\n+    assert result.exit_code == 0\\n+    lines = result.output.split('\\\\n')\\n+    assert lines[3].startswith('archive B')\\n+    assert lines[4].startswith('archive A')\\n+    # Cleanup environment\\n+    cleanup()\\n+\\n+\\n+def test_rename_archive(test_runner):\\n+    \\\"\\\"\\\"Test renaming an existing archive.\\\"\\\"\\\"\\n+    test_runner.invoke(cli, ['create', 'archive B'])\\n+    test_runner.invoke(cli, ['create', 'archive A'])\\n+    # Rename archive B to C\\n+    result = test_runner.invoke(cli, ['rename', 'archive B', 'archive C'])\\n+    assert result.exit_code == 0\\n+    result = test_runner.invoke(cli, ['list'])\\n+    lines = result.output.split('\\\\n')\\n+    assert lines[3].startswith('archive A')\\n+    assert lines[4].startswith('archive C')\\n+    # Error cases\\n+    result = test_runner.invoke(cli, ['rename', 'archive B', 'archive C'])\\n+    assert result.exit_code == -1\\n+    assert result.output == \\\"Unknown archive 'archive B'\\\\n\\\"\\n+    result = test_runner.invoke(cli, ['rename', 'archive C', 'archive A'])\\n+    assert result.exit_code == -1\\n+    assert result.output == \\\"archive 'archive A' already exists\\\\n\\\"\\n+    # Cleanup environment\\n+    cleanup()\\n\",\"diff --git a/tests/cli/test_cli_init.py b/tests/cli/test_cli_init.py\\nnew file mode 100644\\nindex 0000000..7f1b590\\n--- /dev/null\\n+++ b/tests/cli/test_cli_init.py\\n@@ -0,0 +1,33 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit tests for the command-line init command.\\\"\\\"\\\"\\n+\\n+import os\\n+\\n+from click.testing import CliRunner\\n+from pathlib import Path\\n+\\n+from histore.cli.base import init_manager\\n+\\n+\\n+def test_init_manager(tmpdir):\\n+    \\\"\\\"\\\"Test initializing the archive manager directory.\\\"\\\"\\\"\\n+    runner = CliRunner()\\n+    basedir = os.path.abspath(str(tmpdir))\\n+    result = runner.invoke(init_manager, ['--basedir', basedir])\\n+    assert result.exit_code == 0\\n+    assert result.output == 'Initialized in {}.\\\\n'.format(basedir)\\n+    # Create file in temp dir to simulate non-empty directory.\\n+    Path(os.path.join(basedir, 'myfile.txt')).touch()\\n+    result = runner.invoke(init_manager, ['--basedir', basedir])\\n+    assert result.exit_code == -1\\n+    # Create archive manager for non-existing folder\\n+    subdir = os.path.join(basedir, 'subfolder')\\n+    result = runner.invoke(init_manager, ['--basedir', subdir])\\n+    assert result.exit_code == 0\\n+    assert result.output == 'Initialized in {}.\\\\n'.format(subdir)\\n\",\"diff --git a/tests/cli/test_cli_snapshot.py b/tests/cli/test_cli_snapshot.py\\nnew file mode 100644\\nindex 0000000..94f5c2c\\n--- /dev/null\\n+++ b/tests/cli/test_cli_snapshot.py\\n@@ -0,0 +1,82 @@\\n+# This file is part of the History Store (histore).\\n+#\\n+# Copyright (C) 2018-2020 New York University.\\n+#\\n+# The History Store (histore) is released under the Revised BSD License. See\\n+# file LICENSE for full license details.\\n+\\n+\\\"\\\"\\\"Unit tests for the command-line snapshot commands.\\\"\\\"\\\"\\n+\\n+import os\\n+\\n+from click.testing import CliRunner\\n+\\n+from histore.cli.base import cli\\n+from histore.cli.snapshot import get_delimiter\\n+\\n+\\n+DIR = os.path.dirname(os.path.realpath(__file__))\\n+WATERSHED_1 = os.path.join(DIR, '../.files/y43c-5n92.tsv.gz')\\n+\\n+\\n+def test_snapshot_commands(tmpdir):\\n+    \\\"\\\"\\\"Test committing, listing and checking out snapshots.\\\"\\\"\\\"\\n+    basedir = os.path.abspath(str(tmpdir))\\n+    runner = CliRunner()\\n+    runner.invoke(cli, ['init', '--basedir', basedir])\\n+    runner.invoke(\\n+        cli,\\n+        ['create', '--basedir', basedir, '--pk', 'Site,Date', 'myarchive']\\n+    )\\n+    # Commit a snapshot.\\n+    result = runner.invoke(\\n+        cli,\\n+        [\\n+            'commit',\\n+            '--basedir',\\n+            basedir,\\n+            '-d',\\n+            '\\\\\\\\t',\\n+            '-z',\\n+            'myarchive',\\n+            WATERSHED_1\\n+        ]\\n+    )\\n+    assert result.exit_code == 0\\n+    assert result.output == 'Snapshot 0 created.\\\\n'\\n+    # Unknown archive\\n+    result = runner.invoke(\\n+        cli,\\n+        ['commit', '--basedir', basedir, 'myarch', WATERSHED_1]\\n+    )\\n+    assert result.exit_code == -1\\n+    # List snapshots.\\n+    result = runner.invoke(\\n+        cli,\\n+        ['snapshots', '--basedir', basedir, 'myarchive']\\n+    )\\n+    assert result.exit_code == 0\\n+    assert result.output.startswith('0\\\\t')\\n+    # Unknown archive\\n+    result = runner.invoke(cli, ['snapshots', '--basedir', basedir, 'myarch'])\\n+    assert result.exit_code == -1\\n+    # Checkout snapshot\\n+    outfile = os.path.join(basedir, 'outfile.csv')\\n+    result = runner.invoke(\\n+        cli,\\n+        ['checkout', '--basedir', basedir, 'myarchive', outfile]\\n+    )\\n+    assert result.exit_code == 0\\n+    # Unknown archive\\n+    result = runner.invoke(\\n+        cli,\\n+        ['checkout', '--basedir', basedir, 'myarch', outfile]\\n+    )\\n+    assert result.exit_code == -1\\n+\\n+\\n+def test_get_delimiter():\\n+    \\\"\\\"\\\"Test delimiter argument value handling.\\\"\\\"\\\"\\n+    assert get_delimiter(None) == ','\\n+    assert get_delimiter('Tab') == '\\\\t'\\n+    assert get_delimiter('|') == '|'\"]", "hints_text": ""}
