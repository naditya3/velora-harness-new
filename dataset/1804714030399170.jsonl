{"instance_id": "1804714030399170", "repo": "ishaltechtso/pis_data_server", "base_commit": "ace0cb9ce93a518dcb3ae5692b46bbdd7ec3f73a", "problem_statement": "Design Principles, Clean Code, ...:\\nApply some Clean Code principles like SOLID", "FAIL_TO_PASS": ["tests/unit/test_models.py::TestZettelUpdate::test_add_columns", "tests/unit/test_models.py::TestZettelUpdate::test_new_zettel_update", "tests/unit/test_models.py::TestZettel::test_adding_zettel_link", "tests/functional/test_routes.py::TestZettelEditView::test_zettel_edit_view_get", "tests/unit/test_models.py::TestZettel::test_new_zettel"], "PASS_TO_PASS": ["tests/functional/test_routes.py::TestChecklistView::test_checklist_view_links", "tests/functional/test_routes.py::TestSuccessView::test_success_view_links", "tests/unit/test_models.py::TestUpdatedColumn::test_new_updated_column", "tests/functional/test_routes.py::TestZettelSearchView::test_zettel_search_view_links", "tests/functional/test_routes.py::TestLoginView::test_login_view_get", "tests/functional/test_routes.py::TestSuccessView::test_success_view_get", "tests/functional/test_routes.py::TestChecklistView::test_checklist_view_get", "tests/functional/test_routes.py::TestLoginView::test_login_view_links", "tests/functional/test_routes.py::TestManualView::test_manual_view_get", "tests/functional/test_routes.py::TestDigitalizeZettelView::test_digitalize_zettel_view_get", "tests/functional/test_routes.py::TestLabelZettelView::test_label_zettel_view_get", "tests/unit/test_models.py::TestUser::test_new_user", "tests/functional/test_routes.py::TestManualView::test_manual_view_links", "tests/functional/test_routes.py::TestHistoryView::test_history_view_get", "tests/functional/test_routes.py::TestZettelSearchView::test_zettel_search_view_get", "tests/functional/test_routes.py::TestIndexView::test_index_view_get", "tests/functional/test_routes.py::TestIndexView::test_index_view_links", "tests/functional/test_routes.py::TestHistoryView::test_history_view_links"], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/ishaltechtso_pis_data_server:ace0cb9ce93a518dcb3ae5692b46bbdd7ec3f73a", "patch": "[\"diff --git a/.gitignore b/.gitignore\\nindex db23443..30a3c21 100644\\n--- a/.gitignore\\n+++ b/.gitignore\\n@@ -9,8 +9,7 @@ venv/\\n __pycache__/\\n \\n # Flask specific files\\n-*local_config.py\\n-logger.log\\n+/instance\\n \\n # CI specific files\\n *.coverage\\n\",\"diff --git a/pis_app/alembic/versions/f724652d806f_.py b/pis_app/alembic/versions/f724652d806f_.py\\nnew file mode 100644\\nindex 0000000..ff25806\\n--- /dev/null\\n+++ b/pis_app/alembic/versions/f724652d806f_.py\\n@@ -0,0 +1,35 @@\\n+\\\"\\\"\\\"\\n+empty message\\n+\\n+Revision ID: f724652d806f\\n+Revises: ae793ea17598\\n+Create Date: 2022-11-10 18:46:29.220558\\n+\\n+\\\"\\\"\\\"\\n+from alembic import op\\n+import sqlalchemy as sa\\n+\\n+\\n+# revision identifiers, used by Alembic.\\n+revision = 'f724652d806f'\\n+down_revision = 'ae793ea17598'\\n+branch_labels = None\\n+depends_on = None\\n+\\n+\\n+def upgrade():\\n+    # ### commands auto generated by Alembic - please adjust! ###\\n+    op.add_column('zettels', sa.Column('luhmann_id', sa.String(), nullable=False))\\n+    op.drop_index('ix_zettels_luhmann_identifier', table_name='zettels')\\n+    op.create_index(op.f('ix_zettels_luhmann_id'), 'zettels', ['luhmann_id'], unique=True)\\n+    op.drop_column('zettels', 'luhmann_identifier')\\n+    # ### end Alembic commands ###\\n+\\n+\\n+def downgrade():\\n+    # ### commands auto generated by Alembic - please adjust! ###\\n+    op.add_column('zettels', sa.Column('luhmann_identifier', sa.VARCHAR(), autoincrement=False, nullable=False))\\n+    op.drop_index(op.f('ix_zettels_luhmann_id'), table_name='zettels')\\n+    op.create_index('ix_zettels_luhmann_identifier', 'zettels', ['luhmann_identifier'], unique=False)\\n+    op.drop_column('zettels', 'luhmann_id')\\n+    # ### end Alembic commands ###\\n\",\"diff --git a/pis_app/app.py b/pis_app/app.py\\nindex 0e2f80e..9a33ff7 100644\\n--- a/pis_app/app.py\\n+++ b/pis_app/app.py\\n@@ -1,22 +1,28 @@\\n from flask import Flask\\n from flask_login import LoginManager\\n from flask_caching import Cache\\n-from .config import loggerConfig\\n \\n \\n login_manager = LoginManager()\\n-cache = Cache(config={'CACHE_TYPE': 'SimpleCache', \\\"CACHE_DEFAULT_TIMEOUT\\\": 300})\\n+cache = Cache(config={  'CACHE_TYPE': 'SimpleCache', \\n+                        'CACHE_DEFAULT_TIMEOUT': 300})\\n \\n-def create_app(config_object=None):\\n-    app = Flask(__name__, )\\n+\\n+class MyFlask(Flask):\\n+    def get_db_session(self):\\n+        return self._DBSession()\\n+\\n+\\n+def create_app(config_object=None) -> MyFlask:\\n+    app = MyFlask(__name__, instance_relative_config=True)\\n \\n     \\n     # Load Dev Config if no config object is provided\\n     if not config_object:\\n         try:\\n-            from .local_config import DevelopmentConfig\\n+            from instance.private_config import DevelopmentConfig\\n         except ModuleNotFoundError:\\n-            from .config import DevelopmentConfig\\n+            from pis_app.config import DevelopmentConfig\\n             \\n         app.config.from_object(DevelopmentConfig)\\n     \\n@@ -49,7 +55,7 @@ class AppInitializer:\\n         from pis_app.database import Session\\n         import pis_app.models\\n \\n-        self.flask_app.Session = Session\\n+        self.flask_app._DBSession = Session\\n \\n     def init_app_in_ctx(self) -> None:\\n         \\\"\\\"\\\"\\n@@ -67,4 +73,4 @@ class AppInitializer:\\n         cache.init_app(self.flask_app)\\n \\n         with self.flask_app.app_context():\\n-            self.init_app_in_ctx()\\n\\\\ No newline at end of file\\n+            self.init_app_in_ctx()\\n\",\"diff --git a/pis_app/auth.py b/pis_app/auth.py\\nindex 16bfd51..e2abc90 100644\\n--- a/pis_app/auth.py\\n+++ b/pis_app/auth.py\\n@@ -19,7 +19,7 @@ def login_view():\\n \\n     form = LoginForm()\\n     if form.validate_on_submit():\\n-        session = app.Session()\\n+        session = app.get_db_session()\\n         user = session.query(User).filter_by(email=form.email.data).first()\\n         if user and user.check_password(password=form.password.data):\\n             login_user(user)\\n@@ -48,12 +48,12 @@ def signup_view():\\n     form = SignupForm()\\n     if form.validate_on_submit():\\n         # User sign up logic upon POST request\\n-        session = app.Session()\\n+        session = app.get_db_session()\\n         existing_user = session.query(User).filter_by(email=form.email.data).first()\\n         if existing_user is None:\\n             user = User(name=form.name.data, email=form.email.data)\\n             user.set_password(form.password.data)\\n-            session = app.Session()\\n+            session = app.get_db_session()\\n             session.add(user)\\n             session.commit()\\n             login_user(user)\\n@@ -80,7 +80,7 @@ def load_user(user_id):\\n     print(user_id)\\n     \\\"Check if user is logged in on every page load\\\"\\n     if user_id is not None:\\n-        session = app.Session()\\n+        session = app.get_db_session()\\n         return session.query(User).get(user_id)\\n     return None\\n \\n\",\"diff --git a/pis_app/config.py b/pis_app/config.py\\nindex c2c183e..057bb0c 100644\\n--- a/pis_app/config.py\\n+++ b/pis_app/config.py\\n@@ -36,12 +36,12 @@ loggerConfig(\\n                 \\\"stream\\\": \\\"ext://sys.stdout\\\",\\n                 \\\"formatter\\\": \\\"short\\\",\\n             },\\n-            \\\"file\\\": {\\n-                \\\"class\\\": \\\"logging.FileHandler\\\",\\n-                \\\"filename\\\": \\\"logger.log\\\",\\n-                \\\"formatter\\\": \\\"default\\\",\\n-            },\\n+            # \\\"file\\\": {\\n+            #     \\\"class\\\": \\\"logging.FileHandler\\\",\\n+            #     \\\"filename\\\": \\\"instance/logger.log\\\",\\n+            #     \\\"formatter\\\": \\\"default\\\",\\n+            # },\\n         },\\n-        \\\"root\\\": {\\\"level\\\": \\\"INFO\\\", \\\"handlers\\\": [\\\"console\\\", \\\"file\\\"]},\\n+        # \\\"root\\\": {\\\"level\\\": \\\"INFO\\\", \\\"handlers\\\": [\\\"console\\\", \\\"file\\\"]},\\n     }\\n )\\n\",\"diff --git a/pis_app/constants.py b/pis_app/constants.py\\nindex 94c1927..450bf3f 100644\\n--- a/pis_app/constants.py\\n+++ b/pis_app/constants.py\\n@@ -1,7 +1,20 @@\\n+import enum\\n+\\n+\\n NAMING_CONVENTION = {\\n         \\\"ix\\\": \\\"ix_%(column_0_label)s\\\",\\n         \\\"uq\\\": \\\"uq_%(table_name)s_%(column_0_name)s\\\",\\n         \\\"ck\\\": \\\"ck_%(table_name)s_`%(constraint_name)s`\\\",\\n         \\\"fk\\\": \\\"fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s\\\",\\n         \\\"pk\\\": \\\"pk_%(table_name)s\\\"\\n-      }\\n\\\\ No newline at end of file\\n+      }\\n+\\n+\\n+class RolesEnum(int, enum.Enum):\\n+    ADMIN = 0\\n+    USER = 1\\n+\\n+\\n+class FlashEnum(str, enum.Enum):\\n+  ZETTELDUPLICATE = \\\"A Zettel with that Title and/or Luhmann ID already exists! Please try again!\\\"\\n+  ADMIN_ERROR = 'You are not an admin!'\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/database.py b/pis_app/database.py\\nindex 9a36a8f..002d6c3 100644\\n--- a/pis_app/database.py\\n+++ b/pis_app/database.py\\n@@ -8,4 +8,4 @@ meta = MetaData(naming_convention=NAMING_CONVENTION)\\n \\n engine = create_engine(DevelopmentConfig.DATABASE_URI)\\n Base = declarative_base(bind=engine, metadata=meta)\\n-Session = sessionmaker(bind=engine)\\n\\\\ No newline at end of file\\n+Session = sessionmaker(bind=engine, autoflush=False)\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/errorhandlers.py b/pis_app/errorhandlers.py\\nnew file mode 100644\\nindex 0000000..83da5e0\\n--- /dev/null\\n+++ b/pis_app/errorhandlers.py\\n@@ -0,0 +1,6 @@\\n+from flask import current_app as app, render_template\\n+\\n+\\n+@app.errorhandler(404)\\n+def not_found(e):\\n+    return render_template('views/404.html', context={'e':e})\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/forms.py b/pis_app/forms.py\\nindex 802fb20..6a44e10 100644\\n--- a/pis_app/forms.py\\n+++ b/pis_app/forms.py\\n@@ -58,7 +58,7 @@ class LoginForm(FlaskForm):\\n \\n class ZettelSearchForm(FlaskForm):\\n     \\\"\\\"\\\"ZettelSearch Form\\\"\\\"\\\"\\n-    luhmann_identifier = StringField(\\n+    luhmann_id = StringField(\\n         label='Luhmann ID',\\n     )\\n     title = StringField(\\n@@ -69,7 +69,7 @@ class ZettelSearchForm(FlaskForm):\\n \\n class ZettelEditForm(FlaskForm):\\n     \\\"\\\"\\\"Form to edit Zettel\\\"\\\"\\\"\\n-    luhmann_identifier = StringField(\\n+    luhmann_id = StringField(\\n         label='Luhmann ID'\\n     )\\n     title = StringField(\\n@@ -89,7 +89,7 @@ class ZettelEditForm(FlaskForm):\\n \\n class DigitaliseZettelForm(FlaskForm):\\n     \\\"\\\"\\\"Form to capture data for new Zettels\\\"\\\"\\\"\\n-    luhmann_identifier = StringField(\\n+    luhmann_id = StringField(\\n         label='Luhmann ID',\\n         validators=[\\n             DataRequired()\\n\",\"diff --git a/pis_app/models.py b/pis_app/models.py\\nindex 0b2af82..2c4f360 100644\\n--- a/pis_app/models.py\\n+++ b/pis_app/models.py\\n@@ -4,12 +4,7 @@ from werkzeug.security import generate_password_hash, check_password_hash\\n from pis_app.database import Base\\n from sqlalchemy import Table, Column, Integer, String, ForeignKey, Boolean, DateTime\\n from sqlalchemy.orm import relationship\\n-import enum\\n-\\n-\\n-class RolesEnum(int, enum.Enum):\\n-    ADMIN = 0\\n-    USER = 1\\n+from pis_app.constants import RolesEnum\\n \\n \\n class User(UserMixin, Base):\\n@@ -60,7 +55,7 @@ zettel_links_association = Table(\\n class Zettel(Base):\\n     __tablename__ = 'zettels'\\n     id = Column(Integer, primary_key=True)\\n-    luhmann_identifier = Column(String, unique=True, nullable=False, index=True)\\n+    luhmann_id = Column(String, unique=True, nullable=False, index=True)\\n     title = Column(String, unique=True, nullable=False, index=True)\\n     content = Column(String, default=\\\"\\\")\\n     links = relationship(\\n@@ -71,13 +66,13 @@ class Zettel(Base):\\n     )\\n     updates = relationship('ZettelUpdate', back_populates='zettel')\\n \\n-    def __init__(self, luhmann_identifier: str, title: str, content: str = \\\"\\\") -> None:\\n-        self.luhmann_identifier = luhmann_identifier\\n+    def __init__(self, luhmann_id: str, title: str, content: str = \\\"\\\") -> None:\\n+        self.luhmann_id = luhmann_id\\n         self.title = title\\n         self.content = content\\n \\n     def __repr__(self) -> str:\\n-        return f\\\"<{self.luhmann_identifier}: {self.title}>\\\"\\n+        return f\\\"<{self.luhmann_id}: {self.title}>\\\"\\n \\n     def add_outgoing_links(self, links_list: list) -> None:\\n         self.links.extend(links_list)\\n\",\"diff --git a/pis_app/routes.py b/pis_app/routes.py\\nindex e53a51c..b6ca3e8 100644\\n--- a/pis_app/routes.py\\n+++ b/pis_app/routes.py\\n@@ -1,182 +1,157 @@\\n \\\"\\\"\\\"\\n See 'rsc/Redirect_Backbone.png' for a diagram of the endpoints.\\n \\\"\\\"\\\"\\n-#TODO: CUD operations make a new Zettel Update\\n-from flask import render_template, current_app as app, redirect, flash, url_for\\n+from flask import render_template, current_app as app, redirect, flash, url_for, abort\\n from flask_login import login_required, current_user\\n-from .models import RolesEnum, User, Zettel\\n-from .app import cache\\n+from .models import User, Zettel\\n+from .constants import RolesEnum, FlashEnum\\n from .forms import ZettelSearchForm, ZettelEditForm, DigitaliseZettelForm\\n-import time\\n import datetime as dt\\n-from sqlalchemy.exc import IntegrityError\\n-import uuid\\n-\\n+from .app import cache\\n+import pis_app.errorhandlers\\n+from .utility import ZettelFactory, CacheProcessor, DBSessionProcessor\\n \\n \\n # Route for 'Home' page\\n @app.route('/')\\n @app.route('/index')\\n def index_view():\\n-    return render_template('views/index.html', context={'title': 'Index', 'RolesEnum': RolesEnum})\\n+    return render_template('views/index.html', \\n+                            context={'title': 'Index', \\n+                                    'RolesEnum': RolesEnum})\\n \\n \\n # Route for 'History' page\\n @app.route('/history')\\n def history_view():\\n-    return render_template('views/history.html', context={'title': 'History'})\\n+    return render_template('views/history.html', \\n+                            context={'title': 'History'})\\n \\n \\n # Route for 'Manual' page\\n @app.route('/manual')\\n def manual_view():\\n-    return render_template('views/manual.html', context={'title': 'Manual'})\\n+    return render_template('views/manual.html', \\n+                            context={'title': 'Manual'})\\n \\n \\n # Route for 'Zettel Search' page\\n-@app.route('/zettel_search', methods=['POST', 'GET'])\\n+@app.route('/zettel_search', \\n+            methods=['POST', 'GET'])\\n def zettel_search_view():\\n-    zettels = []\\n-\\n     form = ZettelSearchForm()\\n+\\n     if form.validate_on_submit():\\n-        session = app.Session()\\n-        if form.luhmann_identifier.data and form.title.data:\\n-            zettels = session.query(Zettel).filter(Zettel.title.contains(form.title.data), Zettel.luhmann_identifier.contains(form.luhmann_identifier.data))\\n-        elif form.luhmann_identifier.data:\\n-            zettels = session.query(Zettel).filter(Zettel.luhmann_identifier.contains(form.luhmann_identifier.data))\\n-        elif form.title.data:\\n-            zettels = session.query(Zettel).filter(Zettel.title.contains(form.title.data))\\n-        else:\\n-            zettels = session.query(Zettel).all()\\n-        return render_template('views/zettel_search.html', context={'title': 'Zettel Search', 'zettels':zettels, 'form':form})\\n+        db_session = app.get_db_session()\\n+        zettels = db_session.query(Zettel) \\\\\\n+                                .filter(\\n+                                    Zettel.title.contains(form.title.data), \\n+                                    Zettel.luhmann_id.contains(form.luhmann_id.data))\\n+\\n+        return render_template('views/zettel_search.html', \\n+                                context={'title': 'Zettel Search', \\n+                                        'zettels':zettels, \\n+                                        'form':form})\\n     \\n-    return render_template('views/zettel_search.html', context={'title': 'Zettel Search', 'zettels':[], 'form':form})\\n+    return render_template('views/zettel_search.html', \\n+                            context={'title': 'Zettel Search',\\n+                                    'form': form})\\n \\n \\n # Route for 'Zettel' page\\n-@app.route('/zettel/<int:zettel_id>')\\n-def zettel_view(zettel_id):\\n-    session = app.Session()\\n-    zettel = session.query(Zettel).get(zettel_id)\\n-    return render_template('views/zettel.html', context={'title': zettel.title, 'zettel':zettel, 'RolesEnum': RolesEnum})\\n+@app.route('/zettel/<string:luhmann_id>')\\n+def zettel_view(luhmann_id):\\n+    db_session = app.get_db_session()\\n+    zettel = db_session.query(Zettel) \\\\\\n+                        .filter(Zettel.luhmann_id == luhmann_id).one() \\n+    if not zettel:\\n+        abort(404)\\n+\\n+    return render_template('views/zettel.html', \\n+                            context={'title': zettel.title, \\n+                                    'zettel':zettel, \\n+                                    'RolesEnum': RolesEnum})\\n \\n \\n # Route for 'Zettel Edit' page\\n-@app.route('/zettel_edit/<int:zettel_id>', methods=['POST', 'GET'])\\n-def zettel_edit_view(zettel_id):\\n-    session = app.Session()\\n-    zettel = session.query(Zettel).get(zettel_id)\\n+@app.route('/zettel_edit/<string:luhmann_id>', \\n+            methods=['POST', 'GET'])\\n+def zettel_edit_view(luhmann_id):\\n+    db_session = app.get_db_session()\\n+    zettel = db_session.query(Zettel) \\\\\\n+                        .filter(Zettel.luhmann_id == luhmann_id) \\\\\\n+                        .scalar()\\n+    if not zettel:\\n+        abort(404)\\n     \\n     form = ZettelEditForm()\\n+\\n     if form.validate_on_submit():\\n-        zettel_altered = False\\n-        if form.luhmann_identifier.data:\\n-            zettel.luhmann_identifier = form.luhmann_identifier.data\\n-            zettel_altered = True\\n-\\n-        if form.title.data:\\n-            zettel.title = form.title.data\\n-            zettel_altered = True\\n-        \\n-        if form.content.data:\\n-            zettel.content = form.content.data\\n-            zettel_altered = True\\n-\\n-        if form.links.data:\\n-            link_ids = form.links.data.split(',')\\n-            for link_id in link_ids:\\n-                link_zettel = session.query(Zettel).filter(Zettel.luhmann_identifier == link_id).scalar()\\n-                if link_zettel:\\n-                    zettel.links.append(link_zettel)\\n-                else:\\n-                    link_zettel = Zettel(luhmann_identifier=link_id, title=f\\\"Placeholder Title: <{uuid.uuid4()}>\\\")\\n-                    zettel.links.append(link_zettel)\\n-                zettel_altered = True\\n-        \\n-        if form.backlinks.data:\\n-            backlink_ids = form.backlinks.data.split(',')\\n-            for backlink_id in backlink_ids:\\n-                backlink_zettel = session.query(Zettel).filter(Zettel.luhmann_identifier == backlink_id).scalar()\\n-                if backlink_zettel:\\n-                    zettel.backlinks.append(backlink_zettel)\\n-                else: \\n-                    backlink_zettel = Zettel(luhmann_identifier=backlink_id, title=f\\\"Placeholder Title: <{uuid.uuid4()}>\\\")\\n-                    zettel.backlinks.append(backlink_zettel)\\n-                zettel_altered = True\\n-\\n-        if zettel_altered:\\n-            try:\\n-                session.add(zettel)\\n-                session.commit()\\n-                flash(f'[{zettel.luhmann_identifier}: {zettel.title}] successfully edited!')\\n-                return redirect(url_for('zettel_view', zettel_id=zettel.id))\\n-            except IntegrityError:\\n-                flash(\\\"A Zettel with that Title and/or Luhmann ID already exists! Please try again!\\\")\\n-                return redirect(url_for('zettel_edit_view', zettel_id=zettel_id))\\n+        updated_zettel = ZettelFactory(form=form, db_session=db_session) \\\\\\n+                            .update_zettel(zettel=zettel)\\n+        processor = DBSessionProcessor(db_session=db_session)\\n+\\n+        if not processor.confirm_constraint_satisfaction(object=updated_zettel):\\n+            flash(FlashEnum.ZETTELDUPLICATE.value)\\n+            return redirect(url_for('zettel_edit_view', \\n+                                    luhmann_id=luhmann_id))\\n         \\n-    return render_template('views/zettel_edit.html', context={'title': 'Zettel Edit', 'zettel':zettel, 'form':form})\\n+        processor.add_to_db(updated_zettel)\\n+\\n+        return redirect(url_for('zettel_view', \\n+                                luhmann_id=updated_zettel.luhmann_id))\\n+\\n+    return render_template('views/zettel_edit.html', \\n+                            context={'title': 'Zettel Edit', \\n+                                    'zettel':zettel, \\n+                                    'form':form})\\n \\n \\n # Route for 'Checklist' page\\n @app.route('/checklist')\\n def checklist_view():\\n-    return render_template('views/checklist.html', context={'title': 'Checklist'})\\n+    return render_template('views/checklist.html', \\n+                            context={'title': 'Checklist'})\\n \\n \\n # Route for 'Digitalize Zettel' page\\n @app.route('/digitalize_zettel')\\n def digitalize_zettel_view():\\n-    return render_template('views/digitalize_zettel.html', context={'title': 'Digitalize Zettel'})\\n+    return render_template('views/digitalize_zettel.html', \\n+                            context={'title': 'Digitalize Zettel'})\\n \\n \\n # Route for 'Label Zettel' page\\n-@app.route('/label_zettel', methods=['POST', 'GET'])\\n+@app.route('/label_zettel', \\n+            methods=['POST', 'GET'])\\n def label_zettel_view():\\n     form = DigitaliseZettelForm()\\n+\\n     if form.validate_on_submit():\\n-        zettel = Zettel(\\n-            luhmann_identifier=form.luhmann_identifier.data,\\n-            title=form.title.data,\\n-            content=form.content.data\\n-        )\\n-        session = app.Session()\\n-\\n-        if form.links.data:\\n-            link_ids = form.links.data.split(',')\\n-            for link_id in link_ids:\\n-                link_zettel = session.query(Zettel).filter(Zettel.luhmann_identifier == link_id).scalar()\\n-                if link_zettel:\\n-                    zettel.links.append(link_zettel)\\n-                else:\\n-                    link_zettel = Zettel(luhmann_identifier=link_id, title=f\\\"Placeholder Title: <{uuid.uuid4()}>\\\")\\n-                    zettel.links.append(link_zettel)\\n-        \\n-        if form.backlinks.data:\\n-            backlink_ids = form.backlinks.data.split(',')\\n-            for backlink_id in backlink_ids:\\n-                backlink_zettel = session.query(Zettel).filter(Zettel.luhmann_identifier == backlink_id).scalar()\\n-                if backlink_zettel:\\n-                    zettel.backlinks.append(backlink_zettel)\\n-                else: \\n-                    backlink_zettel = Zettel(luhmann_identifier=backlink_id, title=f\\\"Placeholder Title: <{uuid.uuid4()}>\\\")\\n-                    zettel.backlinks.append(backlink_zettel)\\n-\\n-        try:\\n-            session.add(zettel)\\n-            session.commit()\\n-            return redirect(url_for('zettel_view', zettel_id=zettel.id))\\n-        except IntegrityError:\\n-            flash(\\\"A Zettel with that Title and/or Luhmann ID already exists! Please try again!\\\")\\n+        db_session = app.get_db_session()\\n+        zettel = ZettelFactory(form=form, db_session=db_session) \\\\\\n+                    .create_zettel()\\n+        processor = DBSessionProcessor(db_session=db_session)\\n+\\n+        if not processor.confirm_constraint_satisfaction(object=zettel):\\n+            flash(FlashEnum.ZETTELDUPLICATE.value)\\n             return redirect(url_for('label_zettel_view'))\\n \\n-    return render_template('views/label_zettel.html', context={'title': 'Label Zettel', 'form': form})\\n+        processor.add_to_db(zettel)\\n+\\n+        return redirect(url_for('zettel_view', \\n+                                luhmann_id=zettel.luhmann_id))\\n+\\n+    return render_template('views/label_zettel.html', \\n+                            context={'title': 'Label Zettel', \\n+                                    'form': form})\\n \\n \\n # Route for 'Success' page\\n @app.route('/success')\\n def success_view():\\n-    return render_template('views/success.html', context={'title': 'Success'})\\n+    return render_template('views/success.html', \\n+                            context={'title': 'Success'})\\n \\n \\n # Route for 'Admin' page\\n@@ -184,10 +159,13 @@ def success_view():\\n @login_required\\n def admin_view():\\n     if current_user.role == RolesEnum.ADMIN.value:\\n-        session = app.Session()\\n-        users = session.query(User).all()\\n-        return render_template('views/admin.html', context={'title':'Admin Area', 'RolesEnum': RolesEnum, 'users':users})\\n-    flash('You are not an admin!')\\n+        db_session = app.get_db_session()\\n+        users = db_session.query(User).all()\\n+        return render_template('views/admin.html', \\n+                                context={'title':'Admin Area', \\n+                                        'RolesEnum': RolesEnum, \\n+                                        'users':users})\\n+    flash(FlashEnum.ADMIN_ERROR.value)\\n     return redirect(url_for('index_view'))\\n \\n \\n@@ -195,20 +173,23 @@ def admin_view():\\n # @cache.cached()  # caches the WHOLE view\\n def bottleneck_view():\\n     app.logger.info(f'Time upon request: {dt.datetime.now()}')\\n-    title = cache.get('title')\\n-    if title is None:\\n-        time.sleep(10)\\n-        cache.set('title', 'Bottleneck Area')\\n+    title = CacheProcessor(cache=cache) \\\\\\n+                .get(keyword='title')\\n     app.logger.info(f'Time upon response: {dt.datetime.now()}')\\n-    return render_template('views/bottleneck.html', context={'title':title})\\n+    return render_template('views/bottleneck.html', \\n+                            context={'title':title})\\n \\n \\n-@app.route('/delete/<int:zettel_id>')\\n+@app.route('/delete/<string:luhmann_id>')\\n @login_required\\n-def delete_zettel(zettel_id):\\n-    session = app.Session()\\n-    zettel = session.query(Zettel).get(zettel_id)\\n-    session.delete(zettel)\\n-    session.commit()\\n-    flash(f\\\"[{zettel.luhmann_identifier} {zettel.title}] was deleted\\\")\\n+def delete_zettel(luhmann_id):\\n+    db_session = app.get_db_session()\\n+    zettel = db_session.query(Zettel) \\\\\\n+                        .filter(Zettel.luhmann_id == luhmann_id).one()\\n+    if not zettel:\\n+        abort(404)\\n+    \\n+    DBSessionProcessor(db_session=db_session) \\\\\\n+        .delete_from_db(zettel)\\n+    flash(f\\\"[{zettel.luhmann_id} {zettel.title}] was deleted\\\")\\n     return redirect(url_for('index_view'))\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/schemas.py b/pis_app/schemas.py\\ndeleted file mode 100644\\nindex e69de29..0000000\\n--- a/pis_app/schemas.py\\n+++ /dev/null\\n\",\"diff --git a/pis_app/templates/views/404.html b/pis_app/templates/views/404.html\\nnew file mode 100644\\nindex 0000000..2711c82\\n--- /dev/null\\n+++ b/pis_app/templates/views/404.html\\n@@ -0,0 +1,9 @@\\n+{% extends 'components/base.html' %}\\n+\\n+{% block content %}\\n+\\n+<h2>Oops!</h2>\\n+\\n+<p>Looks like the page you requested doesn't exist!</p>\\n+\\n+{% endblock content %}\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/templates/views/label_zettel.html b/pis_app/templates/views/label_zettel.html\\nindex 45d640b..40746bf 100644\\n--- a/pis_app/templates/views/label_zettel.html\\n+++ b/pis_app/templates/views/label_zettel.html\\n@@ -8,9 +8,9 @@\\n     {{ context.form.csrf_token }}\\n \\n     <fieldset>\\n-      {{ context.form.luhmann_identifier.label }}\\n-      {{ context.form.luhmann_identifier }}\\n-      {% for error in context.form.luhmann_identifier.errors %}\\n+      {{ context.form.luhmann_id.label }}\\n+      {{ context.form.luhmann_id }}\\n+      {% for error in context.form.luhmann_id.errors %}\\n         {{ error }}\\n       {% endfor %}\\n     </fieldset>\\n\",\"diff --git a/pis_app/templates/views/zettel.html b/pis_app/templates/views/zettel.html\\nindex 8a4b237..e7ca31c 100644\\n--- a/pis_app/templates/views/zettel.html\\n+++ b/pis_app/templates/views/zettel.html\\n@@ -1,26 +1,26 @@\\n {% extends 'components/base.html' %}\\n \\n {% block content %}\\n-  <h2>{{context.zettel.luhmann_identifier}} {{context.zettel.title}} </h2>\\n+  <h2>{{context.zettel.luhmann_id}} {{context.zettel.title}} </h2>\\n \\n   <h4>Content</h4> \\n   <p>{{context.zettel.content}}</p>\\n \\n   <h4>Links</h4>\\n   {% for zettel in context.zettel.links %}\\n-    <a href=\\\"{{ url_for('zettel_view', zettel_id=zettel.id)}}\\\">{{zettel.luhmann_identifier}} {{zettel.title}}</a>\\n+    <a href=\\\"{{ url_for('zettel_view', luhmann_id=zettel.luhmann_id)}}\\\">{{zettel.luhmann_id}} {{zettel.title}}</a>\\n   {% endfor %}\\n \\n   <h4>Backlinks</h4>\\n   {% for zettel in context.zettel.backlinks %}\\n-    <a href=\\\"{{ url_for('zettel_view', zettel_id=zettel.id)}}\\\">{{zettel.luhmann_identifier}} {{zettel.title}}</a>\\n+    <a href=\\\"{{ url_for('zettel_view', luhmann_id=zettel.luhmann_id)}}\\\">{{zettel.luhmann_id}} {{zettel.title}}</a>\\n   {% endfor %}\\n \\n   <br>\\n   <br>\\n   {% if current_user.role == context.RolesEnum.ADMIN %}\\n-    <a href=\\\"{{ url_for('zettel_edit_view', zettel_id=context.zettel.id) }}\\\">Edit</a> - \\n-    <a href=\\\"{{ url_for('delete_zettel', zettel_id=context.zettel.id) }}\\\">Delete</a>\\n+    <a href=\\\"{{ url_for('zettel_edit_view', luhmann_id=context.zettel.luhmann_id) }}\\\">Edit</a> - \\n+    <a href=\\\"{{ url_for('delete_zettel', luhmann_id=context.zettel.luhmann_id) }}\\\">Delete</a>\\n   {% endif %}\\n {% endblock content %}\\n \\n\",\"diff --git a/pis_app/templates/views/zettel_edit.html b/pis_app/templates/views/zettel_edit.html\\nindex 4592777..e6a3b67 100644\\n--- a/pis_app/templates/views/zettel_edit.html\\n+++ b/pis_app/templates/views/zettel_edit.html\\n@@ -4,14 +4,14 @@\\n \\n   <div>\\n \\n-    <h1>Edit {{ context.zettel.luhmann_identifier}} {{context.zettel.title}}</h1>\\n+    <h1>Edit {{ context.zettel.luhmann_id}} {{context.zettel.title}}</h1>\\n \\n-    <form method=\\\"POST\\\" action=\\\"/zettel_edit/{{context.zettel.id}}\\\">\\n+    <form method=\\\"POST\\\" action=\\\"/zettel_edit/{{context.zettel.luhmann_id}}\\\">\\n       {{ context.form.csrf_token }}\\n \\n       <fieldset>\\n-        {{ context.form.luhmann_identifier.label }}\\n-        {{ context.form.luhmann_identifier(placeholder=context.zettel.luhmann_identifier) }}\\n+        {{ context.form.luhmann_id.label }}\\n+        {{ context.form.luhmann_id(placeholder=context.zettel.luhmann_id) }}\\n       </fieldset>\\n \\n       <fieldset>\\n\",\"diff --git a/pis_app/templates/views/zettel_search.html b/pis_app/templates/views/zettel_search.html\\nindex 0279944..c60c19c 100644\\n--- a/pis_app/templates/views/zettel_search.html\\n+++ b/pis_app/templates/views/zettel_search.html\\n@@ -10,8 +10,8 @@\\n       {{ context.form.csrf_token }}\\n \\n       <fieldset>\\n-        {{ context.form.luhmann_identifier.label }}\\n-        {{ context.form.luhmann_identifier(placeholder='1a3d9b2') }}\\n+        {{ context.form.luhmann_id.label }}\\n+        {{ context.form.luhmann_id(placeholder='1a3d9b2') }}\\n       </fieldset>\\n \\n       <fieldset>\\n@@ -26,7 +26,8 @@\\n     </form>\\n   </div>\\n \\n-  {% for zettel in context.zettels|sort(attribute='luhmann_identifier') %}\\n-    <a href=\\\"{{ url_for('zettel_view', zettel_id=zettel.id) }}\\\">{{ zettel.luhmann_identifier }}: {{ zettel.title }}</a> <br>\\n+  {% for zettel in context.zettels|sort(attribute='luhmann_id') %}\\n+    <a href=\\\"{{ url_for('zettel_view', luhmann_id=zettel.luhmann_id) }}\\\">{{ zettel.luhmann_id }}: {{ zettel.title }}</a> <br>\\n   {% endfor %}\\n+  \\n {% endblock content %}\\n\\\\ No newline at end of file\\n\",\"diff --git a/pis_app/utility.py b/pis_app/utility.py\\nnew file mode 100644\\nindex 0000000..3c1bb53\\n--- /dev/null\\n+++ b/pis_app/utility.py\\n@@ -0,0 +1,142 @@\\n+from flask_wtf import FlaskForm\\n+from pis_app.models import Zettel\\n+from uuid import uuid4\\n+from sqlalchemy.orm import Session\\n+import time\\n+\\n+\\n+class ZettelFactory():\\n+    \\\"\\\"\\\"Instantiates Zettel objects using the 'create_zettel' method\\\"\\\"\\\"\\n+\\n+    def __init__(self, form: FlaskForm, db_session: Session):\\n+        self.form = form\\n+        self.db_session = db_session\\n+\\n+\\n+    def create_zettel(self) -> Zettel:\\n+        zettel = self._zettel_instantiation()\\n+        self._update_links(zettel)\\n+        self._update_backlinks(zettel)\\n+\\n+        return zettel\\n+\\n+\\n+    def update_zettel(self, zettel: Zettel) -> Zettel:\\n+        self._update_data(zettel)\\n+        self._update_links(zettel, purge=True)\\n+        self._update_backlinks(zettel, purge=True)\\n+        return zettel\\n+\\n+\\n+    def _zettel_instantiation(self) -> Zettel:\\n+        zettel = Zettel(\\n+            luhmann_id = self.form.luhmann_id.data,\\n+            title = self.form.title.data,\\n+            content = self.form.content.data\\n+        )\\n+        return zettel\\n+\\n+\\n+    def _update_data(self, zettel: Zettel) -> None:\\n+        if self.form.luhmann_id.data:\\n+            zettel.luhmann_id = self.form.luhmann_id.data\\n+        if self.form.title.data:\\n+            zettel.title = self.form.title.data\\n+        if self.form.content.data:\\n+            zettel.content = self.form.content.data\\n+\\n+    def _update_links(self, zettel: Zettel, purge=False) -> None:\\n+        if self.form.links.data:\\n+            if purge:\\n+                zettel.links.clear()\\n+\\n+            link_ids = [link.strip() for link in self.form.links.data.split(',')]\\n+            for link_id in link_ids:\\n+                link_zettel = self.db_session \\\\\\n+                                    .query(Zettel) \\\\\\n+                                    .filter(Zettel.luhmann_id == link_id) \\\\\\n+                                    .scalar()\\n+\\n+                # link to the zettel if it already exists\\n+                if link_zettel:\\n+                    zettel.links.append(link_zettel)\\n+                # otherwise, create a placeholder zettel for the link\\n+                else:\\n+                    link_zettel = Zettel(luhmann_id=link_id, \\n+                                        title=f\\\"Placeholder Title: <{uuid4()}>\\\")\\n+                    zettel.links.append(link_zettel)\\n+\\n+\\n+    def _update_backlinks(self, zettel: Zettel, purge=False) -> None:\\n+        if self.form.backlinks.data:\\n+            if purge:\\n+                zettel.backlinks.clear()\\n+\\n+            backlink_ids = [backlink.strip() for backlink in self.form.backlinks.data.split(',')]\\n+\\n+            for backlink_id in backlink_ids:\\n+                backlink_zettel = self.db_session \\\\\\n+                                        .query(Zettel) \\\\\\n+                                        .filter(Zettel.luhmann_id == backlink_id) \\\\\\n+                                        .scalar()\\n+\\n+                # backlink to the zettel if it already exists\\n+                if backlink_zettel:\\n+                    zettel.backlinks.append(backlink_zettel)\\n+                # otherwise, create a placeholder zettel for the backlink\\n+                else: \\n+                    backlink_zettel = Zettel(luhmann_id=backlink_id, \\n+                                            title=f\\\"Placeholder Title: <{uuid4()}>\\\")\\n+                    zettel.backlinks.append(backlink_zettel)\\n+\\n+\\n+class CacheProcessor:\\n+    \\\"\\\"\\\"Abstraction Layer for easy access to the Cache\\\"\\\"\\\"\\n+    def __init__(self, cache) -> None:\\n+        self.cache = cache\\n+\\n+    def get(self, keyword) -> str:\\n+        cached_value = self.cache.get(keyword)\\n+        if cached_value:\\n+            return cached_value\\n+        else:\\n+            return self.set(keyword=keyword)\\n+\\n+    def set(self, keyword) -> str:\\n+        time.sleep(10)\\n+        self.cache.set(keyword, 'Bottleneck Area')\\n+        return self.cache.get(keyword)\\n+\\n+\\n+\\n+class DBSessionProcessor:\\n+    \\\"\\\"\\\"Session Processor that helps with updating the zettels in the Database\\\"\\\"\\\"\\n+    def __init__(self, db_session: Session):\\n+        self.db_session = db_session\\n+\\n+    def delete_from_db(self, object):\\n+        self.db_session.delete(object)\\n+        self.db_session.commit()\\n+\\n+    def add_to_db(self, object):\\n+        self.db_session.add(object)\\n+        self.db_session.commit()\\n+        \\n+\\n+    def confirm_constraint_satisfaction(self, object: Zettel):\\n+        \\\"\\\"\\\"\\\"Check if no Zettel constraint was violated\\\"\\\"\\\"\\n+        title_duplicate         = self.db_session.query(Zettel) \\\\\\n+                                                    .filter(Zettel.title == object.title,\\n+                                                            Zettel.id != object.id) \\\\\\n+                                                    .scalar()\\n+        luhmann_id_duplicate    = self.db_session.query(Zettel) \\\\\\n+                                                    .filter(Zettel.luhmann_id == object.luhmann_id,\\n+                                                            Zettel.id != object.id) \\\\\\n+                                                    .scalar()\\n+        if title_duplicate or luhmann_id_duplicate:\\n+            return False\\n+        \\n+        return True\\n+\\n+\\n+    \\n\\\\ No newline at end of file\\n\"]", "test_patch": "[\"diff --git a/tests/conftest.py b/tests/conftest.py\\nindex 5d72c30..18ea6ff 100644\\n--- a/tests/conftest.py\\n+++ b/tests/conftest.py\\n@@ -18,7 +18,7 @@ def user():\\n \\n @pytest.fixture(scope='module')\\n def zettel():\\n-    zettel = Zettel(luhmann_identifier='1', title='Zettelkasten', content='')\\n+    zettel = Zettel(luhmann_id='1', title='Zettelkasten', content='')\\n     return zettel\\n \\n \\n@@ -60,8 +60,8 @@ def init_database(test_client, session):\\n     Base.metadata.create_all()\\n \\n     # Populate the DB\\n-    zettel1 = Zettel(luhmann_identifier='1', title='Zettelkasten')\\n-    zettel2 = Zettel(luhmann_identifier='1a', title='Basic Usage')\\n+    zettel1 = Zettel(luhmann_id='1', title='Zettelkasten')\\n+    zettel2 = Zettel(luhmann_id='1a', title='Basic Usage')\\n \\n     session.add_all([zettel1, zettel2])\\n     session.commit()\\n\",\"diff --git a/tests/unit/test_models.py b/tests/unit/test_models.py\\nindex 9b2ac04..29fb896 100644\\n--- a/tests/unit/test_models.py\\n+++ b/tests/unit/test_models.py\\n@@ -21,10 +21,10 @@ def test_new_zettel(self):\\n         \\\"\\\"\\\"\\n         GIVEN a Zettel Model\\n         WHEN a Zettel object is being created\\n-        THEN check the 'luhmann_identifier', 'title', 'content' are correctly defined\\n+        THEN check the 'luhmann_id', 'title', 'content' are correctly defined\\n         \\\"\\\"\\\"\\n-        zettel = Zettel(luhmann_identifier='1b', title='grey chair', content='there is a grey chair in front of me')\\n-        assert zettel.luhmann_identifier == '1b'\\n+        zettel = Zettel(luhmann_id='1b', title='grey chair', content='there is a grey chair in front of me')\\n+        assert zettel.luhmann_id == '1b'\\n         assert zettel.title == 'grey chair'\\n         assert zettel.content == 'there is a grey chair in front of me'\\n \\n@@ -34,8 +34,8 @@ def test_adding_zettel_link(self):\\n         WHEN a Zettel is linked to the other\\n         THEN check 'links' and 'backlinks' are properly populated\\n         \\\"\\\"\\\"\\n-        zettel1 = Zettel(luhmann_identifier='1b', title='grey chair', content='there is a grey chair in front of me')\\n-        zettel2 = Zettel(luhmann_identifier='1', title='chairs', content='chairs come in different shapes and colors')\\n+        zettel1 = Zettel(luhmann_id='1b', title='grey chair', content='there is a grey chair in front of me')\\n+        zettel2 = Zettel(luhmann_id='1', title='chairs', content='chairs come in different shapes and colors')\\n \\n         zettel1.add_outgoing_links([zettel2])\\n \\n\"]", "hints_text": ""}
