{"instance_id": "1419899735879720", "repo": "stfc/psyclone", "base_commit": "63aeb8d93df4967e9c26f2814a3b28fab72cc090", "problem_statement": "Loop tiling transformation:\\nNow that we have a loop chunking transformation and a loop swap order transformation, we can combine both to make a loop tiling transformation. This can potentially improve caching performance is some stencil applications.", "FAIL_TO_PASS": ["src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py::test_chunkloop_trans_apply_pos", "src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py::test_chunkloop_trans_apply_with_options", "src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py::test_chunkloop_trans_apply_double_chunk", "src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py::test_chunkloop_trans_validation_options", "src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py::test_chunkloop_trans_apply_neg"], "PASS_TO_PASS": [], "language": "python", "test_command": "source /saved/ENV || source /saved/*/ENV && pytest --no-header -rA --tb=no -p no:cacheprovider --continue-on-collection-errors", "test_output_parser": "python/parse_log_pytest_v3", "image_storage_uri": "vmvm-registry.fbinfra.net/repomate_image_activ_pytest/stfc_psyclone:63aeb8d93df4967e9c26f2814a3b28fab72cc090", "patch": "", "test_patch": "[\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nnew file mode 100644\\nindex 0000000000..422baf7550\\n--- /dev/null\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -0,0 +1,150 @@\\n+# -----------------------------------------------------------------------------\\n+# BSD 3-Clause License\\n+#\\n+# Copyright (c) 2021, Science and Technology Facilities Council.\\n+# All rights reserved.\\n+#\\n+# Redistribution and use in source and binary forms, with or without\\n+# modification, are permitted provided that the following conditions are met:\\n+#\\n+# * Redistributions of source code must retain the above copyright notice, this\\n+#   list of conditions and the following disclaimer.\\n+#\\n+# * Redistributions in binary form must reproduce the above copyright notice,\\n+#   this list of conditions and the following disclaimer in the documentation\\n+#   and/or other materials provided with the distribution.\\n+#\\n+# * Neither the name of the copyright holder nor the names of its\\n+#   contributors may be used to endorse or promote products derived from\\n+#   this software without specific prior written permission.\\n+#\\n+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\\n+# \\\"AS IS\\\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\\n+# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS\\n+# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\\n+# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,\\n+# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,\\n+# BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\\n+# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER\\n+# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\\n+# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN\\n+# ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\\n+# POSSIBILITY OF SUCH DAMAGE.\\n+# -----------------------------------------------------------------------------\\n+# Author: S. Siso, STFC Daresbury Lab\\n+# -----------------------------------------------------------------------------\\n+\\n+'''This module contains the unit tests for the LoopTiling2DTrans module'''\\n+\\n+from __future__ import absolute_import, print_function\\n+import pytest\\n+\\n+from psyclone.psyir.nodes import Loop\\n+from psyclone.psyir.transformations import TransformationError, \\\\\\n+    LoopTiling2DTrans\\n+from psyclone.tests.utilities import Compile\\n+\\n+\\n+def test_loop_tiling_2d_trans():\\n+    '''Test the base methods of LoopTiling2DTrans'''\\n+    trans = LoopTiling2DTrans()\\n+    assert str(trans) == \\\"Tile the loop construct using 2D blocks\\\"\\n+\\n+\\n+def test_loop_tiling_2d_trans_validation(fortran_reader):\\n+    ''' Validation passes when found a 2D nested loop construct. '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    LoopTiling2DTrans().validate(outer_loop)\\n+\\n+\\n+def test_loop_tiling_2d_trans_validation1(fortran_reader):\\n+    ''' Validation fails if the outer loop has more than one child. '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j, a\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              a = 4\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    with pytest.raises(NoMatchError) as err:\\n+        LoopTiling2DTrans().validate(outer_loop)\\n+\\n+\\n+def test_loop_tiling_2d_trans_validation2(fortran_reader):\\n+    ''' Validation fails if the loop body is not another loop. '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    with pytest.raises(NoMatchError) as err:\\n+        LoopTiling2DTrans().validate(outer_loop)\\n+\\n+\\n+def test_loop_tiling_2d_trans_validation3(fortran_reader):\\n+    ''' Validation fails if the loop body may have side effects. '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            use other_mod\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                call my_sub(i, j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    with pytest.raises(NoMatchError) as err:\\n+        LoopTiling2DTrans().validate(outer_loop)\\n+\\n+def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n+    ''' Validation passes when found a 2D nested loop construct. '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    LoopTiling2DTrans().validate(outer_loop)\\n+\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    result = fortran_writer(outer_loop)\\n+    print(result)\\n+    assert False\\n+\\n+\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nindex 422baf7550..626e327757 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -42,7 +42,6 @@\\n from psyclone.psyir.nodes import Loop\\n from psyclone.psyir.transformations import TransformationError, \\\\\\n     LoopTiling2DTrans\\n-from psyclone.tests.utilities import Compile\\n \\n \\n def test_loop_tiling_2d_trans():\\n@@ -85,7 +84,7 @@ def test_loop_tiling_2d_trans_validation1(fortran_reader):\\n         end subroutine test\\n      ''')\\n     outer_loop = psyir.walk(Loop)[0]\\n-    with pytest.raises(NoMatchError) as err:\\n+    with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n \\n \\n@@ -102,7 +101,7 @@ def test_loop_tiling_2d_trans_validation2(fortran_reader):\\n         end subroutine test\\n      ''')\\n     outer_loop = psyir.walk(Loop)[0]\\n-    with pytest.raises(NoMatchError) as err:\\n+    with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n \\n \\n@@ -122,9 +121,10 @@ def test_loop_tiling_2d_trans_validation3(fortran_reader):\\n         end subroutine test\\n      ''')\\n     outer_loop = psyir.walk(Loop)[0]\\n-    with pytest.raises(NoMatchError) as err:\\n+    with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n \\n+\\n def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n     ''' Validation passes when found a 2D nested loop construct. '''\\n     psyir = fortran_reader.psyir_from_source('''\\n@@ -140,11 +140,21 @@ def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n         end subroutine test\\n      ''')\\n     outer_loop = psyir.walk(Loop)[0]\\n-    LoopTiling2DTrans().validate(outer_loop)\\n+    LoopTiling2DTrans().apply(outer_loop)\\n \\n     outer_loop = psyir.walk(Loop)[0]\\n     result = fortran_writer(outer_loop)\\n     print(result)\\n-    assert False\\n-\\n-\\n+    expected = '''\\\\\\n+do i_out_var = 1, 100, 32\\n+  i_el_inner = MIN(i_out_var + 32, 100)\\n+  do j_out_var = 1, 100, 32\\n+    do i = i_out_var, i_el_inner, 1\\n+      j_el_inner = MIN(j_out_var + 32, 100)\\n+      do j = j_out_var, j_el_inner, 1\\n+        tmp(i,j) = 2 * tmp(i,j)\\n+      enddo\\n+    enddo\\n+  enddo\\n+enddo'''\\n+    assert expected in result\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\nindex 9eea5e1dbc..1ef1ed158b 100644\\n--- a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n@@ -306,7 +306,7 @@ def test_chunkloop_trans_apply_pos():\\n     code = str(psy.gen)\\n     correct = \\\\\\n         '''DO j_out_var = cu_fld%internal%ystart, cu_fld%internal%ystop, 32\\n-        j_el_inner = MIN(j_out_var + 32, cu_fld%internal%ystop)\\n+        j_el_inner = MIN(j_out_var + (32 - 1), cu_fld%internal%ystop)\\n         DO j = j_out_var, j_el_inner, 1\\n           DO i = cu_fld%internal%xstart, cu_fld%internal%xstop, 1\\n     '''\\n@@ -332,7 +332,7 @@ def test_chunkloop_trans_apply_neg():\\n     code = str(psy.gen)\\n     correct = \\\\\\n         '''DO j_out_var = cu_fld%internal%ystart, cu_fld%internal%ystop, -32\\n-        j_el_inner = MAX(j_out_var - 32, cu_fld%internal%ystop)\\n+        j_el_inner = MAX(j_out_var - (32 + 1), cu_fld%internal%ystop)\\n         DO j = j_out_var, j_el_inner, -1\\n           DO i = cu_fld%internal%xstart, cu_fld%internal%xstop, 1\\n     '''\\n@@ -380,10 +380,10 @@ def test_chunkloop_trans_apply_double_chunk(tmpdir):\\n \\n     correct = \\\\\\n         '''do i_out_var = 1, end, 32\\n-    i_el_inner = MIN(i_out_var + 32, end)\\n+    i_el_inner = MIN(i_out_var + (32 - 1), end)\\n     do i = i_out_var, i_el_inner, 1\\n       do j_out_var = 1, end, 32\\n-        j_el_inner = MIN(j_out_var + 32, end)\\n+        j_el_inner = MIN(j_out_var + (32 - 1), end)\\n         do j = j_out_var, j_el_inner, 1\\n           ai(i,j) = 1\\n         enddo\\n@@ -391,10 +391,10 @@ def test_chunkloop_trans_apply_double_chunk(tmpdir):\\n     enddo\\n   enddo\\n   do i_out_var = 1, end, 32\\n-    i_el_inner = MIN(i_out_var + 32, end)\\n+    i_el_inner = MIN(i_out_var + (32 - 1), end)\\n     do i = i_out_var, i_el_inner, 2\\n       do j_out_var = 1, end, 32\\n-        j_el_inner = MIN(j_out_var + 32, end)\\n+        j_el_inner = MIN(j_out_var + (32 - 1), end)\\n         do j = j_out_var, j_el_inner, 2\\n           aj(i,j) = 1\\n         enddo\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nindex 626e327757..cf1cef4140 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -147,10 +147,10 @@ def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n     print(result)\\n     expected = '''\\\\\\n do i_out_var = 1, 100, 32\\n-  i_el_inner = MIN(i_out_var + 32, 100)\\n+  i_el_inner = MIN(i_out_var + (32 - 1), 100)\\n   do j_out_var = 1, 100, 32\\n     do i = i_out_var, i_el_inner, 1\\n-      j_el_inner = MIN(j_out_var + 32, 100)\\n+      j_el_inner = MIN(j_out_var + (32 - 1), 100)\\n       do j = j_out_var, j_el_inner, 1\\n         tmp(i,j) = 2 * tmp(i,j)\\n       enddo\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_swap_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_swap_trans_test.py\\nindex b49c6395c8..5d3c412c2a 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_swap_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_swap_trans_test.py\\n@@ -44,7 +44,7 @@\\n import pytest\\n \\n from psyclone.domain.gocean.transformations import GOceanLoopFuseTrans\\n-from psyclone.psyir.nodes import CodeBlock\\n+from psyclone.psyir.nodes import CodeBlock, Loop\\n from psyclone.psyir.symbols import ContainerSymbol\\n from psyclone.psyir.transformations import LoopSwapTrans, TransformationError\\n from psyclone.tests.gocean1p0_build import GOcean1p0Build\\n@@ -238,6 +238,43 @@ def test_loop_swap_validate_nodes_in_loop(fortran_reader):\\n             \\\"transformation\\\" in str(err.value))\\n \\n \\n+def test_loop_swap_validate_dependent_loop(fortran_reader):\\n+    '''\\n+    Tests that loops containing dependencies between the inner or the outer\\n+    loop variables and boundary expressions are not validated for swapping.\\n+    '''\\n+    swap_trans = LoopSwapTrans()\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        program test_prog\\n+            integer :: i, j\\n+            real, dimension(10) :: a\\n+            do j = 1, 10\\n+                do i = 1, j\\n+                    a = a + 1\\n+                enddo\\n+            enddo\\n+            do j = 3 + 2 * i, 10\\n+                do i = 1, 10\\n+                    a = a + 1\\n+                enddo\\n+            enddo\\n+         end program test_prog''')\\n+\\n+    loops = psyir.walk(Loop, stop_type=Loop)\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        swap_trans.apply(loops[0])\\n+    assert (\\\"Error in LoopSwap transformation: The outer loop iteration \\\"\\n+            \\\"variable 'j' is part of the inner loop boundary expressions, \\\"\\n+            \\\"so their order can not be swapped.\\\" in str(err.value))\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        swap_trans.apply(loops[1])\\n+    assert (\\\"Error in LoopSwap transformation: The inner loop iteration \\\"\\n+            \\\"variable 'i' is part of the outer loop boundary expressions, \\\"\\n+            \\\"so their order can not be swapped.\\\" in str(err.value))\\n+\\n+\\n def test_loop_swap_schedule_is_kept():\\n     ''' Testing that the existing schedules remain in place (since they could\\n     contain annotations).\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\nindex 1ef1ed158b..707ebae3c9 100644\\n--- a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n@@ -31,7 +31,8 @@\\n # ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\\n # POSSIBILITY OF SUCH DAMAGE.\\n # -----------------------------------------------------------------------------\\n-# Authors A. B. G. Chalk STFC Daresbury Lab\\n+# Authors A. B. G. Chalk, STFC Daresbury Lab\\n+# Modified S. Siso, STFC Daresbury Lab\\n # -----------------------------------------------------------------------------\\n \\n '''This module contains the unit tests for the ChunkLoopTrans module'''\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nindex cf1cef4140..91e940fcea 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -86,6 +86,8 @@ def test_loop_tiling_2d_trans_validation1(fortran_reader):\\n     outer_loop = psyir.walk(Loop)[0]\\n     with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n+    assert (\\\"must be a sub-class of Loop but got 'Assignment'.\\\"\\n+            in str(err.value))\\n \\n \\n def test_loop_tiling_2d_trans_validation2(fortran_reader):\\n@@ -103,6 +105,8 @@ def test_loop_tiling_2d_trans_validation2(fortran_reader):\\n     outer_loop = psyir.walk(Loop)[0]\\n     with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n+    assert (\\\"must be a sub-class of Loop but got 'Assignment'.\\\"\\n+            in str(err.value))\\n \\n \\n def test_loop_tiling_2d_trans_validation3(fortran_reader):\\n@@ -123,6 +127,8 @@ def test_loop_tiling_2d_trans_validation3(fortran_reader):\\n     outer_loop = psyir.walk(Loop)[0]\\n     with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().validate(outer_loop)\\n+    assert (\\\"Nodes of type 'Call' cannot be enclosed by a LoopSwapTrans \\\"\\n+            \\\"transformation\\\" in str(err.value))\\n \\n \\n def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\nindex 707ebae3c9..cdda3d527c 100644\\n--- a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n@@ -295,6 +295,33 @@ def test_chunkloop_trans_validate7():\\n             \\\"CodeBlock node.\\\") in str(excinfo.value)\\n \\n \\n+def test_chunkloop_trans_validation_options(fortran_reader):\\n+    ''' Validation fails if an invalid option map is provided '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    with pytest.raises(TransformationError) as err:\\n+        ChunkLoopTrans().validate(outer_loop, {'unsupported': None})\\n+    assert (\\\"The ChunkLoopTrans does not support the transformation option\\\"\\n+            \\\" 'unsupported', the supported options are: ['chunksize'].\\\"\\n+            in str(err.value))\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        ChunkLoopTrans().validate(outer_loop, {'chunksize': '32'})\\n+    assert (\\\"The ChunkLoopTrans chunksize option must be an integer but \\\"\\n+            \\\"found a 'str'.\\\" in str(err.value))\\n+\\n+\\n def test_chunkloop_trans_apply_pos():\\n     '''Test the apply method of ChunkLoopTrans for a positive step index'''\\n     _, invoke_info = parse(os.path.join(GOCEAN_BASE_PATH, \\\"single_invoke.f90\\\"),\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nindex 91e940fcea..e2844330f5 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -131,6 +131,33 @@ def test_loop_tiling_2d_trans_validation3(fortran_reader):\\n             \\\"transformation\\\" in str(err.value))\\n \\n \\n+def test_loop_tiling_2d_trans_validation_options(fortran_reader):\\n+    ''' Validation fails if an invalid option map is provided '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    with pytest.raises(TransformationError) as err:\\n+        LoopTiling2DTrans().apply(outer_loop, {'unsupported': None})\\n+    assert (\\\"The LoopTiling2DTrans does not support the transformation option\\\"\\n+            \\\" 'unsupported', the supported options are: ['tilesize'].\\\"\\n+            in str(err.value))\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        LoopTiling2DTrans().apply(outer_loop, {'tilesize': '32'})\\n+    assert (\\\"The LoopTiling2DTrans tilesize option must be an integer but \\\"\\n+            \\\"found a 'str'.\\\" in str(err.value))\\n+\\n+\\n def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n     ''' Validation passes when found a 2D nested loop construct. '''\\n     psyir = fortran_reader.psyir_from_source('''\\n@@ -150,7 +177,6 @@ def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n \\n     outer_loop = psyir.walk(Loop)[0]\\n     result = fortran_writer(outer_loop)\\n-    print(result)\\n     expected = '''\\\\\\n do i_out_var = 1, 100, 32\\n   i_el_inner = MIN(i_out_var + (32 - 1), 100)\\n@@ -164,3 +190,38 @@ def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n   enddo\\n enddo'''\\n     assert expected in result\\n+\\n+\\n+def test_loop_tiling_2d_trans_apply_options(fortran_reader, fortran_writer):\\n+    ''' Validation passes when found a 2D nested loop construct when a\\n+    non-default tilesize option is provided '''\\n+    psyir = fortran_reader.psyir_from_source('''\\n+        subroutine test(tmp)\\n+            integer:: i, j\\n+            integer, intent(inout), dimension(100,100) :: tmp\\n+\\n+            do i=1, 100\\n+              do j=1, 100\\n+                tmp(i,j) = 2 * tmp(i,j)\\n+              enddo\\n+            enddo\\n+        end subroutine test\\n+     ''')\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    LoopTiling2DTrans().apply(outer_loop, {\\\"tilesize\\\": 64})\\n+\\n+    outer_loop = psyir.walk(Loop)[0]\\n+    result = fortran_writer(outer_loop)\\n+    expected = '''\\\\\\n+do i_out_var = 1, 100, 64\\n+  i_el_inner = MIN(i_out_var + (64 - 1), 100)\\n+  do j_out_var = 1, 100, 64\\n+    do i = i_out_var, i_el_inner, 1\\n+      j_el_inner = MIN(j_out_var + (64 - 1), 100)\\n+      do j = j_out_var, j_el_inner, 1\\n+        tmp(i,j) = 2 * tmp(i,j)\\n+      enddo\\n+    enddo\\n+  enddo\\n+enddo'''\\n+    assert expected in result\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\nindex cdda3d527c..720d80efa9 100644\\n--- a/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/chunk_loop_trans_test.py\\n@@ -193,7 +193,7 @@ def test_chunkloop_trans_validate4():\\n                                    Reference(lvar), Literal(\\\"1\\\", INTEGER_TYPE))\\n     assign = Assignment.create(Reference(ivar), binop)\\n     sched.addchild(assign)\\n-    parent.children[0].replace_with(Reference(ivar))\\n+    parent.start_expr.replace_with(Reference(ivar))\\n     parent._variable = lvar\\n     with pytest.raises(TransformationError) as excinfo:\\n         chunktrans.validate(parent)\\n@@ -222,7 +222,7 @@ def test_chunkloop_trans_validate4():\\n                                    Reference(ivar), Literal(\\\"1\\\", INTEGER_TYPE))\\n     assign = Assignment.create(Reference(ivar), binop)\\n     sched.addchild(assign)\\n-    parent.children[1].replace_with(Reference(ivar))\\n+    parent.stop_expr.replace_with(Reference(ivar))\\n     parent._variable = lvar\\n     with pytest.raises(TransformationError) as excinfo:\\n         chunktrans.validate(parent)\\n@@ -318,8 +318,16 @@ def test_chunkloop_trans_validation_options(fortran_reader):\\n \\n     with pytest.raises(TransformationError) as err:\\n         ChunkLoopTrans().validate(outer_loop, {'chunksize': '32'})\\n-    assert (\\\"The ChunkLoopTrans chunksize option must be an integer but \\\"\\n-            \\\"found a 'str'.\\\" in str(err.value))\\n+    assert (\\\"The ChunkLoopTrans chunksize option must be a positive integer \\\"\\n+            \\\"but found a 'str'.\\\" in str(err.value))\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        ChunkLoopTrans().validate(outer_loop, {'chunksize': -64})\\n+    assert (\\\"The ChunkLoopTrans chunksize option must be a positive integer \\\"\\n+            \\\"but found '-64'.\\\" in str(err.value))\\n+\\n+    # Positive integers are accepted\\n+    ChunkLoopTrans().validate(outer_loop, {'chunksize': 64})\\n \\n \\n def test_chunkloop_trans_apply_pos():\\n@@ -354,7 +362,7 @@ def test_chunkloop_trans_apply_neg():\\n     psy = PSyFactory(\\\"gocean1.0\\\", distributed_memory=False).\\\\\\n         create(invoke_info)\\n     schedule = psy.invokes.invoke_list[0].schedule\\n-    schedule.children[0].children[2].replace_with(Literal(\\\"-1\\\", INTEGER_TYPE))\\n+    schedule.children[0].step_expr.replace_with(Literal(\\\"-1\\\", INTEGER_TYPE))\\n     chunktrans = ChunkLoopTrans()\\n     chunktrans.apply(schedule.children[0])\\n     code = str(psy.gen)\\n@@ -371,6 +379,24 @@ def test_chunkloop_trans_apply_neg():\\n     assert correct in code\\n \\n \\n+def test_chunkloop_trans_apply_with_options():\\n+    ''' Check that a non-default chunksize option is used correctly. '''\\n+    _, invoke_info = parse(os.path.join(GOCEAN_BASE_PATH, \\\"single_invoke.f90\\\"),\\n+                           api=\\\"gocean1.0\\\")\\n+    psy = PSyFactory(\\\"gocean1.0\\\", distributed_memory=False).\\\\\\n+        create(invoke_info)\\n+    schedule = psy.invokes.invoke_list[0].schedule\\n+    chunktrans = ChunkLoopTrans()\\n+    chunktrans.apply(schedule.children[0], {'chunksize': 4})\\n+    code = str(psy.gen)\\n+    correct = \\\\\\n+        '''DO j_out_var = cu_fld%internal%ystart, cu_fld%internal%ystop, 4\\n+        j_el_inner = MIN(j_out_var + (4 - 1), cu_fld%internal%ystop)\\n+        DO j = j_out_var, j_el_inner, 1\\n+    '''\\n+    assert correct in code\\n+\\n+\\n def test_chunkloop_trans_apply_double_chunk(tmpdir):\\n     '''Test the apply method of ChunkLoopTrans for multiple\\n     chunks of 2 nested loops'''\\n\",\"diff --git a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\nindex e2844330f5..2a9e8240f5 100644\\n--- a/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n+++ b/src/psyclone/tests/psyir/transformations/loop_tiling_2d_trans_test.py\\n@@ -154,8 +154,13 @@ def test_loop_tiling_2d_trans_validation_options(fortran_reader):\\n \\n     with pytest.raises(TransformationError) as err:\\n         LoopTiling2DTrans().apply(outer_loop, {'tilesize': '32'})\\n-    assert (\\\"The LoopTiling2DTrans tilesize option must be an integer but \\\"\\n-            \\\"found a 'str'.\\\" in str(err.value))\\n+    assert (\\\"The LoopTiling2DTrans tilesize option must be a positive integer \\\"\\n+            \\\"but found a 'str'.\\\" in str(err.value))\\n+\\n+    with pytest.raises(TransformationError) as err:\\n+        LoopTiling2DTrans().apply(outer_loop, {'tilesize': -32})\\n+    assert (\\\"The LoopTiling2DTrans tilesize option must be a positive integer \\\"\\n+            \\\"but found '-32'.\\\" in str(err.value))\\n \\n \\n def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n@@ -193,8 +198,7 @@ def test_loop_tiling_2d_trans_apply(fortran_reader, fortran_writer):\\n \\n \\n def test_loop_tiling_2d_trans_apply_options(fortran_reader, fortran_writer):\\n-    ''' Validation passes when found a 2D nested loop construct when a\\n-    non-default tilesize option is provided '''\\n+    ''' Check that a non-default tilesize option is used correctly. '''\\n     psyir = fortran_reader.psyir_from_source('''\\n         subroutine test(tmp)\\n             integer:: i, j\\n\"]", "hints_text": ""}
